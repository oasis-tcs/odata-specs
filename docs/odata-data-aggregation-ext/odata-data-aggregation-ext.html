<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="description" content="This specification adds basic grouping and aggregation functionality (e.g. sum, min, and max) to the Open Data Protocol (OData) without changing any of the base principles of OData." />
  <title>OData Extension for Data Aggregation Version 4.0</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #337f59; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #337f59; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #337f59; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="styles/markdown-styles-v1.7.3b.css" />
  <link rel="stylesheet" href="styles/odata.css" />
  <script type="text/javascript">
    MathJax = {startup: {
      ready() {
        MathJax.startup.defaultReady();
        MathJax.startup.document.outputJax.font.variant.monospace.chars
          [0x2019] = [.611, -.287, .525, {f: "T", c: "′"}];
      }
    }};
  </script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
      function darkmode_auto() {
        if (darkmode_switch.value === "auto") {
          if (darkmode_query.matches) document.documentElement.classList.add("darkmode");
          else document.documentElement.classList.remove("darkmode");
        }
      }

      function darkmode_manual() {
        localStorage.setItem("odata-specs/darkmode", darkmode_switch.value);
        switch (darkmode_switch.value) {
          case "off":
            document.documentElement.classList.remove("darkmode");
            break;
          case "on":
            document.documentElement.classList.add("darkmode");
            break;
          case "auto":
            darkmode_auto();
            break;
        }
      }

      const darkmode_query = matchMedia("(prefers-color-scheme: dark)");
      darkmode_query.addEventListener("change", darkmode_auto);
      const darkmode_switch = document.querySelector("#darkmode select");
      darkmode_switch.value =
        localStorage.getItem("odata-specs/darkmode") || "off";
      darkmode_switch.addEventListener("change", darkmode_manual);
      darkmode_manual();
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body>
<aside id="darkmode">
  <select aria-label="Switch light/dark mode">
    <option value="off" title="Light mode">&#x263C;</option>
    <option value="on" title="Dark mode">&#x263D;</option>
    <option value="auto" title="Follow device mode">&#x25D1;</option>
  </select>
</aside>
<p><img src="https://docs.oasis-open.org/templates/OASISLogo-v3.0.png" alt="OASIS Logo" /></p>
<hr />
<details open><summary>
<h1 id="odata-extension-for-data-aggregation-version-40">OData Extension for Data Aggregation Version 4.0</h1>
</summary>
<h2>Committee Specification Draft 05</h2>
<details open><summary>
<h2 id="19-september-2023">19 September 2023</h2>
</summary>
<p> </p>
<h4>This stage:</h4>
<p><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.md">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.md</a> (Authoritative)<br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.html</a><br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.pdf">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.pdf</a></p>
<h4>Previous stage:</h4>
<p><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.md">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.md</a> (Authoritative)<br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.html</a><br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.pdf">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.pdf</a></p>
<h4>Latest stage:</h4>
<p><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.md">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.md</a> (Authoritative)<br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html</a><br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.pdf">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.pdf</a></p>
<h4>Technical Committee:</h4>
<p><a href="https://www.oasis-open.org/committees/odata/">OASIS Open Data Protocol (OData) TC</a></p>
<h4>Chairs:</h4>
<p>Ralf Handl (<a href="mailto:ralf.handl@sap.com">ralf.handl@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Michael Pizzo (<a href="mailto:mikep@microsoft.com">mikep@microsoft.com</a>), <a href="https://www.microsoft.com/">Microsoft</a></p>
<h4>Editors:</h4>
<p>Ralf Handl (<a href="mailto:ralf.handl@sap.com">ralf.handl@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Hubert Heijkers (<a href="mailto:hubert.heijkers@nl.ibm.com">hubert.heijkers@nl.ibm.com</a>), <a href="https://www.ibm.com/">IBM</a><br />
Gerald Krause (<a href="mailto:gerald.krause@sap.com">gerald.krause@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Michael Pizzo (<a href="mailto:mikep@microsoft.com">mikep@microsoft.com</a>), <a href="https://www.microsoft.com/">Microsoft</a><br />
Heiko Theißen (<a href="mailto:heiko.theissen@sap.com">heiko.theissen@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Martin Zurmuehl (<a href="mailto:martin.zurmuehl@sap.com">martin.zurmuehl@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a></p>
<h4><span id="AdditionalArtifacts">Additional artifacts:</span></h4>
<p>This document is one component of a Work Product that also includes:</p>
<ul>
<li>ABNF components: <em>OData Aggregation ABNF Construction Rules Version 4.0 and OData Aggregation ABNF Test Cases</em>: <a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/abnf/">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/abnf/</a></li>
<li>OData Aggregation Vocabulary:
<ul>
<li><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/vocabularies/Org.OData.Aggregation.V1.json">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/vocabularies/Org.OData.Aggregation.V1.json</a></li>
<li><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/vocabularies/Org.OData.Aggregation.V1.xml">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/vocabularies/Org.OData.Aggregation.V1.xml</a></li>
</ul></li>
</ul>
<h4><span id="RelatedWork">Related work:</span></h4>
<p>This specification is related to:</p>
<ul>
<li><em>OData Version 4.01</em>. Edited by Michael Pizzo, Ralf Handl, and Martin Zurmuehl. A multi-part Work Product which includes:
<ul>
<li><em>OData Version 4.01 Part 1: Protocol</em>. Latest stage: <a href="https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html">https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html</a></li>
<li><em>OData Version 4.01 Part 2: URL Conventions</em>. Latest stage: <a href="https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part2-url-conventions.html">https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part2-url-conventions.html</a></li>
<li><em>ABNF components: OData ABNF Construction Rules Version 4.01 and OData ABNF Test Cases</em>. <a href="https://docs.oasis-open.org/odata/odata/v4.01/os/abnf/">https://docs.oasis-open.org/odata/odata/v4.01/os/abnf/</a></li>
</ul></li>
<li><em>OData Vocabularies Version 4.0</em>. Edited by Michael Pizzo, Ralf Handl, and Ram Jeyaraman. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-vocabularies/v4.0/odata-vocabularies-v4.0.html">https://docs.oasis-open.org/odata/odata-vocabularies/v4.0/odata-vocabularies-v4.0.html</a></li>
<li><em>OData Common Schema Definition Language (CSDL) JSON Representation Version 4.01</em>. Edited by Michael Pizzo, Ralf Handl, and Martin Zurmuehl. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.01/odata-csdl-json-v4.01.html">https://docs.oasis-open.org/odata/odata-csdl-json/v4.01/odata-csdl-json-v4.01.html</a></li>
<li><em>OData Common Schema Definition Language (CSDL) XML Representation Version 4.01</em>. Edited by Michael Pizzo, Ralf Handl, and Martin Zurmuehl. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-csdl-xml/v4.01/odata-csdl-xml-v4.01.html">https://docs.oasis-open.org/odata/odata-csdl-xml/v4.01/odata-csdl-xml-v4.01.html</a></li>
<li><em>OData JSON Format Version 4.01</em>. Edited by Ralf Handl, Mike Pizzo, and Mark Biamonte. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-json-format/v4.01/odata-json-format-v4.01.html">https://docs.oasis-open.org/odata/odata-json-format/v4.01/odata-json-format-v4.01.html</a></li>
</ul>
<h4>Abstract:</h4>
<p>This specification adds basic grouping and aggregation functionality (e.g. sum, min, and max) to the Open Data Protocol (OData) without changing any of the base principles of OData.</p>
<h4>Status:</h4>
<p>This document was last revised or approved by the OASIS Open Data Protocol (OData) TC on the above date. The level of approval is also listed above. Check the “Latest stage” location noted above for possible later revisions of this document. Any other numbered Versions and other technical work produced by the Technical Committee (TC) are listed at <a href="https://groups.oasis-open.org/communities/tc-community-home2?CommunityKey=e7cac2a9-2d18-4640-b94d-018dc7d3f0e2#technical">https://groups.oasis-open.org/communities/tc-community-home2?CommunityKey=e7cac2a9-2d18-4640-b94d-018dc7d3f0e2#technical</a>.</p>
<p>TC members should send comments on this specification to the TC’s email list. Any individual may submit comments to the TC by sending email to <a href="mailto:Technical-Committee-Comments@oasis-open.org">Technical-Committee-Comments@oasis-open.org</a>. Please use a Subject line like “Comment on OData Data Aggregation”.</p>
<p>This specification is provided under the <a href="https://www.oasis-open.org/policies-guidelines/ipr/#RF-on-RAND-Mode">RF on RAND Terms Mode</a> of the <a href="https://www.oasis-open.org/policies-guidelines/ipr/">OASIS IPR Policy</a>, the mode chosen when the Technical Committee was established. For information on whether any patents have been disclosed that may be essential to implementing this specification, and any offers of patent licensing terms, please refer to the Intellectual Property Rights section of the TC’s web page (<a href="https://www.oasis-open.org/committees/odata/ipr.php">https://www.oasis-open.org/committees/odata/ipr.php</a>).</p>
<p>Note that any machine-readable content (<a href="https://www.oasis-open.org/policies-guidelines/tc-process-2017-05-26/#wpComponentsCompLang">Computer Language Definitions</a>) declared Normative for this Work Product is provided in separate plain text files. In the event of a discrepancy between any such plain text file and display content in the Work Product’s prose narrative document(s), the content in the separate plain text file prevails.</p>
<h4>Key words:</h4>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in BCP 14 <a href="#rfc2119">RFC2119</a> and <a href="#rfc8174">RFC8174</a> when, and only when, they appear in all capitals, as shown here.</p>
<h4>Citation format:</h4>
<p>When referencing this specification the following citation format should be used:</p>
<p><strong>[OData-Data-Agg-v4.0]</strong></p>
<p><em>OData Extension for Data Aggregation Version 4.0</em>. Edited by Ralf Handl, Hubert Heijkers, Gerald Krause, Michael Pizzo, Heiko Theißen, and Martin Zurmuehl. 19 September 2023. OASIS Committee Specification Draft 05. <a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd05/odata-data-aggregation-ext-v4.0-csd05.html</a>. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html</a>.</p>
<h4>Notices</h4>
<p>Copyright © OASIS Open 2023. All Rights Reserved.</p>
<p>Distributed under the terms of the OASIS <a href="https://www.oasis-open.org/policies-guidelines/ipr/">IPR Policy</a>.</p>
<p>The name “OASIS” is a trademark of <a href="https://www.oasis-open.org/">OASIS</a>, the owner and developer of this specification, and should be used only to refer to the organization and its official outputs.</p>
<p>For complete copyright information please see the full Notices section in an Appendix <a href="#Notices">below</a>.</p>
</details>
</details>
<hr />
<details open><summary>
<h1 id="table-of-contents">Table of Contents</h1>
</summary>
<div class="toc">
<ul>
<li><a href="#Introduction">1 Introduction</a>
<ul>
<li><a href="#ChangesfromEarlierVersions">1.1 Changes from Earlier Versions</a></li>
<li><a href="#Glossary">1.2 Glossary</a>
<ul>
<li><a href="#DefinitionsofTerms">1.2.1 Definitions of Terms</a></li>
<li><a href="#AcronymsandAbbreviations">1.2.2 Acronyms and Abbreviations</a></li>
<li><a href="#DocumentConventions">1.2.3 Document Conventions</a></li>
</ul></li>
</ul></li>
<li><a href="#Overview">2 Overview</a>
<ul>
<li><a href="#ExampleDataModel">2.1 Example Data Model</a></li>
<li><a href="#ExampleData">2.2 Example Data</a></li>
<li><a href="#ExampleUseCases">2.3 Example Use Cases</a></li>
</ul></li>
<li><a href="#SystemQueryOptionapply">3 System Query Option <code>$apply</code></a>
<ul>
<li><a href="#FundamentalsofInputandOutputSets">3.1 Fundamentals of Input and Output Sets</a>
<ul>
<li><a href="#TypeStructureandContextURL">3.1.1 Type, Structure and Context URL</a></li>
<li><a href="#SamenessandOrder">3.1.2 Sameness and Order</a></li>
<li><a href="#EvaluationofDataAggregationPaths">3.1.3 Evaluation of Data Aggregation Paths</a></li>
</ul></li>
<li><a href="#BasicAggregation">3.2 Basic Aggregation</a>
<ul>
<li><a href="#Transformationaggregate">3.2.1 Transformation <code>aggregate</code></a>
<ul>
<li><a href="#AggregationAlgorithm">3.2.1.1 Aggregation Algorithm</a></li>
<li><a href="#Keywordas">3.2.1.2 Keyword <code>as</code></a></li>
<li><a href="#AggregationMethods">3.2.1.3 Aggregation Methods</a>
<ul>
<li><a href="#StandardAggregationMethodsum">3.2.1.3.1 Standard Aggregation Method <code>sum</code></a></li>
<li><a href="#StandardAggregationMethodmin">3.2.1.3.2 Standard Aggregation Method <code>min</code></a></li>
<li><a href="#StandardAggregationMethodmax">3.2.1.3.3 Standard Aggregation Method <code>max</code></a></li>
<li><a href="#StandardAggregationMethodaverage">3.2.1.3.4 Standard Aggregation Method <code>average</code></a></li>
<li><a href="#StandardAggregationMethodcountdistinct">3.2.1.3.5 Standard Aggregation Method <code>countdistinct</code></a></li>
<li><a href="#CustomAggregationMethods">3.2.1.3.6 Custom Aggregation Methods</a></li>
</ul></li>
<li><a href="#AggregateExpressioncount">3.2.1.4 Aggregate Expression <code>$count</code></a></li>
</ul></li>
<li><a href="#Transformationconcat">3.2.2 Transformation <code>concat</code></a></li>
<li><a href="#Transformationgroupby">3.2.3 Transformation <code>groupby</code></a>
<ul>
<li><a href="#SimpleGrouping">3.2.3.1 Simple Grouping</a></li>
</ul></li>
</ul></li>
<li><a href="#TransformationsProducingaSubset">3.3 Transformations Producing a Subset</a>
<ul>
<li><a href="#Topbottomtransformations">3.3.1 Top/bottom transformations</a>
<ul>
<li><a href="#Transformationsbottomcountandtopcount">3.3.1.1 Transformations <code>bottomcount</code> and <code>topcount</code></a></li>
<li><a href="#Transformationsbottompercentandtoppercent">3.3.1.2 Transformations <code>bottompercent</code> and <code>toppercent</code></a></li>
<li><a href="#Transformationsbottomsumandtopsum">3.3.1.3 Transformations <code>bottomsum</code> and <code>topsum</code></a></li>
</ul></li>
<li><a href="#Transformationfilter">3.3.2 Transformation <code>filter</code></a></li>
<li><a href="#Transformationorderby">3.3.3 Transformation <code>orderby</code></a></li>
<li><a href="#Transformationsearch">3.3.4 Transformation <code>search</code></a></li>
<li><a href="#Transformationskip">3.3.5 Transformation <code>skip</code></a></li>
<li><a href="#Transformationtop">3.3.6 Transformation <code>top</code></a></li>
<li><a href="#StableTotalOrderBeforeskipandtop">3.3.7 Stable Total Order Before <code>$skip</code> and <code>$top</code></a></li>
</ul></li>
<li><a href="#OnetoOneTransformations">3.4 One-to-One Transformations</a>
<ul>
<li><a href="#Transformationidentity">3.4.1 Transformation <code>identity</code></a></li>
<li><a href="#Transformationcompute">3.4.2 Transformation <code>compute</code></a></li>
</ul></li>
<li><a href="#TransformationsChangingtheInputSetStructure">3.5 Transformations Changing the Input Set Structure</a>
<ul>
<li><a href="#Transformationsjoinandouterjoin">3.5.1 Transformations <code>join</code> and <code>outerjoin</code></a></li>
</ul></li>
<li><a href="#ExpressionsEvaluableonaCollection">3.6 Expressions Evaluable on a Collection</a>
<ul>
<li><a href="#Functionaggregate">3.6.1 Function <code>aggregate</code></a></li>
<li><a href="#Expressioncount">3.6.2 Expression <code>$count</code></a></li>
</ul></li>
<li><a href="#Functionisdefined">3.7 Function <code>isdefined</code></a></li>
<li><a href="#EvaluatingapplyasanExpandandSelectOption">3.8 Evaluating <code>$apply</code> as an Expand and Select Option</a></li>
<li><a href="#ABNFforExtendedURLConventions">3.9 ABNF for Extended URL Conventions</a></li>
</ul></li>
<li><a href="#CrossJoinsandAggregation">4 Cross-Joins and Aggregation</a></li>
<li><a href="#VocabularyforDataAggregation">5 Vocabulary for Data Aggregation</a>
<ul>
<li><a href="#AggregationCapabilities">5.1 Aggregation Capabilities</a></li>
<li><a href="#CustomAggregates">5.2 Custom Aggregates</a></li>
<li><a href="#ContextDefiningProperties">5.3 Context-Defining Properties</a></li>
<li><a href="#AnnotationExample">5.4 Annotation Example</a></li>
<li><a href="#Hierarchies">5.5 Hierarchies</a>
<ul>
<li><a href="#RecursiveHierarchy">5.5.1 Recursive Hierarchy</a>
<ul>
<li><a href="#HierarchyFunctions">5.5.1.1 Hierarchy Functions</a></li>
</ul></li>
<li><a href="#HierarchyExamples">5.5.2 Hierarchy Examples</a></li>
</ul></li>
<li><a href="#FunctionsonAggregatedEntities">5.6 Functions on Aggregated Entities</a></li>
</ul></li>
<li><a href="#HierarchicalTransformations">6 Hierarchical Transformations</a>
<ul>
<li><a href="#CommonParametersforHierarchicalTransformations">6.1 Common Parameters for Hierarchical Transformations</a></li>
<li><a href="#HierarchicalTransformationsProducingaSubset">6.2 Hierarchical Transformations Producing a Subset</a>
<ul>
<li><a href="#Transformationsancestorsanddescendants">6.2.1 Transformations <code>ancestors</code> and <code>descendants</code></a></li>
<li><a href="#Transformationtraverse">6.2.2 Transformation <code>traverse</code></a></li>
</ul></li>
</ul></li>
<li><a href="#Examples">7 Examples</a>
<ul>
<li><a href="#RequestingDistinctValues">7.1 Requesting Distinct Values</a></li>
<li><a href="#StandardAggregationMethods">7.2 Standard Aggregation Methods</a></li>
<li><a href="#RequestingExpandedResults">7.3 Requesting Expanded Results</a></li>
<li><a href="#RequestingCustomAggregates">7.4 Requesting Custom Aggregates</a></li>
<li><a href="#Aliasing">7.5 Aliasing</a></li>
<li><a href="#CombiningTransformationsperGroup">7.6 Combining Transformations per Group</a></li>
<li><a href="#ModelFunctionsasSetTransformations">7.7 Model Functions as Set Transformations</a></li>
<li><a href="#ControllingAggregationperRollupLevel">7.8 Controlling Aggregation per Rollup Level</a></li>
<li><a href="#AggregationinRecursiveHierarchies">7.9 Aggregation in Recursive Hierarchies</a></li>
<li><a href="#MaintainingRecursiveHierarchies">7.10 Maintaining Recursive Hierarchies</a></li>
<li><a href="#TransformationSequences">7.11 Transformation Sequences</a></li>
</ul></li>
<li><a href="#Conformance">8 Conformance</a></li>
<li><a href="#References">A References</a>
<ul>
<li><a href="#NormativeReferences">A.1 Normative References</a></li>
</ul></li>
<li><a href="#Acknowledgments">B Acknowledgments</a>
<ul>
<li><a href="#SpecialThanks">B.1 Special Thanks</a></li>
<li><a href="#Participants">B.2 Participants</a></li>
</ul></li>
<li><a href="#RevisionHistory">C Revision History</a></li>
<li><a href="#Notices">D Notices</a></li>
</ul>
</div>
</details>
<hr />
<details open><summary>
<h1 id="1-introduction"><a id="Introduction" href="#Introduction">1 Introduction</a></h1>
</summary>
<p>This specification adds aggregation functionality to the Open Data Protocol (OData) without changing any of the base principles of OData. It defines semantics and a representation for aggregation of data, especially:</p>
<ul>
<li>Semantics and operations for querying aggregated data,</li>
<li>Results format for queries containing aggregated data,</li>
<li>Vocabulary terms to annotate what can be aggregated, and how.</li>
</ul>
<details open><summary>
<h2 id="11-changes-from-earlier-versions"><a id="ChangesfromEarlierVersions" href="#ChangesfromEarlierVersions">1.1 Changes from Earlier Versions</a></h2>
</summary>
<p>Compared to the previous stage <strong>[OData-Data-Agg-v4.0]</strong> OASIS Committee Specification 03, this version makes the following restrictions.</p>
<table>
<thead>
<tr class="header">
<th>Section</th>
<th>Restriction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>After <a href="#AggregateExpressioncount">section 3.2.1.4</a></td>
<td>Keyword <code>from</code> removed</td>
</tr>
<tr class="even">
<td>After <a href="#SimpleGrouping">section 3.2.3.1</a></td>
<td>Grouping with <code>rollup</code> removed</td>
</tr>
<tr class="odd">
<td>After <a href="#Transformationcompute">section 3.4.2</a></td>
<td>Transformation <code>addnested</code> removed</td>
</tr>
<tr class="even">
<td>After <a href="#Transformationsjoinandouterjoin">section 3.5.1</a></td>
<td>Transformation <code>nest</code> removed</td>
</tr>
<tr class="odd">
<td>Before <a href="#RecursiveHierarchy">section 5.5.1</a></td>
<td>Leveled Hierarchy removed</td>
</tr>
<tr class="even">
<td><a href="#CommonParametersforHierarchicalTransformations">Section 6.1</a></td>
<td>Optional parameter <span class="math inline">\(S\)</span> removed</td>
</tr>
<tr class="odd">
<td><a href="#Transformationtraverse">Section 6.2.2</a></td>
<td>Restricted to single-valued <code>ParentNavigationProperty</code></td>
</tr>
<tr class="even">
<td>After <a href="#Transformationtraverse">section 6.2.2</a></td>
<td>Grouping with <code>rolluprecursive</code> removed</td>
</tr>
</tbody>
</table>
</details>
<details open><summary>
<h2 id="12-glossary"><a id="Glossary" href="#Glossary">1.2 Glossary</a></h2>
</summary>
<details open><summary>
<h3 id="121-definitions-of-terms"><a id="DefinitionsofTerms" href="#DefinitionsofTerms">1.2.1 Definitions of Terms</a></h3>
</summary>
<p>This specification defines the following terms:</p>
<ul>
<li><span id="AggregatableExpression"><em>Aggregatable Expression</em></span> – an <a href="#Expression">expression</a> not involving term casts and resulting in a value of a complex or entity or an <a href="#AggregatablePrimitiveType">aggregatable primitive type</a></li>
<li><span id="AggregateExpression"><em>Aggregate Expression</em></span> – argument of the <code>aggregate</code> <a href="#Transformationaggregate">transformation</a> or <a href="#Functionaggregate">function</a> defined in <a href="#AggregationAlgorithm">section 3.2.1.1</a></li>
<li><span id="AggregatablePrimitiveType"><em>Aggregatable Primitive Type</em></span> – a primitive type other than <code>Edm.Stream</code> or subtypes of <code>Edm.Geography</code> or <code>Edm.Geometry</code></li>
<li><span id="DataAggregationPath"><em>Data Aggregation Path</em></span> – a path that consists of one or more segments joined together by forward slashes (<code>/</code>). Segments are names of declared or dynamic structural or navigation properties, or type-cast segments consisting of the (optionally qualified) name of a structured type that is derived from the type identified by the preceding path segment to reach properties declared by the derived type.</li>
<li><span id="Expression"><em>Expression</em></span> – derived from the <code>commonExpr</code> rule (see <a href="#ODataABNF">OData-ABNF</a>)</li>
<li><span id="SingleValuedPropertyPath"><em>Single-Valued Property Path</em></span> – property path ending in a single-valued primitive, complex, or navigation property</li>
</ul>
</details>
<details open><summary>
<h3 id="122-acronyms-and-abbreviations"><a id="AcronymsandAbbreviations" href="#AcronymsandAbbreviations">1.2.2 Acronyms and Abbreviations</a></h3>
</summary>
<p>The following non-exhaustive list contains variable names that are used throughout this document:</p>
<ul>
<li><span class="math inline">\(A,B,C\)</span> – collections of instances</li>
<li><span class="math inline">\(H\)</span> – hierarchical collection</li>
<li><span class="math inline">\(H&#39;\)</span> – subset of nodes from a hierarchical collection</li>
<li><span class="math inline">\(u,v,w\)</span> – instances in a collection</li>
<li><span class="math inline">\(x\)</span> – an instance in a hierarchical collection, called a node</li>
<li><span class="math inline">\(p,q,r\)</span> – paths</li>
<li><span class="math inline">\(T\)</span> – transformation sequence</li>
<li><span class="math inline">\(α\)</span> – <a href="#AggregateExpression">aggregate expression</a>, defined in <a href="#AggregationAlgorithm">section 3.2.1.1</a></li>
<li><span class="math inline">\(\Gamma(A,p)\)</span> – the collection that results from evaluating a <a href="#DataAggregationPath">data aggregation path</a> <span class="math inline">\(p\)</span> relative to a collection <span class="math inline">\(A\)</span>, defined in <a href="#EvaluationofDataAggregationPaths">section 3.1.3</a></li>
<li><span class="math inline">\(γ(u,p)\)</span> – the collection that results from evaluating a <a href="#DataAggregationPath">data aggregation path</a> <span class="math inline">\(p\)</span> relative to an instance <span class="math inline">\(u\)</span>, defined in <a href="#EvaluationofDataAggregationPaths">section 3.1.3</a></li>
<li><span class="math inline">\(\Pi_G(s)\)</span> – a transformation of a collection that injects grouping properties into every instance of the collection, defined in <a href="#SimpleGrouping">section 3.2.3.1</a></li>
<li><span class="math inline">\(σ(x)\)</span> – instance containing a grouping property that represents a node <span class="math inline">\(x\)</span>, defined in <a href="#Transformationtraverse">section 6.2.2</a></li>
</ul>
</details>
<details open><summary>
<h3 id="123-document-conventions"><a id="DocumentConventions" href="#DocumentConventions">1.2.3 Document Conventions</a></h3>
</summary>
<p>Keywords defined by this specification use <code>this monospaced font</code>.</p>
<p>Some sections of this specification are illustrated with non-normative examples.</p>
<div class="example">
<p>Example 1: text describing an example uses this paragraph style</p>
<pre><code>Non-normative examples use this paragraph style.</code></pre>
</div>
<p>All examples in this document are non-normative and informative only. Examples labeled with ⚠ contain advanced concepts or make use of keywords that are defined only later in the text, they can be skipped at first reading.</p>
<p>All other text is normative unless otherwise labeled.</p>
<p>Paragraphs labeled 🚧 in this version of the specification contain restrictions that were not made in <strong>[OData-Data-Agg-v4.0]</strong> OASIS Committee Specification 03. Also, some sections of <strong>[OData-Data-Agg-v4.0]</strong> OASIS Committee Specification 03 are omitted from this version. In later OASIS standard versions these restrictions may be lifted again and the omitted sections reintroduced.</p>
<!--
Here is a customized command line which will generate HTML from the markdown file (named `odata-data-aggregation-ext-v4.0-csd05.md`). Line breaks are added for readability only:

```
pandoc -f gfm+tex_math_dollars+fenced_divs+smart
       -t html
       -o odata-data-aggregation-ext-v4.0-csd05.html
       -c styles/markdown-styles-v1.7.3b.css
       -c styles/odata.css
       -s
       --mathjax
       --eol=lf
       --wrap=none
       --metadata pagetitle="OData Extension for Data Aggregation Version 4.0"
       odata-data-aggregation-ext-v4.0-csd05.md
```

This uses pandoc 3.1.13 from https://github.com/jgm/pandoc/releases/tag/3.1.13.
-->

</details>
</details>
</details>
<hr />
<details open><summary>
<h1 id="2-overview"><a id="Overview" href="#Overview">2 Overview</a></h1>
</summary>
<p>Open Data Protocol (OData) services expose a data model that describes the schema of the service in terms of the Entity Data Model (EDM, see <a href="#ODataCSDL">OData-CSDL</a>) and then allows for querying data in terms of this model. The responses returned by an OData service are based on that data model and retain the relationships between the entities in the model.</p>
<p>Extending the OData query features with simple aggregation capabilities avoids cluttering OData services with an exponential number of explicitly modeled “aggregation level entities” or else restricting the consumer to a small subset of predefined aggregations.</p>
<p>Adding the notion of aggregation to OData without changing any of the base principles in OData has two aspects:</p>
<ol type="1">
<li>Means for the consumer to query aggregated data on top of any given data model (for sufficiently capable data providers)</li>
<li>Means for the provider to annotate what data can be aggregated, and in which way, allowing consumers to avoid asking questions that the provider cannot answer</li>
</ol>
<p>Implementing any of these two aspects is valuable in itself independent of the other, and implementing both provides additional value for consumers. The provided aggregation annotations help a consumer understand more of the data structure looking at the service’s exposed data model. The query extensions allow the consumers to explicitly express the desired aggregation behavior for a particular query. They also allow consumers to formulate queries that utilize the aggregation annotations.</p>
<details open><summary>
<h2 id="21-example-data-model"><a id="ExampleDataModel" href="#ExampleDataModel">2.1 Example Data Model</a></h2>
</summary>
<div class="example">
<p>Example 2: The following diagram depicts a simple model that is used throughout this document.</p>
<svg xmlns:xlink="http://www.w3.org/1999/xlink" class="st20" viewBox="0 200 600 350" style="width:75em">
  <style type="text/css">
  <![CDATA[
    .st1 {fill:#f2f2f2;stroke:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st2 {fill:#ffffff;stroke:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.7}
    .st3 {fill:#000000;font-size:0.666664em}
    .st4 {font-size:1em}
    .st5 {stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st6 {fill:none;visibility:hidden}
    .st7 {stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.4}
    .st8 {fill:#000000;font-size:0.833336em}
    .st9 {fill:#000000;font-size:0.833336em;font-style:italic}
    .st10 {fill:none}
    .st11 {marker-start:url(#mrkr1-125);stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75;visibility:hidden}
    .st12 {fill:#000000;fill-opacity:1;stroke:#000000;stroke-opacity:1;stroke-width:0.22935779816514}
    .st13 {fill:#000000;font-size:0.75em}
    .st14 {fill:#000000;fill-opacity:1;stroke:#000000;stroke-opacity:1;stroke-width:0.22222222222222}
    .st15 {stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72}
    .st16 {marker-end:url(#mrkr1-200);stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72}
    .st17 {fill:none;stroke:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st18 {fill:#000000;font-size:0.75em}
    .st19 {marker-end:url(#mrkr14-311);stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st20 {fill:none;fill-rule:evenodd;font-size:12px;overflow:visible;stroke-linecap:square;stroke-miterlimit:3}
  ]]>
  </style>
  <defs id="Markers">
    <g id="lend1">
      <path d="M 1 -1 L 0 0 L 1 1 "
        style="stroke-linecap:round;stroke-linejoin:round;fill:none" />
    </g>
    <marker id="mrkr1-125" class="st12" orient="auto"
      markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend1" transform="scale(4.36) " />
    </marker>
    <g id="lend2">
      <path d="M 1 1 L 0 0 L 1 -1 L 1 1 " style="stroke:none" />
    </g>
    <marker id="mrkr2-137" class="st14" refX="-4.5" orient="auto"
      markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend2" transform="scale(-4.5,-4.5) " />
    </marker>
    <marker id="mrkr1-200" class="st14" orient="auto"
      markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend1" transform="scale(-4.5,-4.5) " />
    </marker>
    <g id="lend14">
      <path d="M 3 -1 L 0 0 L 3 1 L 3 -1 "
        style="stroke-linecap:round;stroke-linejoin:round;fill:none" />
    </g>
    <marker id="mrkr14-311" class="st12" refX="-13.08"
      orient="auto" markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend14" transform="scale(-4.36,-4.36) " />
    </marker>
  </defs>
  <g id="group1000-1" transform="translate(208.346,-446.457)">
    <g id="shape1001-2" transform="translate(0,-28.3465)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1002-4">
      <rect x="0" y="813.543" width="110.551" height="28.3465"
        class="st2" />
      <text x="4" y="825.32" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Amount: Edm.Decimal</tspan>
      </text>
    </g>
    <g id="shape1003-8">
    </g>
    <g id="shape1004-10" transform="translate(-4.79616E-14,-28.3465)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1005-13">
    </g>
    <g id="shape1006-15">
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st6" />
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st7" />
    </g>
    <g id="shape1000-18">
      <text x="45.27" y="805.2" class="st8">Sale</text>
    </g>
  </g>
  <g id="group1007-20" transform="translate(208.346,-566.929)">
    <g id="shape1008-21" transform="translate(0,-48.7559)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1009-23">
      <rect x="0" y="793.134" width="110.551" height="48.7559"
        class="st2" />
      <text x="4" y="805.51" class="st3">
        Date: Edm.Date {id}
        <tspan x="4" dy="1.2em" class="st4">Month: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Quarter: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Year: Edm.Int16</tspan>
      </text>
    </g>
    <g id="shape1010-29">
    </g>
    <g id="shape1011-31" transform="translate(-4.79616E-14,-48.7559)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1012-34">
    </g>
    <g id="shape1013-36">
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st6" />
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st7" />
    </g>
    <g id="shape1007-39">
      <text x="44.16" y="784.8" class="st8">Time</text>
    </g>
  </g>
  <g id="group1014-41" transform="translate(26.7784,-442.205)">
    <g id="shape1015-42" transform="translate(0,-36.8504)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1016-44">
      <rect x="0" y="805.039" width="110.551" height="36.8504"
        class="st2" />
      <text x="4" y="816.26" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Country: Edm.String</tspan>
      </text>
    </g>
    <g id="shape1017-49">
    </g>
    <g id="shape1018-51" transform="translate(-4.79616E-14,-36.8504)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1019-54">
    </g>
    <g id="shape1020-56">
      <rect x="0" y="782.362" width="110.551" height="59.5276"
        class="st6" />
      <rect x="0" y="782.362" width="110.551" height="59.5276"
        class="st7" />
    </g>
    <g id="shape1014-59">
      <text x="33.6" y="796.7" class="st8">Customer</text>
    </g>
  </g>
  <g id="group1028-61" transform="translate(384.094,-577.134)">
    <g id="shape1029-62" transform="translate(0,-28.3465)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1030-64">
      <rect x="0" y="813.543" width="110.551" height="28.3465"
        class="st2" />
      <text x="4" y="825.32" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String</tspan>
      </text>
    </g>
    <g id="shape1031-68">
    </g>
    <g id="shape1032-70" transform="translate(-4.79616E-14,-28.3465)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1033-73">
    </g>
    <g id="shape1034-75">
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st6" />
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st7" />
    </g>
    <g id="shape1028-78">
      <text x="34.99" y="805.2" class="st8">Category</text>
    </g>
  </g>
  <g id="group1035-80" transform="translate(384.094,-436.252)">
    <g id="shape1036-81" transform="translate(0,-48.7559)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1037-83">
      <rect x="0" y="793.134" width="110.551" height="48.7559"
        class="st2" />
      <text x="4" y="805.51" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Color: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">TaxRate: Edm.Decimal</tspan>
      </text>
    </g>
    <g id="shape1038-89">
    </g>
    <g id="shape1039-91" transform="translate(-4.79616E-14,-48.7559)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1040-94">
    </g>
    <g id="shape1041-96">
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st6" />
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st7" />
    </g>
    <g id="shape1035-99">
      <text x="38.04" y="784.8" class="st9">Product</text>
    </g>
  </g>
  <g id="group1042-101" transform="translate(208.346,-324)">
    <g id="shape1043-102" transform="translate(0,-28.3465)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1044-104">
      <rect x="0" y="813.543" width="110.551" height="28.3465"
        class="st2" />
      <text x="4" y="825.32" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String</tspan>
      </text>
    </g>
    <g id="shape1045-108">
    </g>
    <g id="shape1046-110" transform="translate(-4.79616E-14,-28.3465)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1047-113">
    </g>
    <g id="shape1048-115">
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st6" />
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st7" />
    </g>
    <g id="shape1042-118">
      <text x="14.42" y="805.2" class="st8">SalesOrganization</text>
    </g>
  </g>
  <g id="group1054-120" transform="translate(208.346,-464.882)">
    <g id="shape1055-121" transform="translate(-70.1169,-22.1102)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1056-127" transform="translate(-15.5072,7.65354)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1057-132" transform="translate(0,1673.86) rotate(180)">
    </g>
    <g id="shape1058-134" transform="translate(-47.847,-1.27717)">
    </g>
    <g id="shape1054-138">
      <path d="M0 834.8 L-71.02 834.8" class="st15" />
    </g>
  </g>
  <g id="group1064-141" transform="translate(318.898,-464.882)">
    <g id="shape1065-142" transform="translate(48.9382,-22.1102)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1066-147" transform="translate(0.0833553,8.50393)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1067-152" transform="translate(0,-4.25197)">
    </g>
    <g id="shape1068-154" transform="translate(20.2598,-1.27717)">
    </g>
    <g id="shape1064-157">
      <path d="M0 834.8 L65.2 834.8" class="st15" />
    </g>
  </g>
  <g id="group1069-160" transform="translate(432.283,-577.134)">
    <g id="shape1070-161" transform="translate(5.75265,55.559)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1071-166" transform="translate(-10.5894,14.1732)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1072-171"
      transform="translate(846.142,841.89) rotate(90)">
    </g>
    <g id="shape1073-173" transform="translate(-5.25197,44.0181)">
    </g>
    <g id="shape1069-176">
      <path d="M7.09 841.89 L7.09 911.34" class="st15" />
    </g>
  </g>
  <g id="group1079-179" transform="translate(263.622,-324)">
    <g id="shape1080-180" transform="translate(67.1811,-12.7559)">
      <rect x="0" y="830.551" width="22.6772" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="22.6772" height="11.3386"
        class="st11" />
      <text x="3.83" y="838.92" class="st13">0..1</text>
    </g>
    <g id="shape1081-185" transform="translate(-14.0899,14.1732)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1082-190"
      transform="translate(839.055,841.89) rotate(90)">
    </g>
    <g id="shape1083-192" transform="translate(15.2992,-7.4189)">
    </g>
    <g id="shape1079-195">
      <path
        d="M0 841.89 L-0 852.52 A8.50394 8.50394 -180 0 0 8.5 861.02 L57.4 861.02 A8.50394 8.50394 -180 0 0 65.91 852.52
               L65.91 821.69 A5.31496 5.31496 -180 0 0 60.59 816.38 L55.28 816.38"
        class="st16" />
    </g>
  </g>
  <g id="group1084-201" transform="translate(256.535,-446.457)">
    <g id="shape1085-202" transform="translate(-6.90433,69.4488)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1086-207" transform="translate(5.75264,14.4567)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1087-212"
      transform="translate(846.142,841.89) rotate(90)">
    </g>
    <g id="shape1088-214" transform="translate(-5.25197,45.0929)">
    </g>
    <g id="shape1084-217">
      <path d="M7.09 841.89 L7.09 913.32" class="st16" />
    </g>
  </g>
  <g id="group1094-222" transform="translate(256.535,-497.48)">
    <g id="shape1095-223" transform="translate(-9.17205,-52.441)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1096-228" transform="translate(7.16997,0.708661)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1097-233"
      transform="translate(-831.969,841.89) rotate(-90)">
    </g>
    <g id="shape1098-235" transform="translate(-5.25197,-31.2181)">
    </g>
    <g id="shape1094-238">
      <path d="M7.09 841.89 L7.09 772.44" class="st16" />
    </g>
  </g>
  <g id="shape1099-243" transform="translate(173.622,-446.457)">
    <rect x="0" y="827.717" width="35.4331" height="14.1732"
      class="st17" />
    <text x="7.43" y="837.8" class="st18">Sales</text>
  </g>
  <g id="shape1100-246" transform="translate(317.126,-446.457)">
    <rect x="0" y="827.717" width="35.4331" height="14.1732"
      class="st17" />
    <text x="7.43" y="837.8" class="st18">Sales</text>
  </g>
  <g id="shape1101-249" transform="translate(138.114,-474.803)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="5.09" y="837.8" class="st18">Customer</text>
  </g>
  <g id="shape1102-252" transform="translate(336.539,-474.803)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="8.87" y="837.8" class="st18">Product</text>
  </g>
  <g id="shape1103-255" transform="translate(436.385,-510.236)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="6.92" y="837.8" class="st18">Products</text>
  </g>
  <g id="shape1104-258" transform="translate(389.613,-552.756)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="6.66" y="837.8" class="st18">Category</text>
  </g>
  <g id="shape1105-261" transform="translate(233.707,-538.583)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="4" y="837.8" class="st18">Time</text>
  </g>
  <g id="shape1106-264" transform="translate(183.366,-388.878)">
    <rect x="0" y="827.717" width="92.126" height="14.1732"
      class="st17" />
    <text x="4" y="837.8" class="st18">SalesOrganization</text>
  </g>
  <g id="shape1108-267" transform="translate(330.236,-324)">
    <rect x="0" y="827.717" width="69.7039" height="14.1732"
      class="st17" />
    <text x="4" y="837.8" class="st18">Superordinate</text>
  </g>
  <g id="group1110-270" transform="translate(432.283,-368.504)">
    <g id="shape1111-271" transform="translate(0,-20.4094)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1112-273">
      <rect x="0" y="821.48" width="110.551" height="20.4094"
        class="st2" />
      <text x="4" y="834.09" class="st3">Rating: Edm.Byte</text>
    </g>
    <g id="shape1113-276">
    </g>
    <g id="shape1114-278" transform="translate(-4.79616E-14,-20.4094)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1115-281">
    </g>
    <g id="shape1116-283">
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st6" />
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st7" />
    </g>
    <g id="shape1110-286">
      <text x="26.65" y="813.14" class="st8">FoodProduct</text>
    </g>
  </g>
  <g id="group1117-288" transform="translate(432.283,-308.153)">
    <g id="shape1118-289" transform="translate(0,-20.4094)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1119-291">
      <rect x="0" y="821.48" width="110.551" height="20.4094"
        class="st2" />
      <text x="4" y="834.09" class="st3">RatingClass: Edm.String</text>
    </g>
    <g id="shape1120-294">
    </g>
    <g id="shape1121-296" transform="translate(-4.79616E-14,-20.4094)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1122-299">
    </g>
    <g id="shape1123-301">
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st6" />
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st7" />
    </g>
    <g id="shape1117-304">
      <text x="17.48" y="813.14" class="st8">NonFoodProduct</text>
    </g>
  </g>
  <g id="shape1124-306" transform="translate(432.283,-390.047)">
    <path d="M0 841.89 L-20.55 841.89 L-20.55 805.5" class="st19" />
  </g>
  <g id="shape1125-312" transform="translate(432.283,-329.697)">
    <path d="M0 841.89 L-20.55 841.89 L-20.55 745.14" class="st19" />
  </g>
</svg>

<p>The <code>Amount</code> property in the <code>Sale</code> entity type is an <a href="#AggregationCapabilities">aggregatable property</a>, and the properties of the related entity types are groupable. These can be arranged in hierarchies, for example:</p>
<ul>
<li>Product hierarchy based on <a href="#AggregationCapabilities">groupable</a> properties of the <code>Category</code> and <code>Product</code> entity types</li>
<li>Customer hierarchy based on <code>Country</code> and <code>Customer</code></li>
<li>Time hierarchy based on <code>Year</code>, <code>Month</code>, and <code>Date</code></li>
<li>SalesOrganization <a href="#RecursiveHierarchy">hierarchy</a> based on the recursive association to itself</li>
</ul>
<p>In the context of Online Analytical Processing (OLAP), this model might be described in terms of a Sales “cube” with an Amount “measure” and three “dimensions”. This document will avoid such terms, as they are heavily overloaded.</p>
</div>
<p>Query extensions and descriptive annotations can be applied to normalized schemas as well as partly or fully denormalized schemas.</p>
<div class="example">
<p>Example 3: The following diagram depicts a denormalized schema for the simple model.</p>
<table>
  <tr><th colspan="2">Sale</th></tr>
  <tr><td rowspan="2">Sales</td><td>ID: Edm.String {id}</td></tr>
  <tr><td>Amount: Edm.Decimal</td></tr>
  <tr><td rowspan="2">Category</td><td>CategoryID: Edm.String</td></tr>
  <tr><td>CategoryName: Edm.String</td></tr>
  <tr><td rowspan="4">Product</td><td>ProductID: Edm.String</td></tr>
  <tr><td>ProductName: Edm.String</td></tr>
  <tr><td>ProductColor: Edm.String</td></tr>
  <tr><td>ProductTaxRate: Edm.Decimal</td></tr>
  <tr><td rowspan="1">Food</td><td>FoodProductRating: Edm.Byte</td></tr>
  <tr><td rowspan="1">Non-Food</td><td>NonFoodProductRatingClass: Edm.String</td></tr>
  <tr><td rowspan="3">Sales Organization</td><td>SalesOrganizationID: Edm.String</td></tr>
  <tr><td>SalesOrganizationName: Edm.String</td></tr>
  <tr><td>SalesOrganizationSuperordinateID: Edm.String</td></tr>
  <tr><td rowspan="4">Time</td><td>TimeDate: Edm.Date</td></tr>
  <tr><td>TimeMonth: Edm.String</td></tr>
  <tr><td>TimeQuarter: Edm.String</td></tr>
  <tr><td>TimeYear: Edm.Int16</td></tr>
  <tr><td rowspan="3">Customer</td><td>CustomerID: Edm.String</td></tr>
  <tr><td>CustomerName: Edm.String</td></tr>
  <tr><td>CustomerCountry: Edm.String</td></tr>
</table>

</div>
</details>
<details open><summary>
<h2 id="22-example-data"><a id="ExampleData" href="#ExampleData">2.2 Example Data</a></h2>
</summary>
<div class="example">
<p>Example 4: The following entity sets and sample data will be used to further illustrate the capabilities introduced by this extension.</p>
<div class="example-data" style="width:600px;height:700px">
<svg viewBox="0 0 600 700">
  <defs>
    <marker id="begin" viewBox="0 0 10 10" refX="0" refY="5" orient="auto" markerWidth="5" markerHeight="5">
      <path d="M10,0 L0,5 L10,10 z" />
    </marker>
    <marker id="end" viewBox="0 0 10 10" refX="10" refY="5" orient="auto" markerWidth="5" markerHeight="5">
      <path d="M0,0 L10,5 L0,10 z" />
    </marker>
  </defs>
  <path d="M310,150 l45,50" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M50,485 l0,-35" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M160,485 l30,-185" marker-end="url(#end)" />
  <path d="M215,485 l45,-335" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M300,485 l55,-165" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M525,300 l-40,-20" marker-end="url(#end)" />
</svg>

<div class="nav-2" style="left:250px">
<p>Products</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Category</th>
<th>Name</th>
<th>Color</th>
<th style="text-align: right;">TaxRate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>P1</td>
<td>PG1</td>
<td>Sugar</td>
<td>White</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="even">
<td>P2</td>
<td>PG1</td>
<td>Coffee</td>
<td>Brown</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="odd">
<td>P3</td>
<td>PG2</td>
<td>Paper</td>
<td>White</td>
<td style="text-align: right;">0.14</td>
</tr>
<tr class="even">
<td>P4</td>
<td>PG2</td>
<td>Pencil</td>
<td>Black</td>
<td style="text-align: right;">0.14</td>
</tr>
</tbody>
</table>
</div>
<div style="left:510px">
<p>Food</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;"> </td>
</tr>
<tr class="odd">
<td style="text-align: right;">n/a</td>
</tr>
<tr class="even">
<td style="text-align: right;">n/a</td>
</tr>
</tbody>
</table>
</div>
<div style="left:570px">
<p>Non-Food</p>
<table>
<thead>
<tr class="header">
<th>RatingClass</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n/a</td>
</tr>
<tr class="even">
<td>n/a</td>
</tr>
<tr class="odd">
<td>average</td>
</tr>
<tr class="even">
<td> </td>
</tr>
</tbody>
</table>
</div>
<div style="top:150px">
<p>Time</p>
<table>
<thead>
<tr class="header">
<th>Date</th>
<th>Month</th>
<th>Quarter</th>
<th>Year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2022-01-01</td>
<td>2022-01</td>
<td>2022-1</td>
<td>2022</td>
</tr>
<tr class="even">
<td>2022-04-01</td>
<td>2022-04</td>
<td>2022-2</td>
<td>2022</td>
</tr>
<tr class="odd">
<td>2022-04-10</td>
<td>2022-04</td>
<td>2022-2</td>
<td>2022</td>
</tr>
<tr class="even">
<td>…</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div style="top:150px;left:360px">
<p>Categories</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PG1</td>
<td>Food</td>
</tr>
<tr class="even">
<td>PG2</td>
<td>Non-Food</td>
</tr>
</tbody>
</table>
</div>
<div class="nav-2" style="top:260px;left:360px">
<p>Sales Organizations</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Superordinate</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sales</td>
<td></td>
<td>Corporate Sales</td>
</tr>
<tr class="even">
<td>US</td>
<td>Sales</td>
<td>US</td>
</tr>
<tr class="odd">
<td>US West</td>
<td>US</td>
<td>US West</td>
</tr>
<tr class="even">
<td>US East</td>
<td>US</td>
<td>US East</td>
</tr>
<tr class="odd">
<td>EMEA</td>
<td>Sales</td>
<td>EMEA</td>
</tr>
<tr class="even">
<td>EMEA Central</td>
<td>EMEA</td>
<td>EMEA Central</td>
</tr>
</tbody>
</table>
</div>
<div style="top:300px">
<p>Customers</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Name</th>
<th>Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>C1</td>
<td>Joe</td>
<td>USA</td>
</tr>
<tr class="even">
<td>C2</td>
<td>Sue</td>
<td>USA</td>
</tr>
<tr class="odd">
<td>C3</td>
<td>Sue</td>
<td>Netherlands</td>
</tr>
<tr class="even">
<td>C4</td>
<td>Luc</td>
<td>France</td>
</tr>
</tbody>
</table>
</div>
<div class="nav-2 nav-3 nav-4 nav-5" style="top:450px">
<p>Sales</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Customer</th>
<th>Time</th>
<th>Product</th>
<th>Sales Organization</th>
<th style="text-align: right;">Amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>C1</td>
<td>2022-01-03</td>
<td>P3</td>
<td>US West</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>2</td>
<td>C1</td>
<td>2022-04-10</td>
<td>P1</td>
<td>US West</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C1</td>
<td>2022-08-07</td>
<td>P2</td>
<td>US West</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>4</td>
<td>C2</td>
<td>2022-01-03</td>
<td>P2</td>
<td>US East</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td>5</td>
<td>C2</td>
<td>2022-11-09</td>
<td>P3</td>
<td>US East</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>6</td>
<td>C3</td>
<td>2022-04-01</td>
<td>P1</td>
<td>EMEA Central</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>7</td>
<td>C3</td>
<td>2022-08-06</td>
<td>P3</td>
<td>EMEA Central</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>8</td>
<td>C3</td>
<td>2022-11-22</td>
<td>P3</td>
<td>EMEA Central</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
<div class="legend" style="top:470px;left:500px">
<p>Legend</p>
<table>
<thead>
<tr class="header">
<th>Property</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Key</td>
</tr>
<tr class="even">
<td>Navigation Property</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</details>
<details open><summary>
<h2 id="23-example-use-cases"><a id="ExampleUseCases" href="#ExampleUseCases">2.3 Example Use Cases</a></h2>
</summary>
<div class="example">
<p>Example 5: In the example model, one prominent use case is the relation of customers to products. The first question that is likely to be asked is: “Which customers bought which products?”</p>
<p>This leads to the second more quantitative question: “Who bought how much of what?”</p>
<p>The answer to the second question typically is visualized as a cross-table:</p>
<div class="cross">
<table>
<tbody>
<tr class="odd">
<td></td>
<td></td>
<td style="text-align: right;">Food</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;">Non-Food</td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td style="text-align: right;"></td>
<td style="text-align: right;">Sugar</td>
<td style="text-align: right;">Coffee</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">Paper</td>
</tr>
<tr class="odd">
<td>USA</td>
<td></td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td></td>
<td>Joe</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td></td>
<td>Sue</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td></td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td></td>
<td>Sue</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
</div>
<p>The data in this cross-table can be written down in a shape that more closely resembles the structure of the data model, leaving cells empty that have been aggregated away:</p>
<table>
<thead>
<tr class="header">
<th>Customer/Country</th>
<th>Customer/Name</th>
<th>Product/Category/Name</th>
<th>Product/Name</th>
<th style="text-align: right;">Amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>USA</td>
<td>Joe</td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Joe</td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Joe</td>
<td>Food</td>
<td>Coffee</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Sue</td>
<td>Food</td>
<td>Coffee</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Sue</td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td>Sue</td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td>Sue</td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td>USA</td>
<td></td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>USA</td>
<td></td>
<td>Food</td>
<td>Coffee</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td>USA</td>
<td></td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td></td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td></td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Joe</td>
<td>Food</td>
<td></td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Joe</td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Sue</td>
<td>Food</td>
<td></td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Sue</td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td>Sue</td>
<td>Food</td>
<td></td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td>Sue</td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td>USA</td>
<td></td>
<td>Food</td>
<td></td>
<td style="text-align: right;">14</td>
</tr>
<tr class="even">
<td>USA</td>
<td></td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td></td>
<td>Food</td>
<td></td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td></td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
<p>Note that this result contains seven fully qualified aggregate values, followed by fifteen rollup rows with subtotal values.</p>
</div>
</details>
</details>
<hr />
<details open><summary>
<h1 id="3-system-query-option-apply"><a id="SystemQueryOptionapply" href="#SystemQueryOptionapply">3 System Query Option <code>$apply</code></a></h1>
</summary>
<p>A <em>set transformation</em> (<em>transformation</em> for short) is an operation on an input set that produces an output set. A <em>transformation sequence</em> is a sequence of set transformations, separated by forward slashes to express that they are consecutively applied. A transformation sequence may be invoked using the system query option <code>$apply</code>. The input set of the first set transformation is the collection addressed by the resource path. The output set of each set transformation is the input set for the next set transformation. The output set of the last set transformation in the transformation sequence invoked by the system query option <code>$apply</code> is the result of <code>$apply</code>. This is consistent with the use of service-defined bound and composable functions in path segments. Set transformations may also appear as a parameter of certain other set transformations defined below.</p>
<p>The system query option <code>$apply</code> MUST NOT be used if the resource path addresses a single instance.</p>
<p>The system query option <code>$apply</code> is evaluated first, then the other system query options are evaluated, if applicable, on the result of <code>$apply</code>, see <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#SystemQueryOptions">OData-Protocol, section 11.2.1</a>. Stability across requests for system query options <code>$top</code> and <code>$skip</code> <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#SystemQueryOptiontop">OData-Protocol, section 11.2.6.3</a> is defined in <a href="#StableTotalOrderBeforeskipandtop">section 3.3.7</a>.</p>
<p>Each set transformation:</p>
<ul>
<li>carries over the input type to the output set such that it fits into the data model of the service.</li>
<li>can mark certain navigation properties and stream properties for <em>expansion by default</em>, that is, they are expanded in the result of <code>$apply</code> in the absence of an <code>$expand</code> query option.</li>
<li>may produce an output set with a different number of instances than the input set.</li>
<li>does not necessarily guarantee that all properties of the instances in the output set have a well-defined value.</li>
</ul>
<p>Instances of an output set can contain structural and navigation properties, which can be declared or dynamic, as well as instance annotations.</p>
<p>The allowed set transformations are defined in this section as well as in the section on <a href="#HierarchicalTransformations">Hierarchical Transformations</a>.</p>
<p>Service-defined bound functions that take a collection of instances of a structured type as their binding parameter and return a collection of instances of a structured type MAY be used as set transformations within <code>$apply</code>. Further transformations can follow the bound function. The parameter syntax for bound function segments is identical to the parameter syntax for bound functions in resource path segments or <code>$filter</code> expressions. See <a href="#ModelFunctionsasSetTransformations">section 7.7</a> for an example.</p>
<p>Parameter aliases <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#ParameterAliases">OData-URL, section 5.3</a> can be used inside the value of <code>$apply</code> wherever the ABNF rule <code>applyTrafo</code> <a href="#ODataABNF">OData-ABNF</a> is reduced to a <code>commonExpr</code> <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#CommonExpressionSyntax">OData-URL, section 5.1.1</a> or a <code>collectionExpr</code> (<a href="#ExpressionsEvaluableonaCollection">section 3.6</a>).</p>
<p>If a data service that supports <code>$apply</code> does not support it on the collection identified by the request resource path, it MUST fail with <code>501 Not Implemented</code> and a meaningful human-readable error message.</p>
<p>On resource paths ending in <code>/$count</code> the system query option <code>$apply</code> is evaluated on the set identified by the resource path without the <code>/$count</code> segment, the result is the plain-text number of items in the result of <code>$apply</code>. This is similar to the combination of <code>/$count</code> and <code>$filter</code>.</p>
<p>During serialization of the result of <code>$apply</code> declared properties and dynamic properties are represented as defined by the response format. Other properties have been aggregated away and are not represented in the response. The entities returned in the request examples in the following sections that involve aggregation are therefore transient.</p>
<details open><summary>
<h2 id="31-fundamentals-of-input-and-output-sets"><a id="FundamentalsofInputandOutputSets" href="#FundamentalsofInputandOutputSets">3.1 Fundamentals of Input and Output Sets</a></h2>
</summary>
<p>The definitions of italicized terms made in this section are used throughout this text, always with a hyperlink to this section.</p>
<details open><summary>
<h3 id="311-type-structure-and-context-url"><a id="TypeStructureandContextURL" href="#TypeStructureandContextURL">3.1.1 Type, Structure and Context URL</a></h3>
</summary>
<p>All input sets and output sets in one transformation sequence are collections of the <em>input type</em>, that is the entity type or complex type of the first input set, or in other words, of the resource to which the transformation sequence is applied. The input type is determined by the entity model element identified within the metadata document by the context URL of that resource <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#ContextURL">OData-Protocol, section 10</a>. Individual instances in an input or output set can have a subtype of the input type. (See <a href="#subinputtype">example 65</a>.) The transformation sequence given as the <code>$apply</code> system query option is applied to the resource addressed by the resource path. The transformations defined below can have nested transformation sequences as parameters, these are then applied to resources that can differ from the current input set.</p>
<p>The <em>structure</em> of an instance that occurs in an input or output set is defined by the names of the structural and navigation properties that the instance contains. Instances of an input type can have different structures, subject to the following rules:</p>
<ul>
<li>Declared properties of the input type or a nested or related type thereof or of a subtype of one of these MUST have their declared type and meaning when they occur in an input or output set.</li>
<li>Single- or collection-valued primitive properties addressed by a property path starting at a non-transient entity MUST keep their values from the addressed resource path collection throughout the transformation sequence. Likewise, single- or collection-valued navigation property paths starting at a non-transient entity MUST keep addressing the same non-transient entities as in the addressed resource path collection.</li>
<li>Instances in an output set need not have all declared or dynamic properties that occurred in the input set.</li>
<li>Instances in an output set can have dynamic properties that did not occur in the input set. The name for such a dynamic property is called an <em>alias</em>, it is a simple identifier (see <a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.02/odata-csdl-json-v4.02.html#SimpleIdentifier">OData-CSDL, section 15.2</a>). Aliases MUST differ from names of declared properties in the input type, from names of properties in the first input set, and from names of properties in the current input set. Aliases in one collection MUST also differ from each other.</li>
<li>Instances in an output set that have all key properties of an entity also have the metadata associated with that entity, such as entity-id, read and edit URL (defined in <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#ServiceModel">OData-Protocol, section 4</a>) and ETag (defined in <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#UseofETagsforAvoidingUpdateConflicts">OData-Protocol, section 11.4.1.1</a>) as well as relations to other entities <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#RequestingRelatedEntities">OData-Protocol, section 11.2.7</a>.</li>
</ul>
<p>Here is an overview of the structural changes made by different transformations:</p>
<ul>
<li>During <a href="#BasicAggregation">aggregation</a>, many instances are replaced by one instance, properties that represent the aggregation level are retained, and others are replaced by dynamic properties holding the aggregate value of the many instances or a transformed copy of them.</li>
<li>During <a href="#Transformationcompute">compute</a>, dynamic properties are added to each instance.</li>
<li>During <a href="#Transformationsjoinandouterjoin">join</a>, one instance with a collection of related instances is replaced by many copies, each of which is related via a dynamic property to one of the related instances.</li>
<li>During <a href="#Transformationconcat">concatenation</a>, the same instances are transformed multiple times and the output sets with their potentially different structures are concatenated.</li>
</ul>
<p>An output set thus consists of instances with different structures. This is the same situation as with a collection of an open type (<a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.02/odata-csdl-json-v4.02.html#OpenEntityType">OData-CSDL, section 6.3</a> and <a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.02/odata-csdl-json-v4.02.html#OpenComplexType">OData-CSDL, section 9.3</a>) and it is handled in the same way.</p>
<p>If the first input set is a collection of entities from a given entity set, then so are all input sets and output sets in the transformation sequence. The <code>{select-list}</code> in the context URL <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#ContextURL">OData-Protocol, section 10</a> MUST describe only properties that are present or annotated as absent (for example, if <code>Core.Permissions</code> is <code>None</code> <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#RequestingIndividualEntities">OData-Protocol, section 11.2.2</a>) in all instances of the collection, after applying any <code>$select</code> and <code>$expand</code> system query options. The <code>{select-list}</code> SHOULD describe as many such properties as possible, even if the request involves a concatenation that leads to a non-homogeneous structure. If the server cannot determine any such properties, the <code>{select-list}</code> MUST consist of just the instance annotation <code>AnyStructure</code> defined in the <a href="https://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Core.V1.md#AnyStructure"><code>Core</code> vocabulary</a>. (See <a href="#anystructure">example 66</a>.)</p>
</details>
<details open><summary>
<h3 id="312-sameness-and-order"><a id="SamenessandOrder" href="#SamenessandOrder">3.1.2 Sameness and Order</a></h3>
</summary>
<p>Input sets and output sets are not sets of instances in the mathematical sense but collections, because the same instance can occur multiple times in them. In other words: A collection contains values (which can be instances of structured types or primitive values), possibly with repetitions. The occurrences of the values in the collection form a set in the mathematical sense. The <em>cardinality</em> of a collection is the total number of occurrences in it. When this text describes a transformation algorithmically and stipulates that certain steps are carried out <em>for each occurrence</em> in a collection, this means that the steps are carried out multiple times for the same value if it occurs multiple times in the collection.</p>
<p>A collection addressed by the resource path is returned by the service either as an ordered collection <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#ManagingMembersofanOrderedCollection">OData-Protocol, section 11.4.10</a> or as an unordered collection. The same applies to collections that are nested in or related to the addressed resource as well as to collections that are the result of evaluating an expression starting with <code>$root</code>, which occur, for example, as the first parameter of a <a href="#HierarchicalTransformations">hierarchical transformation</a>.</p>
<p>But when such a collection is transformed by the <code>$apply</code> system query option, additional cases can arise that are neither ordered nor totally unordered. For example, the <a href="#Transformationgroupby"><code>groupby</code></a> transformation retains any order within a group but not between groups.</p>
<div class="example">
<p>⚠ Example 6: Request the top 10 sales per customer. The processing of the request can be parallelized per customer and the responses per customer can be interleaved in the overall response. This means that for any given customer, their top 10 sales appear in the desired order, though not consecutively.</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer),orderby(Amount desc)/top(10))</code></pre>
</div>
<p>For every transformation defined in the following sections, it will be specified how it orders its output set, based on the order of its input set. The order of the last output set can be further influenced by a <code>$orderby</code> system query option before it is observed in the response payload.</p>
<p>An order of a collection is more precisely defined as follows: Given two different occurrences <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> in a collection, which may be of the same value or of different values, <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> or <span class="math inline">\(u_2\)</span> precedes <span class="math inline">\(u_1\)</span>, but not both. It can be neither, in which case the relative order of <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> does not matter. If <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> and <span class="math inline">\(u_2\)</span> precedes <span class="math inline">\(u_3\)</span>, then <span class="math inline">\(u_1\)</span> also precedes <span class="math inline">\(u_3\)</span>, and <span class="math inline">\(u_1\)</span> never precedes <span class="math inline">\(u_1\)</span>. (This is a partial order in the mathematical sense defined on the set of occurrences.)</p>
<p>When transformations are defined in the following sections, the algorithmic description sometimes contains an <em>order-preserving loop</em> over a collection. Such a loop processes the occurrences in an order chosen by the service in such a way that <span class="math inline">\(u_1\)</span> is processed before <span class="math inline">\(u_2\)</span> whenever <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span>. Likewise, in an <em>order-preserving sequence</em> <span class="math inline">\(u_1,…,u_n\)</span> we have <span class="math inline">\(i&lt;j\)</span> whenever <span class="math inline">\(u_i\)</span> precedes <span class="math inline">\(u_j\)</span>.</p>
<p>A collection can be <em>stable-sorted</em> by a list of expressions. In the stable-sorted collection an occurrence <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> if and only if either</p>
<ul>
<li><span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> according to the rules of <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#SystemQueryOptionorderby">OData-Protocol, section 11.2.6.2</a> or</li>
<li>these rules do not determine a precedence in either direction between <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> but <span class="math inline">\(u_1\)</span> preceded <span class="math inline">\(u_2\)</span> in the collection before the sort.</li>
</ul>
<p>Stable-sorting of an ordered collection produces another ordered collection. A stable-sort does not necessarily produce a total order, the sorted collection may still contain two occurrences whose relative order does not matter. The transformation <a href="#Transformationorderby"><code>orderby</code></a> performs a stable-sort.</p>
<p>The output set of a <a href="#BasicAggregation">basic aggregation</a> transformation can contain instances of an entity type without entity-id. After a <a href="#Transformationconcat"><code>concat</code></a> transformation, different occurrences of the same entity can differ in individual non-declared properties. To account for such cases, the definition of sameness given in <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#Equals">OData-URL, section 5.1.1.1.1</a> is refined here. Instances of structured types are <em>the same</em> if</p>
<ul>
<li>both are instances of complex types and both are null or both have the same structure and same values with null considered different from absent or</li>
<li>both are instances of entity types without entity-id (see <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#TransientEntities">OData-Protocol, section 4.3</a>) and both are null or both have the same structure and same values with null considered different from absent (informally speaking, they are compared like complex instances) or</li>
<li>(1) both are instances of the same entity type with the same entity-id (non-transient entities, see <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#EntityIdsandEntityReferences">OData-Protocol, section 4.1</a>) and (2) the structural and navigation properties contained in both have the same values (for non-primitive properties the sameness of values is decided by a recursive invocation of this definition).
<ul>
<li>If this is fulfilled, the instances are called <em>complementary representations of the same non-transient entity</em>. If this case is encountered at some recursion level while the sameness of non-transient entities <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> is established, a merged representation of the entity <span class="math inline">\(u_1=u_2\)</span> exists that contains all properties of <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span>. But if the instances both occur in the last output set, services MUST represent each with its own structure in the response payload.</li>
<li>If the first condition is fulfilled but not the second, the instances are not the same and are called <em>contradictory representations of the same non-transient entity</em>. (<a href="#contradict">Example 84</a> describes a use case for this.)</li>
</ul></li>
</ul>
<p>Collections are <em>the same</em> if there is a one-to-one correspondence <span class="math inline">\(f\)</span> between them such that</p>
<ul>
<li>corresponding occurrences are of the same value and</li>
<li>an occurrence <span class="math inline">\(u_1\)</span> precedes another occurrence <span class="math inline">\(u_2\)</span> if and only if the occurrence <span class="math inline">\(f(u_1)\)</span> precedes the occurrence <span class="math inline">\(f(u_2)\)</span>, where the occurrences <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> may be of the same value or of different values. (A one-to-one correspondence with this second property is called <em>order-preserving</em>.)</li>
</ul>
</details>
<details open><summary>
<h3 id="313-evaluation-of-data-aggregation-paths"><a id="EvaluationofDataAggregationPaths" href="#EvaluationofDataAggregationPaths">3.1.3 Evaluation of Data Aggregation Paths</a></h3>
</summary>
<p>This document specifies how a <a href="#DataAggregationPath">data aggregation path</a> that occurs in a request is evaluated by the service. If such an evaluation fails, the service MUST reject the request.</p>
<p>For a data aggregation path to be a common expression according to <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#CommonExpressionSyntax">OData-URL, section 5.1.1</a>, its segments must be single-valued with the possible exception of the last segment, and it can then be evaluated relative to an instance of a structured type. For the transformations defined in this document, a data aggregation path can also be evaluated relative to a collection <span class="math inline">\(A\)</span>, even if it has arbitrary collection-valued segments itself.</p>
<p>To this end, the following notation is used in the subsequent sections: If <span class="math inline">\(A\)</span> is a collection and <span class="math inline">\(p\)</span> a data aggregation path, optionally followed by a type-cast segment, the result of such a path evaluation is denoted by <span class="math inline">\(\Gamma(A,p)\)</span> and defined as the unordered concatenation, possibly containing repetitions, of the collections <span class="math inline">\(γ(u,p)\)</span> for each <span class="math inline">\(u\)</span> in <span class="math inline">\(A\)</span> that is not null. The function <span class="math inline">\(γ(u,p)\)</span> takes a non-null value and a path as arguments and returns a collection of instances of structured types or primitive values, depending on the type of the final segment of <span class="math inline">\(p\)</span>. It is recursively defined as follows:</p>
<ol type="1">
<li>If <span class="math inline">\(p\)</span> is an empty path, let <span class="math inline">\(B\)</span> be a collection with <span class="math inline">\(u\)</span> as its single member and continue with step 9.</li>
<li>Let <span class="math inline">\(p_1\)</span> be the first segment of <span class="math inline">\(p\)</span> and <span class="math inline">\(p_2\)</span> the remainder, if any, such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(p_1/p_2\)</span>.</li>
<li>If <span class="math inline">\(p_1\)</span> is a type-cast segment and <span class="math inline">\(u\)</span> is of its type or a subtype thereof, let <span class="math inline">\(v=u\)</span> and continue with step 8.</li>
<li>If <span class="math inline">\(p_1\)</span> is a type-cast segment and <span class="math inline">\(u\)</span> is not of its type or a subtype thereof, let <span class="math inline">\(B\)</span> be an empty collection and continue with step 9. (This rule follows <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#AddressingDerivedTypes">OData-URL, section 4.11</a> rather than <a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.02/odata-csdl-json-v4.02.html#PathSyntax">OData-CSDL, section 14.4.1.1</a>.)</li>
<li>Otherwise, <span class="math inline">\(p_1\)</span> is a non-type-cast segment. If <span class="math inline">\(u\)</span> does not contain a structural or navigation property <span class="math inline">\(p_1\)</span>, let <span class="math inline">\(B\)</span> be an empty collection and continue with step 9.</li>
<li>If <span class="math inline">\(p_1\)</span> is single-valued, let <span class="math inline">\(v\)</span> be the value of the structural or navigation property <span class="math inline">\(p_1\)</span> in <span class="math inline">\(u\)</span>. If <span class="math inline">\(v\)</span> is null, let <span class="math inline">\(B\)</span> be an empty collection and continue with step 9; otherwise continue with step 8.</li>
<li>Otherwise, <span class="math inline">\(p_1\)</span> is collection-valued. Let <span class="math inline">\(C\)</span> be the collection addressed by the structural or navigation property <span class="math inline">\(p_1\)</span> in <span class="math inline">\(u\)</span>, and let <span class="math inline">\(B=\Gamma(C,p_2)\)</span>. Then continue with step 9.</li>
<li>Let <span class="math inline">\(B=γ(v,p_2)\)</span>.</li>
<li>Return <span class="math inline">\(B\)</span>.</li>
</ol>
<p>This notation is extended to the case of an empty path <span class="math inline">\(e\)</span> by setting <span class="math inline">\(\Gamma(A,e)=A\)</span> with null values removed. Note the collections returned by <span class="math inline">\(\Gamma\)</span> and <span class="math inline">\(γ\)</span> never contain the null value. Also, every instance <span class="math inline">\(u\)</span> in <span class="math inline">\(\Gamma(A,p)\)</span> occurs also in <span class="math inline">\(A\)</span> or nested into <span class="math inline">\(A\)</span>, therefore an algorithmic step like “Add a dynamic property to each <span class="math inline">\(u\)</span> in <span class="math inline">\(\Gamma(A,p)\)</span>” effectively changes <span class="math inline">\(A\)</span>.</p>
</details>
</details>
<details open><summary>
<h2 id="32-basic-aggregation"><a id="BasicAggregation" href="#BasicAggregation">3.2 Basic Aggregation</a></h2>
</summary>
<details open><summary>
<h3 id="321-transformation-aggregate"><a id="Transformationaggregate" href="#Transformationaggregate">3.2.1 Transformation <code>aggregate</code></a></h3>
</summary>
<details open><summary>
<h4 id="3211-aggregation-algorithm"><a id="AggregationAlgorithm" href="#AggregationAlgorithm">3.2.1.1 Aggregation Algorithm</a></h4>
</summary>
<p>The <code>aggregate</code> transformation takes a comma-separated list of one or more <a href="#AggregateExpression"><em>aggregate expressions</em></a> as parameters and returns an output set with a single instance of the <a href="#TypeStructureandContextURL">input type</a> without entity-id containing one property per aggregate expression, representing the aggregated value of the input set.</p>
<p>An aggregate expression MUST have one of the types listed below. To compute the value of the property for a given aggregate expression, the <code>aggregate</code> transformation first determines a collection <span class="math inline">\(A\)</span> of instances of structured types or primitive values, based on the input set of the <code>aggregate</code> transformation, and a path <span class="math inline">\(p\)</span> that occurs in the aggregate expression. Let <span class="math inline">\(p_1\)</span> denote a <a href="#DataAggregationPath">data aggregation path</a> with single- or collection-valued segments and <span class="math inline">\(p_2\)</span> a type-cast segment. Depending on its type, the aggregate expression contains a path <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_2\)</span> or <span class="math inline">\(p=p_1/p_2\)</span>. Each type of aggregate expression defines a function <span class="math inline">\(f(A)\)</span> which the aggregate transformation evaluates to obtain the property value.</p>
<p>The property is a dynamic property, except for a special case in type 4. In types 1 and 2, the aggregate expression MUST end with the keyword <code>with</code> and an aggregation method <span class="math inline">\(g\)</span>. The aggregation method also determines the type of the dynamic property. In types 1, 2, and 3 the aggregate expression MUST, and in type 4 it MAY, be followed by the keyword <a href="#Keywordas"><code>as</code></a> and an <a href="#TypeStructureandContextURL">alias</a>, which is then the name of the dynamic property.</p>
<p><em>Types of aggregate expressions:</em></p>
<ol type="1">
<li>A path <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_1/p_2\)</span> where the last segment of <span class="math inline">\(p_1\)</span> has a complex or entity or <a href="#AggregatablePrimitiveType">aggregatable primitive type</a> whose values can be aggregated using the specified <a href="#AggregationMethods">aggregation method</a> <span class="math inline">\(g\)</span>, or <span class="math inline">\(p=p_2\)</span> if the input set can be aggregated using the <a href="#CustomAggregationMethods">custom aggregation method</a> <span class="math inline">\(g\)</span>.<br />
Let <span class="math inline">\(f(A)=g(A)\)</span>.</li>
<li>An <a href="#AggregatableExpression">aggregatable expression</a> whose values can be aggregated using the specified <a href="#AggregationMethods">aggregation method</a> <span class="math inline">\(g\)</span>.<br />
Let <span class="math inline">\(f(A)=g(B)\)</span> where <span class="math inline">\(B\)</span> is the collection consisting of the values of the aggregatable expression evaluated relative to <a href="#SamenessandOrder">each occurrence</a> in <span class="math inline">\(A\)</span> with null values removed from <span class="math inline">\(B\)</span>. In this type, <span class="math inline">\(p\)</span> is absent.</li>
<li>A path <span class="math inline">\(p/{\tt\$count}\)</span> (see <a href="#AggregateExpressioncount">section 3.2.1.4</a>) with optional prefix <span class="math inline">\(p/{}\)</span> where <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_2\)</span> or <span class="math inline">\(p=p_1/p_2\)</span>.<br />
Let <span class="math inline">\(f(A)\)</span> be the <a href="#SamenessandOrder">cardinality</a> of <span class="math inline">\(A\)</span>.</li>
<li>A path <span class="math inline">\(p/c\)</span> consisting of an optional prefix <span class="math inline">\(p/{}\)</span> with <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_1/p_2\)</span> where the last segment of <span class="math inline">\(p_1\)</span> has a structured type or <span class="math inline">\(p=p_2\)</span>, and a <a href="#CustomAggregates">custom aggregate</a> <span class="math inline">\(c\)</span> defined on the collection addressed by <span class="math inline">\(p\)</span>.<br />
Let <span class="math inline">\(f(A)=c(A)\)</span>. If computation of the custom aggregate fails, the service MUST reject the request. In the absence of an alias:
<ul>
<li>The name of the property is the name of the custom aggregate.</li>
<li>The property is a dynamic property whose type is determined by the custom aggregate, unless there is a declared property with that name. The latter case is allowed by the <code>CustomAggregate</code> annotation.</li>
</ul></li>
</ol>
<p><em>Determination of <span class="math inline">\(A\)</span>:</em></p>
<p>Let <span class="math inline">\(I\)</span> be the input set. If <span class="math inline">\(p\)</span> is absent, let <span class="math inline">\(A=I\)</span> with null values removed.</p>
<p>Otherwise, let <span class="math inline">\(q\)</span> be the portion of <span class="math inline">\(p\)</span> up to and including the last navigation property, if any, and any type-cast segment that immediately follows, and let <span class="math inline">\(r\)</span> be the remainder, if any, of <span class="math inline">\(p\)</span> that contains no navigation properties, such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(q⁄r\)</span>. The aggregate transformation considers each entity reached via the path <span class="math inline">\(q\)</span> exactly once. To this end, using the <a href="#EvaluationofDataAggregationPaths"><span class="math inline">\(\Gamma\)</span> notation</a>:</p>
<ul>
<li>If <span class="math inline">\(q\)</span> is non-empty, let <span class="math inline">\(E=\Gamma(I,q)\)</span> and remove duplicates from that entity collection: If <a href="#SamenessandOrder">multiple representations of the same non-transient entity</a> are reached, the service MUST merge them into one occurrence in <span class="math inline">\(E\)</span> if they are complementary and MUST reject the request if they are contradictory. If <a href="#SamenessandOrder">multiple occurrences of the same transient entity</a> are reached, the service MUST keep only one occurrence in <span class="math inline">\(E\)</span>.</li>
<li>If <span class="math inline">\(q\)</span> is empty, let <span class="math inline">\(E=I\)</span>.</li>
</ul>
<p>Then, if <span class="math inline">\(r\)</span> is empty, let <span class="math inline">\(A=E\)</span>, otherwise let <span class="math inline">\(A=\Gamma(E,r)\)</span>, this consists of instances of structured types or primitive values, possibly with repetitions.</p>
</details>
<details open><summary>
<h4 id="3212-keyword-as"><a id="Keywordas" href="#Keywordas">3.2.1.2 Keyword <code>as</code></a></h4>
</summary>
<p>Aggregate expressions can be followed by the <code>as</code> keyword followed by an <a href="#TypeStructureandContextURL">alias</a>.</p>
<div class="example">
<p>Example 7:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum as Total,
                                    Amount with max as MxA)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total, MxA)&quot;</span><span class="fu">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">24</span><span class="fu">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MxA@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;MxA&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example <a id="aggrmul" href="#aggrmul">8</a>:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount mul Product/TaxRate
                                    with sum as Tax)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Tax)&quot;</span><span class="fu">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="fl">2.08</span> <span class="fu">}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>An alias affects the structure of the output set: each alias corresponds to a dynamic property in a <code>$select</code> option.</p>
</details>
<details open><summary>
<h4 id="3213-aggregation-methods"><a id="AggregationMethods" href="#AggregationMethods">3.2.1.3 Aggregation Methods</a></h4>
</summary>
<p>Values can be aggregated using the standard aggregation methods <a href="#StandardAggregationMethodsum"><code>sum</code></a>, <a href="#StandardAggregationMethodmin"><code>min</code></a>, <a href="#StandardAggregationMethodmax"><code>max</code></a>, <a href="#StandardAggregationMethodaverage"><code>average</code></a>, and <a href="#StandardAggregationMethodcountdistinct"><code>countdistinct</code></a>, or with <a href="#CustomAggregationMethods">custom aggregation methods</a> defined by the service. Only types 1 and 2 of the <a href="#AggregationAlgorithm">aggregation algorithm</a> involve aggregation methods, and the algorithm ensures that no null values occur among the values to be aggregated.</p>
<details open><summary>
<h5 id="32131-standard-aggregation-method-sum"><a id="StandardAggregationMethodsum" href="#StandardAggregationMethodsum">3.2.1.3.1 Standard Aggregation Method <code>sum</code></a></h5>
</summary>
<p>The standard aggregation method <code>sum</code> can be applied to numeric values to return the sum of the values, or null if there are no values to be aggregated. The provider MUST choose a single type for the property across all instances of that type in the result that is capable of representing the aggregated values. This may require a larger integer type, <code>Edm.Decimal</code> with sufficient <code>Precision</code> and <code>Scale</code>, or <code>Edm.Double</code>.</p>
<div class="example">
<p>Example 9:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum as Total)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">24</span> <span class="fu">}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h5 id="32132-standard-aggregation-method-min"><a id="StandardAggregationMethodmin" href="#StandardAggregationMethodmin">3.2.1.3.2 Standard Aggregation Method <code>min</code></a></h5>
</summary>
<p>The standard aggregation method <code>min</code> can be applied to values with a totally ordered domain to return the smallest of the values, or null if there are no values to be aggregated.</p>
<p>The result property will have the same type as the input property.</p>
<div class="example">
<p>Example 10:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with min as MinAmount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(MinAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;MinAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;MinAmount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h5 id="32133-standard-aggregation-method-max"><a id="StandardAggregationMethodmax" href="#StandardAggregationMethodmax">3.2.1.3.3 Standard Aggregation Method <code>max</code></a></h5>
</summary>
<p>The standard aggregation method <code>max</code> can be applied to values with a totally ordered domain to return the largest of the values, or null if there are no values to be aggregated.</p>
<p>The result property will have the same type as the input property.</p>
<div class="example">
<p>Example 11:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with max as MaxAmount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(MaxAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;MaxAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;MaxAmount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h5 id="32134-standard-aggregation-method-average"><a id="StandardAggregationMethodaverage" href="#StandardAggregationMethodaverage">3.2.1.3.4 Standard Aggregation Method <code>average</code></a></h5>
</summary>
<p>The standard aggregation method <code>average</code> can be applied to numeric values to return the sum of the values divided by the count of the values, or null if there are no values to be aggregated.</p>
<p>The provider MUST choose a single type for the property across all instances of that type in the result that is capable of representing the aggregated values; either <code>Edm.Double</code> or <code>Edm.Decimal</code> with sufficient <code>Precision</code> and <code>Scale</code>.</p>
<div class="example">
<p>Example 12:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with average as AverageAmount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(AverageAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;AverageAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;AverageAmount&quot;</span><span class="fu">:</span> <span class="fl">3.0</span> <span class="fu">}</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h5 id="32135-standard-aggregation-method-countdistinct"><a id="StandardAggregationMethodcountdistinct" href="#StandardAggregationMethodcountdistinct">3.2.1.3.5 Standard Aggregation Method <code>countdistinct</code></a></h5>
</summary>
<p>The aggregation method <code>countdistinct</code> can be applied to arbitrary collections to count the distinct values. Instance comparison uses the definition of equality in <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#Equals">OData-URL, section 5.1.1.1.1</a>.</p>
<p>The result property MUST have type <code>Edm.Decimal</code> with <code>Scale</code> 0 and sufficient <code>Precision</code>.</p>
<div class="example">
<p>Example 13:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Product with countdistinct
                                    as DistinctProducts)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(DistinctProducts)&quot;</span><span class="fu">,</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;DistinctProducts@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;DistinctProducts&quot;</span><span class="fu">:</span> <span class="dv">3</span> <span class="fu">}</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The number of instances in the input set can be counted with the <a href="#AggregateExpressioncount">aggregate expression <code>$count</code></a>.</p>
</details>
<details open><summary>
<h5 id="32136-custom-aggregation-methods"><a id="CustomAggregationMethods" href="#CustomAggregationMethods">3.2.1.3.6 Custom Aggregation Methods</a></h5>
</summary>
<p>Services can define custom aggregation methods if the functionality offered by the standard aggregation methods is not sufficient for the intended consumers.</p>
<p>Custom aggregation methods MUST use a namespace-qualified name (see <a href="#ODataABNF">OData-ABNF</a>), i.e. contain at least one dot. Dot-less names are reserved for future versions of this specification.</p>
<div class="example">
<p>⚠ Example 14: custom aggregation method that concatenates distinct string values separated by commas</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                   aggregate(Amount with sum as Total,
                             Product/Name with Custom.concat as ProductNames))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total,ProductNames)&quot;</span><span class="fu">,</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductNames&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper,Sugar&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductNames&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee,Paper,Sugar&quot;</span> <span class="fu">}</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
</details>
<details open><summary>
<h4 id="3214-aggregate-expression-count"><a id="AggregateExpressioncount" href="#AggregateExpressioncount">3.2.1.4 Aggregate Expression <code>$count</code></a></h4>
</summary>
<p>The aggregate expression <code>$count</code> is defined as type 3 in the <a href="#AggregationAlgorithm">aggregation algorithm</a>. It MUST always specify an <a href="#TypeStructureandContextURL">alias</a> and MUST NOT specify an <a href="#AggregationMethods">aggregation method</a>.</p>
<p>The result property MUST have type <code>Edm.Decimal</code> with <code>Scale</code> 0 and sufficient <code>Precision</code>.</p>
<div class="example">
<p>Example 15:</p>
<pre><code>GET /service/Sales?$apply=aggregate($count as SalesCount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesCount)&quot;</span><span class="fu">,</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
</details>
<details open><summary>
<h3 id="322-transformation-concat"><a id="Transformationconcat" href="#Transformationconcat">3.2.2 Transformation <code>concat</code></a></h3>
</summary>
<p>The <code>concat</code> transformation takes two or more parameters, each of which is a sequence of set transformations.</p>
<p>It applies each transformation sequence to the input set and concatenates the intermediate output sets in the order of the parameters into the output set, preserving the ordering of the individual output sets as well as the structure of each instance in these sets, potentially leading to a non-homogeneously structured output set. If different intermediate output sets contain dynamic properties with the same alias, clients SHOULD ensure they have the same type and meaning in each intermediate output set.</p>
<div class="example">
<p>⚠ Example 16:</p>
<pre><code>GET /service/Sales?$apply=concat(topcount(2,Amount),
                                 aggregate(Amount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Amount)&quot;</span><span class="fu">,</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">24</span> <span class="fu">}</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that two Sales entities with the second highest amount 4 exist in the input set; the entity with <code>ID</code> 3 is included in the result, because the service chose to use the <code>ID</code> property for imposing a stable ordering.</p>
</div>
</details>
<details open><summary>
<h3 id="323-transformation-groupby"><a id="Transformationgroupby" href="#Transformationgroupby">3.2.3 Transformation <code>groupby</code></a></h3>
</summary>
<p>The <code>groupby</code> transformation takes one or two parameters where the second is a list of set transformations, separated by forward slashes to express that they are consecutively applied. If the second parameter is not specified, it defaults to a single transformation whose output set consists of a single instance of the <a href="#TypeStructureandContextURL">input type</a> without properties and without entity-id.</p>
<p>The <code>groupby</code> transformation partitions the input set by the values of certain “grouping properties” and applies the given set transformations to each partition, this is called “simple grouping”.</p>
<details open><summary>
<h4 id="3231-simple-grouping"><a id="SimpleGrouping" href="#SimpleGrouping">3.2.3.1 Simple Grouping</a></h4>
</summary>
<p>The first parameter of <code>groupby</code> specifies the <em>grouping properties</em>, a comma-separated parenthesized list <span class="math inline">\(G\)</span> of one or more <a href="#DataAggregationPath">data aggregation paths</a> with single-valued segments. The same path SHOULD NOT appear more than once; redundant property paths MAY be considered valid, but MUST NOT alter the meaning of the request. Navigation properties and stream properties specified in grouping properties are expanded by default (see <a href="#groupbynav">example 63</a>).</p>
<p>The algorithmic description of this transformation makes use of the following definitions: Let <span class="math inline">\(u[q]\)</span> denote the value of a structural or navigation property <span class="math inline">\(q\)</span> in an instance <span class="math inline">\(u\)</span>. A path <span class="math inline">\(p_1\)</span> is called a <em>prefix</em> of a path <span class="math inline">\(p\)</span> if there is a non-empty path <span class="math inline">\(p_2\)</span> such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(p_1/p_2\)</span>. Let <span class="math inline">\(e\)</span> denote the empty path.</p>
<p>The output set of the <code>groupby</code> transformation is constructed in five steps.</p>
<ol type="1">
<li><a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(u\)</span> in the input set, a projection is computed that contains only the grouping properties. This projection is <span class="math inline">\(s_G(u,e)\)</span> and the function <span class="math inline">\(s_G(u,p)\)</span> takes an instance and a path relative to the input set as arguments and is computed recursively as follows:
<ul>
<li>Let <span class="math inline">\(v\)</span> be an instance of the type of <span class="math inline">\(u\)</span> without properties and without entity-id.</li>
<li>For each structural or navigation property <span class="math inline">\(q\)</span> of <span class="math inline">\(u\)</span>:
<ul>
<li>If <span class="math inline">\(u\)</span> has a subtype of the type addressed by <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> is only declared on that subtype, let <span class="math inline">\(p&#39;=p/p&#39;&#39;/q\)</span> where <span class="math inline">\(p&#39;&#39;\)</span> is a type-cast to the subtype, otherwise let <span class="math inline">\(p&#39;=p/q\)</span>.</li>
<li>If <span class="math inline">\(p&#39;\)</span> occurs in <span class="math inline">\(G\)</span>, let <span class="math inline">\(v[q]=u[q]\)</span>.</li>
<li>Otherwise, if <span class="math inline">\(p&#39;\)</span> is a prefix of a path in <span class="math inline">\(G\)</span> and <span class="math inline">\(u[q]\)</span> has a structured type, let <span class="math inline">\(v[q]=s_G(u[q],p&#39;)\)</span>.</li>
</ul></li>
<li>Return <span class="math inline">\(v\)</span>.</li>
</ul></li>
<li>The input set is split into subsets where two instances are in the same subset if their projections are <a href="#SamenessandOrder">the same</a>. If <a href="#SamenessandOrder">representations of the same non-transient entity</a> are encountered during the comparison of two projections, the service MUST assign them to one subset with the merged representation if they are complementary and MUST reject the request if they are contradictory.</li>
<li>The set transformations from the second parameter are applied to each subset, resulting in a new set of potentially different structure and cardinality. Associated with each resulting set is the common projection of the instances in the subset from which the resulting set was computed.</li>
<li>Each set resulting from the previous step is transformed to contain the associated common projection <span class="math inline">\(s\)</span>. This transformation is denoted by <span class="math inline">\(\Pi_G(s)\)</span> and is defined below.</li>
<li>The output set is the concatenation of the transformed sets from the previous step. The order of occurrences from the same transformed set remains the same, and no order is defined between occurrences from different transformed sets.</li>
</ol>
<p><em>Definition of <span class="math inline">\(\Pi_G(s)\)</span>:</em></p>
<p><em>Prerequisites:</em> <span class="math inline">\(G\)</span> is a list of data aggregation paths and <span class="math inline">\(s\)</span> is an instance of the <a href="#TypeStructureandContextURL">input type</a>.</p>
<p>The output set of the transformation <span class="math inline">\(\Pi_G(s)\)</span> is in one-to-one correspondence with its input set via the <a href="#SamenessandOrder">order-preserving</a> mapping <span class="math inline">\(u↦a_G(u,s,e)\)</span>. The function <span class="math inline">\(a_G(u,s,p)\)</span> takes two instances and a path relative to the input set as arguments and is computed recursively as follows:</p>
<ol type="1">
<li>If necessary, cast <span class="math inline">\(u\)</span> to a subtype so that its type contains all structural and navigation properties of <span class="math inline">\(s\)</span>.</li>
<li>For each structural or navigation property <span class="math inline">\(q\)</span> of <span class="math inline">\(s\)</span>:
<ul>
<li>If <span class="math inline">\(s\)</span> has a subtype of the type addressed by <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> is only declared on that subtype, let <span class="math inline">\(p&#39;=p/p&#39;&#39;/q\)</span> where <span class="math inline">\(p&#39;&#39;\)</span> is a type-cast to the subtype, otherwise let <span class="math inline">\(p&#39;=p/q\)</span>.</li>
<li>If <span class="math inline">\(q\)</span> is a single-valued primitive structural property or <span class="math inline">\(p&#39;\)</span> occurs in <span class="math inline">\(G\)</span>, let <span class="math inline">\(u[q]=s[q]\)</span>. (In the case where <span class="math inline">\(p&#39;\)</span> occurs in <span class="math inline">\(G\)</span> we also call <span class="math inline">\(q\)</span> a <em>final segment from <span class="math inline">\(G\)</span></em>.)</li>
<li>Otherwise, if <span class="math inline">\(q\)</span> is single-valued, let <span class="math inline">\(u[q]=a_G(u[q],s[q],p&#39;)\)</span>.</li>
<li>Otherwise, the behavior is undefined. (Such cases never occur when <span class="math inline">\(\Pi_G(s)\)</span> is used in this document.)</li>
</ul></li>
<li>Return <span class="math inline">\(u\)</span>.</li>
</ol>
<div class="example">
<p>Example 17:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country,Product/Name),
                                  aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>If the second parameter is omitted, steps 2 and 3 above produce one instance containing only the grouping properties per distinct value combination.</p>
<div class="example">
<p>⚠ Example 18:</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/Name,Amount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Product(Name),Amount)&quot;</span><span class="fu">,</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that the result has the same structure, but not the same content as</p>
<pre><code>GET /service/Sales?$expand=Product($select=Name)&amp;$select=Amount</code></pre>
</div>
<p>A <code>groupby</code> transformation affects the structure of the output set similar to <code>$select</code> where each grouping property corresponds to an item in a <code>$select</code> clause.</p>
</details>
</details>
</details>
<details open><summary>
<h2 id="33-transformations-producing-a-subset"><a id="TransformationsProducingaSubset" href="#TransformationsProducingaSubset">3.3 Transformations Producing a Subset</a></h2>
</summary>
<p>These transformations produce an output set that is a subset of their input set, possibly in a different order. Some of the algorithmic descriptions below make use of the following definition: A total order of a collection is called <em>stable across requests</em> if it is the same for all requests that construct the collection by executing the same resource path and transformations, possibly nested, on the same underlying data.</p>
<div class="example">
<p>⚠ Example 19: A stable total order is required for the input set of a <a href="#Transformationskip"><code>skip</code></a> transformation. The following request constructs that input set by executing the <code>groupby</code> transformation on the <code>Sales</code> entity collection, computing the total sales per customer. Because of the subsequent <code>skip</code> transformation, the service must endow this with a stable total order. Then the request divides the total sales per customer into pages of <span class="math inline">\(N\)</span> customers and returns page number <span class="math inline">\(i\)</span> in a reproducible manner (as long as the underlying data do not change).</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Customer),aggregate(Amount with sum as Total))
  /skip(M)/top(N)</code></pre>
<p>where the number in <code>skip</code> is <span class="math inline">\(M=(i-1)⋅N\)</span>. Other values of <span class="math inline">\(M\)</span> can be used to skip, for example, half a page.</p>
</div>
<details open><summary>
<h3 id="331-topbottom-transformations"><a id="Topbottomtransformations" href="#Topbottomtransformations">3.3.1 Top/bottom transformations</a></h3>
</summary>
<p>These transformations take two parameters. The first parameter MUST be an <a href="#Expression">expression</a> that is <a href="#ExpressionsEvaluableonaCollection">evaluable on the input set as a collection</a>, without reference to an individual instance (and which therefore cannot be a property path). The second parameter MUST be an expression that is evaluated on each instance of the input set in turn.</p>
<p>The output set is constructed as follows:</p>
<ol type="1">
<li>Let <span class="math inline">\(A\)</span> be a copy of the input set with a total order that is chosen by the service (it need not preserve any existing order). The total order MUST be stable across requests. (This is the order of the eventual output set of this transformation.)</li>
<li>Let <span class="math inline">\(B\)</span> be a copy of <span class="math inline">\(A\)</span> that is <a href="#SamenessandOrder">stable-sorted</a> in ascending (for transformations starting with <code>bottom</code>) or descending (for transformations starting with <code>top</code>) order of the value specified in the second parameter. (This is the order in which contributions to the output set are considered.)</li>
<li>Start with an empty output set.</li>
<li>Loop over <span class="math inline">\(B\)</span> in its total order.</li>
<li>Exit the loop if a condition is met. This condition depends on the transformation being executed and is given in the subsections below.</li>
<li>Insert the current item of the loop into the output set in the order of <span class="math inline">\(A\)</span>.</li>
<li>Continue the loop.</li>
</ol>
<p>For example, if the input set consists of non-transient entities and the datastore contains an index ordered by the second parameter and then the entity-id, a service may implement this algorithm with <span class="math inline">\(A=B\)</span> ordered like this index.</p>
<p>The order of the output set can be influenced with a subsequent <a href="#Transformationorderby"><code>orderby</code></a> transformation.</p>
<details open><summary>
<h4 id="3311-transformations-bottomcount-and-topcount"><a id="Transformationsbottomcountandtopcount" href="#Transformationsbottomcountandtopcount">3.3.1.1 Transformations <code>bottomcount</code> and <code>topcount</code></a></h4>
</summary>
<p>The first parameter MUST evaluate to a positive integer <span class="math inline">\(c\)</span>. The second parameter MUST evaluate to a primitive type whose values are totally ordered. In step 5, exit the loop if the cardinality of the output set equals <span class="math inline">\(c\)</span>.</p>
<div class="example">
<p>Example 20:</p>
<pre><code>GET /service/Sales?$apply=bottomcount(2,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 21:</p>
<pre><code>GET /service/Sales?$apply=topcount(2,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that two <code>Sales</code> entities with the second highest amount 4 exist in the input set; the entity with <code>ID</code> 3 is included in the result, because the service chose to use the <code>ID</code> property for imposing a stable ordering in step 1. Such a logic needs to be in place even with a preceding <code>orderby</code> since it cannot be ensured that it creates a stable order of the instances on the expressions of the second parameter.</p>
</div>
</details>
<details open><summary>
<h4 id="3312-transformations-bottompercent-and-toppercent"><a id="Transformationsbottompercentandtoppercent" href="#Transformationsbottompercentandtoppercent">3.3.1.2 Transformations <code>bottompercent</code> and <code>toppercent</code></a></h4>
</summary>
<p>The first parameter MUST evaluate to a positive number <span class="math inline">\(p\)</span> less than or equal to 100. The second parameter MUST evaluate to a number. In step 5, exit the loop if the ratio of the sum of the numbers addressed by the second parameter in the output set to their sum in the input set equals or exceeds <span class="math inline">\(p\)</span> percent.</p>
<div class="example">
<p>Example 22:</p>
<pre><code>GET /service/Sales?$apply=bottompercent(50,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 23:</p>
<pre><code>GET /service/Sales?$apply=toppercent(50,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h4 id="3313-transformations-bottomsum-and-topsum"><a id="Transformationsbottomsumandtopsum" href="#Transformationsbottomsumandtopsum">3.3.1.3 Transformations <code>bottomsum</code> and <code>topsum</code></a></h4>
</summary>
<p>The first parameter MUST evaluate to a number <span class="math inline">\(s\)</span>. The second parameter MUST be an <a href="#AggregatableExpression">aggregatable expression</a> that evaluates to a number. In step 5, exit the loop if the sum of the numbers addressed by the second parameter in the output set is greater than or equal to <span class="math inline">\(s\)</span>.</p>
<div class="example">
<p>Example 24:</p>
<pre><code>GET /service/Sales?$apply=bottomsum(7,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 25:</p>
<pre><code>GET /service/Sales?$apply=topsum(15,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
</details>
<details open><summary>
<h3 id="332-transformation-filter"><a id="Transformationfilter" href="#Transformationfilter">3.3.2 Transformation <code>filter</code></a></h3>
</summary>
<p>The <code>filter</code> transformation takes a Boolean expression that could also be passed as a <code>$filter</code> system query option. Its output set is the subset of the input set containing all instances (possibly with repetitions) for which this expression, evaluated relative to the instance, yields true. No order is defined on the output set.</p>
<div class="example">
<p>Example 26:</p>
<pre><code>GET /service/Sales?$apply=filter(Amount gt 3)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h3 id="333-transformation-orderby"><a id="Transformationorderby" href="#Transformationorderby">3.3.3 Transformation <code>orderby</code></a></h3>
</summary>
<p>The <code>orderby</code> transformation takes a list of expressions that could also be passed as a <code>$orderby</code> system query option. Its output set consists of the instances of the input set in the same order <code>$orderby</code> would produce for the given expressions, but keeping the relative order from the input set if the given expressions do not distinguish between two instances. The orderby transformation thereby performs a <a href="#SamenessandOrder">stable-sort</a>. A service supporting this transformation MUST at least offer sorting by values addressed by property paths, including dynamic properties, with both suffixes <code>asc</code> and <code>desc</code>.</p>
<div class="example">
<p>Example 27:</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/Name),
                           aggregate(Amount with sum as Total))
                   /orderby(Total desc)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h3 id="334-transformation-search"><a id="Transformationsearch" href="#Transformationsearch">3.3.4 Transformation <code>search</code></a></h3>
</summary>
<p>The <code>search</code> transformation takes a search expression that could also be passed as a <code>$search</code> system query option. Its output set is the subset of the input set containing all instances (possibly with repetitions) that match this search expression. Closing parentheses in search expressions must be within single or double quotes in order to avoid syntax errors like <code>search())</code>. No order is defined on the output set.</p>
<div class="example">
<p>Example 28: assuming that free-text search on <code>Sales</code> takes the related product name into account,</p>
<pre><code>GET /service/Sales?$apply=search(coffee)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h3 id="335-transformation-skip"><a id="Transformationskip" href="#Transformationskip">3.3.5 Transformation <code>skip</code></a></h3>
</summary>
<p>The <code>skip</code> transformation takes a non-negative integer <span class="math inline">\(c\)</span> as argument. Let <span class="math inline">\(A\)</span> be a copy of the input set with a total order that extends any existing order of the input set but is otherwise chosen by the service. The total order MUST be stable across requests.</p>
<p>The transformation excludes from the output set the first <span class="math inline">\(c\)</span> occurrences in <span class="math inline">\(A\)</span>. It keeps all remaining instances in the same order as they occur in <span class="math inline">\(A\)</span>.</p>
<div class="example">
<p>Example 29:</p>
<pre><code>GET /service/Sales?$apply=orderby(Customer/Name desc)/skip(2)/top(2)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h3 id="336-transformation-top"><a id="Transformationtop" href="#Transformationtop">3.3.6 Transformation <code>top</code></a></h3>
</summary>
<p>The <code>top</code> transformation takes a non-negative integer <span class="math inline">\(c\)</span> as argument. Let <span class="math inline">\(A\)</span> be a copy of the input set with a total order that extends any existing order of the input set but is otherwise chosen by the service. The total order MUST be stable across requests.</p>
<p>If <span class="math inline">\(A\)</span> contains more than <span class="math inline">\(c\)</span> instances, the output set consists of the first <span class="math inline">\(c\)</span> occurrences in <span class="math inline">\(A\)</span>. Otherwise, the output set equals <span class="math inline">\(A\)</span>. The instances in the output set are in the same order as they occur in <span class="math inline">\(A\)</span>.</p>
<p>Note the transformation <code>top(0)</code> produces an empty output set.</p>
<div class="example">
<p>Example 30:</p>
<pre><code>GET /service/Sales?$apply=orderby(Customer/Name desc)/top(2)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h3 id="337-stable-total-order-before-skip-and-top"><a id="StableTotalOrderBeforeskipandtop" href="#StableTotalOrderBeforeskipandtop">3.3.7 Stable Total Order Before <code>$skip</code> and <code>$top</code></a></h3>
</summary>
<p>When the system query options <code>$top</code> and <code>$skip</code> <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#SystemQueryOptiontop">OData-Protocol, section 11.2.6.3</a> are executed after the system query option <code>$apply</code> and after <code>$filter</code> and <code>$orderby</code>, if applicable, they operate on a collection with a total order that extends any existing order but is otherwise chosen by the service. The total order MUST be stable across requests.</p>
</details>
</details>
<details open><summary>
<h2 id="34-one-to-one-transformations"><a id="OnetoOneTransformations" href="#OnetoOneTransformations">3.4 One-to-One Transformations</a></h2>
</summary>
<p>These transformations produce an output set in one-to-one correspondence with their input set. The output set is initially a clone of the input set, then dynamic properties are added to the output set. The values of properties copied from the input set are not changed, nor is the order of instances changed.</p>
<details open><summary>
<h3 id="341-transformation-identity"><a id="Transformationidentity" href="#Transformationidentity">3.4.1 Transformation <code>identity</code></a></h3>
</summary>
<p>The output set of the <code>identity</code> transformation is its input set in unchanged order.</p>
<div class="example">
<p>Example 31: Add a grand total row to the <code>Sales</code> result set</p>
<pre><code>GET /service/Sales?$apply=concat(identity,aggregate(Amount with sum as Total))</code></pre>
</div>
</details>
<details open><summary>
<h3 id="342-transformation-compute"><a id="Transformationcompute" href="#Transformationcompute">3.4.2 Transformation <code>compute</code></a></h3>
</summary>
<p>The <code>compute</code> transformation takes a comma-separated list of one or more <em>compute expressions</em> as parameters.</p>
<p>A compute expression is a common expression followed by the <code>as</code> keyword, followed by an <a href="#TypeStructureandContextURL">alias</a>.</p>
<p>The output set is constructed by copying the instances of the input set and adding one dynamic property per compute expression to <a href="#SamenessandOrder">each occurrence</a> in the output set. The name of each added dynamic property is the alias of the corresponding compute expression. The value of each added dynamic property is computed relative to the corresponding instance. Services MAY support expressions that address dynamic properties added by other expressions within the same <code>compute</code> transformation, provided that the service can determine an evaluation sequence. The type of the property is determined by the rules for evaluating common expressions and numeric promotion defined in <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#CommonExpressionSyntax">OData-URL, section 5.1.1</a>.</p>
<div class="example">
<p>Example 32:</p>
<pre><code>GET /service/Sales?$apply=compute(Amount mul Product/TaxRate as Tax)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(*,Tax)&quot;</span><span class="fu">,</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">24</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">48</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">56</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">28</span> <span class="fu">}</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
</details>
<details open><summary>
<h2 id="35-transformations-changing-the-input-set-structure"><a id="TransformationsChangingtheInputSetStructure" href="#TransformationsChangingtheInputSetStructure">3.5 Transformations Changing the Input Set Structure</a></h2>
</summary>
<p>The output set of the <a href="#Transformationsjoinandouterjoin">join</a> transformations differs from their input set in the number of instances as well as in their structure, but reflects the order of the input set.</p>
<details open><summary>
<h3 id="351-transformations-join-and-outerjoin"><a id="Transformationsjoinandouterjoin" href="#Transformationsjoinandouterjoin">3.5.1 Transformations <code>join</code> and <code>outerjoin</code></a></h3>
</summary>
<p>The <code>join</code> and <code>outerjoin</code> transformations take as their first parameter <span class="math inline">\(p\)</span> a collection-valued complex or navigation property, optionally followed by a type-cast segment to address only instances of that derived type or one of its sub-types, followed by the <code>as</code> keyword, followed by an <a href="#TypeStructureandContextURL">alias</a>. The optional second parameter specifies a transformation sequence <span class="math inline">\(T\)</span>.</p>
<p><a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(u\)</span> in an <a href="#SamenessandOrder">order-preserving loop</a> over the input set</p>
<ol type="1">
<li>the instance collection <span class="math inline">\(A\)</span> addressed by <span class="math inline">\(p\)</span> is identified.</li>
<li>If <span class="math inline">\(T\)</span> is provided, <span class="math inline">\(A\)</span> is replaced with the result of applying <span class="math inline">\(T\)</span> to <span class="math inline">\(A\)</span>.</li>
<li>In case of an <code>outerjoin</code>, if <span class="math inline">\(A\)</span> is empty, a null instance is added to it.</li>
<li><a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(v\)</span> in an <a href="#SamenessandOrder">order-preserving loop</a> over <span class="math inline">\(A\)</span> an instance <span class="math inline">\(w\)</span> is appended to the output set of the transformation:
<ul>
<li>The instance <span class="math inline">\(w\)</span> is a clone of <span class="math inline">\(u\)</span> with an additional dynamic property whose name is the given alias and whose value is <span class="math inline">\(v\)</span>.</li>
<li>The dynamic property is a navigation property if <span class="math inline">\(p\)</span> is a collection-valued navigation property, otherwise it is a complex property.</li>
<li>The dynamic property carries as control information the context URL of <span class="math inline">\(v\)</span>.</li>
</ul></li>
</ol>
<div class="example">
<p>Example 33: all links between products and sales instances</p>
<pre><code>GET /service/Products?$apply=join(Sales as Sale)&amp;$select=ID&amp;$expand=Sale</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(ID,Sale())&quot;</span><span class="fu">,</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>In this example, <code>$expand=Sale</code> is used to include the target entities in the result. There are no subsequent transformations like <code>groupby</code> that would cause it to be expanded by default. If the first parameter <code>Sales</code> was a collection-valued complex property of type <code>SalesModel.SalesComplexType</code>, the complex property <code>Sale</code> would be in the result regardless, and its context would be <code>"@context": "#SalesModel.SalesComplexType"</code>.</p>
<p>Applying <code>outerjoin</code> instead would return an additional instance for product with <code>"ID": "P4"</code> and <code>Sale</code> having a null value.</p>
</div>
</details>
</details>
<details open><summary>
<h2 id="36-expressions-evaluable-on-a-collection"><a id="ExpressionsEvaluableonaCollection" href="#ExpressionsEvaluableonaCollection">3.6 Expressions Evaluable on a Collection</a></h2>
</summary>
<p>The following two subsections introduce two new types of <a href="#Expression">expression</a> that are evaluated relative to a collection, called the input collection.</p>
<p>These expressions are</p>
<ul>
<li>either prepended with a collection-valued path <span class="math inline">\(p\)</span> followed by a forward slash, like a lambda operator <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#LambdaOperators">OData-URL, section 5.1.1.13</a>. The collection identified by that path is then the input collection for the expression.</li>
<li>or prepended with the keyword <code>$these</code> followed by a forward slash, the input collection is then the <em>current collection</em> defined as follows:
<ul>
<li>In a system query option other than <code>$apply</code>, possibly nested within <code>$expand</code> or <code>$select</code>, the current collection is the collection that is the subject of the system query option.</li>
<li>In a path segment that addresses a subset of a collection <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#AddressingaSubsetofaCollection">OData-URL, section 4.12</a>, the current collection is the collection that is the subject of the path segment.</li>
<li>In an <code>$apply</code> transformation, the current collection is the input set of the transformation.</li>
</ul></li>
</ul>
<details open><summary>
<h3 id="361-function-aggregate"><a id="Functionaggregate" href="#Functionaggregate">3.6.1 Function <code>aggregate</code></a></h3>
</summary>
<p>The <code>aggregate</code> function allows the use of aggregated values in <a href="#Expression">expressions</a>. It takes a single parameter accepting an <a href="#AggregateExpression">aggregate expression</a> and returns the aggregated value of type <code>Edm.PrimitiveType</code> as the result from applying the aggregate expression on its input collection.</p>
<p>More precisely, if <span class="math inline">\(α\)</span> is an aggregate expression, the function <span class="math inline">\(p/{\tt aggregate}(α)\)</span> or <span class="math inline">\({\tt\$these}/{\tt aggregate}(α)\)</span> evaluates to the value of the property <span class="math inline">\(D\)</span> in the single instance of the output set that is produced when the transformation <span class="math inline">\({\tt aggregate}(α{\tt\ as\ }D)\)</span> is applied with the input collection as input set.</p>
<div class="example">
<p>Example 34: Sales making up at least a third of the total sales amount.</p>
<pre><code>GET /service/Sales?$filter=Amount mul 3 ge $these/aggregate(Amount with sum)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 35: Products with more than 1.00 sales tax. The aggregate expression of type 2 combines paths with and without <code>$it</code> prefix (compare this with <a href="#aggrmul">example 8</a>).</p>
<pre><code>GET /service/Products?$filter=Sales/aggregate(Amount mul $it/TaxRate with sum)
                              gt 1</code></pre>
</div>
<div class="example">
<p>⚠ Example 36: products with a single sale of at least twice the average sales amount</p>
<pre><code>GET /service/Products?$filter=Sales/any(s:s/Amount ge
                              Sales/aggregate(Amount with average) mul 2)</code></pre>
<p>Both examples result in</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products&quot;</span><span class="fu">,</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h3 id="362-expression-count"><a id="Expressioncount" href="#Expressioncount">3.6.2 Expression <code>$count</code></a></h3>
</summary>
<p>The expression <code>$count</code> evaluates to the cardinality of the input collection.</p>
<div class="example">
<p>Example <a id="collexpr" href="#collexpr">37</a>: The input collection for <code>$count</code> consists of all sales entities, the top third of sales entities by amount form the result.</p>
<pre><code>GET /service/Sales?$apply=topcount($these/$count div 3,Amount)</code></pre>
<p>results in 2 (a third of 8, rounded down) entities. (This differs from <code>toppercent(33.3,Amount)</code>, which returns only the sales entity with <code>ID</code> 4, because that already makes up a third of the total amount.)</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>A definition that is equivalent to a <code>$count</code> expression after a collection-valued path was made in <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#AddressingtheCountofaCollection">OData-URL, section 4.8</a>.</p>
</details>
</details>
<details open><summary>
<h2 id="37-function-isdefined"><a id="Functionisdefined" href="#Functionisdefined">3.7 Function <code>isdefined</code></a></h2>
</summary>
<p>Properties that are not explicitly mentioned in <a href="#Transformationaggregate"><code>aggregate</code></a> or <a href="#Transformationgroupby"><code>groupby</code></a> are considered to have been <em>aggregated away</em>. Since they are treated as having the null value in <code>$filter</code> expressions <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#PathExpressions">OData-URL, section 5.1.1.15</a>, the <code>$filter</code> expression <code>Product eq null</code> cannot distinguish between an instance containing the value for the null product and the instance containing the aggregated value across all products (where the <code>Product</code> has been aggregated away).</p>
<p>The function <code>isdefined</code> can be used to determine whether a property is present or absent in an instance. It takes a <a href="#SingleValuedPropertyPath">single-valued property path</a> as its only parameter and returns true if the property is present in the instance for which the expression containing the <code>isdefined</code> function call is evaluated. A present property can still have the null value; it can represent a grouping of null values, or an aggregation that results in a null value.</p>
<div class="example">
<p>Example 38: <code>Product</code> has been aggregated away, causing an empty result</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum as Total)
           &amp;$filter=isdefined(Product)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[]</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="38-evaluating-apply-as-an-expand-and-select-option"><a id="EvaluatingapplyasanExpandandSelectOption" href="#EvaluatingapplyasanExpandandSelectOption">3.8 Evaluating <code>$apply</code> as an Expand and Select Option</a></h2>
</summary>
<p>The new system query option <code>$apply</code> can be used as an expand or select option to inline the result of aggregating related entities or nested instances. The rules for <a href="#SystemQueryOptionapply">evaluating <code>$apply</code></a> are applied in the context of the related collection of entities or the selected collection of instances, meaning this context defines the input set of the first transformation. Furthermore, <code>$apply</code> is evaluated first, and other expand or select options on the same (navigation) property are evaluated on the result of <code>$apply</code>.</p>
<div class="example">
<p>Example 39: products with aggregated sales</p>
<pre><code>GET /service/Products
  ?$expand=Sales($apply=aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Sales(Total))&quot;</span><span class="fu">,</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>   <span class="dv">12</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">8</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Black&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">4</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="39-abnf-for-extended-url-conventions"><a id="ABNFforExtendedURLConventions" href="#ABNFforExtendedURLConventions">3.9 ABNF for Extended URL Conventions</a></h2>
</summary>
<p>The normative ABNF construction rules for this specification are defined in <a href="#ODataAggABNF">OData-Agg-ABNF</a>. They incrementally extend the rules defined in <a href="#ODataABNF">OData-ABNF</a>.</p>
</details>
</details>
<hr />
<details open><summary>
<h1 id="4-cross-joins-and-aggregation"><a id="CrossJoinsandAggregation" href="#CrossJoinsandAggregation">4 Cross-Joins and Aggregation</a></h1>
</summary>
<p>OData supports querying related entities through defining navigation properties in the data model. These navigation paths help guide simple consumers in understanding and navigating relationships.</p>
<p>In some cases, however, requests need to span entity sets with no predefined associations. Such requests can be sent to the special resource <code>$crossjoin</code> instead of an individual entity set. The cross join of a list of entity sets is the Cartesian product of the listed entity sets, represented as a collection of complex type instances that have a navigation property with cardinality to-one for each participating entity set, and queries across entity sets can be formulated using these navigation properties. See <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part2-url-conventions.html#AddressingtheCrossJoinofEntitySets">OData-URL, section 4.15</a> for details.</p>
<p>Where useful navigations exist it is beneficial to expose those as explicit navigation properties in the model, but the ability to pose queries that span entity sets not related by an association provides a mechanism for advanced consumers to use more flexible join conditions.</p>
<div class="example">
<p>Example 40: if <code>Sale</code> had a string property <code>ProductID</code> instead of the navigation property <code>Product</code>, a “join” between <code>Sales</code> and <code>Products</code> could be accessed via the <code>$crossjoin</code> resource</p>
<pre><code>GET /service/$crossjoin(Products,Sales)
                         ?$expand=Products($select=Name),Sales($select=Amount)
                         &amp;$filter=Products/ID eq Sales/ProductID</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Collection(Edm.ComplexType)&quot;</span><span class="fu">,</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 41: using the <code>$crossjoin</code> resource for aggregate queries</p>
<pre><code>GET /service/$crossjoin(Products,Sales)
    ?$apply=filter(Products/ID eq Sales/ProductID)
           /groupby((Products/Name),
                    aggregate(Sales/Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Collection(Edm.ComplexType)&quot;</span><span class="fu">,</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">},</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The entity container may be annotated in the same way as entity sets to express which aggregate queries are supported, see <a href="#VocabularyforDataAggregation">section 5</a>.</p>
</details>
<hr />
<details open><summary>
<h1 id="5-vocabulary-for-data-aggregation"><a id="VocabularyforDataAggregation" href="#VocabularyforDataAggregation">5 Vocabulary for Data Aggregation</a></h1>
</summary>
<p>The following terms are defined in the vocabulary for data aggregation <a href="#ODataVocAggr">OData-VocAggr</a>.</p>
<details open><summary>
<h2 id="51-aggregation-capabilities"><a id="AggregationCapabilities" href="#AggregationCapabilities">5.1 Aggregation Capabilities</a></h2>
</summary>
<p>The term <code>ApplySupported</code> can be applied to an entity set, an entity type, or a collection if the target expression of the annotation starts with an entity container (see <a href="#containerrooted">example 43</a>). It describes the aggregation capabilities of the annotated target. If present, it implies that instances of the annotated target can contain dynamic properties as an effect of <code>$apply</code> even if they do not specify the <code>OpenType</code> attribute, see <a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.02/odata-csdl-json-v4.02.html#OpenEntityType">OData-CSDL, section 6.3</a>. The term has a complex type with the following properties:</p>
<ul>
<li>The <code>Transformations</code> collection lists all supported set transformations. Allowed values are the names of the standard transformations introduced in sections 3 and 6, and namespace-qualified names identifying a service-defined bindable function. If <code>Transformations</code> is omitted the server supports all transformations defined by this specification.</li>
<li>The <code>CustomAggregationMethods</code> collection lists supported custom aggregation methods. Allowed values are namespace-qualified names identifying service-specific aggregation methods. If omitted, no custom aggregation methods are supported.</li>
<li>🚧 <code>Rollup</code> is reserved for later versions of this specifications. The functional scope of this version of the specification is expressed by giving <code>Rollup</code> the value <code>None</code>.</li>
<li>A non-empty <code>GroupableProperties</code> indicates that only the listed properties of the annotated target can be used in <code>groupby</code>.</li>
<li>A non-empty <code>AggregatableProperties</code> indicates that only the listed properties of the annotated target can be used in <a href="#Transformationaggregate"><code>aggregate</code></a>, optionally restricted to the specified aggregation methods.</li>
</ul>
<p>All properties of <code>ApplySupported</code> are optional, so it can be used as a tagging annotation to signal unlimited support of aggregation.</p>
<p>The term <code>ApplySupportedDefaults</code> can be applied to an entity container. It allows to specify default support for aggregation capabilities <code>Transformations</code>, <code>CustomAggregationMethods</code> and <code>Rollup</code> that propagate to all collection-valued resources in the container. Annotating a specific collection-valued resource with the term <code>ApplySupported</code> overrides the default support with the specified properties using <code>PATCH</code> semantics:</p>
<ul>
<li>Primitive or collection-valued properties specified in <code>ApplySupported</code> replace the corresponding properties specified in <code>ApplySupportedDefaults</code>.</li>
<li>Complex-valued properties specified in <code>ApplySupported</code> override the corresponding properties specified in ApplySupportedDefaults using <code>PATCH</code> semantics recursively.</li>
<li>Properties specified neither in <code>ApplySupported</code> nor in <code>ApplySupportedDefault</code> have their default value.</li>
</ul>
<div class="example">
<p>Example 42: an entity container with default support for everything defined in this specification</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityContainer</span><span class="ot"> Name=</span><span class="st">&quot;SalesData&quot;</span>&gt;</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupportedDefaults&quot;</span> /&gt;</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  …</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityContainer</span>&gt;</span></code></pre></div>
</div>
<div class="example">
<p>Example <a id="containerrooted" href="#containerrooted">43</a>: Define aggregation support only for the products of a given category</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesData/Categories/Products&quot;</span>&gt;</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupported&quot;</span>&gt;</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    …</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Annotations</span>&gt;</span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="52-custom-aggregates"><a id="CustomAggregates" href="#CustomAggregates">5.2 Custom Aggregates</a></h2>
</summary>
<p>The term <code>CustomAggregate</code> allows defining dynamic properties that can be used in <a href="#Transformationaggregate"><code>aggregate</code></a>. No assumptions can be made on how the values of these custom aggregates are calculated, whether they are null, and which input values are used.</p>
<p>When applied to an entity set, an entity type, or a collection if the target expression of the annotation starts with an entity container, the annotation specifies custom aggregates that are available for its instances and for aggregated instances resulting from these instances. When applied to an entity container, the annotation specifies custom aggregates whose input set may span multiple entity sets within the container.</p>
<p>A custom aggregate is identified by the value of the <code>Qualifier</code> attribute when applying the term. The value of the <code>Qualifier</code> attribute is the name of the dynamic property. The name MUST NOT collide with the names of other custom aggregates of the same model element.</p>
<p>The value of the annotation is a string with the qualified name of a primitive type or type definition in scope that specifies the type returned by the custom aggregate.</p>
<p>If the custom aggregate is associated with an entity set, entity type, or collection, the value of the <code>Qualifier</code> attribute MAY be identical to the name of a declared property of the instances in this set or collection. In these cases, the value of the annotation MUST have the same value as the <code>Type</code> attribute of the declared property. This is typically done when the custom aggregate is used as a default aggregate for that property. In this case the name refers to the custom aggregate within an aggregate expression without a <code>with</code> clause, and to the property in all other cases.</p>
<p>If the custom aggregate is associated with an entity container, the value of the <code>Qualifier</code> attribute MUST NOT collide with the names of any entity container children.</p>
<div class="example">
<p>Example 44: Sales forecasts are modeled as a custom aggregate of the Sale entity type because it belongs there. For the budget, there is no appropriate structured type, so it is modeled as a custom aggregate of the <code>SalesData</code> entity container.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesData/Sales&quot;</span>&gt;</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.CustomAggregate&quot;</span><span class="ot"> Qualifier=</span><span class="st">&quot;Forecast&quot;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="ot">              String=</span><span class="st">&quot;Edm.Decimal&quot;</span> /&gt;</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Annotations</span>&gt;</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesData&quot;</span>&gt;</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.CustomAggregate&quot;</span><span class="ot"> Qualifier=</span><span class="st">&quot;Budget&quot;</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="ot">              String=</span><span class="st">&quot;Edm.Decimal&quot;</span> /&gt;</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Annotations</span>&gt;</span></code></pre></div>
<p>These custom aggregates can be used in the <code>aggregate</code> transformation:</p>
<pre><code>GET /service/Sales?$apply=groupby((Time/Month),aggregate(Forecast))</code></pre>
<p>and:</p>
<pre><code>GET /service/$crossjoin(Time)?$apply=groupby((Time/Year),aggregate(Budget))</code></pre>
</div>
</details>
<details open><summary>
<h2 id="53-context-defining-properties"><a id="ContextDefiningProperties" href="#ContextDefiningProperties">5.3 Context-Defining Properties</a></h2>
</summary>
<p>Sometimes the value of a property or custom aggregate is only well-defined within the context given by values of other properties, e.g. a postal code together with its country, or a monetary amount together with its currency unit. These context-defining properties can be listed with the term <code>ContextDefiningProperties</code> whose type is a collection of property paths.</p>
<p>If present, the context-defining properties SHOULD be used as grouping properties when aggregating the annotated property or custom aggregate, or alternatively be restricted to a single value by a pre-filter operation. Services MAY respond with <code>400 Bad Request</code> if the context-defining properties are not sufficiently specified for calculating a meaningful aggregate value.</p>
</details>
<details open><summary>
<h2 id="54-annotation-example"><a id="AnnotationExample" href="#AnnotationExample">5.4 Annotation Example</a></h2>
</summary>
<div class="example">
<p>Example 45: This simplified <code>Sales</code> entity set has a single aggregatable property <code>Amount</code> whose context is defined by the <code>Code</code> property of the related <code>Currency</code>, and a custom aggregate <code>Forecast</code> with the same context. The <code>Code</code> property of <code>Currencies</code> is groupable. All other properties are neither groupable nor aggregatable.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;Currency&quot;</span>&gt;</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;Code&quot;</span> /&gt;</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Code&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Name&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span>&gt;</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Core.IsLanguageDependent&quot;</span> /&gt;</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Property</span>&gt;</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;Sale&quot;</span>&gt;</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Amount&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.Decimal&quot;</span><span class="ot"> Scale=</span><span class="st">&quot;variable&quot;</span>&gt;</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ContextDefiningProperties&quot;</span>&gt;</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyPath</span>&gt;Currency/Code&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Property</span>&gt;</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Currency&quot;</span><span class="ot"> Type=</span><span class="st">&quot;SalesModel.Currency&quot;</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityContainer</span><span class="ot"> Name=</span><span class="st">&quot;SalesData&quot;</span>&gt;</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">EntitySet</span><span class="ot"> Name=</span><span class="st">&quot;Sales&quot;</span><span class="ot"> EntityType=</span><span class="st">&quot;SalesModel.Sale&quot;</span>&gt;</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupported&quot;</span>&gt;</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;AggregatableProperties&quot;</span>&gt;</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>              &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;Property&quot;</span><span class="ot"> PropertyPath=</span><span class="st">&quot;Amount&quot;</span> /&gt;</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">PropertyValue</span>&gt;</span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;GroupableProperties&quot;</span>&gt;</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Currency&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">PropertyValue</span>&gt;</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.CustomAggregate&quot;</span><span class="ot"> Qualifier=</span><span class="st">&quot;Forecast&quot;</span></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a><span class="ot">                String=</span><span class="st">&quot;Edm.Decimal&quot;</span>&gt;</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ContextDefiningProperties&quot;</span>&gt;</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">PropertyPath</span>&gt;Currency/Code&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">EntitySet</span>&gt;</span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">EntitySet</span><span class="ot"> Name=</span><span class="st">&quot;Currencies&quot;</span><span class="ot"> EntityType=</span><span class="st">&quot;SalesModel.Currency&quot;</span>&gt;</span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupported&quot;</span>&gt;</span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;GroupableProperties&quot;</span>&gt;</span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Code&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">PropertyValue</span>&gt;</span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">EntitySet</span>&gt;</span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityContainer</span>&gt;</span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="55-hierarchies"><a id="Hierarchies" href="#Hierarchies">5.5 Hierarchies</a></h2>
</summary>
<p>A hierarchy is an arrangement of entities whose values are represented as being “above”, “below”, or “at the same level as” one another.</p>
<p>🚧 Recursive hierarchies are defined in the following subsection. Any list of properties can be viewed as a leveled hierarchy with a fixed number of levels, for example, year, quarter and month, but this is not made explicit in the OData service.</p>
<details open><summary>
<h3 id="551-recursive-hierarchy"><a id="RecursiveHierarchy" href="#RecursiveHierarchy">5.5.1 Recursive Hierarchy</a></h3>
</summary>
<p>A recursive hierarchy is defined on a collection of entities by</p>
<ul>
<li>determining which entities are part of the hierarchy and giving every such entity a single primitive non-null value that uniquely identifies it within the hierarchy. These entities are called <em>nodes</em>, and the primitive value is called the <em>node identifier</em>, and</li>
<li>associating with every node zero or more nodes from the same collection, called its <em>parent nodes</em>.</li>
</ul>
<p>The recursive hierarchy is described in the model by an annotation of the entity type with the complex term <code>RecursiveHierarchy</code> with these properties:</p>
<ul>
<li>The <code>NodeProperty</code> MUST be a path with single-valued segments ending in a primitive property. This property holds the node identifier of an entity that is a node in the hierarchy.</li>
<li>The <code>ParentNavigationProperty</code> MUST be a collection-valued or nullable single-valued navigation property path that addresses the entity type annotated with this term. It navigates from an entity that is a node in the hierarchy to its parent nodes.</li>
</ul>
<p>The term <code>RecursiveHierarchy</code> can only be applied to entity types, and MUST be applied with a qualifier, which is used to reference the hierarchy in transformations operating on recursive hierarchies and in <a href="#HierarchyFunctions">hierarchy functions</a>. The same entity can serve as nodes in different recursive hierarchies, given different qualifiers.</p>
<p>A <em>root node</em> is a node without parent nodes. A recursive hierarchy can have one or more root nodes. A node is a <em>child node</em> of its parent nodes, a node without child nodes is a <em>leaf node</em>. Two nodes with a common parent node are <em>sibling nodes</em> and so are two root nodes.</p>
<p>The <em>descendants with maximum distance <span class="math inline">\(d≥1\)</span></em> of a node are its child nodes and, if <span class="math inline">\(d&gt;1\)</span>, the descendants of these child nodes with maximum distance <span class="math inline">\(d-1\)</span>. The <em>descendants</em> are the descendants with maximum distance <span class="math inline">\(d=∞\)</span>. A node together with its descendants forms a <em>sub-hierarchy</em> of the hierarchy.</p>
<p>The <em>ancestors with maximum distance <span class="math inline">\(d≥1\)</span></em> of a node are its parent nodes and, if <span class="math inline">\(d&gt;1\)</span>, the ancestors of these parent nodes with maximum distance <span class="math inline">\(d-1\)</span>. The <em>ancestors</em> are the ancestors with maximum distance <span class="math inline">\(d=∞\)</span>. The <code>ParentNavigationProperty</code> MUST be such that no node is an ancestor of itself, in other words: cycles are forbidden.</p>
<p>The term <code>UpPath</code> can be used in hierarchical result sets to associate with each instance one of its ancestors, one ancestor of that ancestor and so on. This instance annotation is introduced in <a href="#Transformationtraverse">section 6.2.2</a>.</p>
<details open><summary>
<h4 id="5511-hierarchy-functions"><a id="HierarchyFunctions" href="#HierarchyFunctions">5.5.1.1 Hierarchy Functions</a></h4>
</summary>
<p>For testing the position of a given entity in a recursive hierarchy, the <code>Aggregation</code> vocabulary <a href="#ODataVocAggr">OData-VocAggr</a> defines unbound functions. These have</p>
<ul>
<li>a parameter pair <code>HierarchyNodes</code>, <code>HierarchyQualifier</code> where <code>HierarchyNodes</code> is a collection and <code>HierarchyQualifier</code> is the qualifier of a <code>RecursiveHierarchy</code> annotation on its common entity type. The node identifiers in this collection define the recursive hierarchy.</li>
<li>a parameter <code>Node</code> that contains the node identifier of the entity to be tested. Note that the test result depends only on this node identifier, not on any other property of the given entity</li>
<li>additional parameters, depending on the type of test (see below)</li>
<li>a Boolean return value for the outcome of the test.</li>
</ul>
<p>The following functions are defined:</p>
<ul>
<li><a href="https://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Aggregation.V1.md#isnode"><code>isnode</code></a> tests if the given entity is a node of the hierarchy.</li>
<li><a href="https://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Aggregation.V1.md#isroot"><code>isroot</code></a> tests if the given entity is a root node of the hierarchy.</li>
<li><a href="https://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Aggregation.V1.md#isdescendant"><code>isdescendant</code></a> tests if the given entity is a descendant with maximum distance <code>MaxDistance</code> of an ancestor node (whose node identifier is given in a parameter <code>Ancestor</code>), or equals the ancestor if <code>IncludeSelf</code> is true.</li>
<li><a href="https://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Aggregation.V1.md#isancestor"><code>isancestor</code></a> tests if the given entity is an ancestor with maximum distance <code>MaxDistance</code> of a descendant node (whose node identifier is given in a parameter <code>Descendant</code>), or equals the descendant if <code>IncludeSelf</code> is true.</li>
<li><a href="https://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Aggregation.V1.md#issibling"><code>issibling</code></a> tests if the given entity and another entity (whose node identifier is given in a parameter <code>Other</code>) are sibling nodes.</li>
<li><a href="https://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Aggregation.V1.md#isleaf"><code>isleaf</code></a> tests if the given entity is a leaf node.</li>
</ul>
</details>
</details>
<details open><summary>
<h3 id="552-hierarchy-examples"><a id="HierarchyExamples" href="#HierarchyExamples">5.5.2 Hierarchy Examples</a></h3>
</summary>
<p>The hierarchy terms can be applied to the <a href="#ExampleDataModel">Example Data Model</a>.</p>
<div class="example">
<p>⚠ Example 46: leveled hierarchies for products and time, and a recursive hierarchy for the sales organizations:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="ot"> standalone=</span><span class="st">&quot;yes&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">edmx:Edmx</span><span class="ot"> xmlns:edmx=</span><span class="st">&quot;http://docs.oasis-open.org/odata/ns/edmx&quot;</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="ot">           Version=</span><span class="st">&quot;4.0&quot;</span>&gt;</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">edmx:Reference</span><span class="ot"> Uri=</span><span class="st">&quot;https://docs.oasis-open.org/odata/odata-data-</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="st">    aggregation-ext/v4.0/csd05/vocabularies/Org.OData.Aggregation.V1.xml&quot;</span>&gt;</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edmx:Include</span><span class="ot"> Alias=</span><span class="st">&quot;Aggregation&quot;</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="ot">                  Namespace=</span><span class="st">&quot;Org.OData.Aggregation.V1&quot;</span> /&gt;</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">edmx:Reference</span>&gt;</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">edmx:DataServices</span>&gt;</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Schema</span><span class="ot"> xmlns=</span><span class="st">&quot;http://docs.oasis-open.org/odata/ns/edm&quot;</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="ot">            Alias=</span><span class="st">&quot;SalesModel&quot;</span><span class="ot"> Namespace=</span><span class="st">&quot;org.example.odata.salesservice&quot;</span>&gt;</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesOrganization&quot;</span>&gt;</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.RecursiveHierarchy&quot;</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="ot">                    Qualifier=</span><span class="st">&quot;SalesOrgHierarchy&quot;</span>&gt;</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;NodeProperty&quot;</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="ot">                           PropertyPath=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;ParentNavigationProperty&quot;</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="ot">                           PropertyPath=</span><span class="st">&quot;Superordinate&quot;</span> /&gt;</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Annotations</span>&gt;</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Schema</span>&gt;</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">edmx:DataServices</span>&gt;</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">edmx:Edmx</span>&gt;</span></code></pre></div>
</div>
<p>The recursive hierarchy <code>SalesOrgHierarchy</code> can be used in functions with the <code>$filter</code> system query option.</p>
<div class="example">
<p>Example 47: requesting all organizations below EMEA</p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isdescendant(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID,
  Ancestor=&#39;EMEA&#39;)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Netherlands&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Netherlands&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Germany&quot;</span><span class="fu">,</span>     <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Germany&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span><span class="fu">,</span>        <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span><span class="fu">,</span>        <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 48: requesting just those organizations directly below EMEA</p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isdescendant(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID,
  Ancestor=&#39;EMEA&#39;,
  MaxDistance=1)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 49: just the lowest-level organizations</p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isleaf(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 50: the lowest-level organizations including their superordinate’s <code>ID</code></p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isleaf(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID)
&amp;$expand=Superordinate($select=ID)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations(*,Superordinate(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span><span class="fu">,</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA United Kingdom&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span><span class="fu">,</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 51: the sales <code>ID</code>s involving sales organizations from EMEA</p>
<pre><code>
GET /service/Sales?$select=ID&amp;$filter=Aggregation.isdescendant(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=SalesOrganization/ID,
  Ancestor=&#39;EMEA&#39;)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(ID)&quot;</span><span class="fu">,</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>Further examples for recursive hierarchies using transformations operating on the hierarchy structure are provided in <a href="#AggregationinRecursiveHierarchies">section 7.9</a>.</p>
</details>
</details>
<details open><summary>
<h2 id="56-functions-on-aggregated-entities"><a id="FunctionsonAggregatedEntities" href="#FunctionsonAggregatedEntities">5.6 Functions on Aggregated Entities</a></h2>
</summary>
<p>Service-defined bound functions that serve as set transformations MAY be annotated with the term <code>AvailableOnAggregates</code> to indicate that they are applicable to aggregated entities under specific conditions:</p>
<ul>
<li>The <code>RequiredProperties</code> collection lists all properties that must be available in the aggregated entities; otherwise, the annotated function will be inapplicable.</li>
</ul>
<div class="example">
<p>Example 52: assume the product is an implicit input for a function bound to a collection of <code>Sales</code>, then aggregating away the product makes this function inapplicable.</p>
</div>
</details>
</details>
<hr />
<details open><summary>
<h1 id="6-hierarchical-transformations"><a id="HierarchicalTransformations" href="#HierarchicalTransformations">6 Hierarchical Transformations</a></h1>
</summary>
<p>The transformations defined in this section are called hierarchical, because they make use of a recursive hierarchy and are defined in terms of hierarchy functions introduced in the previous section.</p>
<p>The transformations <code>ancestors</code> and <code>descendants</code> do not define an order on the output set. An order can be imposed by a subsequent <code>orderby</code> or <code>traverse</code> transformation or a <code>$orderby</code>. The output set of <code>traverse</code> is in preorder or postorder.</p>
<p>The algorithmic descriptions of the transformations make use of a <em>union</em> of collections, this is defined as an unordered collection containing the items from all these collections and from which duplicates have been removed.</p>
<p>The notation <span class="math inline">\(u[t]\)</span> is used to denote the value of a property <span class="math inline">\(t\)</span>, possibly preceded by a type-cast segment, in an instance <span class="math inline">\(u\)</span>. It is also used to denote the value of a single-valued data aggregation path <span class="math inline">\(t\)</span>, evaluated relative to <span class="math inline">\(u\)</span>. The value of a collection-valued <a href="#DataAggregationPath">data aggregation path</a> is denoted in the <a href="#EvaluationofDataAggregationPaths"><span class="math inline">\(\Gamma\)</span> notation</a> by <span class="math inline">\(γ(u,t)\)</span>.</p>
<p>The notations introduced here are used throughout the following subsections.</p>
<details open><summary>
<h2 id="61-common-parameters-for-hierarchical-transformations"><a id="CommonParametersforHierarchicalTransformations" href="#CommonParametersforHierarchicalTransformations">6.1 Common Parameters for Hierarchical Transformations</a></h2>
</summary>
<p>The parameter lists defined in the following subsections have three mandatory parameters in common.</p>
<p>The recursive hierarchy is defined by a parameter pair <span class="math inline">\((H,Q)\)</span>, where <span class="math inline">\(H\)</span> and <span class="math inline">\(Q\)</span> MUST be specified as the first and second parameter. Here, <span class="math inline">\(H\)</span> MUST be an expression of type <code>Collection(Edm.EntityType)</code> starting with <code>$root</code> that has no multiple occurrences of the same entity. <span class="math inline">\(H\)</span> identifies the collection of node entities forming a recursive hierarchy based on an annotation of their common entity type with term <code>RecursiveHierarchy</code> with a <code>Qualifier</code> attribute whose value MUST be provided in <span class="math inline">\(Q\)</span>. The property paths referenced by <code>NodeProperty</code> and <code>ParentNavigationProperty</code> in the <code>RecursiveHierarchy</code> annotation must be evaluable for the nodes in the recursive hierarchy, otherwise the service MUST reject the request. The <code>NodeProperty</code> is denoted by <span class="math inline">\(q\)</span> in this section.</p>
<p>The third parameter MUST be a data aggregation path <span class="math inline">\(p\)</span> with single- or collection-valued segments whose last segment MUST be a primitive property. The node identifier(s) of an instance <span class="math inline">\(u\)</span> in the input set are the primitive values in <span class="math inline">\(γ(u,p)\)</span>, they are reached via <span class="math inline">\(p\)</span> starting from <span class="math inline">\(u\)</span>. Let <span class="math inline">\(p=p_1/…/p_k/r\)</span> with <span class="math inline">\(k≥0\)</span> be the concatenation where each sub-path <span class="math inline">\(p_1,…,p_k\)</span> consists of a collection-valued segment that is preceded by zero or more single-valued segments, and either <span class="math inline">\(r\)</span> consists of one or more single-valued segments or <span class="math inline">\(k≥1\)</span> and <span class="math inline">\({}/r\)</span> is absent. Each segment can be prefixed with a type cast.</p>
</details>
<details open><summary>
<h2 id="62-hierarchical-transformations-producing-a-subset"><a id="HierarchicalTransformationsProducingaSubset" href="#HierarchicalTransformationsProducingaSubset">6.2 Hierarchical Transformations Producing a Subset</a></h2>
</summary>
<p>These transformations produce an output set that consists of certain instances from their input set, possibly with repetitions or in a different order.</p>
<details open><summary>
<h3 id="621-transformations-ancestors-and-descendants"><a id="Transformationsancestorsanddescendants" href="#Transformationsancestorsanddescendants">6.2.1 Transformations <code>ancestors</code> and <code>descendants</code></a></h3>
</summary>
<p>In the simple case, the <code>ancestors</code> transformation takes an input set consisting of instances that belong to a recursive hierarchy <span class="math inline">\((H,Q)\)</span>. It determines a subset <span class="math inline">\(A\)</span> of the input set and then determines the set of ancestors of <span class="math inline">\(A\)</span> that were already contained in the input set. Its output set is the ancestors set, optionally including <span class="math inline">\(A\)</span>.</p>
<p>In the more complex case, the instances in the input set are instead related to nodes in a recursive hierarchy. Then the <code>ancestors</code> transformation determines a subset <span class="math inline">\(A\)</span> of the input set consisting of instances that are related to certain nodes in the hierarchy, called start nodes. The ancestors of these start nodes are then determined, and the output set consists of instances of the input set that are related to the ancestors, or optionally to the start nodes.</p>
<p>The <code>descendants</code> transformation works analogously, but with descendants.</p>
<p><span class="math inline">\(H\)</span>, <span class="math inline">\(Q\)</span> and <span class="math inline">\(p\)</span> are the first three parameters defined <a href="#CommonParametersforHierarchicalTransformations">above</a>.</p>
<p>The fourth parameter is a transformation sequence <span class="math inline">\(T\)</span> composed of transformations listed <a href="#TransformationsProducingaSubset">section 3.3</a> or <a href="#Transformationsancestorsanddescendants">section 6.2.1</a> and of service-defined bound functions whose output set is a subset of their input set. <span class="math inline">\(A\)</span> is the output set of this sequence applied to the input set.</p>
<p>The fifth parameter <span class="math inline">\(d\)</span> is optional and takes an integer greater than or equal to 1 that specifies the maximum distance between start nodes and ancestors or descendants to be considered. An optional final <code>keep start</code> parameter drives the optional inclusion of the subset or start nodes.</p>
<p>The output set of the transformation <span class="math inline">\({\tt ancestors}(H,Q,p,T,d,{\tt keep\ start})\)</span> or <span class="math inline">\({\tt descendants}(H,Q,p,T,d,{\tt keep\ start})\)</span> is defined as the <a href="#HierarchicalTransformations">union</a> of the output sets of transformations <span class="math inline">\(F(u)\)</span> applied to the input set for all <span class="math inline">\(u\)</span> in <span class="math inline">\(A\)</span>. For a given instance <span class="math inline">\(u\)</span>, the transformation <span class="math inline">\(F(u)\)</span> determines all instances of the input set whose node identifier is an ancestor or descendant of the node identifier of <span class="math inline">\(u\)</span>:</p>
<p>If <span class="math inline">\(p\)</span> contains only single-valued segments, then, for <code>ancestors</code>, <span class="math display">\[\matrix{
F(u)={\tt filter}(\hbox{\tt Aggregation.isancestor}(\hfill\\
\quad {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\
\quad {\tt Node}=p,\;{\tt Descendant}=u[p],\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true}))\hfill
}\]</span> or, for <code>descendants</code>, <span class="math display">\[\matrix{
F(u)={\tt filter}(\hbox{\tt Aggregation.isdescendant}(\hfill\\
\quad {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\
\quad {\tt Node}=p,\;{\tt Ancestor}=u[p],\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true})).\hfill
}\]</span></p>
<p>Otherwise <span class="math inline">\(p=p_1/…/p_k/r\)</span> with <span class="math inline">\(k≥1\)</span>, in this case the output set of the transformation <span class="math inline">\(F(u)\)</span> is defined as the <a href="#HierarchicalTransformations">union</a> of the output sets of transformations <span class="math inline">\(G(n)\)</span> applied to the input set for all <span class="math inline">\(n\)</span> in <span class="math inline">\(γ(u,p)\)</span>. The output set of <span class="math inline">\(G(n)\)</span> consists of the instances of the input set whose node identifier is an ancestor or descendant of the node identifier <span class="math inline">\(n\)</span>:</p>
<p>For <code>ancestors</code>, <span class="math display">\[\matrix{
G(n)={\tt filter}(\hfill\\
\hskip1pc p_1/{\tt any}(y_1:\hfill\\
\hskip2pc y_1/p_2/{\tt any}(y_2:\hfill\\
\hskip3pc ⋱\hfill\\
\hskip4pc y_{k-1}/p_k/{\tt any}(y_k:\hfill\\
\hskip5pc \hbox{\tt Aggregation.isancestor}(\hfill\\
\hskip6pc {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\
\hskip6pc {\tt Node}=y_k/r,\;{\tt Descendant}=n,\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true}\hfill\\
\hskip5pc )\hfill\\
\hskip4pc )\hfill\\
\hskip3pc ⋰\hfill\\
\hskip2pc )\hfill\\
\hskip1pc )\hfill\\
)\hfill
}\]</span> or, for <code>descendants</code>, <span class="math display">\[\matrix{
G(n)={\tt filter}(\hfill\\
\hskip1pc p_1/{\tt any}(y_1:\hfill\\
\hskip2pc y_1/p_2/{\tt any}(y_2:\hfill\\
\hskip3pc ⋱\hfill\\
\hskip4pc y_{k-1}/p_k/{\tt any}(y_k:\hfill\\
\hskip5pc \hbox{\tt Aggregation.isdescendant}(\hfill\\
\hskip6pc {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\
\hskip6pc {\tt Node}=y_k/r,\;{\tt Ancestor}=n,\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true}\hfill\\
\hskip5pc )\hfill\\
\hskip4pc )\hfill\\
\hskip3pc ⋰\hfill\\
\hskip2pc )\hfill\\
\hskip1pc )\hfill\\
)\hfill
}\]</span> where <span class="math inline">\(y_1,…,y_k\)</span> denote <code>lambdaVariableExpr</code>s as defined in <a href="#ODataABNF">OData-ABNF</a> and <span class="math inline">\({}/r\)</span> may be absent.</p>
<p>If parameter <span class="math inline">\(d\)</span> is absent, the parameter <span class="math inline">\({\tt MaxDistance}=d\)</span> is omitted. If <code>keep start</code> is absent, the parameter <span class="math inline">\({\tt IncludeSelf}={\tt true}\)</span> is omitted.</p>
<p>Since the output set of <code>ancestors</code> is constructed as a union, no instance from the input set will occur more than once in it, even if, for example, a sale is related to both a sales organization and one of its ancestor organizations. For <code>descendants</code>, analogously.</p>
<div class="example">
<p>Example 53: Request based on the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a>, with <code>Superordinate/$ref</code> expanded to illustrate the hierarchy relation</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    ancestors($root/SalesOrganizations,SalesOrgHierarchy,ID,
              filter(contains(Name,&#39;East&#39;) or contains(Name,&#39;Central&#39;)))
  &amp;$expand=Superordinate/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>    <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 54: Request based on the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a>, with <code>Superordinate/$ref</code> expanded to illustrate the hierarchy relation</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    descendants($root/SalesOrganizations,SalesOrgHierarchy,ID,
                filter(Name eq &#39;US&#39;),keep start)
  &amp;$expand=Superordinate/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example 55: Input set and recursive hierarchy from two different entity sets</p>
<pre><code>GET /service/Sales?$apply=
    ancestors($root/SalesOrganizations,
              SalesOrgHierarchy,
              SalesOrganization/ID,
              filter(contains(SalesOrganization/Name,&#39;East&#39;)
                  or contains(SalesOrganization/Name,&#39;Central&#39;)),
              keep start)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;5&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;6&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;7&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;8&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h3 id="622-transformation-traverse"><a id="Transformationtraverse" href="#Transformationtraverse">6.2.2 Transformation <code>traverse</code></a></h3>
</summary>
<p>The <code>traverse</code> transformation returns instances of the input set that are or are related to nodes of a given recursive hierarchy in a specified tree order.</p>
<p>🚧 This version of the specification defines the behavior of the <code>traverse</code> transformation only in recursive hierarchies where <code>RecursiveHierarchy/ParentNavigationProperty</code> is single-valued.</p>
<p><span class="math inline">\(H\)</span>, <span class="math inline">\(Q\)</span> and <span class="math inline">\(p\)</span> are the first three parameters defined <a href="#CommonParametersforHierarchicalTransformations">above</a>.</p>
<p>The fourth parameter <span class="math inline">\(h\)</span> of the <code>traverse</code> transformation is either <code>preorder</code> or <code>postorder</code>. Let <span class="math inline">\(H&#39;\)</span> be the collection of root nodes in the recursive hierarchy <span class="math inline">\((H,Q)\)</span>. Nodes in <span class="math inline">\(H&#39;\)</span> are called start nodes in this subsection (see <a href="#weight">example 91</a>).</p>
<p>Let <span class="math inline">\(o\)</span> be the list of all following parameters that are expressions which could also be passed as a <code>$orderby</code> system query option, if there are any. If <span class="math inline">\(o\)</span> is present, the transformation <a href="#SamenessandOrder">stable-sorts</a> <span class="math inline">\(H&#39;\)</span> by <span class="math inline">\(o\)</span>.</p>
<p>🚧 Future versions of this specification MAY allow an optional fifth parameter that comes before the parameter list <span class="math inline">\(o\)</span> and could not be passed as a <code>$orderby</code> system query option.</p>
<p>The instances in the input set are related to one node (if <span class="math inline">\(p\)</span> is single-valued) or multiple nodes (if <span class="math inline">\(p\)</span> is collection-valued) in the recursive hierarchy. Given a node <span class="math inline">\(x\)</span>, denote by <span class="math inline">\(\hat F(x)\)</span> the collection of all instances in the input set that are related to <span class="math inline">\(x\)</span>; these collections can overlap. For each <span class="math inline">\(u\)</span> in <span class="math inline">\(\hat F(x)\)</span>, the output set contains one instance that comprises the properties of <span class="math inline">\(u\)</span> and additional properties that identify the node <span class="math inline">\(x\)</span>. These additional properties are independent of <span class="math inline">\(u\)</span> and are bundled into an instance called <span class="math inline">\(σ(x)\)</span>. For example, if a sale <span class="math inline">\(u\)</span> is related to two sales organizations and hence contained in both <span class="math inline">\(\hat F(x_1)\)</span> and <span class="math inline">\(\hat F(x_2)\)</span>, the output set will contain two instances <span class="math inline">\((u,σ(x_1))\)</span> and <span class="math inline">\((u,σ(x_2))\)</span> and <span class="math inline">\(σ(x_i)\)</span> contributes a navigation property <code>SalesOrganization</code>.</p>
<p>A transformation <span class="math inline">\(F(x)\)</span> is defined below such that <span class="math inline">\(\hat F(x)\)</span> is the output set of <span class="math inline">\(F(x)\)</span> applied to the input set of the <code>traverse</code> transformation.</p>
<p>Given a node <span class="math inline">\(x\)</span>, the formulas below contain the transformation <span class="math inline">\(\Pi_G(σ(x))\)</span> in order to inject the properties of <span class="math inline">\(σ(x)\)</span> into the instances in <span class="math inline">\(\hat F(x)\)</span>; this uses the function <span class="math inline">\(\Pi_G\)</span> that is defined in the <a href="#SimpleGrouping">simple grouping</a> section. Further, <span class="math inline">\(G\)</span> is a list of <a href="#DataAggregationPath">data aggregation paths</a> that shall be present in the output set, and <span class="math inline">\(σ\)</span> is a function that maps each hierarchy node <span class="math inline">\(x\)</span> to an instance of the <a href="#TypeStructureandContextURL">input type</a> containing the paths from <span class="math inline">\(G\)</span>. As a consequence of the following definitions, only single-valued properties and “final segments from <span class="math inline">\(G\)</span>” are nested into <span class="math inline">\(σ(x)\)</span>, therefore the behavior of <span class="math inline">\(\Pi_G(σ(x))\)</span> is well-defined.</p>
<p>The definition of <span class="math inline">\(σ(x)\)</span> makes use of a function <span class="math inline">\(a(ε,t,x)\)</span>, which returns a sparsely populated instance <span class="math inline">\(u\)</span> in which only the path <span class="math inline">\(t\)</span> has a value, namely <span class="math inline">\(u[t]=x\)</span>.</p>
<p>Three cases are distinguished:</p>
<ol type="1">
<li><em>Case where the recursive hierarchy is defined on the input set</em><br />
This case applies if the paths <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> are equal. Let <span class="math inline">\(σ(x)=x\)</span> and let <span class="math inline">\(G\)</span> be a list containing all structural and navigation properties of the entity type of <span class="math inline">\(H\)</span>.<br />
In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> injects all properties of <span class="math inline">\(x\)</span> into the instances of the output set. (See <a href="#caseone">example 57</a>.)</li>
<li><em>Case where the recursive hierarchy is defined on the related entity type addressed by a navigation property path</em><br />
This case applies if <span class="math inline">\(p&#39;\)</span> is a non-empty navigation property path and <span class="math inline">\(p&#39;&#39;\)</span> an optional type-cast segment such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(p&#39;/p&#39;&#39;/q\)</span>. Let <span class="math inline">\(σ(x)=a(ε,p&#39;/p&#39;&#39;,x)\)</span> and let <span class="math inline">\(G=(p&#39;)\)</span>.<br />
In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> injects the whole related entity <span class="math inline">\(x\)</span> into the instances of the output set. The navigation property path <span class="math inline">\(p&#39;\)</span> is expanded by default. (See <a href="#rollupnode">example 58</a>.)</li>
<li><em>Case where the recursive hierarchy is related to the input set only through equality of node identifiers, not through navigation</em><br />
If neither case 1 nor case 2 applies, let <span class="math inline">\(σ(x)=a(ε,p,x[q])\)</span> and let <span class="math inline">\(G=(p)\)</span>.<br />
In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> injects only the node identifier of <span class="math inline">\(x\)</span> into the instances of the output set.</li>
</ol>
<p>Here paths are considered equal if their non-type-cast segments refer to the same model elements when evaluated relative to the input set (see <a href="#pathequals">example 59</a>).</p>
<p>The function <span class="math inline">\(a(u,t,x)\)</span> takes an instance, a path and another instance as arguments and is defined recursively as follows:</p>
<ol type="1">
<li>If <span class="math inline">\(u\)</span> equals the special symbol <span class="math inline">\(ε\)</span>, set <span class="math inline">\(u\)</span> to a new instance of the <a href="#TypeStructureandContextURL">input type</a> without properties and without entity-id.</li>
<li>If <span class="math inline">\(t\)</span> contains only one segment other than a type cast, let <span class="math inline">\(t_1=t\)</span>, and let <span class="math inline">\(x&#39;=x\)</span>, then go to step 6.</li>
<li>Otherwise, let <span class="math inline">\(t_1\)</span> be the first property segment in <span class="math inline">\(t\)</span>, possibly together with a preceding type-cast segment, let <span class="math inline">\(t_2\)</span> be any type-cast segment that immediately follows, and let <span class="math inline">\(t_3\)</span> be the remainder such that <span class="math inline">\(t\)</span> equals the concatenated path <span class="math inline">\(t_1/t_2/t_3\)</span> where <span class="math inline">\({}/t_2\)</span> may be absent.</li>
<li>Let <span class="math inline">\(u&#39;\)</span> be an instance of the type of <span class="math inline">\(t_1/t_2\)</span> without properties and without entity-id.</li>
<li>Let <span class="math inline">\(x&#39;=a(u&#39;,t_3,x)\)</span>.</li>
<li>If <span class="math inline">\(t_1\)</span> is single-valued, let <span class="math inline">\(u[t_1]=x&#39;\)</span>.</li>
<li>If <span class="math inline">\(t_1\)</span> is collection-valued, let <span class="math inline">\(u[t_1]\)</span> be a collection consisting of one item <span class="math inline">\(x&#39;\)</span>.</li>
<li>Return <span class="math inline">\(u\)</span>.</li>
</ol>
<p>(See <a href="#traversecoll">example 88</a>.)</p>
<p>Since start nodes are root nodes, <span class="math inline">\(σ(x)\)</span> is computed exactly once for every node <span class="math inline">\(x\)</span>, as part of the recursive formula for <span class="math inline">\(R(x)\)</span> given below.</p>
<p>Let <span class="math inline">\(r_1,…,r_n\)</span> be a sequence of the start nodes in <span class="math inline">\(H&#39;\)</span> <a href="#SamenessandOrder">preserving the order</a> of <span class="math inline">\(H&#39;\)</span> stable-sorted by <span class="math inline">\(o\)</span>. Then the transformation <span class="math inline">\({\tt traverse}(H,Q,p,h,o)\)</span> is defined as equivalent to <span class="math display">\[{\tt concat}(R(r_1),…,R(r_n)).\]</span></p>
<p><span class="math inline">\(R(x)\)</span> is a transformation producing the specified tree order for a sub-hierarchy of <span class="math inline">\(H\)</span> with root node <span class="math inline">\(x\)</span>. Let <span class="math inline">\(c_1,…,c_m\)</span> with <span class="math inline">\(m≥0\)</span> be an <a href="#SamenessandOrder">order-preserving sequence</a> of the <a href="#RecursiveHierarchy">children</a> of <span class="math inline">\(x\)</span> in <span class="math inline">\((H,Q)\)</span>. The <em>recursive formula for <span class="math inline">\(R(x)\)</span></em> is as follows:</p>
<p>If <span class="math inline">\(h={\tt preorder}\)</span>, then <span class="math display">\[R(x)={\tt concat}(F(x)/\Pi_G(σ(x)),R(c_1),…,R(c_m)).\]</span></p>
<p>If <span class="math inline">\(h={\tt postorder}\)</span>, then <span class="math display">\[R(x)={\tt concat}(R(c_1),…,R(c_m),F(x)/\Pi_G(σ(x))).\]</span></p>
<p>The absence of cycles guarantees that the recursion terminates.</p>
<p><span class="math inline">\(F(x)\)</span> is a transformation that determines for the specified node <span class="math inline">\(x\)</span> the instances of the input set having the same node identifier as <span class="math inline">\(x\)</span>.</p>
<p>If <span class="math inline">\(p\)</span> contains only single-valued segments, then <span class="math display">\[F(x)={\tt filter}(p{\tt\ eq\ }x[q]).\]</span></p>
<p>Otherwise <span class="math inline">\(p=p_1/…/p_k/r\)</span> with <span class="math inline">\(k≥1\)</span> and <span class="math display">\[\matrix{
F(x)={\tt filter}(\hfill\\
\hskip1pc p_1/{\tt any}(y_1:\hfill\\
\hskip2pc y_1/p_2/{\tt any}(y_2:\hfill\\
\hskip3pc ⋱\hfill\\
\hskip4pc y_{k-1}/p_k/{\tt any}(y_k:\hfill\\
\hskip5pc y_k/r{\tt\ eq\ }x[q]\hfill\\
\hskip4pc )\hfill\\
\hskip3pc ⋰\hfill\\
\hskip2pc )\hfill\\
\hskip1pc )\hfill\\
)\hfill
}\]</span> where <span class="math inline">\(y_1,…,y_k\)</span> denote <code>lambdaVariableExpr</code>s and <span class="math inline">\({}/r\)</span> may be absent.</p>
<div class="example">
<p>Example 56: Based on the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a></p>
<pre><code>GET /service/SalesOrganizations?$apply=
    descendants($root/SalesOrganizations,SalesOrgHierarchy,ID,
                Name eq &#39;US&#39;,keep start)
    /ancestors($root/SalesOrganizations,SalesOrgHierarchy,ID,
                contains(Name,&#39;East&#39;),keep start)
    /traverse($root/SalesOrganizations,SalesOrgHierarchy,ID,preorder)
  &amp;$expand=Superordinate/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example <a id="caseone" href="#caseone">57</a>: Postorder traversal of organizations in the hierarchy defined in <a href="#HierarchyExamples">Hierarchy Examples</a> with <span class="math inline">\(p=q={\tt ID}\)</span> (case 1 of the <a href="#Transformationtraverse">definition</a> of <span class="math inline">\(σ(x)\)</span>). In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> writes back the entire node into the output set of <span class="math inline">\(T\)</span>.</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    traverse($root/SalesOrganizations,SalesOrgHierarchy,ID,postorder)
  &amp;$select=ID,Name
  &amp;$expand=Superordinate($select=ID)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$metadata#SalesOrganizations(ID,Name,Superordinate(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>           <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span>         <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span>        <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example <a id="rollupnode" href="#rollupnode">58</a>: Postorder traversal of sales per organization in the hierarchy defined in <a href="#HierarchyExamples">Hierarchy Examples</a> with <span class="math inline">\(p=p&#39;/q={\tt SalesOrganization}/{\tt ID}\)</span> and <span class="math inline">\(p&#39;={\tt SalesOrganization}\)</span> (case 2 of the <a href="#Transformationtraverse">definition</a> of <span class="math inline">\(σ(x)\)</span>).</p>
<pre><code>GET /service/Sales?$apply=traverse(
      $root/SalesOrganizations,
      SalesOrgHierarchy,
      SalesOrganization/ID,
      postorder)
  &amp;$select=ID
  &amp;$expand=SalesOrganization($select=ID)</code></pre>
<p>The result contains each sale once for every organization to which it belongs, directly or indirectly.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(ID,SalesOrganization(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example <a id="pathequals" href="#pathequals">59</a>: Although <span class="math inline">\(p={\tt ID}\)</span> and <span class="math inline">\(q={\tt ID}\)</span>, they are not equal in the sense of case 1, because they are evaluated relative to different entity sets. Hence, this is an example of case 3 of the <a href="#Transformationtraverse">definition</a> of <span class="math inline">\(σ(x)\)</span>, where no <code>Sales/ID</code> matches a <code>SalesOrganizations/ID</code>, that is, all <span class="math inline">\(F(x)\)</span> have empty output sets.</p>
<pre><code>GET /service/Sales?$apply=traverse(
      $root/SalesOrganizations,
      SalesOrgHierarchy,
      ID,
      postorder)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(ID,SalesOrganization(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[]</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
</details>
</details>
<hr />
<details open><summary>
<h1 id="7-examples"><a id="Examples" href="#Examples">7 Examples</a></h1>
</summary>
<p>The following examples show some common aggregation-related questions that can be answered by combining the transformations defined in <a href="#SystemQueryOptionapply">sections 3</a> and <a href="#HierarchicalTransformations">6</a>.</p>
<details open><summary>
<h2 id="71-requesting-distinct-values"><a id="RequestingDistinctValues" href="#RequestingDistinctValues">7.1 Requesting Distinct Values</a></h2>
</summary>
<p>Grouping without specifying a set transformation returns the distinct combination of the grouping properties.</p>
<div class="example">
<p>Example 60:</p>
<pre><code>GET /service/Customers?$apply=groupby((Name))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers(Name)&quot;</span><span class="fu">,</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Luc&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span> <span class="fu">}</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that “Sue” appears only once although the customer base contains two different Sues.</p>
</div>
<p>Aggregation is also possible across related entities.</p>
<div class="example">
<p>Example 61: customers that bought something</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Name))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Name))&quot;</span><span class="fu">,</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Since <code>groupby</code> expands navigation properties in grouping properties by default, this is the same result as if the request would include a <code>$expand=Customer($select=Name)</code>. The <code>groupby</code> removes all other properties.</p>
<p>Note that “Luc” does not appear in the aggregated result as he hasn’t bought anything and therefore there are no sales entities that refer/navigate to Luc.</p>
<p>However, even though both Sues bought products, only one “Sue” appears in the aggregate result. Including properties that guarantee the right level of uniqueness in the grouping can repair that.</p>
</div>
<div class="example">
<p>Example 62:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Name,Customer/ID))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Name,ID))&quot;</span><span class="fu">,</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>This could also have been formulated as</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer))
           &amp;$expand=Customer($select=Name,ID)</code></pre>
</div>
<div class="example">
<p>Example <a id="groupbynav" href="#groupbynav">63</a>: Grouping by navigation property <code>Customer</code></p>
<pre><code>
GET /service/Sales?$apply=groupby((Customer))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer())&quot;</span><span class="fu">,</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 64: the first question in the motivating example in <a href="#ExampleUseCases">section 2.3</a>, which customers bought which products, can now be expressed as</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Name,Customer/ID,Product/Name))</code></pre>
<p>and results in</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Name,ID),Product(Name))&quot;</span><span class="fu">,</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example <a id="subinputtype" href="#subinputtype">65</a>: grouping by properties of subtypes</p>
<pre><code>GET /service/Products?$apply=groupby((SalesModel.FoodProduct/Rating,
                                      SalesModel.NonFoodProduct/RatingClass))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(SalesModel.FoodProduct/Rating,</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="st">                                  SalesModel.NonFoodProduct/RatingClass)&quot;</span><span class="fu">,</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.NonFoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;RatingClass&quot;</span><span class="fu">:</span> <span class="st">&quot;average&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.NonFoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;RatingClass&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example <a id="anystructure" href="#anystructure">66</a>: grouping by a property of a subtype</p>
<pre><code>GET /service/Products?$apply=groupby((SalesModel.FoodProduct/Rating))</code></pre>
<p>results in a third group representing entities with no <code>SalesModel.FoodProduct/Rating</code>, including the <code>SalesModel.NonFoodProduct</code>s:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(@Core.AnyStructure)&quot;</span><span class="fu">,</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="fu">}</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="72-standard-aggregation-methods"><a id="StandardAggregationMethods" href="#StandardAggregationMethods">7.2 Standard Aggregation Methods</a></h2>
</summary>
<p>The client may specify one of the predefined aggregation methods <a href="#StandardAggregationMethodmin"><code>min</code></a>, <a href="#StandardAggregationMethodmax"><code>max</code></a>, <a href="#StandardAggregationMethodsum"><code>sum</code></a>, <a href="#StandardAggregationMethodaverage"><code>average</code></a>, and <a href="#StandardAggregationMethodcountdistinct"><code>countdistinct</code></a>, or a <a href="#CustomAggregationMethods">custom aggregation method</a>, to aggregate an <a href="#AggregatableExpression">aggregatable expression</a>. Expressions defining an aggregate method specify an <a href="#Keywordas">alias</a>. The aggregated values are returned in a dynamic property whose name is determined by the alias.</p>
<div class="example">
<p>Example <a id="aggr" href="#aggr">67</a>:</p>
<pre><code>GET /service/Products?$apply=groupby((Name),
                              aggregate(Sales/Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,Total)&quot;</span><span class="fu">,</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>   <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span>                          <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that the base set of the request is <code>Products</code>, so there is a result item for product <code>Pencil</code> even though there are no sales items. The input set for the aggregation in the third row is <span class="math inline">\(I\)</span> consisting of the pencil, <span class="math inline">\(p=q/r={\tt Sales}/{\tt Amount}\)</span>, <span class="math inline">\(E=\Gamma(I,q)\)</span> is empty and <span class="math inline">\(A=\Gamma(E,r)\)</span> is also empty. The sum over the empty collection is null.</p>
</div>
<div class="example">
<p>Example 68: Compute the aggregate as a property using the <code>aggregate</code> function in <code>$compute</code>:</p>
<pre><code>GET /service/Products?$compute=Sales/aggregate(Amount with sum) as Total</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(*,Total)&quot;</span><span class="fu">,</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Black&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>                               <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 69: Alternatively, <code>join</code> could be applied to yield a flat structure:</p>
<pre><code>GET /service/Products?$apply=
    join(Sales as TotalSales,aggregate(Amount with sum as Total))
    /groupby((Name,TotalSales/Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,TotalSales())&quot;</span><span class="fu">,</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Applying <code>outerjoin</code> instead would return an additional entity for product with <code>ID</code> “Pencil” and <code>TotalSales</code> having a null value.</p>
</div>
<div class="example">
<p>Example 70:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                            aggregate(Amount with average as AverageAmount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),AverageAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AverageAmount&quot;</span><span class="fu">:</span> <span class="fl">1.6666666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AverageAmount&quot;</span><span class="fu">:</span> <span class="fl">3.8</span> <span class="fu">}</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Here the <code>AverageAmount</code> is of type <code>Edm.Double</code>.</p>
</div>
<div class="example">
<p>Example 71: <code>$count</code> after navigation property</p>
<pre><code>GET /service/Products?$apply=groupby((Name),
                              aggregate(Sales/$count as SalesCount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,SalesCount)&quot;</span><span class="fu">,</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">0</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The <code>aggregate</code> function can not only be used in <code>$compute</code> but also in <code>$filter</code> and <code>$orderby</code>:</p>
<div class="example">
<p>Example 72: Products with an aggregated sales volume of ten or more</p>
<pre><code>GET /service/Products?$filter=Sales/aggregate(Amount with sum) ge 10</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products&quot;</span><span class="fu">,</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 73: Customers in descending order of their aggregated sales volume</p>
<pre><code>GET /service/Customers?$orderby=Sales/aggregate(Amount with sum) desc</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers&quot;</span><span class="fu">,</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Luc&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;France&quot;</span> <span class="fu">}</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 74: Contribution of each sales to grand total sales amount</p>
<pre><code>GET /service/Sales?$compute=Amount divby $these/aggregate(Amount with sum)
                            as Contribution</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(*,Contribution)&quot;</span><span class="fu">,</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0416666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0833333333333333</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">1666666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">3333333333333333</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">1666666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0833333333333333</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0416666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0833333333333333</span> <span class="fu">}</span></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 75: Product categories with at least one product having an aggregated sales amount greater than 10</p>
<pre><code>GET /service/Categories?$filter=Products/any(
                                p:p/Sales/aggregate(Amount with sum) gt 10)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Categories&quot;</span><span class="fu">,</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;PG1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Food&quot;</span> <span class="fu">}</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The <code>aggregate</code> function can also be applied inside <code>$apply</code>:</p>
<div class="example">
<p>Example 76: Sales volume per customer in relation to total volume</p>
<pre><code>GET /service/Sales?$apply=
    groupby((Customer),aggregate(Amount with sum as CustomerAmount))
    /compute(CustomerAmount divby $these/aggregate(CustomerAmount with sum)
             as Contribution)
  &amp;$expand=Customer/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(),CustomerAmount,Contribution)&quot;</span><span class="fu">,</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span>    <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;Customers(&#39;C1&#39;)&quot;</span> <span class="fu">},</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">2916667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span>    <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;Customers(&#39;C2&#39;)&quot;</span> <span class="fu">},</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span>    <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;Customers(&#39;C3&#39;)&quot;</span> <span class="fu">},</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">2083333</span> <span class="fu">}</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="73-requesting-expanded-results"><a id="RequestingExpandedResults" href="#RequestingExpandedResults">7.3 Requesting Expanded Results</a></h2>
</summary>
<div class="example">
<p>Example 77: use <code>outerjoin</code> to split up collection-valued navigation properties for grouping</p>
<pre><code>GET /service/Customers?$apply=outerjoin(Sales as ProductSales)
                       /groupby((Country,ProductSales/Product/Name))</code></pre>
<p>returns the different combinations of products sold per country:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers(Country,ProductSales())&quot;</span><span class="fu">,</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span><span class="fu">,</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span><span class="fu">,</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;France&quot;</span><span class="fu">,</span> <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="74-requesting-custom-aggregates"><a id="RequestingCustomAggregates" href="#RequestingCustomAggregates">7.4 Requesting Custom Aggregates</a></h2>
</summary>
<p>Custom aggregates are defined through the <a href="#CustomAggregates"><code>CustomAggregate</code></a> annotation. They can be associated with an entity set, a collection or an entity container.</p>
<p>A custom aggregate can be used by specifying the name of the custom aggregate in the <a href="#Transformationaggregate"><code>aggregate</code></a> clause.</p>
<div class="example">
<p>Example 78:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                           aggregate(Amount with sum as Actual,Forecast))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Actual,Forecast)&quot;</span><span class="fu">,</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Actual@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Actual&quot;</span><span class="fu">:</span>  <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Forecast@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Forecast&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Actual@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Actual&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Forecast@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Forecast&quot;</span><span class="fu">:</span> <span class="dv">21</span> <span class="fu">}</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>When associated with an entity set a custom aggregate MAY have the same name as a property of the underlying entity type with the same type as the type returned by the custom aggregate. This is typically done when the aggregate is used as a default aggregate for that property.</p>
<div class="example">
<p>Example 79: A custom aggregate can be defined with the same name as a property of the same type in order to define a default aggregate for that property.</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),aggregate(Amount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Amount)&quot;</span><span class="fu">,</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span>  <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">19</span> <span class="fu">}</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="75-aliasing"><a id="Aliasing" href="#Aliasing">7.5 Aliasing</a></h2>
</summary>
<p>A property can be aggregated in multiple ways, each with a different alias.</p>
<div class="example">
<p>Example 80:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                           aggregate(Amount with sum as Total,
                                     Amount with average as AvgAmt))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total,AvgAmt)&quot;</span><span class="fu">,</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AvgAmt@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="fl">1.6666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AvgAmt@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="fl">3.8</span> <span class="fu">}</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>There is no hard distinction between groupable and aggregatable properties: the same property can be aggregated and used to group the aggregated results.</p>
<div class="example">
<p>Example 81:</p>
<pre><code>GET /service/Sales?$apply=groupby((Amount),aggregate(Amount with sum as Total))</code></pre>
<p>will return all distinct amounts appearing in sales orders and how much money was made with deals of this amount</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Amount,Total)&quot;</span><span class="fu">,</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">6</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="76-combining-transformations-per-group"><a id="CombiningTransformationsperGroup" href="#CombiningTransformationsperGroup">7.6 Combining Transformations per Group</a></h2>
</summary>
<p>Dynamic property names may be reused in different transformation sequences passed to <code>concat</code>.</p>
<div class="example">
<p>Example <a id="bestselling" href="#bestselling">82</a>: to get the best-selling product per country with sub-totals for every country, the partial results of a transformation sequence and a <code>groupby</code> transformation are concatenated:</p>
<pre><code>GET /service/Sales?$apply=concat(
                     groupby((Customer/Country,Product/Name),
                             aggregate(Amount with sum as Total))
                       /groupby((Customer/Country),topcount(1,Total)),
                     groupby((Customer/Country),
                             aggregate(Amount with sum as Total)))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">19</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span></span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 83: transformation sequences are also useful inside <code>groupby</code>: Aggregate the amount by only considering the top two sales amounts per product and country:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country,Product/Name),
                      topcount(2,Amount)/aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example <a id="contradict" href="#contradict">84</a>: concatenation of two different groupings “biggest sale per customer” and “biggest sale per product”, made distinguishable by a dynamic property:</p>
<pre><code>GET /service/Sales?$apply=concat(
    groupby((Customer),topcount(1,Amount))/compute(&#39;Customer&#39; as per),
    groupby((Product),topcount(1,Amount))/compute(&#39;Product&#39; as per))
  &amp;$expand=Customer($select=ID),Product($select=ID)</code></pre>
<p>In the result, <code>Sales</code> entities 4 and 6 occur twice each with contradictory values of the dynamic property <code>per</code>. If a UI consuming the response presents the two groupings in separate columns based on the <code>per</code> property, no contradiction effectively arises.</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(*,per,Customer(ID),Product(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span> <span class="fu">},</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span> <span class="fu">},</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span> <span class="fu">},</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;6&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span> <span class="fu">},</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;6&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Product&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span> <span class="fu">},</span></span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Product&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span> <span class="fu">},</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;5&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Product&quot;</span> <span class="fu">}</span></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="77-model-functions-as-set-transformations"><a id="ModelFunctionsasSetTransformations" href="#ModelFunctionsasSetTransformations">7.7 Model Functions as Set Transformations</a></h2>
</summary>
<div class="example">
<p>Example 85: As a variation of <a href="#bestselling">example 82</a>, a query for returning the best-selling product per country and the total amount of the remaining products can be formulated with the help of a model function.</p>
<p>For this purpose, the model includes a definition of a <code>TopCountAndRemainder</code> function that accepts a count and a numeric property for the top entities:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">edm:Function</span><span class="ot"> Name=</span><span class="st">&quot;TopCountAndRemainder&quot;</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="ot">              IsBound=</span><span class="st">&quot;true&quot;</span>&gt;</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:Parameter</span><span class="ot">  Name=</span><span class="st">&quot;EntityCollection&quot;</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="ot">                    Type=</span><span class="st">&quot;Collection(Edm.EntityType)&quot;</span> /&gt;</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:Parameter</span><span class="ot">  Name=</span><span class="st">&quot;Count&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.Int16&quot;</span> /&gt;</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:Parameter</span><span class="ot">  Name=</span><span class="st">&quot;Property&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:ReturnType</span><span class="ot"> Type=</span><span class="st">&quot;Collection(Edm.EntityType)&quot;</span> /&gt;</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">edm:Function</span>&gt;</span></code></pre></div>
<p>The function retains those entities that <code>topcount</code> also would retain, and replaces the remaining entities by a single aggregated entity, where only the numeric property has a value, which is the sum over those remaining entities:</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Customer/Country,Product/Name),
          aggregate(Amount with sum as Total))
  /groupby((Customer/Country),
           Self.TopCountAndRemainder(Count=1,Property=&#39;Total&#39;))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">7</span> <span class="fu">}</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that these two entities get their values for the Country property from the groupby transformation, which ensures that they contain all grouping properties with the correct values.</p>
</div>
</details>
<details open><summary>
<h2 id="78-controlling-aggregation-per-rollup-level"><a id="ControllingAggregationperRollupLevel" href="#ControllingAggregationperRollupLevel">7.8 Controlling Aggregation per Rollup Level</a></h2>
</summary>
<p>For a leveled hierarchy, consumers may specify a different aggregation method per level as a hierarchy level below the root level.</p>
<div class="example">
<p>Example 86: get the average of the overall amount by month per product.</p>
<p>Using a transformation sequence:</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/ID,Product/Name,Time/Month),
                           aggregate(Amount with sum) as Total))
                  /groupby((Product/ID,Product/Name),
                           aggregate(Total with average as MonthlyAverage))</code></pre>
</details>
<details open><summary>
<h2 id="79-aggregation-in-recursive-hierarchies"><a id="AggregationinRecursiveHierarchies" href="#AggregationinRecursiveHierarchies">7.9 Aggregation in Recursive Hierarchies</a></h2>
</summary>
<div class="example">
<p>⚠ Example 87: The input set <code>Sales</code> is filtered along a hierarchy on a related entity (navigation property <code>SalesOrganization</code>) before an aggregation</p>
<pre><code>GET /service/Sales?$apply=
  descendants($root/SalesOrganizations,
    SalesOrgHierarchy,
    SalesOrganization/ID,
    filter(SalesOrganization/Name eq &#39;US&#39;),
    keep start)
  /aggregate(Amount with sum as TotalAmount)</code></pre>
<p>The same aggregate value is computed if the input set is the hierarchical entity <code>SalesOrganizations</code> and an assumed partner navigation property <code>Sales</code> of <code>SalesOrganization</code> appears in the <code>aggregate</code> transformation</p>
<pre><code>GET /service/SalesOrganizations?$apply=
  descendants($root/SalesOrganizations,
    SalesOrgHierarchy,
    ID,
    filter(Name eq &#39;US&#39;),
    keep start)
  /aggregate(Sales/Amount with sum as TotalAmount)</code></pre>
</div>
<div class="example">
<p>Example <a id="traversecoll" href="#traversecoll">88</a>: Preorder traversal of a hierarchy with 1:N relationship with collection-valued segment <span class="math inline">\(p_1={\tt Sales}\)</span> and <span class="math inline">\(r={\tt SalesOrganization}/{\tt ID}\)</span>.</p>
<pre><code>GET /service/Products?$apply=traverse(
      $root/SalesOrganizations,
      SalesOrgHierarchy,
      Sales/SalesOrganization/ID,
      preorder,
      Name asc)
    &amp;$select=ID</code></pre>
<p>The result contains multiple instances of the same <code>Product</code> that differ in their <code>Sales</code> navigation property even though they agree in their <code>ID</code> key property. The node <span class="math inline">\(x\)</span> with <span class="math inline">\(x/{\tt ID}={}\)</span><code>"US"</code> has <span class="math inline">\(σ(x)={}\)</span><code>{"Sales": [{"SalesOrganization": {"ID": "US"}}]}</code>.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$metadata#Products(ID,Sales(SalesOrganization(ID)))&quot;</span><span class="fu">,</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
</details>
<details open><summary>
<h2 id="710-maintaining-recursive-hierarchies"><a id="MaintainingRecursiveHierarchies" href="#MaintainingRecursiveHierarchies">7.10 Maintaining Recursive Hierarchies</a></h2>
</summary>
<p>Besides changes to the structural properties of the entities in a hierarchical collection, hierarchy maintenance involves changes to the parent-child relationships.</p>
<div class="example">
<p>Example 89: Move a sales organization Switzerland under the parent EMEA Central by binding the parent navigation property to EMEA Central <a href="https://docs.oasis-open.org/odata/odata-json-format/v4.02/odata-json-format-v4.02.html#BindOperation">OData-JSON, section 8.5</a>:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="er">PATCH</span> <span class="er">/service/SalesOrganizations(&#39;Switzerland&#39;)</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;EMEA Central&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span></code></pre></div>
<p>results in <code>204 No Content</code>.</p>
<p>Deleting the parent from the sales organization Switzerland (making it a root) can be achieved either with:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="er">PATCH</span> <span class="er">/service/SalesOrganizations(&#39;Switzerland&#39;)</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="fu">}</span></span></code></pre></div>
<p>or with:</p>
<pre><code>DELETE /service/SalesOrganizations(&#39;Switzerland&#39;)/Superordinate/$ref</code></pre>
</div>
<div class="example">
<p>Example <a id="refconstr" href="#refconstr">90</a>: If the parent navigation property contained a referential constraint for the key of the target <a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.02/odata-csdl-json-v4.02.html#ReferentialConstraint">OData-CSDL, section 8.5</a>,</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;SalesOrganization&quot;</span>&gt;</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Name&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;SuperordinateID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Superordinate&quot;</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Type=</span><span class="st">&quot;SalesModel.SalesOrganization&quot;</span>&gt;</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ReferentialConstraint</span><span class="ot"> Property=</span><span class="st">&quot;SuperordinateID&quot;</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a><span class="ot">                           ReferencedProperty=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">NavigationProperty</span>&gt;</span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span></code></pre></div>
<p>then alternatively the property taking part in the referential constraint <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#UpdateaPrimitiveProperty">OData-Protocol, section 11.4.9.1</a> could be changed to EMEA Central:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="er">PATCH</span> <span class="er">/service/SalesOrganizations(&#39;Switzerland&#39;)</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;SuperordinateID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span></span></code></pre></div>
</div>
<p>If the parent-child relationship between sales organizations is maintained in a separate entity set, a node can have multiple parents, with additional information on each parent-child relationship.</p>
<div class="example">
<p>⚠ Example <a id="weight" href="#weight">91</a>: Assume the relation from a node to its parent nodes contains a weight:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;SalesOrganizationRelation&quot;</span>&gt;</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;Superordinate/ID&quot;</span><span class="ot"> Alias=</span><span class="st">&quot;SuperordinateID&quot;</span> /&gt;</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Weight&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.Decimal&quot;</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="ot">                          Nullable=</span><span class="st">&quot;false&quot;</span><span class="ot"> DefaultValue=</span><span class="st">&quot;1&quot;</span> /&gt;</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Superordinate&quot;</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Type=</span><span class="st">&quot;SalesModel.SalesOrganization&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;SalesOrganization&quot;</span>&gt;</span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Name&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Relations&quot;</span></span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Type=</span><span class="st">&quot;Collection(SalesModel.SalesOrganizationRelation)&quot;</span></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Nullable=</span><span class="st">&quot;false&quot;</span><span class="ot"> ContainsTarget=</span><span class="st">&quot;true&quot;</span> /&gt;</span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.RecursiveHierarchy&quot;</span></span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a><span class="ot">              Qualifier=</span><span class="st">&quot;MultiParentHierarchy&quot;</span>&gt;</span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;NodeProperty&quot;</span></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a><span class="ot">                     PropertyPath=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;ParentNavigationProperty&quot;</span></span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a><span class="ot">                     NavigationPropertyPath=</span><span class="st">&quot;Relations/Superordinate&quot;</span> /&gt;</span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span></code></pre></div>
<p>Further assume the following relationships between sales organizations:</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Relations/SuperordinateID</th>
<th style="text-align: right;">Relations/Weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>US</td>
<td>Sales</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>EMEA</td>
<td>Sales</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td>EMEA Central</td>
<td>EMEA</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>Atlantis</td>
<td>US</td>
<td style="text-align: right;">0.6</td>
</tr>
<tr class="odd">
<td>Atlantis</td>
<td>EMEA</td>
<td style="text-align: right;">0.4</td>
</tr>
<tr class="even">
<td>Phobos</td>
<td>Mars</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
<p>Then Atlantis is a node with two parents. The standard hierarchical transformations <code>ancestors</code> and <code>descendants</code> disregard the weight property and consider both parents equally valid. Transformation <code>traverse</code> has no defined behavior.</p>
<p>Since this example contains no referential constraint, there is no analogy to <a href="#refconstr">example 90</a>. The alias <code>SuperordinateID</code> cannot be used in the payload, the following request is invalid:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/service/SalesOrganizations(&#39;Mars&#39;)/Relations</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;SuperordinateID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span></span></code></pre></div>
<p>The alias <code>SuperordinateID</code> is used in the request to delete the added relationship again:</p>
<pre><code>DELETE /service/SalesOrganizations(&#39;Mars&#39;)/Relations(&#39;Sales&#39;)</code></pre>
</div>
</details>
<details open><summary>
<h2 id="711-transformation-sequences"><a id="TransformationSequences" href="#TransformationSequences">7.11 Transformation Sequences</a></h2>
</summary>
<p>Applying aggregation first covers the most prominent use cases. The slightly more sophisticated question “how much money is earned with small sales” requires filtering the base set before applying the aggregation. To enable this type of question several transformations can be specified in <code>$apply</code> in the order they are to be applied, separated by a forward slash.</p>
<div class="example">
<p>Example 92:</p>
<pre><code>GET /service/Sales?$apply=filter(Amount le 1)
    /aggregate(Amount with sum as Total)</code></pre>
<p>means “filter first, then aggregate”, and results in</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>Using <code>filter</code> within <code>$apply</code> does not preclude using it as a normal system query option.</p>
<div class="example">
<p>Example 93:</p>
<pre><code>GET /service/Sales?$apply=filter(Amount le 2)/groupby((Product/Name),
                                         aggregate(Amount with sum as Total))
           &amp;$filter=Total ge 4</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>For further examples, consider another data model containing entity sets for cities, countries and continents and the obvious associations between them.</p>
<div class="example">
<p>Example 94: getting the population per country with</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                            aggregate(Population with sum as TotalPopulation))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Cities(Continent(Name),Country(Name),</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="st">                                TotalPopulation)&quot;</span><span class="fu">,</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Continent&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Asia&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;China&quot;</span> <span class="fu">},</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalPopulation@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Int32&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalPopulation&quot;</span><span class="fu">:</span> <span class="dv">1412000000</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Continent&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Asia&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;India&quot;</span> <span class="fu">},</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalPopulation@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Int32&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalPopulation&quot;</span><span class="fu">:</span> <span class="dv">1408000000</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 95: all countries with megacities and their continents</p>
<pre><code>GET /service/Cities?$apply=filter(Population ge 10000000)
                   /groupby((Continent/Name,Country/Name),
                            aggregate(Population with sum as TotalPopulation))</code></pre>
</div>
<div class="example">
<p>Example 96: all countries with tens of millions of city dwellers and the continents only for these countries</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                          aggregate(Population with sum as CountryPopulation))
                   /filter(CountryPopulation ge 10000000)
                   /concat(identity,
                         groupby((Continent/Name),
                           aggregate(CountryPopulation with sum
                                      as TotalPopulation)))</code></pre>
<p>or</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                          aggregate(Population with sum as CountryPopulation))
                   /filter(CountryPopulation ge 10000000)
                   /concat(groupby((Continent/Name,Country/Name),
                             aggregate(CountryPopulation with sum
                                       as TotalPopulation)),
                           groupby((Continent/Name),
                             aggregate(CountryPopulation with sum
                                       as TotalPopulation)))</code></pre>
</div>
<div class="example">
<p>Example 97: all countries with tens of millions of city dwellers and all continents with cities independent of their size</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                          aggregate(Population with sum as CountryPopulation))
                   /concat(filter(CountryPopulation ge 10000000),
                         groupby((Continent/Name),
                                 aggregate(CountryPopulation with sum
                                       as TotalPopulation)))</code></pre>
</div>
<div class="example">
<p>Example 98: assuming that <code>Amount</code> is a custom aggregate in addition to the property, determine the total for countries with an <code>Amount</code> greater than 1000</p>
<pre><code>GET /service/SalesOrders?$apply=
  groupby((Customer/Country),aggregate(Amount))
  /filter(Amount gt 1000)
  /aggregate(Amount)</code></pre>
</div>
</details>
</details>
<hr />
<details open><summary>
<h1 id="8-conformance"><a id="Conformance" href="#Conformance">8 Conformance</a></h1>
</summary>
<p>Conforming services MUST follow all rules of this specification for the set transformations and aggregation methods they support. They MUST implement all set transformations and aggregation methods they advertise via the annotation <a href="#AggregationCapabilities"><code>ApplySupported</code></a>.</p>
<p>Conforming clients MUST be prepared to consume a model that uses any or all of the constructs defined in this specification, including custom aggregation methods defined by the service, and MUST ignore any constructs not defined in this version of the specification.</p>
</details>
<hr />
<details open><summary>
<h1 id="appendix-a-references"><a id="References" href="#References">Appendix A. References</a></h1>
</summary>
<p>This appendix contains the normative references that are used in this document.</p>
<p>While any hyperlinks included in this appendix were valid at the time of publication, OASIS cannot guarantee their long-term validity.</p>
<details open><summary>
<h2 id="a1-normative-references"><a id="NormativeReferences" href="#NormativeReferences">A.1 Normative References</a></h2>
</summary>
<p>The following documents are referenced in such a way that some or all of their content constitutes requirements of this document.</p>
<h6><span id="ODataABNF">OData-ABNF</span></h6>
<p><em>ABNF components: OData ABNF Construction Rules Version 4.01 and OData ABNF Test Cases.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6><span id="ODataAggABNF">OData-Agg-ABNF</span></h6>
<p><em>OData Aggregation ABNF Construction Rules Version 4.0.</em><br />
See link in “<a href="#AdditionalArtifacts">Additional artifacts</a>” section on cover page.</p>
<h6><span id="ODataCSDL">OData-CSDL</span></h6>
<p><em>OData Common Schema Definition Language (CSDL) JSON Representation Version 4.01.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<p><em>OData Common Schema Definition Language (CSDL) XML Representation Version 4.01.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6><span id="ODataJSON">OData-JSON</span></h6>
<p><em>OData JSON Format Version 4.01.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6><span id="ODataProtocol">OData-Protocol</span></h6>
<p><em>OData Version 4.01. Part 1: Protocol.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6><span id="ODataURL">OData-URL</span></h6>
<p><em>OData Version 4.01. Part 2: URL Conventions.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6><span id="ODataVocAggr">OData-VocAggr</span></h6>
<p><em>OData Aggregation Vocabulary.</em><br />
See link in “<a href="#AdditionalArtifacts">Additional artifacts</a>” section on cover page.</p>
<h6><span id="ODataVocCore">OData-VocCore</span></h6>
<p><em>OData Core Vocabulary.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6><span id="rfc2119">RFC2119</span></h6>
<p><em>Bradner, S., “Key words for use in RFCs to Indicate Requirement Levels”, BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997</em><br />
<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>.</p>
<h6><span id="rfc8174">RFC8174</span></h6>
<p><em>Leiba, B., “Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words”, BCP 14, RFC 8174, DOI 10.17487/RFC8174, May 2017</em><br />
<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>.</p>
</details>
</details>
<hr />
<details open><summary>
<h1 id="appendix-b-acknowledgments"><a id="Acknowledgments" href="#Acknowledgments">Appendix B. Acknowledgments</a></h1>
</summary>
<details open><summary>
<h2 id="b1-special-thanks"><a id="SpecialThanks" href="#SpecialThanks">B.1 Special Thanks</a></h2>
</summary>
<p>The contributions of the OASIS OData Technical Committee members, enumerated in <a href="https://docs.oasis-open.org/odata/odata/v4.02/odata-v4.02-part1-protocol.html#Participants">OData-Protocol, section C.2</a>, are gratefully acknowledged.</p>
</details>
<details open><summary>
<h2 id="b2-participants"><a id="Participants" href="#Participants">B.2 Participants</a></h2>
</summary>
<p><strong>OData TC Members:</strong></p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">First Name</th>
<th style="text-align: left;">Last Name</th>
<th style="text-align: left;">Company</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">George</td>
<td style="text-align: left;">Ericson</td>
<td style="text-align: left;">Dell</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hubert</td>
<td style="text-align: left;">Heijkers</td>
<td style="text-align: left;">IBM</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ling</td>
<td style="text-align: left;">Jin</td>
<td style="text-align: left;">IBM</td>
</tr>
<tr class="even">
<td style="text-align: left;">Stefan</td>
<td style="text-align: left;">Hagen</td>
<td style="text-align: left;">Individual</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Michael</td>
<td style="text-align: left;">Pizzo</td>
<td style="text-align: left;">Microsoft</td>
</tr>
<tr class="even">
<td style="text-align: left;">Christof</td>
<td style="text-align: left;">Sprenger</td>
<td style="text-align: left;">Microsoft</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ralf</td>
<td style="text-align: left;">Handl</td>
<td style="text-align: left;">SAP SE</td>
</tr>
<tr class="even">
<td style="text-align: left;">Gerald</td>
<td style="text-align: left;">Krause</td>
<td style="text-align: left;">SAP SE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Heiko</td>
<td style="text-align: left;">Theißen</td>
<td style="text-align: left;">SAP SE</td>
</tr>
<tr class="even">
<td style="text-align: left;">Martin</td>
<td style="text-align: left;">Zurmuehl</td>
<td style="text-align: left;">SAP SE</td>
</tr>
</tbody>
</table>
</details>
</details>
<hr />
<details open><summary>
<h1 id="appendix-c-revision-history"><a id="RevisionHistory" href="#RevisionHistory">Appendix C. Revision History</a></h1>
</summary>
<table>
<thead>
<tr class="header">
<th>Revision</th>
<th>Date</th>
<th>Editor</th>
<th>Changes Made</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Working Draft 01</td>
<td>2012-11-12</td>
<td>Ralf Handl</td>
<td>Translated contribution into OASIS format</td>
</tr>
<tr class="even">
<td>Committee Specification Draft 01</td>
<td>2013-07-25</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Martin Zurmuehl</td>
<td>Switched to pipe-and-filter-style query language based on composable set transformations<br> Fleshed out examples and addressed numerous editorial and technical issues processed through the TC<br> Added Conformance section</td>
</tr>
<tr class="odd">
<td>Committee Specification Draft 02</td>
<td>2014-01-09</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Martin Zurmuehl</td>
<td>Dynamic properties used all aggregated values either via aliases or via custom aggregates<br> Refactored annotations</td>
</tr>
<tr class="even">
<td>Committee Specification Draft 03</td>
<td>2015-07-16</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Martin Zurmuehl</td>
<td>Added compute transformation<br> Minor clean-up</td>
</tr>
<tr class="odd">
<td>Committee Specification Draft 04</td>
<td>2023-07-05</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Heiko Theißen</td>
<td>Added section about fundamentals of input and output sets<br> Algorithmic descriptions of transformations<br> Added join and outerjoin transformations, replaced expand by addnested<br> Added transformations orderby, skip, top, nest<br> Added transformations for recursive hierarchies, updated related filter functions<br> Added functions evaluable on a collection, introduced keyword $these<br> Merged section 4 “Representation of Aggregated Instances” into section 3<br> Remove actions and functions (except set transformations) on aggregated entities, adapted section “Actions and Functions on Aggregated Entities”</td>
</tr>
<tr class="even">
<td>Committee Specification 03</td>
<td>2023-09-19</td>
<td>Ralf Handl<br> Gerald Krause<br> Heiko Theißen</td>
<td>Non-material changes from public review feedback</td>
</tr>
<tr class="odd">
<td>Committee Specification Draft 05</td>
<td>2023-09-19</td>
<td>Gerald Krause<br> Heiko Theißen</td>
<td>Remove sections not intended for OASIS Standard</td>
</tr>
</tbody>
</table>
</details>
<hr />
<details open><summary>
<h1 id="appendix-d-notices"><a id="Notices" href="#Notices">Appendix D. Notices</a></h1>
</summary>
<p>Copyright © OASIS Open 2023. All Rights Reserved.</p>
<p>All capitalized terms in the following text have the meanings assigned to them in the OASIS Intellectual Property Rights Policy (the “OASIS IPR Policy”). The full <a href="https://www.oasis-open.org/policies-guidelines/ipr/">Policy</a> may be found at the OASIS website.</p>
<p>This document and translations of it may be copied and furnished to others, and derivative works that comment on or otherwise explain it or assist in its implementation may be prepared, copied, published, and distributed, in whole or in part, without restriction of any kind, provided that the above copyright notice and this section are included on all such copies and derivative works. However, this document itself may not be modified in any way, including by removing the copyright notice or references to OASIS, except as needed for the purpose of developing any document or deliverable produced by an OASIS Technical Committee (in which case the rules applicable to copyrights, as set forth in the OASIS IPR Policy, must be followed) or as required to translate it into languages other than English.</p>
<p>The limited permissions granted above are perpetual and will not be revoked by OASIS or its successors or assigns.</p>
<p>This document and the information contained herein is provided on an “AS IS” basis and OASIS DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY OWNERSHIP RIGHTS OR ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.</p>
<p>As stated in the OASIS IPR Policy, the following three paragraphs in brackets apply to OASIS Standards Final Deliverable documents (Committee Specification, Candidate OASIS Standard, OASIS Standard, or Approved Errata).</p>
<p>[OASIS requests that any OASIS Party or any other party that believes it has patent claims that would necessarily be infringed by implementations of this OASIS Standards Final Deliverable, to notify OASIS TC Administrator and provide an indication of its willingness to grant patent licenses to such patent claims in a manner consistent with the IPR Mode of the OASIS Technical Committee that produced this deliverable.]</p>
<p>[OASIS invites any party to contact the OASIS TC Administrator if it is aware of a claim of ownership of any patent claims that would necessarily be infringed by implementations of this OASIS Standards Final Deliverable by a patent holder that is not willing to provide a license to such patent claims in a manner consistent with the IPR Mode of the OASIS Technical Committee that produced this OASIS Standards Final Deliverable. OASIS may include such claims on its website, but disclaims any obligation to do so.]</p>
<p>[OASIS takes no position regarding the validity or scope of any intellectual property or other rights that might be claimed to pertain to the implementation or use of the technology described in this OASIS Standards Final Deliverable or the extent to which any license under such rights might or might not be available; neither does it represent that it has made any effort to identify any such rights. Information on OASIS’ procedures with respect to rights in any document or deliverable produced by an OASIS Technical Committee can be found on the OASIS website. Copies of claims of rights made available for publication and any assurances of licenses to be made available, or the result of an attempt made to obtain a general license or permission for the use of such proprietary rights by implementers or users of this OASIS Standards Final Deliverable, can be obtained from the OASIS TC Administrator. OASIS makes no representation that any information or list of intellectual property rights will at any time be complete, or that any claims in such list are, in fact, Essential Claims.]</p>
<p>The name “OASIS” is a trademark of <a href="https://www.oasis-open.org/">OASIS</a>, the owner and developer of this specification, and should be used only to refer to the organization and its official outputs. OASIS welcomes reference to, and implementation and use of, specifications, while reserving the right to enforce its marks against misleading uses. Please see <a href="https://www.oasis-open.org/policies-guidelines/trademark/">https://www.oasis-open.org/policies-guidelines/trademark/</a> for above guidance.</p>
</div>
</body>
</html>
