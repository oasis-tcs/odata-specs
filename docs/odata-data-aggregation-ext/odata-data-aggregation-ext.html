<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="description" content="This specification adds basic grouping and aggregation functionality (e.g. sum, min, and max) to the Open Data Protocol (OData) without changing any of the base principles of OData." />
  <title>OData Extension for Data Aggregation Version 4.0</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="styles/markdown-styles-v1.7.3b.css" />
  <link rel="stylesheet" href="styles/odata.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body>
<p><img src="https://docs.oasis-open.org/templates/OASISLogo-v3.0.png" alt="OASIS Logo" /></p>
<hr />
<h1 id="odata-extension-for-data-aggregation-version-40">OData Extension for Data Aggregation Version 4.0</h1>
<h2 id="committee-specification-03">Committee Specification 03</h2>
<h2 id="19-september-2023">19 September 2023</h2>
<p> </p>
<h4 id="this-stage">This stage:</h4>
<p><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.md">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.md</a> (Authoritative)<br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.html</a><br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.pdf">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.pdf</a></p>
<h4 id="previous-stage">Previous stage:</h4>
<p><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd04/odata-data-aggregation-ext-v4.0-csd04.md">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd04/odata-data-aggregation-ext-v4.0-csd04.md</a> (Authoritative)<br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd04/odata-data-aggregation-ext-v4.0-csd04.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd04/odata-data-aggregation-ext-v4.0-csd04.html</a><br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd04/odata-data-aggregation-ext-v4.0-csd04.pdf">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/csd04/odata-data-aggregation-ext-v4.0-csd04.pdf</a></p>
<h4 id="latest-stage">Latest stage:</h4>
<p><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.md">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.md</a> (Authoritative)<br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html</a><br />
<a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.pdf">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.pdf</a></p>
<h4 id="technical-committee">Technical Committee:</h4>
<p><a href="https://www.oasis-open.org/committees/odata/">OASIS Open Data Protocol (OData) TC</a></p>
<h4 id="chairs">Chairs:</h4>
<p>Ralf Handl (<a href="mailto:ralf.handl@sap.com">ralf.handl@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Michael Pizzo (<a href="mailto:mikep@microsoft.com">mikep@microsoft.com</a>), <a href="https://www.microsoft.com/">Microsoft</a></p>
<h4 id="editors">Editors:</h4>
<p>Ralf Handl (<a href="mailto:ralf.handl@sap.com">ralf.handl@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Hubert Heijkers (<a href="mailto:hubert.heijkers@nl.ibm.com">hubert.heijkers@nl.ibm.com</a>), <a href="https://www.ibm.com/">IBM</a><br />
Gerald Krause (<a href="mailto:gerald.krause@sap.com">gerald.krause@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Michael Pizzo (<a href="mailto:mikep@microsoft.com">mikep@microsoft.com</a>), <a href="https://www.microsoft.com/">Microsoft</a><br />
Heiko Theißen (<a href="mailto:heiko.theissen@sap.com">heiko.theissen@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a><br />
Martin Zurmuehl (<a href="mailto:martin.zurmuehl@sap.com">martin.zurmuehl@sap.com</a>), <a href="https://www.sap.com/">SAP SE</a></p>
<h4 id="additional-artifacts"><a name="AdditionalArtifacts">Additional artifacts:</a></h4>
<p>This document is one component of a Work Product that also includes:</p>
<ul>
<li>ABNF components: <em>OData Aggregation ABNF Construction Rules Version 4.0 and OData Aggregation ABNF Test Cases</em>: <a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/abnf/">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/abnf/</a></li>
<li>OData Aggregation Vocabulary:
<ul>
<li><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/vocabularies/Org.OData.Aggregation.V1.json">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/vocabularies/Org.OData.Aggregation.V1.json</a></li>
<li><a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/vocabularies/Org.OData.Aggregation.V1.xml">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/vocabularies/Org.OData.Aggregation.V1.xml</a></li>
</ul></li>
</ul>
<h4 id="related-work"><a name="RelatedWork">Related work:</a></h4>
<p>This specification is related to:</p>
<ul>
<li><em>OData Version 4.01</em>. Edited by Michael Pizzo, Ralf Handl, and Martin Zurmuehl. A multi-part Work Product which includes:
<ul>
<li><em>OData Version 4.01 Part 1: Protocol</em>. Latest stage: <a href="https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html">https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html</a></li>
<li><em>OData Version 4.01 Part 2: URL Conventions</em>. Latest stage: <a href="https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part2-url-conventions.html">https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part2-url-conventions.html</a></li>
<li><em>ABNF components: OData ABNF Construction Rules Version 4.01 and OData ABNF Test Cases</em>. <a href="https://docs.oasis-open.org/odata/odata/v4.01/os/abnf/">https://docs.oasis-open.org/odata/odata/v4.01/os/abnf/</a></li>
</ul></li>
<li><em>OData Vocabularies Version 4.0</em>. Edited by Michael Pizzo, Ralf Handl, and Ram Jeyaraman. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-vocabularies/v4.0/odata-vocabularies-v4.0.html">https://docs.oasis-open.org/odata/odata-vocabularies/v4.0/odata-vocabularies-v4.0.html</a></li>
<li><em>OData Common Schema Definition Language (CSDL) JSON Representation Version 4.01</em>. Edited by Michael Pizzo, Ralf Handl, and Martin Zurmuehl. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-csdl-json/v4.01/odata-csdl-json-v4.01.html">https://docs.oasis-open.org/odata/odata-csdl-json/v4.01/odata-csdl-json-v4.01.html</a></li>
<li><em>OData Common Schema Definition Language (CSDL) XML Representation Version 4.01</em>. Edited by Michael Pizzo, Ralf Handl, and Martin Zurmuehl. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-csdl-xml/v4.01/odata-csdl-xml-v4.01.html">https://docs.oasis-open.org/odata/odata-csdl-xml/v4.01/odata-csdl-xml-v4.01.html</a></li>
<li><em>OData JSON Format Version 4.01</em>. Edited by Ralf Handl, Mike Pizzo, and Mark Biamonte. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-json-format/v4.01/odata-json-format-v4.01.html">https://docs.oasis-open.org/odata/odata-json-format/v4.01/odata-json-format-v4.01.html</a></li>
</ul>
<h4 id="abstract">Abstract:</h4>
<p>This specification adds basic grouping and aggregation functionality (e.g. sum, min, and max) to the Open Data Protocol (OData) without changing any of the base principles of OData.</p>
<h4 id="status">Status:</h4>
<p>This document was last revised or approved by the OASIS Open Data Protocol (OData) TC on the above date. The level of approval is also listed above. Check the “Latest stage” location noted above for possible later revisions of this document. Any other numbered Versions and other technical work produced by the Technical Committee (TC) are listed at <a href="https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=odata#technical">https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=odata#technical</a>.</p>
<p>TC members should send comments on this specification to the TC’s email list. Others should send comments to the TC’s public comment list, after subscribing to it by following the instructions at the “<a href="https://www.oasis-open.org/committees/comments/index.php?wg_abbrev=odata">Send A Comment</a>” button on the TC’s web page at <a href="https://www.oasis-open.org/committees/odata/">https://www.oasis-open.org/committees/odata/</a>.</p>
<p>This specification is provided under the <a href="https://www.oasis-open.org/policies-guidelines/ipr/#RF-on-RAND-Mode">RF on RAND Terms Mode</a> of the <a href="https://www.oasis-open.org/policies-guidelines/ipr/">OASIS IPR Policy</a>, the mode chosen when the Technical Committee was established. For information on whether any patents have been disclosed that may be essential to implementing this specification, and any offers of patent licensing terms, please refer to the Intellectual Property Rights section of the TC’s web page (<a href="https://www.oasis-open.org/committees/odata/ipr.php">https://www.oasis-open.org/committees/odata/ipr.php</a>).</p>
<p>Note that any machine-readable content (<a href="https://www.oasis-open.org/policies-guidelines/tc-process-2017-05-26/#wpComponentsCompLang">Computer Language Definitions</a>) declared Normative for this Work Product is provided in separate plain text files. In the event of a discrepancy between any such plain text file and display content in the Work Product’s prose narrative document(s), the content in the separate plain text file prevails.</p>
<h4 id="key-words">Key words:</h4>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in BCP 14 <a href="#rfc2119">RFC2119</a> and <a href="#rfc8174">RFC8174</a> when, and only when, they appear in all capitals, as shown here.</p>
<h4 id="citation-format">Citation format:</h4>
<p>When referencing this specification the following citation format should be used:</p>
<p><strong>[OData-Data-Agg-v4.0]</strong></p>
<p><em>OData Extension for Data Aggregation Version 4.0</em>. Edited by Ralf Handl, Hubert Heijkers, Gerald Krause, Michael Pizzo, Heiko Theißen, and Martin Zurmuehl. 19 September 2023. OASIS Committee Specification 03. <a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/cs03/odata-data-aggregation-ext-v4.0-cs03.html</a>. Latest stage: <a href="https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html">https://docs.oasis-open.org/odata/odata-data-aggregation-ext/v4.0/odata-data-aggregation-ext-v4.0.html</a>.</p>
<h4 id="notices">Notices</h4>
<p>Copyright © OASIS Open 2023. All Rights Reserved.</p>
<p>Distributed under the terms of the OASIS <a href="https://www.oasis-open.org/policies-guidelines/ipr/">IPR Policy</a>.</p>
<p>The name “OASIS” is a trademark of <a href="https://www.oasis-open.org/">OASIS</a>, the owner and developer of this specification, and should be used only to refer to the organization and its official outputs.</p>
<p>For complete copyright information please see the full Notices section in an Appendix <a href="#Notices">below</a>.</p>
<hr />
<h1 id="table-of-contents">Table of Contents</h1>
<div class="toc">
<ul>
<li><a href="#Introduction">1 Introduction</a>
<ul>
<li><a href="#Glossary">1.1 Glossary</a>
<ul>
<li><a href="#DefinitionsofTerms">1.1.1 Definitions of Terms</a></li>
<li><a href="#AcronymsandAbbreviations">1.1.2 Acronyms and Abbreviations</a></li>
<li><a href="#DocumentConventions">1.1.3 Document Conventions</a></li>
</ul></li>
</ul></li>
<li><a href="#Overview">2 Overview</a>
<ul>
<li><a href="#ExampleDataModel">2.1 Example Data Model</a></li>
<li><a href="#ExampleData">2.2 Example Data</a></li>
<li><a href="#ExampleUseCases">2.3 Example Use Cases</a></li>
</ul></li>
<li><a href="#SystemQueryOptionapply">3 System Query Option <code>$apply</code></a>
<ul>
<li><a href="#FundamentalsofInputandOutputSets">3.1 Fundamentals of Input and Output Sets</a>
<ul>
<li><a href="#TypeStructureandContextURL">3.1.1 Type, Structure and Context URL</a></li>
<li><a href="#SamenessandOrder">3.1.2 Sameness and Order</a></li>
<li><a href="#EvaluationofDataAggregationPaths">3.1.3 Evaluation of Data Aggregation Paths</a></li>
</ul></li>
<li><a href="#BasicAggregation">3.2 Basic Aggregation</a>
<ul>
<li><a href="#Transformationaggregate">3.2.1 Transformation <code>aggregate</code></a>
<ul>
<li><a href="#AggregationAlgorithm">3.2.1.1 Aggregation Algorithm</a></li>
<li><a href="#Keywordas">3.2.1.2 Keyword <code>as</code></a></li>
<li><a href="#AggregationMethods">3.2.1.3 Aggregation Methods</a>
<ul>
<li><a href="#StandardAggregationMethodsum">3.2.1.3.1 Standard Aggregation Method <code>sum</code></a></li>
<li><a href="#StandardAggregationMethodmin">3.2.1.3.2 Standard Aggregation Method <code>min</code></a></li>
<li><a href="#StandardAggregationMethodmax">3.2.1.3.3 Standard Aggregation Method <code>max</code></a></li>
<li><a href="#StandardAggregationMethodaverage">3.2.1.3.4 Standard Aggregation Method <code>average</code></a></li>
<li><a href="#StandardAggregationMethodcountdistinct">3.2.1.3.5 Standard Aggregation Method <code>countdistinct</code></a></li>
<li><a href="#CustomAggregationMethods">3.2.1.3.6 Custom Aggregation Methods</a></li>
</ul></li>
<li><a href="#AggregateExpressioncount">3.2.1.4 Aggregate Expression <code>$count</code></a></li>
<li><a href="#Keywordfrom">3.2.1.5 Keyword <code>from</code></a></li>
</ul></li>
<li><a href="#Transformationconcat">3.2.2 Transformation <code>concat</code></a></li>
<li><a href="#Transformationgroupby">3.2.3 Transformation <code>groupby</code></a>
<ul>
<li><a href="#SimpleGrouping">3.2.3.1 Simple Grouping</a></li>
<li><a href="#Groupingwithrollup">3.2.3.2 Grouping with <code>rollup</code></a></li>
</ul></li>
</ul></li>
<li><a href="#TransformationsProducingaSubset">3.3 Transformations Producing a Subset</a>
<ul>
<li><a href="#Topbottomtransformations">3.3.1 Top/bottom transformations</a>
<ul>
<li><a href="#Transformationsbottomcountandtopcount">3.3.1.1 Transformations <code>bottomcount</code> and <code>topcount</code></a></li>
<li><a href="#Transformationsbottompercentandtoppercent">3.3.1.2 Transformations <code>bottompercent</code> and <code>toppercent</code></a></li>
<li><a href="#Transformationsbottomsumandtopsum">3.3.1.3 Transformations <code>bottomsum</code> and <code>topsum</code></a></li>
</ul></li>
<li><a href="#Transformationfilter">3.3.2 Transformation <code>filter</code></a></li>
<li><a href="#Transformationorderby">3.3.3 Transformation <code>orderby</code></a></li>
<li><a href="#Transformationsearch">3.3.4 Transformation <code>search</code></a></li>
<li><a href="#Transformationskip">3.3.5 Transformation <code>skip</code></a></li>
<li><a href="#Transformationtop">3.3.6 Transformation <code>top</code></a></li>
<li><a href="#StableTotalOrderBeforeskipandtop">3.3.7 Stable Total Order Before <code>$skip</code> and <code>$top</code></a></li>
</ul></li>
<li><a href="#OnetoOneTransformations">3.4 One-to-One Transformations</a>
<ul>
<li><a href="#Transformationidentity">3.4.1 Transformation <code>identity</code></a></li>
<li><a href="#Transformationcompute">3.4.2 Transformation <code>compute</code></a></li>
<li><a href="#Transformationaddnested">3.4.3 Transformation <code>addnested</code></a></li>
</ul></li>
<li><a href="#TransformationsChangingtheInputSetStructure">3.5 Transformations Changing the Input Set Structure</a>
<ul>
<li><a href="#Transformationsjoinandouterjoin">3.5.1 Transformations <code>join</code> and <code>outerjoin</code></a></li>
<li><a href="#Transformationnest">3.5.2 Transformation <code>nest</code></a></li>
</ul></li>
<li><a href="#ExpressionsEvaluableonaCollection">3.6 Expressions Evaluable on a Collection</a>
<ul>
<li><a href="#Functionaggregate">3.6.1 Function <code>aggregate</code></a></li>
<li><a href="#Expressioncount">3.6.2 Expression <code>$count</code></a></li>
</ul></li>
<li><a href="#Functionisdefined">3.7 Function <code>isdefined</code></a></li>
<li><a href="#EvaluatingapplyasanExpandandSelectOption">3.8 Evaluating <code>$apply</code> as an Expand and Select Option</a></li>
<li><a href="#ABNFforExtendedURLConventions">3.9 ABNF for Extended URL Conventions</a></li>
</ul></li>
<li><a href="#CrossJoinsandAggregation">4 Cross-Joins and Aggregation</a></li>
<li><a href="#VocabularyforDataAggregation">5 Vocabulary for Data Aggregation</a>
<ul>
<li><a href="#AggregationCapabilities">5.1 Aggregation Capabilities</a></li>
<li><a href="#CustomAggregates">5.2 Custom Aggregates</a></li>
<li><a href="#ContextDefiningProperties">5.3 Context-Defining Properties</a></li>
<li><a href="#AnnotationExample">5.4 Annotation Example</a></li>
<li><a href="#Hierarchies">5.5 Hierarchies</a>
<ul>
<li><a href="#LeveledHierarchy">5.5.1 Leveled Hierarchy</a></li>
<li><a href="#RecursiveHierarchy">5.5.2 Recursive Hierarchy</a>
<ul>
<li><a href="#HierarchyFunctions">5.5.2.1 Hierarchy Functions</a></li>
</ul></li>
<li><a href="#HierarchyExamples">5.5.3 Hierarchy Examples</a></li>
</ul></li>
<li><a href="#FunctionsonAggregatedEntities">5.6 Functions on Aggregated Entities</a></li>
</ul></li>
<li><a href="#HierarchicalTransformations">6 Hierarchical Transformations</a>
<ul>
<li><a href="#CommonParametersforHierarchicalTransformations">6.1 Common Parameters for Hierarchical Transformations</a></li>
<li><a href="#HierarchicalTransformationsProducingaSubset">6.2 Hierarchical Transformations Producing a Subset</a>
<ul>
<li><a href="#Transformationsancestorsanddescendants">6.2.1 Transformations <code>ancestors</code> and <code>descendants</code></a></li>
<li><a href="#Transformationtraverse">6.2.2 Transformation <code>traverse</code></a>
<ul>
<li><a href="#StandardCaseoftraverse">6.2.2.1 Standard Case of <code>traverse</code></a></li>
<li><a href="#GeneralCaseoftraverse">6.2.2.2 General Case of <code>traverse</code></a></li>
</ul></li>
</ul></li>
<li><a href="#Groupingwithrolluprecursive">6.3 Grouping with <code>rolluprecursive</code></a></li>
</ul></li>
<li><a href="#Examples">7 Examples</a>
<ul>
<li><a href="#RequestingDistinctValues">7.1 Requesting Distinct Values</a></li>
<li><a href="#StandardAggregationMethods">7.2 Standard Aggregation Methods</a></li>
<li><a href="#RequestingExpandedResults">7.3 Requesting Expanded Results</a></li>
<li><a href="#RequestingCustomAggregates">7.4 Requesting Custom Aggregates</a></li>
<li><a href="#Aliasing">7.5 Aliasing</a></li>
<li><a href="#CombiningTransformationsperGroup">7.6 Combining Transformations per Group</a></li>
<li><a href="#ModelFunctionsasSetTransformations">7.7 Model Functions as Set Transformations</a></li>
<li><a href="#ControllingAggregationperRollupLevel">7.8 Controlling Aggregation per Rollup Level</a></li>
<li><a href="#AggregationinRecursiveHierarchies">7.9 Aggregation in Recursive Hierarchies</a></li>
<li><a href="#MaintainingRecursiveHierarchies">7.10 Maintaining Recursive Hierarchies</a></li>
<li><a href="#TransformationSequences">7.11 Transformation Sequences</a></li>
</ul></li>
<li><a href="#Conformance">8 Conformance</a></li>
<li><a href="#References">A References</a>
<ul>
<li><a href="#NormativeReferences">A.1 Normative References</a></li>
</ul></li>
<li><a href="#Acknowledgments">B Acknowledgments</a>
<ul>
<li><a href="#SpecialThanks">B.1 Special Thanks</a></li>
<li><a href="#Participants">B.2 Participants</a></li>
</ul></li>
<li><a href="#RevisionHistory">C Revision History</a></li>
<li><a href="#Notices">D Notices</a></li>
</ul>
</div>
<hr />
<h1 id="1-introduction"><a name="Introduction" href="#Introduction">1 Introduction</a></h1>
<p>This specification adds aggregation functionality to the Open Data Protocol (OData) without changing any of the base principles of OData. It defines semantics and a representation for aggregation of data, especially:</p>
<ul>
<li>Semantics and operations for querying aggregated data,</li>
<li>Results format for queries containing aggregated data,</li>
<li>Vocabulary terms to annotate what can be aggregated, and how.</li>
</ul>
<h2 id="11-glossary"><a name="Glossary" href="#Glossary">1.1 Glossary</a></h2>
<h3 id="111-definitions-of-terms"><a name="DefinitionsofTerms" href="#DefinitionsofTerms">1.1.1 Definitions of Terms</a></h3>
<p>This specification defines the following terms:</p>
<ul>
<li><a name="AggregatableExpression"><em>Aggregatable Expression</em></a> – an <a href="#Expression">expression</a> not involving term casts and resulting in a value of a complex or entity or an <a href="#AggregatablePrimitiveType">aggregatable primitive type</a></li>
<li><a name="AggregateExpression"><em>Aggregate Expression</em></a> – argument of the <code>aggregate</code> <a href="#Transformationaggregate">transformation</a> or <a href="#Functionaggregate">function</a> defined in <a href="#AggregationAlgorithm">section 3.2.1.1</a></li>
<li><a name="AggregatablePrimitiveType"><em>Aggregatable Primitive Type</em></a> – a primitive type other than <code>Edm.Stream</code> or subtypes of <code>Edm.Geography</code> or <code>Edm.Geometry</code></li>
<li><a name="DataAggregationPath"><em>Data Aggregation Path</em></a> – a path that consists of one or more segments joined together by forward slashes (<code>/</code>). Segments are names of declared or dynamic structural or navigation properties, or type-cast segments consisting of the (optionally qualified) name of a structured type that is derived from the type identified by the preceding path segment to reach properties declared by the derived type.</li>
<li><a name="Expression"><em>Expression</em></a> – derived from the <code>commonExpr</code> rule (see <a href="#ODataABNF">OData-ABNF</a>)</li>
<li><a name="SingleValuedPropertyPath"><em>Single-Valued Property Path</em></a> – property path ending in a single-valued primitive, complex, or navigation property</li>
</ul>
<h3 id="112-acronyms-and-abbreviations"><a name="AcronymsandAbbreviations" href="#AcronymsandAbbreviations">1.1.2 Acronyms and Abbreviations</a></h3>
<p>The following non-exhaustive list contains variable names that are used throughout this document:</p>
<ul>
<li><span class="math inline">\(A,B,C\)</span> – collections of instances</li>
<li><span class="math inline">\(H\)</span> – hierarchical collection</li>
<li><span class="math inline">\(H&#39;\)</span> – subset of nodes from a hierarchical collection</li>
<li><span class="math inline">\(u,v,w\)</span> – instances in a collection</li>
<li><span class="math inline">\(x\)</span> – an instance in a hierarchical collection, called a node</li>
<li><span class="math inline">\(p,q,r\)</span> – paths</li>
<li><span class="math inline">\(S,T\)</span> – transformation sequences</li>
<li><span class="math inline">\(α\)</span> – <a href="#AggregateExpression">aggregate expression</a>, defined in <a href="#AggregationAlgorithm">section 3.2.1.1</a></li>
<li><span class="math inline">\(\Gamma(A,p)\)</span> – the collection that results from evaluating a <a href="#DataAggregationPath">data aggregation path</a> <span class="math inline">\(p\)</span> relative to a collection <span class="math inline">\(A\)</span>, defined in <a href="#EvaluationofDataAggregationPaths">section 3.1.3</a></li>
<li><span class="math inline">\(γ(u,p)\)</span> – the collection that results from evaluating a <a href="#DataAggregationPath">data aggregation path</a> <span class="math inline">\(p\)</span> relative to an instance <span class="math inline">\(u\)</span>, defined in <a href="#EvaluationofDataAggregationPaths">section 3.1.3</a></li>
<li><span class="math inline">\(\Pi_G(s)\)</span> – a transformation of a collection that injects grouping properties into every instance of the collection, defined in <a href="#SimpleGrouping">section 3.2.3.1</a></li>
<li><span class="math inline">\(σ(x)\)</span> – instance containing a grouping property that represents a node <span class="math inline">\(x\)</span>, defined in <a href="#Transformationtraverse">section 6.2.2</a></li>
</ul>
<h3 id="113-document-conventions"><a name="DocumentConventions" href="#DocumentConventions">1.1.3 Document Conventions</a></h3>
<p>Keywords defined by this specification use <code>this  monospaced  font</code>.</p>
<p>Some sections of this specification are illustrated with non-normative examples.</p>
<div class="example">
<p>Example 1: text describing an example uses this paragraph style</p>
<pre><code>Non-normative examples use this paragraph style.</code></pre>
</div>
<p>All examples in this document are non-normative and informative only. Examples labeled with ⚠ contain advanced concepts or make use of keywords that are defined only later in the text, they can be skipped at first reading.</p>
<p>All other text is normative unless otherwise labeled.</p>
<div class="example">
<p>Here is a customized command line which will generate HTML from this markdown file (named <code>odata-data-aggregation-ext-v4.0-cs03.md</code>). Line breaks are added for readability only:</p>
<pre><code>pandoc -f gfm+tex_math_dollars+fenced_divs+smart
       -t html
       -o odata-data-aggregation-ext-v4.0-cs03.html
       -c styles/markdown-styles-v1.7.3b.css
       -c styles/odata.css
       -s
       --mathjax
       --eol=lf
       --wrap=none
       --metadata pagetitle=&quot;OData Extension for Data Aggregation Version 4.0&quot;
       odata-data-aggregation-ext-v4.0-cs03.md</code></pre>
<p>This uses pandoc 3.1.12.2 from <a href="https://github.com/jgm/pandoc/releases/tag/3.1.12.2">https://github.com/jgm/pandoc/releases/tag/3.1.12.2</a>.</p>
</div>
<hr />
<h1 id="2-overview"><a name="Overview" href="#Overview">2 Overview</a></h1>
<p>Open Data Protocol (OData) services expose a data model that describes the schema of the service in terms of the Entity Data Model (EDM, see <a href="#ODataCSDL">OData-CSDL</a>) and then allows for querying data in terms of this model. The responses returned by an OData service are based on that data model and retain the relationships between the entities in the model.</p>
<p>Extending the OData query features with simple aggregation capabilities avoids cluttering OData services with an exponential number of explicitly modeled “aggregation level entities” or else restricting the consumer to a small subset of predefined aggregations.</p>
<p>Adding the notion of aggregation to OData without changing any of the base principles in OData has two aspects:</p>
<ol type="1">
<li>Means for the consumer to query aggregated data on top of any given data model (for sufficiently capable data providers)</li>
<li>Means for the provider to annotate what data can be aggregated, and in which way, allowing consumers to avoid asking questions that the provider cannot answer</li>
</ol>
<p>Implementing any of these two aspects is valuable in itself independent of the other, and implementing both provides additional value for consumers. The provided aggregation annotations help a consumer understand more of the data structure looking at the service’s exposed data model. The query extensions allow the consumers to explicitly express the desired aggregation behavior for a particular query. They also allow consumers to formulate queries that utilize the aggregation annotations.</p>
<h2 id="21-example-data-model"><a name="ExampleDataModel" href="#ExampleDataModel">2.1 Example Data Model</a></h2>
<div class="example">
<p>Example 2: The following diagram depicts a simple model that is used throughout this document.</p>
<svg xmlns:xlink="http://www.w3.org/1999/xlink" class="st20" viewBox="0 200 600 350" style="width:75em">
  <style type="text/css">
  <![CDATA[
    .st1 {fill:#f2f2f2;stroke:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st2 {fill:#ffffff;stroke:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.7}
    .st3 {fill:#000000;font-size:0.666664em}
    .st4 {font-size:1em}
    .st5 {stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st6 {fill:none;visibility:hidden}
    .st7 {stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.4}
    .st8 {fill:#000000;font-size:0.833336em}
    .st9 {fill:#000000;font-size:0.833336em;font-style:italic}
    .st10 {fill:none}
    .st11 {marker-start:url(#mrkr1-125);stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75;visibility:hidden}
    .st12 {fill:#000000;fill-opacity:1;stroke:#000000;stroke-opacity:1;stroke-width:0.22935779816514}
    .st13 {fill:#000000;font-size:0.75em}
    .st14 {fill:#000000;fill-opacity:1;stroke:#000000;stroke-opacity:1;stroke-width:0.22222222222222}
    .st15 {stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72}
    .st16 {marker-end:url(#mrkr1-200);stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72}
    .st17 {fill:none;stroke:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st18 {fill:#000000;font-size:0.75em}
    .st19 {marker-end:url(#mrkr14-311);stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.75}
    .st20 {fill:none;fill-rule:evenodd;font-size:12px;overflow:visible;stroke-linecap:square;stroke-miterlimit:3}
  ]]>
  </style>
  <defs id="Markers">
    <g id="lend1">
      <path d="M 1 -1 L 0 0 L 1 1 "
        style="stroke-linecap:round;stroke-linejoin:round;fill:none" />
    </g>
    <marker id="mrkr1-125" class="st12" orient="auto"
      markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend1" transform="scale(4.36) " />
    </marker>
    <g id="lend2">
      <path d="M 1 1 L 0 0 L 1 -1 L 1 1 " style="stroke:none" />
    </g>
    <marker id="mrkr2-137" class="st14" refX="-4.5" orient="auto"
      markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend2" transform="scale(-4.5,-4.5) " />
    </marker>
    <marker id="mrkr1-200" class="st14" orient="auto"
      markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend1" transform="scale(-4.5,-4.5) " />
    </marker>
    <g id="lend14">
      <path d="M 3 -1 L 0 0 L 3 1 L 3 -1 "
        style="stroke-linecap:round;stroke-linejoin:round;fill:none" />
    </g>
    <marker id="mrkr14-311" class="st12" refX="-13.08"
      orient="auto" markerUnits="strokeWidth" overflow="visible">
      <use xlink:href="#lend14" transform="scale(-4.36,-4.36) " />
    </marker>
  </defs>
  <g id="group1000-1" transform="translate(208.346,-446.457)">
    <g id="shape1001-2" transform="translate(0,-28.3465)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1002-4">
      <rect x="0" y="813.543" width="110.551" height="28.3465"
        class="st2" />
      <text x="4" y="825.32" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Amount: Edm.Decimal</tspan>
      </text>
    </g>
    <g id="shape1003-8">
    </g>
    <g id="shape1004-10" transform="translate(-4.79616E-14,-28.3465)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1005-13">
    </g>
    <g id="shape1006-15">
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st6" />
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st7" />
    </g>
    <g id="shape1000-18">
      <text x="45.27" y="805.2" class="st8">Sale</text>
    </g>
  </g>
  <g id="group1007-20" transform="translate(208.346,-566.929)">
    <g id="shape1008-21" transform="translate(0,-48.7559)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1009-23">
      <rect x="0" y="793.134" width="110.551" height="48.7559"
        class="st2" />
      <text x="4" y="805.51" class="st3">
        Date: Edm.Date {id}
        <tspan x="4" dy="1.2em" class="st4">Month: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Quarter: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Year: Edm.Int16</tspan>
      </text>
    </g>
    <g id="shape1010-29">
    </g>
    <g id="shape1011-31" transform="translate(-4.79616E-14,-48.7559)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1012-34">
    </g>
    <g id="shape1013-36">
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st6" />
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st7" />
    </g>
    <g id="shape1007-39">
      <text x="44.16" y="784.8" class="st8">Time</text>
    </g>
  </g>
  <g id="group1014-41" transform="translate(26.7784,-442.205)">
    <g id="shape1015-42" transform="translate(0,-36.8504)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1016-44">
      <rect x="0" y="805.039" width="110.551" height="36.8504"
        class="st2" />
      <text x="4" y="816.26" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Country: Edm.String</tspan>
      </text>
    </g>
    <g id="shape1017-49">
    </g>
    <g id="shape1018-51" transform="translate(-4.79616E-14,-36.8504)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1019-54">
    </g>
    <g id="shape1020-56">
      <rect x="0" y="782.362" width="110.551" height="59.5276"
        class="st6" />
      <rect x="0" y="782.362" width="110.551" height="59.5276"
        class="st7" />
    </g>
    <g id="shape1014-59">
      <text x="33.6" y="796.7" class="st8">Customer</text>
    </g>
  </g>
  <g id="group1028-61" transform="translate(384.094,-577.134)">
    <g id="shape1029-62" transform="translate(0,-28.3465)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1030-64">
      <rect x="0" y="813.543" width="110.551" height="28.3465"
        class="st2" />
      <text x="4" y="825.32" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String</tspan>
      </text>
    </g>
    <g id="shape1031-68">
    </g>
    <g id="shape1032-70" transform="translate(-4.79616E-14,-28.3465)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1033-73">
    </g>
    <g id="shape1034-75">
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st6" />
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st7" />
    </g>
    <g id="shape1028-78">
      <text x="34.99" y="805.2" class="st8">Category</text>
    </g>
  </g>
  <g id="group1035-80" transform="translate(384.094,-436.252)">
    <g id="shape1036-81" transform="translate(0,-48.7559)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1037-83">
      <rect x="0" y="793.134" width="110.551" height="48.7559"
        class="st2" />
      <text x="4" y="805.51" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">Color: Edm.String </tspan>
        <tspan x="4" dy="1.2em" class="st4">TaxRate: Edm.Decimal</tspan>
      </text>
    </g>
    <g id="shape1038-89">
    </g>
    <g id="shape1039-91" transform="translate(-4.79616E-14,-48.7559)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1040-94">
    </g>
    <g id="shape1041-96">
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st6" />
      <rect x="0" y="770.457" width="110.551" height="71.4331"
        class="st7" />
    </g>
    <g id="shape1035-99">
      <text x="38.04" y="784.8" class="st9">Product</text>
    </g>
  </g>
  <g id="group1042-101" transform="translate(208.346,-324)">
    <g id="shape1043-102" transform="translate(0,-28.3465)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1044-104">
      <rect x="0" y="813.543" width="110.551" height="28.3465"
        class="st2" />
      <text x="4" y="825.32" class="st3">
        ID: Edm.String {id}
        <tspan x="4" dy="1.2em" class="st4">Name: Edm.String</tspan>
      </text>
    </g>
    <g id="shape1045-108">
    </g>
    <g id="shape1046-110" transform="translate(-4.79616E-14,-28.3465)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1047-113">
    </g>
    <g id="shape1048-115">
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st6" />
      <rect x="0" y="790.866" width="110.551" height="51.0236"
        class="st7" />
    </g>
    <g id="shape1042-118">
      <text x="14.42" y="805.2" class="st8">SalesOrganization</text>
    </g>
  </g>
  <g id="group1054-120" transform="translate(208.346,-464.882)">
    <g id="shape1055-121" transform="translate(-70.1169,-22.1102)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1056-127" transform="translate(-15.5072,7.65354)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1057-132" transform="translate(0,1673.86) rotate(180)">
    </g>
    <g id="shape1058-134" transform="translate(-47.847,-1.27717)">
    </g>
    <g id="shape1054-138">
      <path d="M0 834.8 L-71.02 834.8" class="st15" />
    </g>
  </g>
  <g id="group1064-141" transform="translate(318.898,-464.882)">
    <g id="shape1065-142" transform="translate(48.9382,-22.1102)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1066-147" transform="translate(0.0833553,8.50393)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1067-152" transform="translate(0,-4.25197)">
    </g>
    <g id="shape1068-154" transform="translate(20.2598,-1.27717)">
    </g>
    <g id="shape1064-157">
      <path d="M0 834.8 L65.2 834.8" class="st15" />
    </g>
  </g>
  <g id="group1069-160" transform="translate(432.283,-577.134)">
    <g id="shape1070-161" transform="translate(5.75265,55.559)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1071-166" transform="translate(-10.5894,14.1732)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1072-171"
      transform="translate(846.142,841.89) rotate(90)">
    </g>
    <g id="shape1073-173" transform="translate(-5.25197,44.0181)">
    </g>
    <g id="shape1069-176">
      <path d="M7.09 841.89 L7.09 911.34" class="st15" />
    </g>
  </g>
  <g id="group1079-179" transform="translate(263.622,-324)">
    <g id="shape1080-180" transform="translate(67.1811,-12.7559)">
      <rect x="0" y="830.551" width="22.6772" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="22.6772" height="11.3386"
        class="st11" />
      <text x="3.83" y="838.92" class="st13">0..1</text>
    </g>
    <g id="shape1081-185" transform="translate(-14.0899,14.1732)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1082-190"
      transform="translate(839.055,841.89) rotate(90)">
    </g>
    <g id="shape1083-192" transform="translate(15.2992,-7.4189)">
    </g>
    <g id="shape1079-195">
      <path
        d="M0 841.89 L-0 852.52 A8.50394 8.50394 -180 0 0 8.5 861.02 L57.4 861.02 A8.50394 8.50394 -180 0 0 65.91 852.52
               L65.91 821.69 A5.31496 5.31496 -180 0 0 60.59 816.38 L55.28 816.38"
        class="st16" />
    </g>
  </g>
  <g id="group1084-201" transform="translate(256.535,-446.457)">
    <g id="shape1085-202" transform="translate(-6.90433,69.4488)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1086-207" transform="translate(5.75264,14.4567)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1087-212"
      transform="translate(846.142,841.89) rotate(90)">
    </g>
    <g id="shape1088-214" transform="translate(-5.25197,45.0929)">
    </g>
    <g id="shape1084-217">
      <path d="M7.09 841.89 L7.09 913.32" class="st16" />
    </g>
  </g>
  <g id="group1094-222" transform="translate(256.535,-497.48)">
    <g id="shape1095-223" transform="translate(-9.17205,-52.441)">
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="15.5095" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">1</text>
    </g>
    <g id="shape1096-228" transform="translate(7.16997,0.708661)">
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st10" />
      <rect x="0" y="830.551" width="14.0065" height="11.3386"
        class="st11" />
      <text x="5.25" y="838.92" class="st13">*</text>
    </g>
    <g id="shape1097-233"
      transform="translate(-831.969,841.89) rotate(-90)">
    </g>
    <g id="shape1098-235" transform="translate(-5.25197,-31.2181)">
    </g>
    <g id="shape1094-238">
      <path d="M7.09 841.89 L7.09 772.44" class="st16" />
    </g>
  </g>
  <g id="shape1099-243" transform="translate(173.622,-446.457)">
    <rect x="0" y="827.717" width="35.4331" height="14.1732"
      class="st17" />
    <text x="7.43" y="837.8" class="st18">Sales</text>
  </g>
  <g id="shape1100-246" transform="translate(317.126,-446.457)">
    <rect x="0" y="827.717" width="35.4331" height="14.1732"
      class="st17" />
    <text x="7.43" y="837.8" class="st18">Sales</text>
  </g>
  <g id="shape1101-249" transform="translate(138.114,-474.803)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="5.09" y="837.8" class="st18">Customer</text>
  </g>
  <g id="shape1102-252" transform="translate(336.539,-474.803)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="8.87" y="837.8" class="st18">Product</text>
  </g>
  <g id="shape1103-255" transform="translate(436.385,-510.236)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="6.92" y="837.8" class="st18">Products</text>
  </g>
  <g id="shape1104-258" transform="translate(389.613,-552.756)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="6.66" y="837.8" class="st18">Category</text>
  </g>
  <g id="shape1105-261" transform="translate(233.707,-538.583)">
    <rect x="0" y="827.717" width="49.7571" height="14.1732"
      class="st17" />
    <text x="4" y="837.8" class="st18">Time</text>
  </g>
  <g id="shape1106-264" transform="translate(183.366,-388.878)">
    <rect x="0" y="827.717" width="92.126" height="14.1732"
      class="st17" />
    <text x="4" y="837.8" class="st18">SalesOrganization</text>
  </g>
  <g id="shape1108-267" transform="translate(330.236,-324)">
    <rect x="0" y="827.717" width="69.7039" height="14.1732"
      class="st17" />
    <text x="4" y="837.8" class="st18">Superordinate</text>
  </g>
  <g id="group1110-270" transform="translate(432.283,-368.504)">
    <g id="shape1111-271" transform="translate(0,-20.4094)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1112-273">
      <rect x="0" y="821.48" width="110.551" height="20.4094"
        class="st2" />
      <text x="4" y="834.09" class="st3">Rating: Edm.Byte</text>
    </g>
    <g id="shape1113-276">
    </g>
    <g id="shape1114-278" transform="translate(-4.79616E-14,-20.4094)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1115-281">
    </g>
    <g id="shape1116-283">
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st6" />
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st7" />
    </g>
    <g id="shape1110-286">
      <text x="26.65" y="813.14" class="st8">FoodProduct</text>
    </g>
  </g>
  <g id="group1117-288" transform="translate(432.283,-308.153)">
    <g id="shape1118-289" transform="translate(0,-20.4094)">
      <rect x="0" y="819.213" width="110.551" height="22.6772"
        class="st1" />
    </g>
    <g id="shape1119-291">
      <rect x="0" y="821.48" width="110.551" height="20.4094"
        class="st2" />
      <text x="4" y="834.09" class="st3">RatingClass: Edm.String</text>
    </g>
    <g id="shape1120-294">
    </g>
    <g id="shape1121-296" transform="translate(-4.79616E-14,-20.4094)">
      <path d="M0 841.89 L110.55 841.89" class="st5" />
    </g>
    <g id="shape1122-299">
    </g>
    <g id="shape1123-301">
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st6" />
      <rect x="0" y="798.803" width="110.551" height="43.0866"
        class="st7" />
    </g>
    <g id="shape1117-304">
      <text x="17.48" y="813.14" class="st8">NonFoodProduct</text>
    </g>
  </g>
  <g id="shape1124-306" transform="translate(432.283,-390.047)">
    <path d="M0 841.89 L-20.55 841.89 L-20.55 805.5" class="st19" />
  </g>
  <g id="shape1125-312" transform="translate(432.283,-329.697)">
    <path d="M0 841.89 L-20.55 841.89 L-20.55 745.14" class="st19" />
  </g>
</svg>

<p>The <code>Amount</code> property in the <code>Sale</code> entity type is an <a href="#AggregationCapabilities">aggregatable property</a>, and the properties of the related entity types are groupable. These can be arranged in hierarchies, for example:</p>
<ul>
<li>Product hierarchy based on <a href="#AggregationCapabilities">groupable</a> properties of the <code>Category</code> and <code>Product</code> entity types</li>
<li>Customer <a href="#LeveledHierarchy">hierarchy</a> based on <code>Country</code> and <code>Customer</code></li>
<li>Time <a href="#LeveledHierarchy">hierarchy</a> based on <code>Year</code>, <code>Month</code>, and <code>Date</code></li>
<li>SalesOrganization <a href="#RecursiveHierarchy">hierarchy</a> based on the recursive association to itself</li>
</ul>
<p>In the context of Online Analytical Processing (OLAP), this model might be described in terms of a Sales “cube” with an Amount “measure” and three “dimensions”. This document will avoid such terms, as they are heavily overloaded.</p>
</div>
<p>Query extensions and descriptive annotations can be applied to normalized schemas as well as partly or fully denormalized schemas.</p>
<div class="example">
<p>Example 3: The following diagram depicts a denormalized schema for the simple model.</p>
<table>
  <tr><th colspan="2">Sale</th></tr>
  <tr><td rowspan="2">Sales</td><td>ID: Edm.String {id}</td></tr>
  <tr><td>Amount: Edm.Decimal</td></tr>
  <tr><td rowspan="2">Category</td><td>CategoryID: Edm.String</td></tr>
  <tr><td>CategoryName: Edm.String</td></tr>
  <tr><td rowspan="4">Product</td><td>ProductID: Edm.String</td></tr>
  <tr><td>ProductName: Edm.String</td></tr>
  <tr><td>ProductColor: Edm.String</td></tr>
  <tr><td>ProductTaxRate: Edm.Decimal</td></tr>
  <tr><td rowspan="1">Food</td><td>FoodProductRating: Edm.Byte</td></tr>
  <tr><td rowspan="1">Non-Food</td><td>NonFoodProductRatingClass: Edm.String</td></tr>
  <tr><td rowspan="3">Sales Organization</td><td>SalesOrganizationID: Edm.String</td></tr>
  <tr><td>SalesOrganizationName: Edm.String</td></tr>
  <tr><td>SalesOrganizationSuperordinateID: Edm.String</td></tr>
  <tr><td rowspan="4">Time</td><td>TimeDate: Edm.Date</td></tr>
  <tr><td>TimeMonth: Edm.String</td></tr>
  <tr><td>TimeQuarter: Edm.String</td></tr>
  <tr><td>TimeYear: Edm.Int16</td></tr>
  <tr><td rowspan="3">Customer</td><td>CustomerID: Edm.String</td></tr>
  <tr><td>CustomerName: Edm.String</td></tr>
  <tr><td>CustomerCountry: Edm.String</td></tr>
</table>

</div>
<h2 id="22-example-data"><a name="ExampleData" href="#ExampleData">2.2 Example Data</a></h2>
<div class="example">
<p>Example 4: The following entity sets and sample data will be used to further illustrate the capabilities introduced by this extension.</p>
<div class="example-data" style="width:600px;height:700px">
<svg viewBox="0 0 600 700">
  <defs>
    <marker id="begin" viewBox="0 0 10 10" refX="0" refY="5" orient="auto" markerWidth="5" markerHeight="5">
      <path d="M10,0 L0,5 L10,10 z" />
    </marker>
    <marker id="end" viewBox="0 0 10 10" refX="10" refY="5" orient="auto" markerWidth="5" markerHeight="5">
      <path d="M0,0 L10,5 L0,10 z" />
    </marker>
  </defs>
  <path d="M310,150 l45,50" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M50,485 l0,-35" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M160,485 l30,-185" marker-end="url(#end)" />
  <path d="M215,485 l45,-335" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M300,485 l55,-165" marker-start="url(#begin)" marker-end="url(#end)" />
  <path d="M525,300 l-40,-20" marker-end="url(#end)" />
</svg>

<div class="nav-2" style="left:250px">
<p>Products</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Category</th>
<th>Name</th>
<th>Color</th>
<th style="text-align: right;">TaxRate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>P1</td>
<td>PG1</td>
<td>Sugar</td>
<td>White</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="even">
<td>P2</td>
<td>PG1</td>
<td>Coffee</td>
<td>Brown</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="odd">
<td>P3</td>
<td>PG2</td>
<td>Paper</td>
<td>White</td>
<td style="text-align: right;">0.14</td>
</tr>
<tr class="even">
<td>P4</td>
<td>PG2</td>
<td>Pencil</td>
<td>Black</td>
<td style="text-align: right;">0.14</td>
</tr>
</tbody>
</table>
</div>
<div style="left:510px">
<p>Food</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;"> </td>
</tr>
<tr class="odd">
<td style="text-align: right;">n/a</td>
</tr>
<tr class="even">
<td style="text-align: right;">n/a</td>
</tr>
</tbody>
</table>
</div>
<div style="left:570px">
<p>Non-Food</p>
<table>
<thead>
<tr class="header">
<th>RatingClass</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n/a</td>
</tr>
<tr class="even">
<td>n/a</td>
</tr>
<tr class="odd">
<td>average</td>
</tr>
<tr class="even">
<td> </td>
</tr>
</tbody>
</table>
</div>
<div style="top:150px">
<p>Time</p>
<table>
<thead>
<tr class="header">
<th>Date</th>
<th>Month</th>
<th>Quarter</th>
<th>Year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2022-01-01</td>
<td>2022-01</td>
<td>2022-1</td>
<td>2022</td>
</tr>
<tr class="even">
<td>2022-04-01</td>
<td>2022-04</td>
<td>2022-2</td>
<td>2022</td>
</tr>
<tr class="odd">
<td>2022-04-10</td>
<td>2022-04</td>
<td>2022-2</td>
<td>2022</td>
</tr>
<tr class="even">
<td>…</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div style="top:150px;left:360px">
<p>Categories</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PG1</td>
<td>Food</td>
</tr>
<tr class="even">
<td>PG2</td>
<td>Non-Food</td>
</tr>
</tbody>
</table>
</div>
<div class="nav-2" style="top:260px;left:360px">
<p>Sales Organizations</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Superordinate</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sales</td>
<td></td>
<td>Corporate Sales</td>
</tr>
<tr class="even">
<td>US</td>
<td>Sales</td>
<td>US</td>
</tr>
<tr class="odd">
<td>US West</td>
<td>US</td>
<td>US West</td>
</tr>
<tr class="even">
<td>US East</td>
<td>US</td>
<td>US East</td>
</tr>
<tr class="odd">
<td>EMEA</td>
<td>Sales</td>
<td>EMEA</td>
</tr>
<tr class="even">
<td>EMEA Central</td>
<td>EMEA</td>
<td>EMEA Central</td>
</tr>
</tbody>
</table>
</div>
<div style="top:300px">
<p>Customers</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Name</th>
<th>Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>C1</td>
<td>Joe</td>
<td>USA</td>
</tr>
<tr class="even">
<td>C2</td>
<td>Sue</td>
<td>USA</td>
</tr>
<tr class="odd">
<td>C3</td>
<td>Sue</td>
<td>Netherlands</td>
</tr>
<tr class="even">
<td>C4</td>
<td>Luc</td>
<td>France</td>
</tr>
</tbody>
</table>
</div>
<div class="nav-2 nav-3 nav-4 nav-5" style="top:450px">
<p>Sales</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Customer</th>
<th>Time</th>
<th>Product</th>
<th>Sales Organization</th>
<th style="text-align: right;">Amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>C1</td>
<td>2022-01-03</td>
<td>P3</td>
<td>US West</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>2</td>
<td>C1</td>
<td>2022-04-10</td>
<td>P1</td>
<td>US West</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C1</td>
<td>2022-08-07</td>
<td>P2</td>
<td>US West</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>4</td>
<td>C2</td>
<td>2022-01-03</td>
<td>P2</td>
<td>US East</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td>5</td>
<td>C2</td>
<td>2022-11-09</td>
<td>P3</td>
<td>US East</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>6</td>
<td>C3</td>
<td>2022-04-01</td>
<td>P1</td>
<td>EMEA Central</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>7</td>
<td>C3</td>
<td>2022-08-06</td>
<td>P3</td>
<td>EMEA Central</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>8</td>
<td>C3</td>
<td>2022-11-22</td>
<td>P3</td>
<td>EMEA Central</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
<div class="legend" style="top:470px;left:500px">
<p>Legend</p>
<table>
<thead>
<tr class="header">
<th>Property</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Key</td>
</tr>
<tr class="even">
<td>Navigation Property</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<h2 id="23-example-use-cases"><a name="ExampleUseCases" href="#ExampleUseCases">2.3 Example Use Cases</a></h2>
<div class="example">
<p>Example 5: In the example model, one prominent use case is the relation of customers to products. The first question that is likely to be asked is: “Which customers bought which products?”</p>
<p>This leads to the second more quantitative question: “Who bought how much of what?”</p>
<p>The answer to the second question typically is visualized as a cross-table:</p>
<div class="cross">
<table>
<tbody>
<tr class="odd">
<td></td>
<td></td>
<td style="text-align: right;">Food</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;">Non-Food</td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td style="text-align: right;"></td>
<td style="text-align: right;">Sugar</td>
<td style="text-align: right;">Coffee</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">Paper</td>
</tr>
<tr class="odd">
<td>USA</td>
<td></td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td></td>
<td>Joe</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td></td>
<td>Sue</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td></td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td></td>
<td>Sue</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
</div>
<p>The data in this cross-table can be written down in a shape that more closely resembles the structure of the data model, leaving cells empty that have been aggregated away:</p>
<table>
<thead>
<tr class="header">
<th>Customer/Country</th>
<th>Customer/Name</th>
<th>Product/Category/Name</th>
<th>Product/Name</th>
<th style="text-align: right;">Amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>USA</td>
<td>Joe</td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Joe</td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Joe</td>
<td>Food</td>
<td>Coffee</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Sue</td>
<td>Food</td>
<td>Coffee</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Sue</td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td>Sue</td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td>Sue</td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td>USA</td>
<td></td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td>USA</td>
<td></td>
<td>Food</td>
<td>Coffee</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td>USA</td>
<td></td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td></td>
<td>Food</td>
<td>Sugar</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td></td>
<td>Non-Food</td>
<td>Paper</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Joe</td>
<td>Food</td>
<td></td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Joe</td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td>USA</td>
<td>Sue</td>
<td>Food</td>
<td></td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td>USA</td>
<td>Sue</td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td>Sue</td>
<td>Food</td>
<td></td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td>Sue</td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td>USA</td>
<td></td>
<td>Food</td>
<td></td>
<td style="text-align: right;">14</td>
</tr>
<tr class="even">
<td>USA</td>
<td></td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td>Netherlands</td>
<td></td>
<td>Food</td>
<td></td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>Netherlands</td>
<td></td>
<td>Non-Food</td>
<td></td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
<p>Note that this result contains seven fully qualified aggregate values, followed by fifteen rollup rows with subtotal values.</p>
</div>
<hr />
<h1 id="3-system-query-option-apply"><a name="SystemQueryOptionapply" href="#SystemQueryOptionapply">3 System Query Option <code>$apply</code></a></h1>
<p>A <em>set transformation</em> (<em>transformation</em> for short) is an operation on an input set that produces an output set. A <em>transformation sequence</em> is a sequence of set transformations, separated by forward slashes to express that they are consecutively applied. A transformation sequence may be invoked using the system query option <code>$apply</code>. The input set of the first set transformation is the collection addressed by the resource path. The output set of each set transformation is the input set for the next set transformation. The output set of the last set transformation in the transformation sequence invoked by the system query option <code>$apply</code> is the result of <code>$apply</code>. This is consistent with the use of service-defined bound and composable functions in path segments. Set transformations may also appear as a parameter of certain other set transformations defined below.</p>
<p>The system query option <code>$apply</code> MUST NOT be used if the resource path addresses a single instance.</p>
<p>The system query option <code>$apply</code> is evaluated first, then the other system query options are evaluated, if applicable, on the result of <code>$apply</code>, see <a href="#ODataProtocol">OData-Protocol, section 11.2.1</a>. Stability across requests for system query options <code>$top</code> and <code>$skip</code> <a href="#ODataProtocol">OData-Protocol, sections 11.2.6.3 and 11.2.6.4</a> is defined in <a href="#StableTotalOrderBeforeskipandtop">section 3.3.7</a>.</p>
<p>Each set transformation:</p>
<ul>
<li>carries over the input type to the output set such that it fits into the data model of the service.</li>
<li>can mark certain navigation properties and stream properties for <em>expansion by default</em>, that is, they are expanded in the result of <code>$apply</code> in the absence of an <code>$expand</code> query option.</li>
<li>may produce an output set with a different number of instances than the input set.</li>
<li>does not necessarily guarantee that all properties of the instances in the output set have a well-defined value.</li>
</ul>
<p>Instances of an output set can contain structural and navigation properties, which can be declared or dynamic, as well as instance annotations.</p>
<p>The allowed set transformations are defined in this section as well as in the section on <a href="#HierarchicalTransformations">Hierarchical Transformations</a>.</p>
<p>Service-defined bound functions that take a collection of instances of a structured type as their binding parameter and return a collection of instances of a structured type MAY be used as set transformations within <code>$apply</code>. Further transformations can follow the bound function. The parameter syntax for bound function segments is identical to the parameter syntax for bound functions in resource path segments or <code>$filter</code> expressions. See <a href="#ModelFunctionsasSetTransformations">section 7.7</a> for an example.</p>
<p>If a data service that supports <code>$apply</code> does not support it on the collection identified by the request resource path, it MUST fail with <code>501 Not Implemented</code> and a meaningful human-readable error message.</p>
<p>On resource paths ending in <code>/$count</code> the system query option <code>$apply</code> is evaluated on the set identified by the resource path without the <code>/$count</code> segment, the result is the plain-text number of items in the result of <code>$apply</code>. This is similar to the combination of <code>/$count</code> and <code>$filter</code>.</p>
<p>During serialization of the result of <code>$apply</code> declared properties and dynamic properties are represented as defined by the response format. Other properties have been aggregated away and are not represented in the response. The entities returned in the request examples in the following sections that involve aggregation are therefore transient.</p>
<h2 id="31-fundamentals-of-input-and-output-sets"><a name="FundamentalsofInputandOutputSets" href="#FundamentalsofInputandOutputSets">3.1 Fundamentals of Input and Output Sets</a></h2>
<p>The definitions of italicized terms made in this section are used throughout this text, always with a hyperlink to this section.</p>
<h3 id="311-type-structure-and-context-url"><a name="TypeStructureandContextURL" href="#TypeStructureandContextURL">3.1.1 Type, Structure and Context URL</a></h3>
<p>All input sets and output sets in one transformation sequence are collections of the <em>input type</em>, that is the entity type or complex type of the first input set, or in other words, of the resource to which the transformation sequence is applied. The input type is determined by the entity model element identified within the metadata document by the context URL of that resource <a href="#ODataProtocol">OData-Protocol, section 10</a>. Individual instances in an input or output set can have a subtype of the input type. (See <a href="#subinputtype">example 74</a>.) The transformation sequence given as the <code>$apply</code> system query option is applied to the resource addressed by the resource path. The transformations defined below can have nested transformation sequences as parameters, these are then applied to resources that can differ from the current input set.</p>
<p>The <em>structure</em> of an instance that occurs in an input or output set is defined by the names of the structural and navigation properties that the instance contains. Instances of an input type can have different structures, subject to the following rules:</p>
<ul>
<li>Declared properties of the input type or a nested or related type thereof or of a subtype of one of these MUST have their declared type and meaning when they occur in an input or output set.</li>
<li>Single- or collection-valued primitive properties addressed by a property path starting at a non-transient entity MUST keep their values from the addressed resource path collection throughout the transformation sequence. Likewise, single- or collection-valued navigation property paths starting at a non-transient entity MUST keep addressing the same non-transient entities as in the addressed resource path collection.</li>
<li>Instances in an output set need not have all declared or dynamic properties that occurred in the input set.</li>
<li>Instances in an output set can have dynamic properties that did not occur in the input set. The name for such a dynamic property is called an <em>alias</em>, it is a simple identifier (see <a href="#ODataCSDL">OData-CSDL, section 17.2</a>). Aliases MUST differ from names of declared properties in the input type, from names of properties in the first input set, and from names of properties in the current input set. Aliases in one collection MUST also differ from each other.</li>
</ul>
<p>Here is an overview of the structural changes made by different transformations:</p>
<ul>
<li>During <a href="#BasicAggregation">aggregation</a> or <a href="#Transformationnest">nest</a>, many instances are replaced by one instance, properties that represent the aggregation level are retained, and others are replaced by dynamic properties holding the aggregate value of the many instances or a transformed copy of them.</li>
<li>During <a href="#Transformationcompute">compute</a>, dynamic properties are added to each instance.</li>
<li>During <a href="#Transformationaddnested">addnested</a>, dynamic properties are added to each occurrence of a related collection.</li>
<li>During <a href="#Transformationsjoinandouterjoin">join</a>, one instance with a collection of related instances is replaced by many copies, each of which is related via a dynamic property to one of the related instances.</li>
<li>During <a href="#Transformationconcat">concatenation</a>, the same instances are transformed multiple times and the output sets with their potentially different structures are concatenated.</li>
</ul>
<p>An output set thus consists of instances with different structures. This is the same situation as with a collection of an open type <a href="#ODataCSDL">OData-CSDL, sections 6.3 and 9.3</a> and it is handled in the same way.</p>
<p>If the first input set is a collection of entities from a given entity set, then so are all input sets and output sets in the transformation sequence. The <code>{select-list}</code> in the context URL <a href="#ODataProtocol">OData-Protocol, section 10</a> MUST describe only properties that are present or annotated as absent (for example, if <code>Core.Permissions</code> is <code>None</code> <a href="#ODataProtocol">OData-Protocol, section 11.2.2</a>) in all instances of the collection, after applying any <code>$select</code> and <code>$expand</code> system query options. The <code>{select-list}</code> SHOULD describe as many such properties as possible, even if the request involves a concatenation that leads to a non-homogeneous structure. If the server cannot determine any such properties, the <code>{select-list}</code> MUST consist of just the instance annotation <code>AnyStructure</code> defined in the <code>Core</code> vocabulary <a href="#ODataVocCore">OData-VocCore</a>. (See <a href="#anystructure">example 75</a>.)</p>
<h3 id="312-sameness-and-order"><a name="SamenessandOrder" href="#SamenessandOrder">3.1.2 Sameness and Order</a></h3>
<p>Input sets and output sets are not sets of instances in the mathematical sense but collections, because the same instance can occur multiple times in them. In other words: A collection contains values (which can be instances of structured types or primitive values), possibly with repetitions. The occurrences of the values in the collection form a set in the mathematical sense. The <em>cardinality</em> of a collection is the total number of occurrences in it. When this text describes a transformation algorithmically and stipulates that certain steps are carried out <em>for each occurrence</em> in a collection, this means that the steps are carried out multiple times for the same value if it occurs multiple times in the collection.</p>
<p>A collection addressed by the resource path is returned by the service either as an ordered collection <a href="#ODataProtocol">OData-Protocol, section 11.4.10</a> or as an unordered collection. The same applies to collections that are nested in or related to the addressed resource as well as to collections that are the result of evaluating an expression starting with <code>$root</code>, which occur, for example, as the first parameter of a <a href="#HierarchicalTransformations">hierarchical transformation</a>.</p>
<p>But when such a collection is transformed by the <code>$apply</code> system query option, additional cases can arise that are neither ordered nor totally unordered. For example, the <a href="#Transformationgroupby"><code>groupby</code></a> transformation retains any order within a group but not between groups.</p>
<div class="example">
<p>⚠ Example 6: Request the top 10 sales per customer. The processing of the request can be parallelized per customer and the responses per customer can be interleaved in the overall response. This means that for any given customer, their top 10 sales appear in the desired order, though not consecutively.</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer),orderby(Amount desc)/top(10))</code></pre>
</div>
<p>For every transformation defined in the following sections, it will be specified how it orders its output set, based on the order of its input set. The order of the last output set can be further influenced by a <code>$orderby</code> system query option before it is observed in the response payload.</p>
<p>An order of a collection is more precisely defined as follows: Given two different occurrences <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> in a collection, which may be of the same value or of different values, <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> or <span class="math inline">\(u_2\)</span> precedes <span class="math inline">\(u_1\)</span>, but not both. It can be neither, in which case the relative order of <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> does not matter. If <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> and <span class="math inline">\(u_2\)</span> precedes <span class="math inline">\(u_3\)</span>, then <span class="math inline">\(u_1\)</span> also precedes <span class="math inline">\(u_3\)</span>, and <span class="math inline">\(u_1\)</span> never precedes <span class="math inline">\(u_1\)</span>. (This is a partial order in the mathematical sense defined on the set of occurrences.)</p>
<p>When transformations are defined in the following sections, the algorithmic description sometimes contains an <em>order-preserving loop</em> over a collection. Such a loop processes the occurrences in an order chosen by the service in such a way that <span class="math inline">\(u_1\)</span> is processed before <span class="math inline">\(u_2\)</span> whenever <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span>. Likewise, in an <em>order-preserving sequence</em> <span class="math inline">\(u_1,…,u_n\)</span> we have <span class="math inline">\(i&lt;j\)</span> whenever <span class="math inline">\(u_i\)</span> precedes <span class="math inline">\(u_j\)</span>.</p>
<p>A collection can be <em>stable-sorted</em> by a list of expressions. In the stable-sorted collection an occurrence <span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> if and only if either</p>
<ul>
<li><span class="math inline">\(u_1\)</span> precedes <span class="math inline">\(u_2\)</span> according to the rules of <a href="#ODataProtocol">OData-Protocol, section 11.2.6.2</a> or</li>
<li>these rules do not determine a precedence in either direction between <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> but <span class="math inline">\(u_1\)</span> preceded <span class="math inline">\(u_2\)</span> in the collection before the sort.</li>
</ul>
<p>Stable-sorting of an ordered collection produces another ordered collection. A stable-sort does not necessarily produce a total order, the sorted collection may still contain two occurrences whose relative order does not matter. The transformation <a href="#Transformationorderby"><code>orderby</code></a> performs a stable-sort.</p>
<p>The output set of a <a href="#BasicAggregation">basic aggregation</a> transformation can contain instances of an entity type without entity-id. After a <a href="#Transformationconcat"><code>concat</code></a> transformation, different occurrences of the same entity can differ in individual non-declared properties. To account for such cases, the definition of sameness given in <a href="#ODataURL">OData-URL, section 5.1.1.1.1</a> is refined here. Instances of structured types are <em>the same</em> if</p>
<ul>
<li>both are instances of complex types and both are null or both have the same structure and same values with null considered different from absent or</li>
<li>both are instances of entity types without entity-id (transient entities, see <a href="#ODataProtocol">OData-Protocol, section 4.3</a>) and both are null or both have the same structure and same values with null considered different from absent (informally speaking, they are compared like complex instances) or</li>
<li>(1) both are instances of the same entity type with the same entity-id (non-transient entities, see <a href="#ODataProtocol">OData-Protocol, section 4.1</a>) and (2) the structural and navigation properties contained in both have the same values (for non-primitive properties the sameness of values is decided by a recursive invocation of this definition).
<ul>
<li>If this is fulfilled, the instances are called <em>complementary representations of the same non-transient entity</em>. If this case is encountered at some recursion level while the sameness of non-transient entities <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> is established, a merged representation of the entity <span class="math inline">\(u_1=u_2\)</span> exists that contains all properties of <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span>. But if the instances both occur in the last output set, services MUST represent each with its own structure in the response payload.</li>
<li>If the first condition is fulfilled but not the second, the instances are not the same and are called <em>contradictory representations of the same non-transient entity</em>. (<a href="#contradict">Example 103</a> describes a use case for this.)</li>
</ul></li>
</ul>
<p>Collections are <em>the same</em> if there is a one-to-one correspondence <span class="math inline">\(f\)</span> between them such that</p>
<ul>
<li>corresponding occurrences are of the same value and</li>
<li>an occurrence <span class="math inline">\(u_1\)</span> precedes another occurrence <span class="math inline">\(u_2\)</span> if and only if the occurrence <span class="math inline">\(f(u_1)\)</span> precedes the occurrence <span class="math inline">\(f(u_2)\)</span>, where the occurrences <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> may be of the same value or of different values. (A one-to-one correspondence with this second property is called <em>order-preserving</em>.)</li>
</ul>
<h3 id="313-evaluation-of-data-aggregation-paths"><a name="EvaluationofDataAggregationPaths" href="#EvaluationofDataAggregationPaths">3.1.3 Evaluation of Data Aggregation Paths</a></h3>
<p>This document specifies how a <a href="#DataAggregationPath">data aggregation path</a> that occurs in a request is evaluated by the service. If such an evaluation fails, the service MUST reject the request.</p>
<p>For a data aggregation path to be a common expression according to <a href="#ODataURL">OData-URL, section 5.1.1</a>, its segments must be single-valued with the possible exception of the last segment, and it can then be evaluated relative to an instance of a structured type. For the transformations defined in this document, a data aggregation path can also be evaluated relative to a collection <span class="math inline">\(A\)</span>, even if it has arbitrary collection-valued segments itself.</p>
<p>To this end, the following notation is used in the subsequent sections: If <span class="math inline">\(A\)</span> is a collection and <span class="math inline">\(p\)</span> a data aggregation path, optionally followed by a type-cast segment, the result of such a path evaluation is denoted by <span class="math inline">\(\Gamma(A,p)\)</span> and defined as the unordered concatenation, possibly containing repetitions, of the collections <span class="math inline">\(γ(u,p)\)</span> for each <span class="math inline">\(u\)</span> in <span class="math inline">\(A\)</span> that is not null. The function <span class="math inline">\(γ(u,p)\)</span> takes a non-null value and a path as arguments and returns a collection of instances of structured types or primitive values, depending on the type of the final segment of <span class="math inline">\(p\)</span>. It is recursively defined as follows:</p>
<ol type="1">
<li>If <span class="math inline">\(p\)</span> is an empty path, let <span class="math inline">\(B\)</span> be a collection with <span class="math inline">\(u\)</span> as its single member and continue with step 9.</li>
<li>Let <span class="math inline">\(p_1\)</span> be the first segment of <span class="math inline">\(p\)</span> and <span class="math inline">\(p_2\)</span> the remainder, if any, such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(p_1/p_2\)</span>.</li>
<li>If <span class="math inline">\(p_1\)</span> is a type-cast segment and <span class="math inline">\(u\)</span> is of its type or a subtype thereof, let <span class="math inline">\(v=u\)</span> and continue with step 8.</li>
<li>If <span class="math inline">\(p_1\)</span> is a type-cast segment and <span class="math inline">\(u\)</span> is not of its type or a subtype thereof, let <span class="math inline">\(B\)</span> be an empty collection and continue with step 9. (This rule follows <a href="#ODataURL">OData-URL, section 4.11</a> rather than <a href="#ODataCSDL">OData-CSDL, section 14.4.1.1</a>.)</li>
<li>Otherwise, <span class="math inline">\(p_1\)</span> is a non-type-cast segment. If <span class="math inline">\(u\)</span> does not contain a structural or navigation property <span class="math inline">\(p_1\)</span>, let <span class="math inline">\(B\)</span> be an empty collection and continue with step 9.</li>
<li>If <span class="math inline">\(p_1\)</span> is single-valued, let <span class="math inline">\(v\)</span> be the value of the structural or navigation property <span class="math inline">\(p_1\)</span> in <span class="math inline">\(u\)</span>. If <span class="math inline">\(v\)</span> is null, let <span class="math inline">\(B\)</span> be an empty collection and continue with step 9; otherwise continue with step 8.</li>
<li>Otherwise, <span class="math inline">\(p_1\)</span> is collection-valued. Let <span class="math inline">\(C\)</span> be the collection addressed by the structural or navigation property <span class="math inline">\(p_1\)</span> in <span class="math inline">\(u\)</span>, and let <span class="math inline">\(B=\Gamma(C,p_2)\)</span>. Then continue with step 9.</li>
<li>Let <span class="math inline">\(B=γ(v,p_2)\)</span>.</li>
<li>Return <span class="math inline">\(B\)</span>.</li>
</ol>
<p>This notation is extended to the case of an empty path <span class="math inline">\(e\)</span> by setting <span class="math inline">\(\Gamma(A,e)=A\)</span> with null values removed. Note the collections returned by <span class="math inline">\(\Gamma\)</span> and <span class="math inline">\(γ\)</span> never contain the null value. Also, every instance <span class="math inline">\(u\)</span> in <span class="math inline">\(\Gamma(A,p)\)</span> occurs also in <span class="math inline">\(A\)</span> or nested into <span class="math inline">\(A\)</span>, therefore an algorithmic step like “Add a dynamic property to each <span class="math inline">\(u\)</span> in <span class="math inline">\(\Gamma(A,p)\)</span>” effectively changes <span class="math inline">\(A\)</span>.</p>
<h2 id="32-basic-aggregation"><a name="BasicAggregation" href="#BasicAggregation">3.2 Basic Aggregation</a></h2>
<h3 id="321-transformation-aggregate"><a name="Transformationaggregate" href="#Transformationaggregate">3.2.1 Transformation <code>aggregate</code></a></h3>
<h4 id="3211-aggregation-algorithm"><a name="AggregationAlgorithm" href="#AggregationAlgorithm">3.2.1.1 Aggregation Algorithm</a></h4>
<p>The <code>aggregate</code> transformation takes a comma-separated list of one or more <a href="#AggregateExpression"><em>aggregate expressions</em></a> as parameters and returns an output set with a single instance of the <a href="#TypeStructureandContextURL">input type</a> without entity-id containing one property per aggregate expression, representing the aggregated value of the input set.</p>
<p>An aggregate expression MUST have one of the types listed below or be constructed with the <a href="#Keywordfrom"><code>from</code></a> keyword. To compute the value of the property for a given aggregate expression, the <code>aggregate</code> transformation first determines a collection <span class="math inline">\(A\)</span> of instances of structured types or primitive values, based on the input set of the <code>aggregate</code> transformation, and a path <span class="math inline">\(p\)</span> that occurs in the aggregate expression. Let <span class="math inline">\(p_1\)</span> denote a <a href="#DataAggregationPath">data aggregation path</a> with single- or collection-valued segments and <span class="math inline">\(p_2\)</span> a type-cast segment. Depending on its type, the aggregate expression contains a path <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_2\)</span> or <span class="math inline">\(p=p_1/p_2\)</span>. Each type of aggregate expression defines a function <span class="math inline">\(f(A)\)</span> which the aggregate transformation evaluates to obtain the property value.</p>
<p>The property is a dynamic property, except for a special case in type 4. In types 1 and 2, the aggregate expression MUST end with the keyword <code>with</code> and an aggregation method <span class="math inline">\(g\)</span>. The aggregation method also determines the type of the dynamic property. In types 1, 2, and 3 the aggregate expression MUST, and in type 4 it MAY, be followed by the keyword <a href="#Keywordas"><code>as</code></a> and an <a href="#TypeStructureandContextURL">alias</a>, which is then the name of the dynamic property.</p>
<p><em>Types of aggregate expressions:</em></p>
<ol type="1">
<li>A path <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_1/p_2\)</span> where the last segment of <span class="math inline">\(p_1\)</span> has a complex or entity or <a href="#AggregatablePrimitiveType">aggregatable primitive type</a> whose values can be aggregated using the specified <a href="#AggregationMethods">aggregation method</a> <span class="math inline">\(g\)</span>, or <span class="math inline">\(p=p_2\)</span> if the input set can be aggregated using the <a href="#CustomAggregationMethods">custom aggregation method</a> <span class="math inline">\(g\)</span>.<br />
Let <span class="math inline">\(f(A)=g(A)\)</span>.</li>
<li>An <a href="#AggregatableExpression">aggregatable expression</a> whose values can be aggregated using the specified <a href="#AggregationMethods">aggregation method</a> <span class="math inline">\(g\)</span>.<br />
Let <span class="math inline">\(f(A)=g(B)\)</span> where <span class="math inline">\(B\)</span> is the collection consisting of the values of the aggregatable expression evaluated relative to <a href="#SamenessandOrder">each occurrence</a> in <span class="math inline">\(A\)</span> with null values removed from <span class="math inline">\(B\)</span>. In this type, <span class="math inline">\(p\)</span> is absent.</li>
<li>A path <span class="math inline">\(p/{\tt\$count}\)</span> (see <a href="#AggregateExpressioncount">section 3.2.1.4</a>) with optional prefix <span class="math inline">\(p/{}\)</span> where <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_2\)</span> or <span class="math inline">\(p=p_1/p_2\)</span>.<br />
Let <span class="math inline">\(f(A)\)</span> be the <a href="#SamenessandOrder">cardinality</a> of <span class="math inline">\(A\)</span>.</li>
<li>A path <span class="math inline">\(p/c\)</span> consisting of an optional prefix <span class="math inline">\(p/{}\)</span> with <span class="math inline">\(p=p_1\)</span> or <span class="math inline">\(p=p_1/p_2\)</span> where the last segment of <span class="math inline">\(p_1\)</span> has a structured type or <span class="math inline">\(p=p_2\)</span>, and a <a href="#CustomAggregates">custom aggregate</a> <span class="math inline">\(c\)</span> defined on the collection addressed by <span class="math inline">\(p\)</span>.<br />
Let <span class="math inline">\(f(A)=c(A)\)</span>. If computation of the custom aggregate fails, the service MUST reject the request. In the absence of an alias:
<ul>
<li>The name of the property is the name of the custom aggregate.</li>
<li>The property is a dynamic property whose type is determined by the custom aggregate, unless there is a declared property with that name. The latter case is allowed by the <code>CustomAggregate</code> annotation.</li>
</ul></li>
</ol>
<p><em>Determination of <span class="math inline">\(A\)</span>:</em></p>
<p>Let <span class="math inline">\(I\)</span> be the input set. If <span class="math inline">\(p\)</span> is absent, let <span class="math inline">\(A=I\)</span> with null values removed.</p>
<p>Otherwise, let <span class="math inline">\(q\)</span> be the portion of <span class="math inline">\(p\)</span> up to and including the last navigation property, if any, and any type-cast segment that immediately follows, and let <span class="math inline">\(r\)</span> be the remainder, if any, of <span class="math inline">\(p\)</span> that contains no navigation properties, such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(q⁄r\)</span>. The aggregate transformation considers each entity reached via the path <span class="math inline">\(q\)</span> exactly once. To this end, using the <a href="#EvaluationofDataAggregationPaths"><span class="math inline">\(\Gamma\)</span> notation</a>:</p>
<ul>
<li>If <span class="math inline">\(q\)</span> is non-empty, let <span class="math inline">\(E=\Gamma(I,q)\)</span> and remove duplicates from that entity collection: If <a href="#SamenessandOrder">multiple representations of the same non-transient entity</a> are reached, the service MUST merge them into one occurrence in <span class="math inline">\(E\)</span> if they are complementary and MUST reject the request if they are contradictory. (See <a href="#aggrconflict">example 128</a>.) If <a href="#SamenessandOrder">multiple occurrences of the same transient entity</a> are reached, the service MUST keep only one occurrence in <span class="math inline">\(E\)</span>.</li>
<li>If <span class="math inline">\(q\)</span> is empty, let <span class="math inline">\(E=I\)</span>.</li>
</ul>
<p>Then, if <span class="math inline">\(r\)</span> is empty, let <span class="math inline">\(A=E\)</span>, otherwise let <span class="math inline">\(A=\Gamma(E,r)\)</span>, this consists of instances of structured types or primitive values, possibly with repetitions.</p>
<h4 id="3212-keyword-as"><a name="Keywordas" href="#Keywordas">3.2.1.2 Keyword <code>as</code></a></h4>
<p>Aggregate expressions can be followed by the <code>as</code> keyword followed by an <a href="#TypeStructureandContextURL">alias</a>.</p>
<div class="example">
<p>Example 7:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum as Total,
                                    Amount with max as MxA)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total, MxA)&quot;</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">24</span><span class="fu">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MxA@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;MxA&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example <a name="aggrmul" href="#aggrmul">8</a>:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount mul Product/TaxRate
                                    with sum as Tax)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Tax)&quot;</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="fl">2.08</span> <span class="fu">}</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>An alias affects the structure of the output set: each alias corresponds to a dynamic property in a <code>$select</code> option.</p>
<h4 id="3213-aggregation-methods"><a name="AggregationMethods" href="#AggregationMethods">3.2.1.3 Aggregation Methods</a></h4>
<p>Values can be aggregated using the standard aggregation methods <a href="#StandardAggregationMethodsum"><code>sum</code></a>, <a href="#StandardAggregationMethodmin"><code>min</code></a>, <a href="#StandardAggregationMethodmax"><code>max</code></a>, <a href="#StandardAggregationMethodaverage"><code>average</code></a>, and <a href="#StandardAggregationMethodcountdistinct"><code>countdistinct</code></a>, or with <a href="#CustomAggregationMethods">custom aggregation methods</a> defined by the service. Only types 1 and 2 of the <a href="#AggregationAlgorithm">aggregation algorithm</a> involve aggregation methods, and the algorithm ensures that no null values occur among the values to be aggregated.</p>
<h5 id="32131-standard-aggregation-method-sum"><a name="StandardAggregationMethodsum" href="#StandardAggregationMethodsum">3.2.1.3.1 Standard Aggregation Method <code>sum</code></a></h5>
<p>The standard aggregation method <code>sum</code> can be applied to numeric values to return the sum of the values, or null if there are no values to be aggregated. The provider MUST choose a single type for the property across all instances of that type in the result that is capable of representing the aggregated values. This may require a larger integer type, <code>Edm.Decimal</code> with sufficient <code>Precision</code> and <code>Scale</code>, or <code>Edm.Double</code>.</p>
<div class="example">
<p>Example 9:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum as Total)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">24</span> <span class="fu">}</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h5 id="32132-standard-aggregation-method-min"><a name="StandardAggregationMethodmin" href="#StandardAggregationMethodmin">3.2.1.3.2 Standard Aggregation Method <code>min</code></a></h5>
<p>The standard aggregation method <code>min</code> can be applied to values with a totally ordered domain to return the smallest of the values, or null if there are no values to be aggregated.</p>
<p>The result property will have the same type as the input property.</p>
<div class="example">
<p>Example 10:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with min as MinAmount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(MinAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;MinAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;MinAmount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h5 id="32133-standard-aggregation-method-max"><a name="StandardAggregationMethodmax" href="#StandardAggregationMethodmax">3.2.1.3.3 Standard Aggregation Method <code>max</code></a></h5>
<p>The standard aggregation method <code>max</code> can be applied to values with a totally ordered domain to return the largest of the values, or null if there are no values to be aggregated.</p>
<p>The result property will have the same type as the input property.</p>
<div class="example">
<p>Example 11:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with max as MaxAmount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(MaxAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;MaxAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;MaxAmount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h5 id="32134-standard-aggregation-method-average"><a name="StandardAggregationMethodaverage" href="#StandardAggregationMethodaverage">3.2.1.3.4 Standard Aggregation Method <code>average</code></a></h5>
<p>The standard aggregation method <code>average</code> can be applied to numeric values to return the sum of the values divided by the count of the values, or null if there are no values to be aggregated.</p>
<p>The provider MUST choose a single type for the property across all instances of that type in the result that is capable of representing the aggregated values; either <code>Edm.Double</code> or <code>Edm.Decimal</code> with sufficient <code>Precision</code> and <code>Scale</code>.</p>
<div class="example">
<p>Example 12:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with average as AverageAmount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(AverageAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;AverageAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;AverageAmount&quot;</span><span class="fu">:</span> <span class="fl">3.0</span> <span class="fu">}</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h5 id="32135-standard-aggregation-method-countdistinct"><a name="StandardAggregationMethodcountdistinct" href="#StandardAggregationMethodcountdistinct">3.2.1.3.5 Standard Aggregation Method <code>countdistinct</code></a></h5>
<p>The aggregation method <code>countdistinct</code> can be applied to arbitrary collections to count the distinct values. Instance comparison uses the definition of equality in <a href="#ODataURL">OData-URL, section 5.1.1.1.1</a>.</p>
<p>The result property MUST have type <code>Edm.Decimal</code> with <code>Scale</code> 0 and sufficient <code>Precision</code>.</p>
<div class="example">
<p>Example 13:</p>
<pre><code>GET /service/Sales?$apply=aggregate(Product with countdistinct
                                    as DistinctProducts)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(DistinctProducts)&quot;</span><span class="fu">,</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;DistinctProducts@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;DistinctProducts&quot;</span><span class="fu">:</span> <span class="dv">3</span> <span class="fu">}</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The number of instances in the input set can be counted with the <a href="#AggregateExpressioncount">aggregate expression <code>$count</code></a>.</p>
<h5 id="32136-custom-aggregation-methods"><a name="CustomAggregationMethods" href="#CustomAggregationMethods">3.2.1.3.6 Custom Aggregation Methods</a></h5>
<p>Services can define custom aggregation methods if the functionality offered by the standard aggregation methods is not sufficient for the intended consumers.</p>
<p>Custom aggregation methods MUST use a namespace-qualified name (see <a href="#ODataABNF">OData-ABNF</a>), i.e. contain at least one dot. Dot-less names are reserved for future versions of this specification.</p>
<div class="example">
<p>⚠ Example 14: custom aggregation method that concatenates distinct string values separated by commas</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                   aggregate(Amount with sum as Total,
                             Product/Name with Custom.concat as ProductNames))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total,ProductNames)&quot;</span><span class="fu">,</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductNames&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper,Sugar&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductNames&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee,Paper,Sugar&quot;</span> <span class="fu">}</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h4 id="3214-aggregate-expression-count"><a name="AggregateExpressioncount" href="#AggregateExpressioncount">3.2.1.4 Aggregate Expression <code>$count</code></a></h4>
<p>The aggregate expression <code>$count</code> is defined as type 3 in the <a href="#AggregationAlgorithm">aggregation algorithm</a>. It MUST always specify an <a href="#TypeStructureandContextURL">alias</a> and MUST NOT specify an <a href="#AggregationMethods">aggregation method</a>.</p>
<p>The result property MUST have type <code>Edm.Decimal</code> with <code>Scale</code> 0 and sufficient <code>Precision</code>.</p>
<div class="example">
<p>Example 15:</p>
<pre><code>GET /service/Sales?$apply=aggregate($count as SalesCount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesCount)&quot;</span><span class="fu">,</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h4 id="3215-keyword-from"><a name="Keywordfrom" href="#Keywordfrom">3.2.1.5 Keyword <code>from</code></a></h4>
<p>The <code>from</code> keyword offers a shortcut for a sequence of <a href="#Transformationgroupby"><code>groupby</code></a> and <a href="#Transformationaggregate"><code>aggregate</code></a> transformations with the pattern <span class="math inline">\({\tt groupby}(…,{\tt aggregate}(…{\tt\ as\ }D_1))/{\tt aggregate}(D_1{\tt\ with\ }…)\)</span>.</p>
<p>In the following <span class="math inline">\(p_1,…,p_n\)</span> are <a href="#DataAggregationPath">data aggregation paths</a> that are allowed in <code>groupby</code> for <a href="#SimpleGrouping">simple grouping</a>.</p>
<ol type="1">
<li>If <span class="math inline">\(α\)</span> is an <a href="#AggregateExpression">aggregate expression</a> and <span class="math inline">\(g\)</span> is an aggregation method, then <span class="math display">\[α{\tt\ from\ }p_1,…,p_n{\tt\ with\ }g\]</span> is an aggregate expression which evaluates to the value of property <span class="math inline">\(D\)</span> in the single instance in the output set of the following transformation sequence: <span class="math display">\[{\tt groupby}((p_1,…,p_n),{\tt aggregate}(α{\tt\ as\ }D_1))/{\tt aggregate}(D_1{\tt\ with\ }g{\tt\ as\ }D).\]</span></li>
<li>If <span class="math inline">\(α=p/c{\tt\ from\ }…\)</span> is an aggregate expression that starts with a custom aggregate <span class="math inline">\(c\)</span>, optionally prefixed with a path <span class="math inline">\(p\)</span> as in type 4 in the <a href="#AggregationAlgorithm">aggregation algorithm</a>, and that optionally continues with <code>from</code> and <code>with</code> clauses that were introduced through application of these rules, then <span class="math display">\[α{\tt\ from\ }p_1,…,p_n\]</span> is an aggregate expression which evaluates to the value of property <span class="math inline">\(c\)</span> in the single instance in the output set of the following transformation sequence: <span class="math display">\[{\tt groupby}((p_1,…,p_n),{\tt aggregate}(α{\tt\ as\ }D_1))/{\tt aggregate}(p/c).\]</span></li>
</ol>
<p>Aggregate expressions constructed by these rules MUST be followed in the <code>aggregate</code> transformation by the keyword <code>as</code> and an <a href="#TypeStructureandContextURL">alias</a>. These rules can be applied repeatedly and lead to multiple <code>from</code> and <code>with</code> clauses in an aggregate expression.</p>
<div class="example">
<p>⚠ Example <a name="from" href="#from">16</a>: illustrates rule 1 where <span class="math inline">\(α={\tt Amount\ with\ sum}\)</span>, <span class="math inline">\(p_1={\tt Time}\)</span>, <span class="math inline">\(g={\tt average}\)</span></p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum from Time with average
                                    as DailyAverage)</code></pre>
<p>is equivalent to (but avoids the intermediate dynamic property <code>Total</code>)</p>
<pre><code>GET /service/Sales?$apply=groupby((Time),aggregate(Amount with sum as Total))
                  /aggregate(Total with average as DailyAverage)</code></pre>
<p>and results in the average sales volume per day</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(DailyAverage)&quot;</span><span class="fu">,</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;DailyAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;DailyAverage&quot;</span><span class="fu">:</span> <span class="fl">3.428571428571429</span> <span class="fu">}</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example 17: illustrates rule 1 where <span class="math inline">\(α={\tt Forecast}\)</span>, <span class="math inline">\(p_1={\tt Time}\)</span>, <span class="math inline">\(g={\tt average}\)</span></p>
<pre><code>GET /service/Sales?$apply=aggregate(Forecast from Time with average
                                    as DailyAverage)</code></pre>
<p>is equivalent to</p>
<pre><code>GET /service/Sales?$apply=groupby((Time),aggregate(Forecast))
                  /aggregate(Forecast with average as DailyAverage)</code></pre>
</div>
<div class="example">
<p>⚠ Example 18: the maximal daily average for sales of any product</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with average from Time,Product/Name
                                           with max as MaxDailyAverage)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(MaxDailyAverage)&quot;</span><span class="fu">,</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;MaxDailyAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;MaxDailyAverage&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="322-transformation-concat"><a name="Transformationconcat" href="#Transformationconcat">3.2.2 Transformation <code>concat</code></a></h3>
<p>The <code>concat</code> transformation takes two or more parameters, each of which is a sequence of set transformations.</p>
<p>It applies each transformation sequence to the input set and concatenates the intermediate output sets in the order of the parameters into the output set, preserving the ordering of the individual output sets as well as the structure of each instance in these sets, potentially leading to a non-homogeneously structured output set. If different intermediate output sets contain dynamic properties with the same alias, clients SHOULD ensure they have the same type and meaning in each intermediate output set.</p>
<div class="example">
<p>⚠ Example 19:</p>
<pre><code>GET /service/Sales?$apply=concat(topcount(2,Amount),
                                 aggregate(Amount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Amount)&quot;</span><span class="fu">,</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">24</span> <span class="fu">}</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that two Sales entities with the second highest amount 4 exist in the input set; the entity with <code>ID</code> 3 is included in the result, because the service chose to use the <code>ID</code> property for imposing a stable ordering.</p>
</div>
<h3 id="323-transformation-groupby"><a name="Transformationgroupby" href="#Transformationgroupby">3.2.3 Transformation <code>groupby</code></a></h3>
<p>The <code>groupby</code> transformation takes one or two parameters where the second is a list of set transformations, separated by forward slashes to express that they are consecutively applied. If the second parameter is not specified, it defaults to a single transformation whose output set consists of a single instance of the <a href="#TypeStructureandContextURL">input type</a> without properties and without entity-id.</p>
<h4 id="3231-simple-grouping"><a name="SimpleGrouping" href="#SimpleGrouping">3.2.3.1 Simple Grouping</a></h4>
<p>In its simplest form the first parameter of <code>groupby</code> specifies the <em>grouping properties</em>, a comma-separated parenthesized list <span class="math inline">\(G\)</span> of one or more <a href="#DataAggregationPath">data aggregation paths</a> with single-valued segments. The same path SHOULD NOT appear more than once; redundant property paths MAY be considered valid, but MUST NOT alter the meaning of the request. Navigation properties and stream properties specified in grouping properties are expanded by default (see <a href="#groupbynav">example 72</a>).</p>
<p>The algorithmic description of this transformation makes use of the following definitions: Let <span class="math inline">\(u[q]\)</span> denote the value of a structural or navigation property <span class="math inline">\(q\)</span> in an instance <span class="math inline">\(u\)</span>. A path <span class="math inline">\(p_1\)</span> is called a <em>prefix</em> of a path <span class="math inline">\(p\)</span> if there is a non-empty path <span class="math inline">\(p_2\)</span> such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(p_1/p_2\)</span>. Let <span class="math inline">\(e\)</span> denote the empty path.</p>
<p>The output set of the <code>groupby</code> transformation is constructed in five steps.</p>
<ol type="1">
<li><a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(u\)</span> in the input set, a projection is computed that contains only the grouping properties. This projection is <span class="math inline">\(s_G(u,e)\)</span> and the function <span class="math inline">\(s_G(u,p)\)</span> takes an instance and a path relative to the input set as arguments and is computed recursively as follows:
<ul>
<li>Let <span class="math inline">\(v\)</span> be an instance of the type of <span class="math inline">\(u\)</span> without properties and without entity-id.</li>
<li>For each structural or navigation property <span class="math inline">\(q\)</span> of <span class="math inline">\(u\)</span>:
<ul>
<li>If <span class="math inline">\(u\)</span> has a subtype of the type addressed by <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> is only declared on that subtype, let <span class="math inline">\(p&#39;=p/p&#39;&#39;/q\)</span> where <span class="math inline">\(p&#39;&#39;\)</span> is a type-cast to the subtype, otherwise let <span class="math inline">\(p&#39;=p/q\)</span>.</li>
<li>If <span class="math inline">\(p&#39;\)</span> occurs in <span class="math inline">\(G\)</span>, let <span class="math inline">\(v[q]=u[q]\)</span>.</li>
<li>Otherwise, if <span class="math inline">\(p&#39;\)</span> is a prefix of a path in <span class="math inline">\(G\)</span>, let <span class="math inline">\(v[q]=s_G(u[q],p&#39;)\)</span>.</li>
</ul></li>
<li>Return <span class="math inline">\(v\)</span>.</li>
</ul></li>
<li>The input set is split into subsets where two instances are in the same subset if their projections are <a href="#SamenessandOrder">the same</a>. If <a href="#SamenessandOrder">representations of the same non-transient entity</a> are encountered during the comparison of two projections, the service MUST assign them to one subset with the merged representation if they are complementary and MUST reject the request if they are contradictory.</li>
<li>The set transformations from the second parameter are applied to each subset, resulting in a new set of potentially different structure and cardinality. Associated with each resulting set is the common projection of the instances in the subset from which the resulting set was computed.</li>
<li>Each set resulting from the previous step is transformed to contain the associated common projection <span class="math inline">\(s\)</span>. This transformation is denoted by <span class="math inline">\(\Pi_G(s)\)</span> and is defined below.</li>
<li>The output set is the concatenation of the transformed sets from the previous step. The order of occurrences from the same transformed set remains the same, and no order is defined between occurrences from different transformed sets.</li>
</ol>
<p><em>Definition of <span class="math inline">\(\Pi_G(s)\)</span>:</em></p>
<p><em>Prerequisites:</em> <span class="math inline">\(G\)</span> is a list of data aggregation paths and <span class="math inline">\(s\)</span> is an instance of the <a href="#TypeStructureandContextURL">input type</a>.</p>
<p>The output set of the transformation <span class="math inline">\(\Pi_G(s)\)</span> is in one-to-one correspondence with its input set via the <a href="#SamenessandOrder">order-preserving</a> mapping <span class="math inline">\(u↦a_G(u,s,e)\)</span>. The function <span class="math inline">\(a_G(u,s,p)\)</span> takes two instances and a path relative to the input set as arguments and is computed recursively as follows:</p>
<ol type="1">
<li>If necessary, cast <span class="math inline">\(u\)</span> to a subtype so that its type contains all structural and navigation properties of <span class="math inline">\(s\)</span>.</li>
<li>For each structural or navigation property <span class="math inline">\(q\)</span> of <span class="math inline">\(s\)</span>:
<ul>
<li>If <span class="math inline">\(s\)</span> has a subtype of the type addressed by <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> is only declared on that subtype, let <span class="math inline">\(p&#39;=p/p&#39;&#39;/q\)</span> where <span class="math inline">\(p&#39;&#39;\)</span> is a type-cast to the subtype, otherwise let <span class="math inline">\(p&#39;=p/q\)</span>.</li>
<li>If <span class="math inline">\(q\)</span> is a single-valued primitive structural property or <span class="math inline">\(p&#39;\)</span> occurs in <span class="math inline">\(G\)</span>, let <span class="math inline">\(u[q]=s[q]\)</span>. (In the case where <span class="math inline">\(p&#39;\)</span> occurs in <span class="math inline">\(G\)</span> we also call <span class="math inline">\(q\)</span> a <em>final segment from <span class="math inline">\(G\)</span></em>.)</li>
<li>Otherwise, if <span class="math inline">\(q\)</span> is single-valued, let <span class="math inline">\(u[q]=a_G(u[q],s[q],p&#39;)\)</span>.</li>
<li>Otherwise, the behavior is undefined. (Such cases never occur when <span class="math inline">\(\Pi_G(s)\)</span> is used in this document.)</li>
</ul></li>
<li>Return <span class="math inline">\(u\)</span>.</li>
</ol>
<div class="example">
<p>Example 20:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country,Product/Name),
                                  aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>If the second parameter is omitted, steps 2 and 3 above produce one instance containing only the grouping properties per distinct value combination.</p>
<div class="example">
<p>⚠ Example 21:</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/Name,Amount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Product(Name),Amount)&quot;</span><span class="fu">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that the result has the same structure, but not the same content as</p>
<pre><code>GET /service/Sales?$expand=Product($select=Name)&amp;$select=Amount</code></pre>
</div>
<p>A <code>groupby</code> transformation affects the structure of the output set similar to <code>$select</code> where each grouping property corresponds to an item in a <code>$select</code> clause.</p>
<h4 id="3232-grouping-with-rollup"><a name="Groupingwithrollup" href="#Groupingwithrollup">3.2.3.2 Grouping with <code>rollup</code></a></h4>
<p>The <code>rollup</code> grouping operator allows applying set transformations to instances of an input set organized in a <a href="#LeveledHierarchy">leveled hierarchy</a>. It can be used instead of a grouping property in the first parameter of <code>groupby</code>. It has two overloads, depending on the number of parameters.</p>
<p>If used with two or more parameters, it defines an unnamed leveled hierarchy of grouping properties as a list of <a href="#DataAggregationPath">data aggregation paths</a> with single-valued segments. The first path in the list is the root level of the hierarchy defining the coarsest granularity, and the other paths define consecutively finer-grained levels of the hierarchy. This unnamed hierarchy is used for grouping instances.</p>
<p>A groupby with <code>rollup</code> applied to a leveled hierarchy allows requesting aggregation for all levels of that hierarchy. It splits the input set into groups using all grouping properties (see (1) below), then removes the last property from the hierarchy (see (2)) and repeats this process using the remaining grouping properties until all of the levels have been used up (see terminating rule (3)).</p>
<p>Such a grouping with <code>rollup</code> for a leveled hierarchy is processed using the following equivalence relationships, in which <span class="math inline">\(p_1,…,p_k\)</span> are groupable property paths representing a level, <span class="math inline">\(T\)</span> is a transformation sequence, the ellipsis (<span class="math inline">\(…\)</span>) stands in for zero or more property paths, <span class="math inline">\(P_1\)</span> stands in for zero or more property paths and <span class="math inline">\(P_2\)</span> for zero or more <code>rollup</code> or <a href="#Groupingwithrolluprecursive"><code>rolluprecursive</code></a> operators or property paths:</p>
<ul>
<li><span class="math inline">\({\tt groupby}((P_1,{\tt rollup}(p_1,…,p_{k-1},p_k),P_2),T)\)</span> is equivalent to <span class="math display">\[\matrix{   {\tt concat}(\hfill\\   \quad {\tt groupby}((P_1,p_1,…,p_{k-1},p_k,P_2),T),\hfill&amp;\tt (1)\\   \quad {\tt groupby}((P_1,{\tt rollup}(p_1,…,p_{k-1}),P_2),T)\hfill&amp;\tt(2)\\   ).\hskip25pc\\   }\]</span></li>
<li><span class="math inline">\({\tt groupby}((P_1,{\tt rollup}(p_1,p_2),P_2),T)\)</span> is equivalent to <span class="math display">\[\matrix{   {\tt concat}(\hfill&amp;\tt (3)\\   \quad {\tt groupby}((P_1,p_1,p_2,P_2),T),\hfill\\   \quad {\tt groupby}((P_1,p_1,P_2),T)\hfill\\   ).\hskip25pc\\   }\]</span></li>
</ul>
<div class="example">
<p>Example 22: rolling up two hierarchies, the first with two levels, the second with three levels: <span class="math display">\[({\tt rollup}(p_{1,1},p_{1,2}),{\tt rollup}(p_{2,1},p_{2,2},p_{2,3}))\]</span> will result in the six groupings <span class="math display">\[\matrix{ (p_{1,1},p_{1,2},\hfill&amp;p_{2,1},p_{2,2},p_{2,3})\hfill\\ (p_{1,1},p_{1,2},\hfill&amp;p_{2,1},p_{2,2})\hfill\\ (p_{1,1},p_{1,2},\hfill&amp;p_{2,1})\hfill\\ (p_{1,1},\hfill&amp;p_{2,1},p_{2,2},p_{2,3})\hfill\\ (p_{1,1},\hfill&amp;p_{2,1},p_{2,2})\hfill\\ (p_{1,1},\hfill&amp;p_{2,1})\hfill }\]</span> The leveled hierarchy of the first rollup has 2 levels, the one of the second has 3 levels, and the groupings represent all possible <span class="math inline">\(6=2⋅3\)</span> combinations of levels from both hierarchies.</p>
</div>
<div class="example">
<p>Example 23: answering the second question in <a href="#ExampleUseCases">section 2.3</a></p>
<pre><code>GET /service/Sales?$apply=groupby((rollup(Customer/Country,Customer/Name),
                                   rollup(Product/Category/Name,Product/Name)),
                                  aggregate(Amount with sum as Total))</code></pre>
<p>results in seven entities for the finest grouping level</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="st">                               Product(Category(Name)),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span> <span class="fu">},</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span>  <span class="fu">{</span> <span class="dt">&quot;Category&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Non-Food&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span></code></pre></div>
<p>plus additional fifteen rollup entities for subtotals: five without customer name</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span>  <span class="fu">{</span> <span class="dt">&quot;Category&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Food&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span> <span class="fu">}</span><span class="er">,</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span></code></pre></div>
<p>six without product name</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span> <span class="fu">},</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span>  <span class="fu">{</span> <span class="dt">&quot;Category&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Food&quot;</span> <span class="fu">}</span> <span class="fu">},</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">6</span> <span class="fu">}</span><span class="er">,</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span></code></pre></div>
<p>and four with neither customer nor product name</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span>  <span class="fu">{</span> <span class="dt">&quot;Category&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Food&quot;</span> <span class="fu">}</span> <span class="fu">},</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">14</span> <span class="fu">}</span><span class="er">,</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="er">]</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<p>Note that the absence of one or more properties of the output structure declared by the surrounding OData context allows distinguishing rollup entities from other entities.</p>
<p>If <code>rollup</code> is used with one parameter, the parameter references a named leveled hierarchy to be used for grouping instances, and therefore MUST be the value of the <code>Qualifier</code> attribute of an annotation with term <a href="#LeveledHierarchy"><code>LeveledHierarchy</code></a>. If the annotation has qualifier <span class="math inline">\(Q\)</span> and as value a collection consisting of <span class="math inline">\(p_1,…,p_n\)</span> with <span class="math inline">\(n≥2\)</span>, then <span class="math inline">\({\tt rollup}(Q)\)</span> is equivalent to <span class="math inline">\({\tt rollup}(p_1,…,p_n)\)</span>.</p>
<p>Another grouping operator <a href="#Groupingwithrolluprecursive"><code>rolluprecursive</code></a> which similarly works with a <a href="#RecursiveHierarchy">recursive hierarchy</a> is defined later.</p>
<h2 id="33-transformations-producing-a-subset"><a name="TransformationsProducingaSubset" href="#TransformationsProducingaSubset">3.3 Transformations Producing a Subset</a></h2>
<p>These transformations produce an output set that is a subset of their input set, possibly in a different order. Some of the algorithmic descriptions below make use of the following definition: A total order of a collection is called <em>stable across requests</em> if it is the same for all requests that construct the collection by executing the same resource path and transformations, possibly nested, on the same underlying data.</p>
<div class="example">
<p>⚠ Example 24: A stable total order is required for the input set of a <a href="#Transformationskip"><code>skip</code></a> transformation. The following request constructs that input set by executing the <code>groupby</code> transformation on the <code>Sales</code> entity collection, computing the total sales per customer. Because of the subsequent <code>skip</code> transformation, the service must endow this with a stable total order. Then the request divides the total sales per customer into pages of <span class="math inline">\(N\)</span> customers and returns page number <span class="math inline">\(i\)</span> in a reproducible manner (as long as the underlying data do not change).</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Customer),aggregate(Amount with sum as Total))
  /skip(M)/top(N)</code></pre>
<p>where the number in <code>skip</code> is <span class="math inline">\(M=(i-1)⋅N\)</span>. Other values of <span class="math inline">\(M\)</span> can be used to skip, for example, half a page.</p>
</div>
<h3 id="331-topbottom-transformations"><a name="Topbottomtransformations" href="#Topbottomtransformations">3.3.1 Top/bottom transformations</a></h3>
<p>These transformations take two parameters. The first parameter MUST be an <a href="#Expression">expression</a> that is <a href="#ExpressionsEvaluableonaCollection">evaluable on the input set as a collection</a>, without reference to an individual instance (and which therefore cannot be a property path). The second parameter MUST be an expression that is evaluated on each instance of the input set in turn.</p>
<p>The output set is constructed as follows:</p>
<ol type="1">
<li>Let <span class="math inline">\(A\)</span> be a copy of the input set with a total order that is chosen by the service (it need not preserve any existing order). The total order MUST be stable across requests. (This is the order of the eventual output set of this transformation.)</li>
<li>Let <span class="math inline">\(B\)</span> be a copy of <span class="math inline">\(A\)</span> that is <a href="#SamenessandOrder">stable-sorted</a> in ascending (for transformations starting with <code>bottom</code>) or descending (for transformations starting with <code>top</code>) order of the value specified in the second parameter. (This is the order in which contributions to the output set are considered.)</li>
<li>Start with an empty output set.</li>
<li>Loop over <span class="math inline">\(B\)</span> in its total order.</li>
<li>Exit the loop if a condition is met. This condition depends on the transformation being executed and is given in the subsections below.</li>
<li>Insert the current item of the loop into the output set in the order of <span class="math inline">\(A\)</span>.</li>
<li>Continue the loop.</li>
</ol>
<p>For example, if the input set consists of non-transient entities and the datastore contains an index ordered by the second parameter and then the entity-id, a service may implement this algorithm with <span class="math inline">\(A=B\)</span> ordered like this index.</p>
<p>The order of the output set can be influenced with a subsequent <a href="#Transformationorderby"><code>orderby</code></a> transformation.</p>
<h4 id="3311-transformations-bottomcount-and-topcount"><a name="Transformationsbottomcountandtopcount" href="#Transformationsbottomcountandtopcount">3.3.1.1 Transformations <code>bottomcount</code> and <code>topcount</code></a></h4>
<p>The first parameter MUST evaluate to a positive integer <span class="math inline">\(c\)</span>. The second parameter MUST evaluate to a primitive type whose values are totally ordered. In step 5, exit the loop if the cardinality of the output set equals <span class="math inline">\(c\)</span>.</p>
<div class="example">
<p>Example 25:</p>
<pre><code>GET /service/Sales?$apply=bottomcount(2,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 26:</p>
<pre><code>GET /service/Sales?$apply=topcount(2,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that two <code>Sales</code> entities with the second highest amount 4 exist in the input set; the entity with <code>ID</code> 3 is included in the result, because the service chose to use the <code>ID</code> property for imposing a stable ordering in step 1. Such a logic needs to be in place even with a preceding <code>orderby</code> since it cannot be ensured that it creates a stable order of the instances on the expressions of the second parameter.</p>
</div>
<h4 id="3312-transformations-bottompercent-and-toppercent"><a name="Transformationsbottompercentandtoppercent" href="#Transformationsbottompercentandtoppercent">3.3.1.2 Transformations <code>bottompercent</code> and <code>toppercent</code></a></h4>
<p>The first parameter MUST evaluate to a positive number <span class="math inline">\(p\)</span> less than or equal to 100. The second parameter MUST evaluate to a number. In step 5, exit the loop if the ratio of the sum of the numbers addressed by the second parameter in the output set to their sum in the input set equals or exceeds <span class="math inline">\(p\)</span> percent.</p>
<div class="example">
<p>Example 27:</p>
<pre><code>GET /service/Sales?$apply=bottompercent(50,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 28:</p>
<pre><code>GET /service/Sales?$apply=toppercent(50,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h4 id="3313-transformations-bottomsum-and-topsum"><a name="Transformationsbottomsumandtopsum" href="#Transformationsbottomsumandtopsum">3.3.1.3 Transformations <code>bottomsum</code> and <code>topsum</code></a></h4>
<p>The first parameter MUST evaluate to a number <span class="math inline">\(s\)</span>. The second parameter MUST be an <a href="#AggregatableExpression">aggregatable expression</a> that evaluates to a number. In step 5, exit the loop if the sum of the numbers addressed by the second parameter in the output set is greater than or equal to <span class="math inline">\(s\)</span>.</p>
<div class="example">
<p>Example 29:</p>
<pre><code>GET /service/Sales?$apply=bottomsum(7,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 30:</p>
<pre><code>GET /service/Sales?$apply=topsum(15,Amount)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="332-transformation-filter"><a name="Transformationfilter" href="#Transformationfilter">3.3.2 Transformation <code>filter</code></a></h3>
<p>The <code>filter</code> transformation takes a Boolean expression that could also be passed as a <code>$filter</code> system query option. Its output set is the subset of the input set containing all instances (possibly with repetitions) for which this expression, evaluated relative to the instance, yields true. No order is defined on the output set.</p>
<div class="example">
<p>Example 31:</p>
<pre><code>GET /service/Sales?$apply=filter(Amount gt 3)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="333-transformation-orderby"><a name="Transformationorderby" href="#Transformationorderby">3.3.3 Transformation <code>orderby</code></a></h3>
<p>The <code>orderby</code> transformation takes a list of expressions that could also be passed as a <code>$orderby</code> system query option. Its output set consists of the instances of the input set in the same order <code>$orderby</code> would produce for the given expressions, but keeping the relative order from the input set if the given expressions do not distinguish between two instances. The orderby transformation thereby performs a <a href="#SamenessandOrder">stable-sort</a>. A service supporting this transformation MUST at least offer sorting by values addressed by property paths, including dynamic properties, with both suffixes <code>asc</code> and <code>desc</code>.</p>
<div class="example">
<p>Example 32:</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/Name),
                           aggregate(Amount with sum as Total))
                   /orderby(Total desc)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="334-transformation-search"><a name="Transformationsearch" href="#Transformationsearch">3.3.4 Transformation <code>search</code></a></h3>
<p>The <code>search</code> transformation takes a search expression that could also be passed as a <code>$search</code> system query option. Its output set is the subset of the input set containing all instances (possibly with repetitions) that match this search expression. Closing parentheses in search expressions must be within single or double quotes in order to avoid syntax errors like <code>search())</code>. No order is defined on the output set.</p>
<div class="example">
<p>Example 33: assuming that free-text search on <code>Sales</code> takes the related product name into account,</p>
<pre><code>GET /service/Sales?$apply=search(coffee)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="335-transformation-skip"><a name="Transformationskip" href="#Transformationskip">3.3.5 Transformation <code>skip</code></a></h3>
<p>The <code>skip</code> transformation takes a non-negative integer <span class="math inline">\(c\)</span> as argument. Let <span class="math inline">\(A\)</span> be a copy of the input set with a total order that extends any existing order of the input set but is otherwise chosen by the service. The total order MUST be stable across requests.</p>
<p>The transformation excludes from the output set the first <span class="math inline">\(c\)</span> occurrences in <span class="math inline">\(A\)</span>. It keeps all remaining instances in the same order as they occur in <span class="math inline">\(A\)</span>.</p>
<div class="example">
<p>Example 34:</p>
<pre><code>GET /service/Sales?$apply=orderby(Customer/Name desc)/skip(2)/top(2)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="336-transformation-top"><a name="Transformationtop" href="#Transformationtop">3.3.6 Transformation <code>top</code></a></h3>
<p>The <code>top</code> transformation takes a non-negative integer <span class="math inline">\(c\)</span> as argument. Let <span class="math inline">\(A\)</span> be a copy of the input set with a total order that extends any existing order of the input set but is otherwise chosen by the service. The total order MUST be stable across requests.</p>
<p>If <span class="math inline">\(A\)</span> contains more than <span class="math inline">\(c\)</span> instances, the output set consists of the first <span class="math inline">\(c\)</span> occurrences in <span class="math inline">\(A\)</span>. Otherwise, the output set equals <span class="math inline">\(A\)</span>. The instances in the output set are in the same order as they occur in <span class="math inline">\(A\)</span>.</p>
<p>Note the transformation <code>top(0)</code> produces an empty output set.</p>
<div class="example">
<p>Example 35:</p>
<pre><code>GET /service/Sales?$apply=orderby(Customer/Name desc)/top(2)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="337-stable-total-order-before-skip-and-top"><a name="StableTotalOrderBeforeskipandtop" href="#StableTotalOrderBeforeskipandtop">3.3.7 Stable Total Order Before <code>$skip</code> and <code>$top</code></a></h3>
<p>When the system query options <code>$top</code> and <code>$skip</code> <a href="#ODataProtocol">OData-Protocol, sections 11.2.6.3 and 11.2.6.4</a> are executed after the system query option <code>$apply</code> and after <code>$filter</code> and <code>$orderby</code>, if applicable, they operate on a collection with a total order that extends any existing order but is otherwise chosen by the service. The total order MUST be stable across requests.</p>
<h2 id="34-one-to-one-transformations"><a name="OnetoOneTransformations" href="#OnetoOneTransformations">3.4 One-to-One Transformations</a></h2>
<p>These transformations produce an output set in one-to-one correspondence with their input set. The output set is initially a clone of the input set, then dynamic properties are added to the output set. The values of properties copied from the input set are not changed, nor is the order of instances changed.</p>
<h3 id="341-transformation-identity"><a name="Transformationidentity" href="#Transformationidentity">3.4.1 Transformation <code>identity</code></a></h3>
<p>The output set of the <code>identity</code> transformation is its input set in unchanged order.</p>
<div class="example">
<p>Example 36: Add a grand total row to the <code>Sales</code> result set</p>
<pre><code>GET /service/Sales?$apply=concat(identity,aggregate(Amount with sum as Total))</code></pre>
</div>
<h3 id="342-transformation-compute"><a name="Transformationcompute" href="#Transformationcompute">3.4.2 Transformation <code>compute</code></a></h3>
<p>The <code>compute</code> transformation takes a comma-separated list of one or more <em>compute expressions</em> as parameters.</p>
<p>A compute expression is a common expression followed by the <code>as</code> keyword, followed by an <a href="#TypeStructureandContextURL">alias</a>.</p>
<p>The output set is constructed by copying the instances of the input set and adding one dynamic property per compute expression to <a href="#SamenessandOrder">each occurrence</a> in the output set. The name of each added dynamic property is the alias of the corresponding compute expression. The value of each added dynamic property is computed relative to the corresponding instance. Services MAY support expressions that address dynamic properties added by other expressions within the same compute transformation, provided that the service can determine an evaluation sequence. The type of the property is determined by the rules for evaluating common expressions and numeric promotion defined in <a href="#ODataURL">OData-URL, section 5.1.1</a>.</p>
<div class="example">
<p>Example 37:</p>
<pre><code>GET /service/Sales?$apply=compute(Amount mul Product/TaxRate as Tax)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(*,Tax)&quot;</span><span class="fu">,</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">24</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">48</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">56</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Tax@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Tax&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">28</span> <span class="fu">}</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="343-transformation-addnested"><a name="Transformationaddnested" href="#Transformationaddnested">3.4.3 Transformation <code>addnested</code></a></h3>
<p>The <code>addnested</code> transformation expands a path relative to the input set, applies one or more transformation sequences to the addressed resources, and adds the transformed resources as dynamic (navigation) properties to the output set. The output set <span class="math inline">\(A\)</span> is initially a clone of the input set.</p>
<p>The first parameter of the <code>addnested</code> transformation is a path <span class="math inline">\(p\)</span> or a concatenated path <span class="math inline">\(p/q\)</span>. Here, <span class="math inline">\(p=p_1/…/p_k\)</span> with <span class="math inline">\(k≥1\)</span> is a <a href="#DataAggregationPath">data aggregation path</a> with single- or collection-valued segments. The path <span class="math inline">\(p\)</span> MUST NOT contain any navigation properties prior to the last segment <span class="math inline">\(p_k\)</span>, which MUST either be a navigation or a complex structural property. If the optional <span class="math inline">\(q\)</span> is present, it MUST be a type-cast segment. This is an extension of the definition in <a href="#ODataURL">OData-URL, section 5.1.3</a> in that the first parameter need not contain a navigation property.</p>
<p>Further parameters are one or more transformation sequences followed by the <code>as</code> keyword followed by an <a href="#TypeStructureandContextURL">alias</a> whose name need not differ from names in the input set but MUST differ from names already in <span class="math inline">\(\Gamma(A,p_1/…/p_{k-1})\)</span> (using the <a href="#EvaluationofDataAggregationPaths"><span class="math inline">\(\Gamma\)</span> notation</a>) as well as from aliases for other transformation sequences.</p>
<p>If <span class="math inline">\(p_k\)</span> is single-valued, the transformation sequences MUST consist of only <code>identity</code> or <code>compute</code> or <code>addnested</code> transformations, because these transform one-element collections into one-element collections. This makes it meaningful to speak (in this section only) of a transformation sequence applied to a single instance; this means applying it to a collection containing the single instance and taking as result the single instance from the output set.</p>
<p><a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(u\)</span> in <span class="math inline">\(\Gamma(A,p_1/…/p_{k-1})\)</span>, let <span class="math inline">\(B=γ(u,p_k/q)\)</span> and let the resource <span class="math inline">\(v\)</span> be</p>
<ul>
<li>the collection <span class="math inline">\(B\)</span> if <span class="math inline">\(p_k\)</span> is collection-valued</li>
<li>the single instance in <span class="math inline">\(B\)</span> if <span class="math inline">\(p_k\)</span> is single-valued and <span class="math inline">\(B\)</span> is non-empty</li>
<li>undefined if <span class="math inline">\(p_k\)</span> is single-valued and <span class="math inline">\(B\)</span> is empty.</li>
</ul>
<p>If <span class="math inline">\(v\)</span> is defined, then for each transformation sequence, a dynamic property is added to <span class="math inline">\(u\)</span> as follows: If <span class="math inline">\(p_k\)</span> is a navigation property, the added property is a dynamic navigation property, which is expanded by default, otherwise it is a dynamic structural property. Its name is the alias of the transformation sequence. The value of the added property is the result of the transformation sequence applied to <span class="math inline">\(v\)</span>. The dynamic property carries as control information the context URL of <span class="math inline">\(v\)</span>.</p>
<div class="example">
<p>Example 38:</p>
<pre><code>GET /service/Customers?$apply=addnested(Sales,
                                        filter(Amount gt 3) as FilteredSales)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers(FilteredSales())&quot;</span><span class="fu">,</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">]</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;5&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">]</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span><span class="fu">,</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Luc&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;France&quot;</span><span class="fu">,</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">}</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>If <code>Sales</code> was a collection-valued complex property of type <code>SalesModel.SalesComplexType</code>, the context would be <code>"FilteredSales@context": "#Collection(SalesModel.SalesComplexType)"</code>.</p>
</div>
<h2 id="35-transformations-changing-the-input-set-structure"><a name="TransformationsChangingtheInputSetStructure" href="#TransformationsChangingtheInputSetStructure">3.5 Transformations Changing the Input Set Structure</a></h2>
<p>The output set of the <a href="#Transformationsjoinandouterjoin">join</a> transformations differs from their input set in the number of instances as well as in their structure, but reflects the order of the input set. Transformation <a href="#Transformationnest"><code>nest</code></a> produces a one-instance output set.</p>
<h3 id="351-transformations-join-and-outerjoin"><a name="Transformationsjoinandouterjoin" href="#Transformationsjoinandouterjoin">3.5.1 Transformations <code>join</code> and <code>outerjoin</code></a></h3>
<p>The <code>join</code> and <code>outerjoin</code> transformations take as their first parameter <span class="math inline">\(p\)</span> a collection-valued complex or navigation property, optionally followed by a type-cast segment to address only instances of that derived type or one of its sub-types, followed by the <code>as</code> keyword, followed by an <a href="#TypeStructureandContextURL">alias</a>. The optional second parameter specifies a transformation sequence <span class="math inline">\(T\)</span>.</p>
<p><a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(u\)</span> in an <a href="#SamenessandOrder">order-preserving loop</a> over the input set</p>
<ol type="1">
<li>the instance collection <span class="math inline">\(A\)</span> addressed by <span class="math inline">\(p\)</span> is identified.</li>
<li>If <span class="math inline">\(T\)</span> is provided, <span class="math inline">\(A\)</span> is replaced with the result of applying <span class="math inline">\(T\)</span> to <span class="math inline">\(A\)</span>.</li>
<li>In case of an <code>outerjoin</code>, if <span class="math inline">\(A\)</span> is empty, a null instance is added to it.</li>
<li><a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(v\)</span> in an <a href="#SamenessandOrder">order-preserving loop</a> over <span class="math inline">\(A\)</span> an instance <span class="math inline">\(w\)</span> is appended to the output set of the transformation:
<ul>
<li>The instance <span class="math inline">\(w\)</span> is a clone of <span class="math inline">\(u\)</span> with an additional dynamic property whose name is the given alias and whose value is <span class="math inline">\(v\)</span>.</li>
<li>The dynamic property is a navigation property if <span class="math inline">\(p\)</span> is a collection-valued navigation property, otherwise it is a complex property.</li>
<li>The dynamic property carries as control information the context URL of <span class="math inline">\(v\)</span>.</li>
</ul></li>
</ol>
<div class="example">
<p>Example 39: all links between products and sales instances</p>
<pre><code>GET /service/Products?$apply=join(Sales as Sale)&amp;$select=ID&amp;$expand=Sale</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(ID,Sale())&quot;</span><span class="fu">,</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sale&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>In this example, <code>$expand=Sale</code> is used to include the target entities in the result. There are no subsequent transformations like <code>groupby</code> that would cause it to be expanded by default. If the first parameter <code>Sales</code> was a collection-valued complex property of type <code>SalesModel.SalesComplexType</code>, the complex property <code>Sale</code> would be in the result regardless, and its context would be <code>"@context": "#SalesModel.SalesComplexType"</code>.</p>
<p>Applying <code>outerjoin</code> instead would return an additional instance for product with <code>"ID": "P4"</code> and <code>Sale</code> having a null value.</p>
</div>
<h3 id="352-transformation-nest"><a name="Transformationnest" href="#Transformationnest">3.5.2 Transformation <code>nest</code></a></h3>
<p>The <code>nest</code> transformation takes as parameters one or more transformation sequences followed by the <code>as</code> keyword followed by an <a href="#TypeStructureandContextURL">alias</a>.</p>
<p>The output set consists of a single instance of the <a href="#TypeStructureandContextURL">input type</a> without entity-id having one dynamic property per transformation sequence. The name of the dynamic property is the alias for this transformation sequence. The value of the dynamic property is the collection resulting from the transformation sequence applied to the input set. The dynamic property carries as control information the context URL of the transformed input set.</p>
<div class="example">
<p>Example 40:</p>
<pre><code>GET /service/Sales?$apply=nest(groupby((Customer/ID)) as Customers)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customers())&quot;</span><span class="fu">,</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customers@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Customer(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Customers&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="36-expressions-evaluable-on-a-collection"><a name="ExpressionsEvaluableonaCollection" href="#ExpressionsEvaluableonaCollection">3.6 Expressions Evaluable on a Collection</a></h2>
<p>The following two subsections introduce two new types of <a href="#Expression">expression</a> that are evaluated relative to a collection, called the input collection.</p>
<p>These expressions are</p>
<ul>
<li>either prepended with a collection-valued path <span class="math inline">\(p\)</span> followed by a forward slash, like a lambda operator <a href="#ODataURL">OData-URL, section 5.1.1.13</a>. The collection identified by that path is then the input collection for the expression.</li>
<li>or prepended with the keyword <code>$these</code> followed by a forward slash, the input collection is then the <em>current collection</em> defined as follows:
<ul>
<li>In a system query option other than <code>$apply</code>, possibly nested within <code>$expand</code> or <code>$select</code>, the current collection is the collection that is the subject of the system query option.</li>
<li>In a path segment that addresses a subset of a collection <a href="#ODataURL">OData-URL, section 4.12</a>, the current collection is the collection that is the subject of the path segment.</li>
<li>In an <code>$apply</code> transformation, the current collection is the input set of the transformation.</li>
</ul></li>
</ul>
<h3 id="361-function-aggregate"><a name="Functionaggregate" href="#Functionaggregate">3.6.1 Function <code>aggregate</code></a></h3>
<p>The <code>aggregate</code> function allows the use of aggregated values in <a href="#Expression">expressions</a>. It takes a single parameter accepting an <a href="#AggregateExpression">aggregate expression</a> and returns the aggregated value of type <code>Edm.PrimitiveType</code> as the result from applying the aggregate expression on its input collection.</p>
<p>More precisely, if <span class="math inline">\(α\)</span> is an aggregate expression, the function <span class="math inline">\(p/{\tt aggregate}(α)\)</span> or <span class="math inline">\({\tt\$these}/{\tt aggregate}(α)\)</span> evaluates to the value of the property <span class="math inline">\(D\)</span> in the single instance of the output set that is produced when the transformation <span class="math inline">\({\tt aggregate}(α{\tt\ as\ }D)\)</span> is applied with the input collection as input set.</p>
<div class="example">
<p>Example 41: Sales making up at least a third of the total sales amount.</p>
<pre><code>GET /service/Sales?$filter=Amount mul 3 ge $these/aggregate(Amount with sum)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 42: Products with more than 1.00 sales tax. The aggregate expression of type 2 combines paths with and without <code>$it</code> prefix (compare this with <a href="#aggrmul">example 8</a>).</p>
<pre><code>GET /service/Products?$filter=Sales/aggregate(Amount mul $it/TaxRate with sum)
                              gt 1</code></pre>
</div>
<div class="example">
<p>⚠ Example 43: products with a single sale of at least twice the average sales amount</p>
<pre><code>GET /service/Products?$filter=Sales/any(s:s/Amount ge
                              Sales/aggregate(Amount with average) mul 2)</code></pre>
<p>Both examples result in</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products&quot;</span><span class="fu">,</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="362-expression-count"><a name="Expressioncount" href="#Expressioncount">3.6.2 Expression <code>$count</code></a></h3>
<p>The expression <code>$count</code> evaluates to the cardinality of the input collection.</p>
<div class="example">
<p>Example <a name="collexpr" href="#collexpr">44</a>: The input collection for <code>$count</code> consists of all sales entities, the top third of sales entities by amount form the result.</p>
<pre><code>GET /service/Sales?$apply=topcount($these/$count div 3,Amount)</code></pre>
<p>results in 2 (a third of 8, rounded down) entities. (This differs from <code>toppercent(33.3,Amount)</code>, which returns only the sales entity with <code>ID</code> 4, because that already makes up a third of the total amount.)</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>A definition that is equivalent to a <code>$count</code> expression after a collection-valued path was made in <a href="#ODataURL">OData-URL, section 4.8</a>.</p>
<h2 id="37-function-isdefined"><a name="Functionisdefined" href="#Functionisdefined">3.7 Function <code>isdefined</code></a></h2>
<p>Properties that are not explicitly mentioned in <a href="#Transformationaggregate"><code>aggregate</code></a> or <a href="#Transformationgroupby"><code>groupby</code></a> are considered to have been <em>aggregated away</em>. Since they are treated as having the null value in <code>$filter</code> expressions <a href="#ODataURL">OData-URL, section 5.1.1.15</a>, the <code>$filter</code> expression <code>Product eq null</code> cannot distinguish between an instance containing the value for the null product and the instance containing the aggregated value across all products (where the <code>Product</code> has been aggregated away).</p>
<p>The function <code>isdefined</code> can be used to determine whether a property is present or absent in an instance. It takes a <a href="#SingleValuedPropertyPath">single-valued property path</a> as its only parameter and returns true if the property is present in the instance for which the expression containing the <code>isdefined</code> function call is evaluated. A present property can still have the null value; it can represent a grouping of null values, or an aggregation that results in a null value.</p>
<div class="example">
<p>Example 45: <code>Product</code> has been aggregated away, causing an empty result</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum as Total)
           &amp;$filter=isdefined(Product)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[]</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="38-evaluating-apply-as-an-expand-and-select-option"><a name="EvaluatingapplyasanExpandandSelectOption" href="#EvaluatingapplyasanExpandandSelectOption">3.8 Evaluating <code>$apply</code> as an Expand and Select Option</a></h2>
<p>The new system query option <code>$apply</code> can be used as an expand or select option to inline the result of aggregating related entities or nested instances. The rules for <a href="#SystemQueryOptionapply">evaluating <code>$apply</code></a> are applied in the context of the related collection of entities or the selected collection of instances, meaning this context defines the input set of the first transformation. Furthermore, <code>$apply</code> is evaluated first, and other expand or select options on the same (navigation) property are evaluated on the result of <code>$apply</code>.</p>
<div class="example">
<p>Example 46: products with aggregated sales</p>
<pre><code>GET /service/Products
  ?$expand=Sales($apply=aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Sales(Total))&quot;</span><span class="fu">,</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>   <span class="dv">12</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">8</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Black&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">4</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="39-abnf-for-extended-url-conventions"><a name="ABNFforExtendedURLConventions" href="#ABNFforExtendedURLConventions">3.9 ABNF for Extended URL Conventions</a></h2>
<p>The normative ABNF construction rules for this specification are defined in <a href="#ODataAggABNF">OData-Agg-ABNF</a>. They incrementally extend the rules defined in <a href="#ODataABNF">OData-ABNF</a>.</p>
<hr />
<h1 id="4-cross-joins-and-aggregation"><a name="CrossJoinsandAggregation" href="#CrossJoinsandAggregation">4 Cross-Joins and Aggregation</a></h1>
<p>OData supports querying related entities through defining navigation properties in the data model. These navigation paths help guide simple consumers in understanding and navigating relationships.</p>
<p>In some cases, however, requests need to span entity sets with no predefined associations. Such requests can be sent to the special resource <code>$crossjoin</code> instead of an individual entity set. The cross join of a list of entity sets is the Cartesian product of the listed entity sets, represented as a collection of complex type instances that have a navigation property with cardinality to-one for each participating entity set, and queries across entity sets can be formulated using these navigation properties. See <a href="#ODataURL">OData-URL</a> for details.</p>
<p>Where useful navigations exist it is beneficial to expose those as explicit navigation properties in the model, but the ability to pose queries that span entity sets not related by an association provides a mechanism for advanced consumers to use more flexible join conditions.</p>
<div class="example">
<p>Example 47: if <code>Sale</code> had a string property <code>ProductID</code> instead of the navigation property <code>Product</code>, a “join” between <code>Sales</code> and <code>Products</code> could be accessed via the <code>$crossjoin</code> resource</p>
<pre><code>GET /service/$crossjoin(Products,Sales)
                         ?$expand=Products($select=Name),Sales($select=Amount)
                         &amp;$filter=Products/ID eq Sales/ProductID</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Collection(Edm.ComplexType)&quot;</span><span class="fu">,</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 48: using the <code>$crossjoin</code> resource for aggregate queries</p>
<pre><code>GET /service/$crossjoin(Products,Sales)
    ?$apply=filter(Products/ID eq Sales/ProductID)
           /groupby((Products/Name),
                    aggregate(Sales/Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Collection(Edm.ComplexType)&quot;</span><span class="fu">,</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">},</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Products&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">},</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The entity container may be annotated in the same way as entity sets to express which aggregate queries are supported, see <a href="#VocabularyforDataAggregation">section 5</a>.</p>
<hr />
<h1 id="5-vocabulary-for-data-aggregation"><a name="VocabularyforDataAggregation" href="#VocabularyforDataAggregation">5 Vocabulary for Data Aggregation</a></h1>
<p>The following terms are defined in the vocabulary for data aggregation <a href="#ODataVocAggr">OData-VocAggr</a>.</p>
<h2 id="51-aggregation-capabilities"><a name="AggregationCapabilities" href="#AggregationCapabilities">5.1 Aggregation Capabilities</a></h2>
<p>The term <code>ApplySupported</code> can be applied to an entity set, an entity type, or a collection if the target expression of the annotation starts with an entity container (see <a href="#containerrooted">example 50</a>). It describes the aggregation capabilities of the annotated target. If present, it implies that instances of the annotated target can contain dynamic properties as an effect of <code>$apply</code> even if they do not specify the <code>OpenType</code> attribute, see <a href="#ODataCSDL">OData-CSDL</a>. The term has a complex type with the following properties:</p>
<ul>
<li>The <code>Transformations</code> collection lists all supported set transformations. Allowed values are the names of the standard transformations introduced in sections 3 and 6, and namespace-qualified names identifying a service-defined bindable function. If <code>Transformations</code> is omitted the server supports all transformations defined by this specification.</li>
<li>The <code>CustomAggregationMethods</code> collection lists supported custom aggregation methods. Allowed values are namespace-qualified names identifying service-specific aggregation methods. If omitted, no custom aggregation methods are supported.</li>
<li><code>Rollup</code> specifies whether the service supports no rollup, only a single rollup hierarchy, or multiple rollup hierarchies in a <a href="#Transformationgroupby"><code>groupby</code></a> transformation. If omitted, multiple rollup hierarchies are supported.</li>
<li>A non-empty <code>GroupableProperties</code> indicates that only the listed properties of the annotated target can be used in <code>groupby</code>.</li>
<li>A non-empty <code>AggregatableProperties</code> indicates that only the listed properties of the annotated target can be used in <a href="#Transformationaggregate"><code>aggregate</code></a>, optionally restricted to the specified aggregation methods.</li>
</ul>
<p>All properties of <code>ApplySupported</code> are optional, so it can be used as a tagging annotation to signal unlimited support of aggregation.</p>
<p>The term <code>ApplySupportedDefaults</code> can be applied to an entity container. It allows to specify default support for aggregation capabilities <code>Transformations</code>, <code>CustomAggregationMethods</code> and <code>Rollup</code> that propagate to all collection-valued resources in the container. Annotating a specific collection-valued resource with the term <code>ApplySupported</code> overrides the default support with the specified properties using <code>PATCH</code> semantics:</p>
<ul>
<li>Primitive or collection-valued properties specified in <code>ApplySupported</code> replace the corresponding properties specified in <code>ApplySupportedDefaults</code>.</li>
<li>Complex-valued properties specified in <code>ApplySupported</code> override the corresponding properties specified in ApplySupportedDefaults using <code>PATCH</code> semantics recursively.</li>
<li>Properties specified neither in <code>ApplySupported</code> nor in <code>ApplySupportedDefault</code> have their default value.</li>
</ul>
<div class="example">
<p>Example 49: an entity container with default support for everything defined in this specification</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityContainer</span><span class="ot"> Name=</span><span class="st">&quot;SalesData&quot;</span>&gt;</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupportedDefaults&quot;</span> /&gt;</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  …</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityContainer</span>&gt;</span></code></pre></div>
</div>
<div class="example">
<p>Example <a name="containerrooted" href="#containerrooted">50</a>: Define aggregation support only for the products of a given category</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesData/Categories/Products&quot;</span>&gt;</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupported&quot;</span>&gt;</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    …</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Annotations</span>&gt;</span></code></pre></div>
</div>
<h2 id="52-custom-aggregates"><a name="CustomAggregates" href="#CustomAggregates">5.2 Custom Aggregates</a></h2>
<p>The term <code>CustomAggregate</code> allows defining dynamic properties that can be used in <a href="#Transformationaggregate"><code>aggregate</code></a>. No assumptions can be made on how the values of these custom aggregates are calculated, whether they are null, and which input values are used.</p>
<p>When applied to an entity set, an entity type, or a collection if the target expression of the annotation starts with an entity container, the annotation specifies custom aggregates that are available for its instances and for aggregated instances resulting from these instances. When applied to an entity container, the annotation specifies custom aggregates whose input set may span multiple entity sets within the container.</p>
<p>A custom aggregate is identified by the value of the <code>Qualifier</code> attribute when applying the term. The value of the <code>Qualifier</code> attribute is the name of the dynamic property. The name MUST NOT collide with the names of other custom aggregates of the same model element.</p>
<p>The value of the annotation is a string with the qualified name of a primitive type or type definition in scope that specifies the type returned by the custom aggregate.</p>
<p>If the custom aggregate is associated with an entity set, entity type, or collection, the value of the <code>Qualifier</code> attribute MAY be identical to the name of a declared property of the instances in this set or collection. In these cases, the value of the annotation MUST have the same value as the <code>Type</code> attribute of the declared property. This is typically done when the custom aggregate is used as a default aggregate for that property. In this case the name refers to the custom aggregate within an aggregate expression without a <code>with</code> clause, and to the property in all other cases.</p>
<p>If the custom aggregate is associated with an entity container, the value of the <code>Qualifier</code> attribute MUST NOT collide with the names of any entity container children.</p>
<div class="example">
<p>Example 51: Sales forecasts are modeled as a custom aggregate of the Sale entity type because it belongs there. For the budget, there is no appropriate structured type, so it is modeled as a custom aggregate of the <code>SalesData</code> entity container.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesData/Sales&quot;</span>&gt;</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.CustomAggregate&quot;</span><span class="ot"> Qualifier=</span><span class="st">&quot;Forecast&quot;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="ot">              String=</span><span class="st">&quot;Edm.Decimal&quot;</span> /&gt;</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Annotations</span>&gt;</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesData&quot;</span>&gt;</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.CustomAggregate&quot;</span><span class="ot"> Qualifier=</span><span class="st">&quot;Budget&quot;</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="ot">              String=</span><span class="st">&quot;Edm.Decimal&quot;</span> /&gt;</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Annotations</span>&gt;</span></code></pre></div>
<p>These custom aggregates can be used in the <code>aggregate</code> transformation:</p>
<pre><code>GET /service/Sales?$apply=groupby((Time/Month),aggregate(Forecast))</code></pre>
<p>and:</p>
<pre><code>GET /service/$crossjoin(Time)?$apply=groupby((Time/Year),aggregate(Budget))</code></pre>
</div>
<h2 id="53-context-defining-properties"><a name="ContextDefiningProperties" href="#ContextDefiningProperties">5.3 Context-Defining Properties</a></h2>
<p>Sometimes the value of a property or custom aggregate is only well-defined within the context given by values of other properties, e.g. a postal code together with its country, or a monetary amount together with its currency unit. These context-defining properties can be listed with the term <code>ContextDefiningProperties</code> whose type is a collection of property paths.</p>
<p>If present, the context-defining properties SHOULD be used as grouping properties when aggregating the annotated property or custom aggregate, or alternatively be restricted to a single value by a pre-filter operation. Services MAY respond with <code>400 Bad Request</code> if the context-defining properties are not sufficiently specified for calculating a meaningful aggregate value.</p>
<h2 id="54-annotation-example"><a name="AnnotationExample" href="#AnnotationExample">5.4 Annotation Example</a></h2>
<div class="example">
<p>Example 52: This simplified <code>Sales</code> entity set has a single aggregatable property <code>Amount</code> whose context is defined by the <code>Code</code> property of the related <code>Currency</code>, and a custom aggregate <code>Forecast</code> with the same context. The <code>Code</code> property of <code>Currencies</code> is groupable. All other properties are neither groupable nor aggregatable.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;Currency&quot;</span>&gt;</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;Code&quot;</span> /&gt;</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Code&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Name&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span>&gt;</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Core.IsLanguageDependent&quot;</span> /&gt;</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Property</span>&gt;</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;Sale&quot;</span>&gt;</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Amount&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.Decimal&quot;</span><span class="ot"> Scale=</span><span class="st">&quot;variable&quot;</span>&gt;</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ContextDefiningProperties&quot;</span>&gt;</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyPath</span>&gt;Currency/Code&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Property</span>&gt;</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Currency&quot;</span><span class="ot"> Type=</span><span class="st">&quot;SalesModel.Currency&quot;</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityContainer</span><span class="ot"> Name=</span><span class="st">&quot;SalesData&quot;</span>&gt;</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">EntitySet</span><span class="ot"> Name=</span><span class="st">&quot;Sales&quot;</span><span class="ot"> EntityType=</span><span class="st">&quot;SalesModel.Sale&quot;</span>&gt;</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupported&quot;</span>&gt;</span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;AggregatableProperties&quot;</span>&gt;</span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>              &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;Property&quot;</span><span class="ot"> PropertyPath=</span><span class="st">&quot;Amount&quot;</span> /&gt;</span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">PropertyValue</span>&gt;</span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;GroupableProperties&quot;</span>&gt;</span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Currency&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">PropertyValue</span>&gt;</span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb93-44"><a href="#cb93-44" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb93-45"><a href="#cb93-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-46"><a href="#cb93-46" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.CustomAggregate&quot;</span><span class="ot"> Qualifier=</span><span class="st">&quot;Forecast&quot;</span></span>
<span id="cb93-47"><a href="#cb93-47" aria-hidden="true" tabindex="-1"></a><span class="ot">                String=</span><span class="st">&quot;Edm.Decimal&quot;</span>&gt;</span>
<span id="cb93-48"><a href="#cb93-48" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ContextDefiningProperties&quot;</span>&gt;</span>
<span id="cb93-49"><a href="#cb93-49" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb93-50"><a href="#cb93-50" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">PropertyPath</span>&gt;Currency/Code&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb93-51"><a href="#cb93-51" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb93-52"><a href="#cb93-52" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb93-53"><a href="#cb93-53" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb93-54"><a href="#cb93-54" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">EntitySet</span>&gt;</span>
<span id="cb93-55"><a href="#cb93-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-56"><a href="#cb93-56" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">EntitySet</span><span class="ot"> Name=</span><span class="st">&quot;Currencies&quot;</span><span class="ot"> EntityType=</span><span class="st">&quot;SalesModel.Currency&quot;</span>&gt;</span>
<span id="cb93-57"><a href="#cb93-57" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.ApplySupported&quot;</span>&gt;</span>
<span id="cb93-58"><a href="#cb93-58" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb93-59"><a href="#cb93-59" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;GroupableProperties&quot;</span>&gt;</span>
<span id="cb93-60"><a href="#cb93-60" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb93-61"><a href="#cb93-61" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Code&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb93-62"><a href="#cb93-62" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb93-63"><a href="#cb93-63" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">PropertyValue</span>&gt;</span>
<span id="cb93-64"><a href="#cb93-64" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb93-65"><a href="#cb93-65" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb93-66"><a href="#cb93-66" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">EntitySet</span>&gt;</span>
<span id="cb93-67"><a href="#cb93-67" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityContainer</span>&gt;</span></code></pre></div>
</div>
<h2 id="55-hierarchies"><a name="Hierarchies" href="#Hierarchies">5.5 Hierarchies</a></h2>
<p>A hierarchy is an arrangement of entities whose values are represented as being “above”, “below”, or “at the same level as” one another. A hierarchy can be leveled or recursive.</p>
<h3 id="551-leveled-hierarchy"><a name="LeveledHierarchy" href="#LeveledHierarchy">5.5.1 Leveled Hierarchy</a></h3>
<p>A <em>leveled hierarchy</em> has a fixed number of levels each of which is represented by a <a href="#SimpleGrouping">grouping property</a>. The values of a lower-level property depend on the property value of the level above.</p>
<p>A leveled hierarchy can be defined for a collection of instances of an entity or complex type and is described with the term <code>LeveledHierarchy</code> that lists the properties used to form the hierarchy.</p>
<p>The order of the collection is significant: it lists paths from the entity or complex type where the term is applied to groupable properties representing the levels, starting with the root level (coarsest granularity) down to the lowest (finest-grained) level of the hierarchy.</p>
<p>The term <code>LeveledHierarchy</code> MUST be applied with a qualifier that can be used to reference the hierarchy in <a href="#Groupingwithrollup">grouping with <code>rollup</code></a>.</p>
<h3 id="552-recursive-hierarchy"><a name="RecursiveHierarchy" href="#RecursiveHierarchy">5.5.2 Recursive Hierarchy</a></h3>
<p>A recursive hierarchy is defined on a collection of entities by</p>
<ul>
<li>determining which entities are part of the hierarchy and giving every such entity a single primitive non-null value that uniquely identifies it within the hierarchy. These entities are called <em>nodes</em>, and the primitive value is called the <em>node identifier</em>, and</li>
<li>associating with every node zero or more nodes from the same collection, called its <em>parent nodes</em>.</li>
</ul>
<p>The recursive hierarchy is described in the model by an annotation of the entity type with the complex term <code>RecursiveHierarchy</code> with these properties:</p>
<ul>
<li>The <code>NodeProperty</code> MUST be a path with single-valued segments ending in a primitive property. This property holds the node identifier of an entity that is a node in the hierarchy.</li>
<li>The <code>ParentNavigationProperty</code> MUST be a collection-valued or nullable single-valued navigation property path that addresses the entity type annotated with this term. It navigates from an entity that is a node in the hierarchy to its parent nodes.</li>
</ul>
<p>The term <code>RecursiveHierarchy</code> can only be applied to entity types, and MUST be applied with a qualifier, which is used to reference the hierarchy in transformations operating on recursive hierarchies, in <a href="#Groupingwithrolluprecursive">grouping with <code>rolluprecursive</code></a>, and in <a href="#HierarchyFunctions">hierarchy functions</a>. The same entity can serve as nodes in different recursive hierarchies, given different qualifiers.</p>
<p>A <em>root node</em> is a node without parent nodes. A recursive hierarchy can have one or more root nodes. A node is a <em>child node</em> of its parent nodes, a node without child nodes is a <em>leaf node</em>. Two nodes with a common parent node are <em>sibling nodes</em> and so are two root nodes.</p>
<p>The <em>descendants with maximum distance <span class="math inline">\(d≥1\)</span></em> of a node are its child nodes and, if <span class="math inline">\(d&gt;1\)</span>, the descendants of these child nodes with maximum distance <span class="math inline">\(d-1\)</span>. The <em>descendants</em> are the descendants with maximum distance <span class="math inline">\(d=∞\)</span>. A node together with its descendants forms a <em>sub-hierarchy</em> of the hierarchy.</p>
<p>The <em>ancestors with maximum distance <span class="math inline">\(d≥1\)</span></em> of a node are its parent nodes and, if <span class="math inline">\(d&gt;1\)</span>, the ancestors of these parent nodes with maximum distance <span class="math inline">\(d-1\)</span>. The <em>ancestors</em> are the ancestors with maximum distance <span class="math inline">\(d=∞\)</span>. The <code>ParentNavigationProperty</code> MUST be such that no node is an ancestor of itself, in other words: cycles are forbidden.</p>
<p>The term <code>UpPath</code> can be used in hierarchical result sets to associate with each instance one of its ancestors, one ancestor of that ancestor and so on. This instance annotation is introduced in <a href="#Transformationtraverse">section 6.2.2</a>.</p>
<h4 id="5521-hierarchy-functions"><a name="HierarchyFunctions" href="#HierarchyFunctions">5.5.2.1 Hierarchy Functions</a></h4>
<p>For testing the position of a given entity in a recursive hierarchy, the Aggregation vocabulary <a href="#ODataVocAggr">OData-VocAggr</a> defines unbound functions. These have</p>
<ul>
<li>a parameter pair <code>HierarchyNodes</code>, <code>HierarchyQualifier</code> where <code>HierarchyNodes</code> is a collection and <code>HierarchyQualifier</code> is the qualifier of a <code>RecursiveHierarchy</code> annotation on its common entity type. The node identifiers in this collection define the recursive hierarchy.</li>
<li>a parameter <code>Node</code> that contains the node identifier of the entity to be tested. Note that the test result depends only on this node identifier, not on any other property of the given entity</li>
<li>additional parameters, depending on the type of test (see below)</li>
<li>a Boolean return value for the outcome of the test.</li>
</ul>
<p>The following functions are defined:</p>
<ul>
<li><code>isnode</code> tests if the given entity is a node of the hierarchy.</li>
<li><code>isroot</code> tests if the given entity is a root node of the hierarchy.</li>
<li><code>isdescendant</code> tests if the given entity is a descendant with maximum distance <code>MaxDistance</code> of an ancestor node (whose node identifier is given in a parameter <code>Ancestor</code>), or equals the ancestor if <code>IncludeSelf</code> is true.</li>
<li><code>isancestor</code> tests if the given entity is an ancestor with maximum distance <code>MaxDistance</code> of a descendant node (whose node identifier is given in a parameter <code>Descendant</code>), or equals the descendant if <code>IncludeSelf</code> is true.</li>
<li><code>issibling</code> tests if the given entity and another entity (whose node identifier is given in a parameter <code>Other</code>) are sibling nodes.</li>
<li><code>isleaf</code> tests if the given entity is a leaf node.</li>
</ul>
<p>Another function <code>rollupnode</code> is defined that can only be used in connection with <a href="#Groupingwithrolluprecursive"><code>rolluprecursive</code></a>.</p>
<h3 id="553-hierarchy-examples"><a name="HierarchyExamples" href="#HierarchyExamples">5.5.3 Hierarchy Examples</a></h3>
<p>The hierarchy terms can be applied to the <a href="#ExampleDataModel">Example Data Model</a>.</p>
<div class="example">
<p>⚠ Example 53: leveled hierarchies for products and time, and a recursive hierarchy for the sales organizations:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="ot"> standalone=</span><span class="st">&quot;yes&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">edmx:Edmx</span><span class="ot"> xmlns:edmx=</span><span class="st">&quot;http://docs.oasis-open.org/odata/ns/edmx&quot;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="ot">           Version=</span><span class="st">&quot;4.0&quot;</span>&gt;</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">edmx:Reference</span><span class="ot"> Uri=</span><span class="st">&quot;https://docs.oasis-open.org/odata/odata-data-</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="st">    aggregation-ext/v4.0/cs03/vocabularies/Org.OData.Aggregation.V1.xml&quot;</span>&gt;</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edmx:Include</span><span class="ot"> Alias=</span><span class="st">&quot;Aggregation&quot;</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="ot">                  Namespace=</span><span class="st">&quot;Org.OData.Aggregation.V1&quot;</span> /&gt;</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">edmx:Reference</span>&gt;</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">edmx:DataServices</span>&gt;</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Schema</span><span class="ot"> xmlns=</span><span class="st">&quot;http://docs.oasis-open.org/odata/ns/edm&quot;</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="ot">            Alias=</span><span class="st">&quot;SalesModel&quot;</span><span class="ot"> Namespace=</span><span class="st">&quot;org.example.odata.salesservice&quot;</span>&gt;</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.Product&quot;</span>&gt;</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.LeveledHierarchy&quot;</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="ot">                    Qualifier=</span><span class="st">&quot;ProductHierarchy&quot;</span>&gt;</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Category/Name&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Name&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Annotations</span>&gt;</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.Time&quot;</span>&gt;</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.LeveledHierarchy&quot;</span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="ot">                    Qualifier=</span><span class="st">&quot;TimeHierarchy&quot;</span>&gt;</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Collection</span>&gt;</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Year&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Quarter&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyPath</span>&gt;Month&lt;/<span class="kw">PropertyPath</span>&gt;</span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Collection</span>&gt;</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Annotations</span>&gt;</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesModel.SalesOrganization&quot;</span>&gt;</span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.RecursiveHierarchy&quot;</span></span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a><span class="ot">                    Qualifier=</span><span class="st">&quot;SalesOrgHierarchy&quot;</span>&gt;</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;NodeProperty&quot;</span></span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a><span class="ot">                           PropertyPath=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;ParentNavigationProperty&quot;</span></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a><span class="ot">                           PropertyPath=</span><span class="st">&quot;Superordinate&quot;</span> /&gt;</span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>          &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">Annotations</span>&gt;</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Schema</span>&gt;</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">edmx:DataServices</span>&gt;</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">edmx:Edmx</span>&gt;</span></code></pre></div>
</div>
<p>The recursive hierarchy <code>SalesOrgHierarchy</code> can be used in functions with the <code>$filter</code> system query option.</p>
<div class="example">
<p>Example 54: requesting all organizations below EMEA</p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isdescendant(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID,
  Ancestor=&#39;EMEA&#39;)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Netherlands&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Netherlands&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Germany&quot;</span><span class="fu">,</span>     <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Germany&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span><span class="fu">,</span>        <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span><span class="fu">,</span>        <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 55: requesting just those organizations directly below EMEA</p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isdescendant(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID,
  Ancestor=&#39;EMEA&#39;,
  MaxDistance=1)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA South&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA North&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 56: just the lowest-level organizations</p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isleaf(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 57: the lowest-level organizations including their superordinate’s <code>ID</code></p>
<pre><code>GET /service/SalesOrganizations?$filter=Aggregation.isleaf(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=ID)
&amp;$expand=Superordinate($select=ID)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations(*,Superordinate(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office London&quot;</span><span class="fu">,</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA United Kingdom&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales Office New York&quot;</span><span class="fu">,</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 58: the sales <code>ID</code>s involving sales organizations from EMEA</p>
<pre><code>
GET /service/Sales?$select=ID&amp;$filter=Aggregation.isdescendant(
  HierarchyNodes=$root/SalesOrganizations,
  HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
  Node=SalesOrganization/ID,
  Ancestor=&#39;EMEA&#39;)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(ID)&quot;</span><span class="fu">,</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>Further examples for recursive hierarchies using transformations operating on the hierarchy structure are provided in <a href="#AggregationinRecursiveHierarchies">section 7.9</a>.</p>
<h2 id="56-functions-on-aggregated-entities"><a name="FunctionsonAggregatedEntities" href="#FunctionsonAggregatedEntities">5.6 Functions on Aggregated Entities</a></h2>
<p>Service-defined bound functions that serve as set transformations MAY be annotated with the term <code>AvailableOnAggregates</code> to indicate that they are applicable to aggregated entities under specific conditions:</p>
<ul>
<li>The <code>RequiredProperties</code> collection lists all properties that must be available in the aggregated entities; otherwise, the annotated function will be inapplicable.</li>
</ul>
<div class="example">
<p>Example 59: assume the product is an implicit input for a function bound to a collection of <code>Sales</code>, then aggregating away the product makes this function inapplicable.</p>
</div>
<hr />
<h1 id="6-hierarchical-transformations"><a name="HierarchicalTransformations" href="#HierarchicalTransformations">6 Hierarchical Transformations</a></h1>
<p>The transformations and the <code>rolluprecursive</code> operator defined in this section are called hierarchical, because they make use of a recursive hierarchy and are defined in terms of hierarchy functions introduced in the previous section.</p>
<p>The transformations <code>ancestors</code> and <code>descendants</code> do not define an order on the output set. An order can be imposed by a subsequent <code>orderby</code> or <code>traverse</code> transformation or a <code>$orderby</code>. The output set of <code>traverse</code> is in preorder or postorder, and grouping with <code>rolluprecursive</code> orders its output set in analogy with <a href="#SimpleGrouping">simple grouping</a>.</p>
<p>The algorithmic descriptions of the transformations make use of a <em>union</em> of collections, this is defined as an unordered collection containing the items from all these collections and from which duplicates have been removed.</p>
<p>The notation <span class="math inline">\(u[t]\)</span> is used to denote the value of a property <span class="math inline">\(t\)</span>, possibly preceded by a type-cast segment, in an instance <span class="math inline">\(u\)</span>. It is also used to denote the value of a single-valued data aggregation path <span class="math inline">\(t\)</span>, evaluated relative to <span class="math inline">\(u\)</span>. The value of a collection-valued <a href="#DataAggregationPath">data aggregation path</a> is denoted in the <a href="#EvaluationofDataAggregationPaths"><span class="math inline">\(\Gamma\)</span> notation</a> by <span class="math inline">\(γ(u,t)\)</span>.</p>
<p>The notations introduced here are used throughout the following subsections.</p>
<h2 id="61-common-parameters-for-hierarchical-transformations"><a name="CommonParametersforHierarchicalTransformations" href="#CommonParametersforHierarchicalTransformations">6.1 Common Parameters for Hierarchical Transformations</a></h2>
<p>The parameter lists defined in the following subsections have three mandatory parameters in common.</p>
<p>The recursive hierarchy is defined by a parameter pair <span class="math inline">\((H,Q)\)</span>, where <span class="math inline">\(H\)</span> and <span class="math inline">\(Q\)</span> MUST be specified as the first and second parameter. Here, <span class="math inline">\(H\)</span> MUST be an expression of type <code>Collection(Edm.EntityType)</code> starting with <code>$root</code> that has no multiple occurrences of the same entity. <span class="math inline">\(H\)</span> identifies the collection of node entities forming a recursive hierarchy based on an annotation of their common entity type with term <code>RecursiveHierarchy</code> with a <code>Qualifier</code> attribute whose value MUST be provided in <span class="math inline">\(Q\)</span>. The property paths referenced by <code>NodeProperty</code> and <code>ParentNavigationProperty</code> in the <code>RecursiveHierarchy</code> annotation must be evaluable for the nodes in the recursive hierarchy, otherwise the service MUST reject the request. The <code>NodeProperty</code> is denoted by <span class="math inline">\(q\)</span> in this section.</p>
<p>The third parameter MUST be a data aggregation path <span class="math inline">\(p\)</span> with single- or collection-valued segments whose last segment MUST be a primitive property. The node identifier(s) of an instance <span class="math inline">\(u\)</span> in the input set are the primitive values in <span class="math inline">\(γ(u,p)\)</span>, they are reached via <span class="math inline">\(p\)</span> starting from <span class="math inline">\(u\)</span>. Let <span class="math inline">\(p=p_1/…/p_k/r\)</span> with <span class="math inline">\(k≥0\)</span> be the concatenation where each sub-path <span class="math inline">\(p_1,…,p_k\)</span> consists of a collection-valued segment that is preceded by zero or more single-valued segments, and either <span class="math inline">\(r\)</span> consists of one or more single-valued segments or <span class="math inline">\(k≥1\)</span> and <span class="math inline">\({}/r\)</span> is absent. Each segment can be prefixed with a type cast.</p>
<p>Some parameter lists allow as optional fourth or fifth parameter a non-empty sequence <span class="math inline">\(S\)</span> of transformations. The transformation sequence <span class="math inline">\(S\)</span> will be applied to the node collection <span class="math inline">\(H\)</span>. It MUST consist of transformations listed in <a href="#TransformationsProducingaSubset">section 3.3</a> or <a href="#HierarchicalTransformationsProducingaSubset">section 6.2</a> or service-defined bound functions whose output set is a subset of their input set.</p>
<h2 id="62-hierarchical-transformations-producing-a-subset"><a name="HierarchicalTransformationsProducingaSubset" href="#HierarchicalTransformationsProducingaSubset">6.2 Hierarchical Transformations Producing a Subset</a></h2>
<p>These transformations produce an output set that consists of certain instances from their input set, possibly with repetitions or in a different order.</p>
<h3 id="621-transformations-ancestors-and-descendants"><a name="Transformationsancestorsanddescendants" href="#Transformationsancestorsanddescendants">6.2.1 Transformations <code>ancestors</code> and <code>descendants</code></a></h3>
<p>In the simple case, the <code>ancestors</code> transformation takes an input set consisting of instances that belong to a recursive hierarchy <span class="math inline">\((H,Q)\)</span>. It determines a subset <span class="math inline">\(A\)</span> of the input set and then determines the set of ancestors of <span class="math inline">\(A\)</span> that were already contained in the input set. Its output set is the ancestors set, optionally including <span class="math inline">\(A\)</span>.</p>
<p>In the more complex case, the instances in the input set are instead related to nodes in a recursive hierarchy. Then the <code>ancestors</code> transformation determines a subset <span class="math inline">\(A\)</span> of the input set consisting of instances that are related to certain nodes in the hierarchy, called start nodes. The ancestors of these start nodes are then determined, and the output set consists of instances of the input set that are related to the ancestors, or optionally to the start nodes.</p>
<p>The <code>descendants</code> transformation works analogously, but with descendants.</p>
<p><span class="math inline">\(H\)</span>, <span class="math inline">\(Q\)</span> and <span class="math inline">\(p\)</span> are the first three parameters defined <a href="#CommonParametersforHierarchicalTransformations">above</a>.</p>
<p>The fourth parameter is a transformation sequence <span class="math inline">\(T\)</span> composed of transformations listed <a href="#TransformationsProducingaSubset">section 3.3</a> or <a href="#Transformationsancestorsanddescendants">section 6.2.1</a> and of service-defined bound functions whose output set is a subset of their input set. <span class="math inline">\(A\)</span> is the output set of this sequence applied to the input set.</p>
<p>The fifth parameter <span class="math inline">\(d\)</span> is optional and takes an integer greater than or equal to 1 that specifies the maximum distance between start nodes and ancestors or descendants to be considered. An optional final <code>keep start</code> parameter drives the optional inclusion of the subset or start nodes.</p>
<p>The output set of the transformation <span class="math inline">\({\tt ancestors}(H,Q,p,T,d,{\tt keep\ start})\)</span> or <span class="math inline">\({\tt descendants}(H,Q,p,T,d,{\tt keep\ start})\)</span> is defined as the <a href="#HierarchicalTransformations">union</a> of the output sets of transformations <span class="math inline">\(F(u)\)</span> applied to the input set for all <span class="math inline">\(u\)</span> in <span class="math inline">\(A\)</span>. For a given instance <span class="math inline">\(u\)</span>, the transformation <span class="math inline">\(F(u)\)</span> determines all instances of the input set whose node identifier is an ancestor or descendant of the node identifier of <span class="math inline">\(u\)</span>:</p>
<p>If <span class="math inline">\(p\)</span> contains only single-valued segments, then, for <code>ancestors</code>, <span class="math display">\[\matrix{ F(u)={\tt filter}(\hbox{\tt Aggregation.isancestor}(\hfill\\ \quad {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\ \quad {\tt Node}=p,\;{\tt Descendant}=u[p],\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true}))\hfill }\]</span> or, for <code>descendants</code>, <span class="math display">\[\matrix{ F(u)={\tt filter}(\hbox{\tt Aggregation.isdescendant}(\hfill\\ \quad {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\ \quad {\tt Node}=p,\;{\tt Ancestor}=u[p],\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true})).\hfill }\]</span></p>
<p>Otherwise <span class="math inline">\(p=p_1/…/p_k/r\)</span> with <span class="math inline">\(k≥1\)</span>, in this case the output set of the transformation <span class="math inline">\(F(u)\)</span> is defined as the <a href="#HierarchicalTransformations">union</a> of the output sets of transformations <span class="math inline">\(G(n)\)</span> applied to the input set for all <span class="math inline">\(n\)</span> in <span class="math inline">\(γ(u,p)\)</span>. The output set of <span class="math inline">\(G(n)\)</span> consists of the instances of the input set whose node identifier is an ancestor or descendant of the node identifier <span class="math inline">\(n\)</span>:</p>
<p>For <code>ancestors</code>, <span class="math display">\[\matrix{ G(n)={\tt filter}(\hfill\\ \hskip1pc p_1/{\tt any}(y_1:\hfill\\ \hskip2pc y_1/p_2/{\tt any}(y_2:\hfill\\ \hskip3pc ⋱\hfill\\ \hskip4pc y_{k-1}/p_k/{\tt any}(y_k:\hfill\\ \hskip5pc \hbox{\tt Aggregation.isancestor}(\hfill\\ \hskip6pc {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\ \hskip6pc {\tt Node}=y_k/r,\;{\tt Descendant}=n,\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true}\hfill\\ \hskip5pc )\hfill\\ \hskip4pc )\hfill\\ \hskip3pc ⋰\hfill\\ \hskip2pc )\hfill\\ \hskip1pc )\hfill\\ )\hfill }\]</span> or, for <code>descendants</code>, <span class="math display">\[\matrix{ G(n)={\tt filter}(\hfill\\ \hskip1pc p_1/{\tt any}(y_1:\hfill\\ \hskip2pc y_1/p_2/{\tt any}(y_2:\hfill\\ \hskip3pc ⋱\hfill\\ \hskip4pc y_{k-1}/p_k/{\tt any}(y_k:\hfill\\ \hskip5pc \hbox{\tt Aggregation.isdescendant}(\hfill\\ \hskip6pc {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\ \hskip6pc {\tt Node}=y_k/r,\;{\tt Ancestor}=n,\;{\tt MaxDistance}=d,\;{\tt IncludeSelf}={\tt true}\hfill\\ \hskip5pc )\hfill\\ \hskip4pc )\hfill\\ \hskip3pc ⋰\hfill\\ \hskip2pc )\hfill\\ \hskip1pc )\hfill\\ )\hfill }\]</span> where <span class="math inline">\(y_1,…,y_k\)</span> denote <code>lambdaVariableExpr</code>s as defined in <a href="#ODataABNF">OData-ABNF</a> and <span class="math inline">\({}/r\)</span> may be absent.</p>
<p>If parameter <span class="math inline">\(d\)</span> is absent, the parameter <span class="math inline">\({\tt MaxDistance}=d\)</span> is omitted. If <code>keep start</code> is absent, the parameter <span class="math inline">\({\tt IncludeSelf}={\tt true}\)</span> is omitted.</p>
<p>Since the output set of <code>ancestors</code> is constructed as a union, no instance from the input set will occur more than once in it, even if, for example, a sale is related to both a sales organization and one of its ancestor organizations. For <code>descendants</code>, analogously.</p>
<div class="example">
<p>Example 60: Request based on the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a>, with <code>Superordinate/$ref</code> expanded to illustrate the hierarchy relation</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    ancestors($root/SalesOrganizations,SalesOrgHierarchy,ID,
              filter(contains(Name,&#39;East&#39;) or contains(Name,&#39;Central&#39;)))
  &amp;$expand=Superordinate/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>    <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 61: Request based on the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a>, with <code>Superordinate/$ref</code> expanded to illustrate the hierarchy relation</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    descendants($root/SalesOrganizations,SalesOrgHierarchy,ID,
                filter(Name eq &#39;US&#39;),keep start)
  &amp;$expand=Superordinate/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example 62: Input set and recursive hierarchy from two different entity sets</p>
<pre><code>GET /service/Sales?$apply=
    ancestors($root/SalesOrganizations,
              SalesOrgHierarchy,
              SalesOrganization/ID,
              filter(contains(SalesOrganization/Name,&#39;East&#39;)
                  or contains(SalesOrganization/Name,&#39;Central&#39;)),
              keep start)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;5&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;6&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;7&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;8&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h3 id="622-transformation-traverse"><a name="Transformationtraverse" href="#Transformationtraverse">6.2.2 Transformation <code>traverse</code></a></h3>
<p>The traverse transformation returns instances of the input set that are or are related to nodes of a given recursive hierarchy in a specified tree order.</p>
<p><span class="math inline">\(H\)</span>, <span class="math inline">\(Q\)</span> and <span class="math inline">\(p\)</span> are the first three parameters defined <a href="#CommonParametersforHierarchicalTransformations">above</a>.</p>
<p>The fourth parameter <span class="math inline">\(h\)</span> of the <code>traverse</code> transformation is either <code>preorder</code> or <code>postorder</code>. <span class="math inline">\(S\)</span> is an optional fifth parameter as defined <a href="#CommonParametersforHierarchicalTransformations">above</a>. Let <span class="math inline">\(H&#39;\)</span> be the output set of the transformation sequence <span class="math inline">\(S\)</span> applied to <span class="math inline">\(H\)</span>, or let <span class="math inline">\(H&#39;\)</span> be the collection of root nodes in the recursive hierarchy <span class="math inline">\((H,Q)\)</span> if <span class="math inline">\(S\)</span> is not specified. Nodes in <span class="math inline">\(H&#39;\)</span> are called start nodes in this subsection (see <a href="#weight">example 117</a>).</p>
<p>All following parameters are optional and form a list <span class="math inline">\(o\)</span> of expressions that could also be passed as a <code>$orderby</code> system query option. If <span class="math inline">\(o\)</span> is present, the transformation <a href="#SamenessandOrder">stable-sorts</a> <span class="math inline">\(H&#39;\)</span> by <span class="math inline">\(o\)</span>.</p>
<p>The instances in the input set are related to one node (if <span class="math inline">\(p\)</span> is single-valued) or multiple nodes (if <span class="math inline">\(p\)</span> is collection-valued) in the recursive hierarchy. Given a node <span class="math inline">\(x\)</span>, denote by <span class="math inline">\(\hat F(x)\)</span> the collection of all instances in the input set that are related to <span class="math inline">\(x\)</span>; these collections can overlap. For each <span class="math inline">\(u\)</span> in <span class="math inline">\(\hat F(x)\)</span>, the output set contains one instance that comprises the properties of <span class="math inline">\(u\)</span> and additional properties that identify the node <span class="math inline">\(x\)</span>. These additional properties are independent of <span class="math inline">\(u\)</span> and are bundled into an instance called <span class="math inline">\(σ(x)\)</span>. For example, if a sale <span class="math inline">\(u\)</span> is related to two sales organizations and hence contained in both <span class="math inline">\(\hat F(x_1)\)</span> and <span class="math inline">\(\hat F(x_2)\)</span>, the output set will contain two instances <span class="math inline">\((u,σ(x_1))\)</span> and <span class="math inline">\((u,σ(x_2))\)</span> and <span class="math inline">\(σ(x_i)\)</span> contributes a navigation property <code>SalesOrganization</code>.</p>
<p>A transformation <span class="math inline">\(F(x)\)</span> is defined below such that <span class="math inline">\(\hat F(x)\)</span> is the output set of <span class="math inline">\(F(x)\)</span> applied to the input set of the <code>traverse</code> transformation.</p>
<p>Given a node <span class="math inline">\(x\)</span>, the formulas below contain the transformation <span class="math inline">\(\Pi_G(σ(x))\)</span> in order to inject the properties of <span class="math inline">\(σ(x)\)</span> into the instances in <span class="math inline">\(\hat F(x)\)</span>; this uses the function <span class="math inline">\(\Pi_G\)</span> that is defined in the <a href="#SimpleGrouping">simple grouping</a> section. Further, <span class="math inline">\(G\)</span> is a list of <a href="#DataAggregationPath">data aggregation paths</a> that shall be present in the output set, and <span class="math inline">\(σ\)</span> is a function that maps each hierarchy node <span class="math inline">\(x\)</span> to an instance of the <a href="#TypeStructureandContextURL">input type</a> containing the paths from <span class="math inline">\(G\)</span>. As a consequence of the following definitions, only single-valued properties and “final segments from <span class="math inline">\(G\)</span>” are nested into <span class="math inline">\(σ(x)\)</span>, therefore the behavior of <span class="math inline">\(\Pi_G(σ(x))\)</span> is well-defined.</p>
<p>The definition of <span class="math inline">\(σ(x)\)</span> makes use of a function <span class="math inline">\(a(ε,t,x)\)</span>, which returns a sparsely populated instance <span class="math inline">\(u\)</span> in which only the path <span class="math inline">\(t\)</span> has a value, namely <span class="math inline">\(u[t]=x\)</span>.</p>
<p>Three cases are distinguished:</p>
<ol type="1">
<li><em>Case where the recursive hierarchy is defined on the input set</em><br />
This case applies if the paths <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> are equal. Let <span class="math inline">\(σ(x)=x\)</span> and let <span class="math inline">\(G\)</span> be a list containing all structural and navigation properties of the entity type of <span class="math inline">\(H\)</span>.<br />
In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> injects all properties of <span class="math inline">\(x\)</span> into the instances of the output set. (See <a href="#caseone">example 65</a>.)</li>
<li><em>Case where the recursive hierarchy is defined on the related entity type addressed by a navigation property path</em><br />
This case applies if <span class="math inline">\(p&#39;\)</span> is a non-empty navigation property path and <span class="math inline">\(p&#39;&#39;\)</span> an optional type-cast segment such that <span class="math inline">\(p\)</span> equals the concatenated path <span class="math inline">\(p&#39;/p&#39;&#39;/q\)</span>. Let <span class="math inline">\(σ(x)=a(ε,p&#39;/p&#39;&#39;,x)\)</span> and let <span class="math inline">\(G=(p&#39;)\)</span>.<br />
In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> injects the whole related entity <span class="math inline">\(x\)</span> into the instances of the output set. The navigation property path <span class="math inline">\(p&#39;\)</span> is expanded by default. (See <a href="#rollupnode">example 66</a>.)</li>
<li><em>Case where the recursive hierarchy is related to the input set only through equality of node identifiers, not through navigation</em><br />
If neither case 1 nor case 2 applies, let <span class="math inline">\(σ(x)=a(ε,p,x[q])\)</span> and let <span class="math inline">\(G=(p)\)</span>.<br />
In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> injects only the node identifier of <span class="math inline">\(x\)</span> into the instances of the output set.</li>
</ol>
<p>Here paths are considered equal if their non-type-cast segments refer to the same model elements when evaluated relative to the input set (see <a href="#pathequals">example 68</a>).</p>
<p>The function <span class="math inline">\(a(u,t,x)\)</span> takes an instance, a path and another instance as arguments and is defined recursively as follows:</p>
<ol type="1">
<li>If <span class="math inline">\(u\)</span> equals the special symbol <span class="math inline">\(ε\)</span>, set <span class="math inline">\(u\)</span> to a new instance of the <a href="#TypeStructureandContextURL">input type</a> without properties and without entity-id.</li>
<li>If <span class="math inline">\(t\)</span> contains only one segment other than a type cast, let <span class="math inline">\(t_1=t\)</span>, and let <span class="math inline">\(x&#39;=x\)</span>, then go to step 6.</li>
<li>Otherwise, let <span class="math inline">\(t_1\)</span> be the first property segment in <span class="math inline">\(t\)</span>, possibly together with a preceding type-cast segment, let <span class="math inline">\(t_2\)</span> be any type-cast segment that immediately follows, and let <span class="math inline">\(t_3\)</span> be the remainder such that <span class="math inline">\(t\)</span> equals the concatenated path <span class="math inline">\(t_1/t_2/t_3\)</span> where <span class="math inline">\({}/t_2\)</span> may be absent.</li>
<li>Let <span class="math inline">\(u&#39;\)</span> be an instance of the type of <span class="math inline">\(t_1/t_2\)</span> without properties and without entity-id.</li>
<li>Let <span class="math inline">\(x&#39;=a(u&#39;,t_3,x)\)</span>.</li>
<li>If <span class="math inline">\(t_1\)</span> is single-valued, let <span class="math inline">\(u[t_1]=x&#39;\)</span>.</li>
<li>If <span class="math inline">\(t_1\)</span> is collection-valued, let <span class="math inline">\(u[t_1]\)</span> be a collection consisting of one item <span class="math inline">\(x&#39;\)</span>.</li>
<li>Return <span class="math inline">\(u\)</span>.</li>
</ol>
<p>(See <a href="#traversecoll">example 112</a>.)</p>
<h4 id="6221-standard-case-of-traverse"><a name="StandardCaseoftraverse" href="#StandardCaseoftraverse">6.2.2.1 Standard Case of <code>traverse</code></a></h4>
<p>The algorithm is first given for the standard case where <code>RecursiveHierarchy/ParentNavigationProperty</code> is single-valued and the optional parameter <span class="math inline">\(S\)</span> is not specified. In this standard case, start nodes are root nodes and <span class="math inline">\(σ(x)\)</span> is computed exactly once for every node <span class="math inline">\(x\)</span>, as part of the recursive formula for <span class="math inline">\(R(x)\)</span> given below. The general case follows <a href="#GeneralCaseoftraverse">later</a>.</p>
<p>Let <span class="math inline">\(r_1,…,r_n\)</span> be a sequence of the start nodes in <span class="math inline">\(H&#39;\)</span> <a href="#SamenessandOrder">preserving the order</a> of <span class="math inline">\(H&#39;\)</span> stable-sorted by <span class="math inline">\(o\)</span>. Then the transformation <span class="math inline">\({\tt traverse}(H,Q,p,h,o)\)</span> is defined as equivalent to <span class="math display">\[{\tt concat}(R(r_1),…,R(r_n)).\]</span></p>
<p><span class="math inline">\(R(x)\)</span> is a transformation producing the specified tree order for a sub-hierarchy of <span class="math inline">\(H\)</span> with root node <span class="math inline">\(x\)</span>. Let <span class="math inline">\(c_1,…,c_m\)</span> with <span class="math inline">\(m≥0\)</span> be an <a href="#SamenessandOrder">order-preserving sequence</a> of the <a href="#RecursiveHierarchy">children</a> of <span class="math inline">\(x\)</span> in <span class="math inline">\((H,Q)\)</span>. The <em>recursive formula for <span class="math inline">\(R(x)\)</span></em> is as follows:</p>
<p>If <span class="math inline">\(h={\tt preorder}\)</span>, then <span class="math display">\[R(x)={\tt concat}(F(x)/\Pi_G(σ(x)),R(c_1),…,R(c_m)).\]</span></p>
<p>If <span class="math inline">\(h={\tt postorder}\)</span>, then <span class="math display">\[R(x)={\tt concat}(R(c_1),…,R(c_m),F(x)/\Pi_G(σ(x))).\]</span></p>
<p>The absence of cycles guarantees that the recursion terminates.</p>
<p><span class="math inline">\(F(x)\)</span> is a transformation that determines for the specified node <span class="math inline">\(x\)</span> the instances of the input set having the same node identifier as <span class="math inline">\(x\)</span>.</p>
<p>If <span class="math inline">\(p\)</span> contains only single-valued segments, then <span class="math display">\[F(x)={\tt filter}(p{\tt\ eq\ }x[q]).\]</span></p>
<p>Otherwise <span class="math inline">\(p=p_1/…/p_k/r\)</span> with <span class="math inline">\(k≥1\)</span> and <span class="math display">\[\matrix{ F(x)={\tt filter}(\hfill\\ \hskip1pc p_1/{\tt any}(y_1:\hfill\\ \hskip2pc y_1/p_2/{\tt any}(y_2:\hfill\\ \hskip3pc ⋱\hfill\\ \hskip4pc y_{k-1}/p_k/{\tt any}(y_k:\hfill\\ \hskip5pc y_k/r{\tt\ eq\ }x[q]\hfill\\ \hskip4pc )\hfill\\ \hskip3pc ⋰\hfill\\ \hskip2pc )\hfill\\ \hskip1pc )\hfill\\ )\hfill }\]</span> where <span class="math inline">\(y_1,…,y_k\)</span> denote <code>lambdaVariableExpr</code>s and <span class="math inline">\({}/r\)</span> may be absent.</p>
<div class="example">
<p>Example 63: Based on the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a></p>
<pre><code>GET /service/SalesOrganizations?$apply=
    descendants($root/SalesOrganizations,SalesOrgHierarchy,ID,
                Name eq &#39;US&#39;,keep start)
    /ancestors($root/SalesOrganizations,SalesOrgHierarchy,ID,
                contains(Name,&#39;East&#39;),keep start)
    /traverse($root/SalesOrganizations,SalesOrgHierarchy,ID,preorder)
  &amp;$expand=Superordinate/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h4 id="6222-general-case-of-traverse"><a name="GeneralCaseoftraverse" href="#GeneralCaseoftraverse">6.2.2.2 General Case of <code>traverse</code></a></h4>
<p>In the general case, the recursive algorithm can reach a node <span class="math inline">\(x\)</span> multiple times, via different parents or ancestors, or because <span class="math inline">\(x\)</span> is a start node and a descendant of another start node. Then the algorithm computes <span class="math inline">\(R(x)\)</span> and hence <span class="math inline">\(σ(x)\)</span> multiple times. In order to distinguish these computation results, information about the ancestors up to the start node is injected into each <span class="math inline">\(σ(x)\)</span> by annotating <span class="math inline">\(x\)</span> differently before each <span class="math inline">\(σ(x)\)</span> is computed. On the other hand, certain nodes can be unreachable from any start node, these are called orphans of the traversal (see <a href="#weight">example 117</a>).</p>
<p>More precisely, in the general case every node <span class="math inline">\(y\)</span> is annotated with the term <code>UpPath</code> from the <code>Aggregation</code> vocabulary <a href="#ODataVocAggr">OData-VocAggr</a>. The annotation has <span class="math inline">\(Q\)</span> as qualifier and the annotation value is a collection of string values of node identifiers. The first member of that collection is the node identifier of the parent node <span class="math inline">\(x\)</span> such that <span class="math inline">\(R(y)\)</span> appears on the right-hand side of the recursive formula for <span class="math inline">\(R(x)\)</span>. The following members are the members of the <code>Aggregation.UpPath</code> collection of <span class="math inline">\(x\)</span>. Every instance in the output set of <code>traverse</code> is related to one node with <code>Aggregation.UpPath</code> annotation. Start nodes appear annotated with an empty collection.</p>
<div class="example">
<p>⚠ Example 64: A sales organization <a href="#weight">Atlantis</a> with two parents US and EMEA would occur twice in the result of a <code>traverse</code> transformation:</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    traverse($root/SalesOrganizations,MultiParentHierarchy,ID,preorder)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#SalesOrganizations&quot;</span><span class="fu">,</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>        <span class="ot">[</span> <span class="st">&quot;US&quot;</span><span class="ot">,</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;AtlantisChild&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Child of Atlantis&quot;</span><span class="fu">,</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>         <span class="ot">[</span> <span class="st">&quot;Atlantis&quot;</span><span class="ot">,</span> <span class="st">&quot;US&quot;</span><span class="ot">,</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>        <span class="ot">[</span> <span class="st">&quot;EMEA&quot;</span><span class="ot">,</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;AtlantisChild&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Child of Atlantis&quot;</span><span class="fu">,</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>        <span class="ot">[</span> <span class="st">&quot;Atlantis&quot;</span><span class="ot">,</span> <span class="st">&quot;EMEA&quot;</span><span class="ot">,</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>Given a start node <span class="math inline">\(x\)</span>, let <span class="math inline">\(ρ_0(x)\)</span> be the node <span class="math inline">\(x\)</span> with the annotation <span class="math inline">\(ρ_0(x)/@\hbox{\tt Aggregation.UpPath}\#Q=[]\)</span> set to an empty collection.</p>
<p>Given a node <span class="math inline">\(x\)</span> annotated with <span class="math inline">\(x/@\hbox{\tt Aggregation.UpPath}\#Q=[x_1,…,x_d]\)</span>, where <span class="math inline">\(d≥0\)</span>, and given a child <span class="math inline">\(y\)</span> of <span class="math inline">\(x\)</span>, let <span class="math inline">\(ρ(y,x)\)</span> be the node <span class="math inline">\(y\)</span> with the annotation <span class="math display">\[ρ(y,x)/@\hbox{\tt Aggregation.UpPath}\#Q=[{\tt cast}(x[q],\hbox{\tt Edm.String}),x_1,…,x_d].\]</span></p>
<p>Like structural and navigation properties, these instance annotations are considered part of the node <span class="math inline">\(x\)</span> and are copied over to <span class="math inline">\(σ(x)\)</span>. For them to be included in the transformation <span class="math inline">\(\Pi_G(σ(x))\)</span>, an additional step is inserted between steps 2 and 3 of the function <span class="math inline">\(a_G(u,s,p)\)</span> as defined in the <a href="#SimpleGrouping">simple grouping section</a>:</p>
<ul>
<li>If <span class="math inline">\(s\)</span> is annotated with <code>Aggregation.UpPath</code> and qualifier <span class="math inline">\(Q\)</span>, copy this annotation from <span class="math inline">\(s\)</span> to <span class="math inline">\(u\)</span>.</li>
</ul>
<p>Recall that instance annotations never appear in <a href="#DataAggregationPath">data aggregation paths</a> or <a href="#AggregatableExpression">aggregatable expressions</a>. They are not considered when determining whether instances of structured types are <a href="#SamenessandOrder">the same</a>, they do not cause conflicting representations and are absent from merged representations.</p>
<p>Let <span class="math inline">\(r_1,…,r_n\)</span> be the start nodes in <span class="math inline">\(H&#39;\)</span> as above, then the transformation <span class="math inline">\({\tt traverse}(H,Q,p,h,S,o)\)</span> is defined as equivalent to <span class="math display">\[{\tt concat}(R(ρ_0(r_1)),…,R(ρ_0(r_n))\]</span> where the function <span class="math inline">\(R(x)\)</span> takes as argument a node with <code>Aggregation.UpPath</code> annotation. With <span class="math inline">\(F(x)\)</span> and <span class="math inline">\(c_1,…,c_m\)</span> as above, if <span class="math inline">\(h={\tt preorder}\)</span>, then <span class="math display">\[R(x)={\tt concat}(F(x)/\Pi_G(σ(x)),R(ρ(c_1,x)),…,R(ρ(c_m,x))),\]</span> and if <span class="math inline">\(h={\tt postorder}\)</span>, then <span class="math display">\[R(x)={\tt concat}(R(ρ(c_1,x)),…,R(ρ(c_m,x)),F(x)/\Pi_G(σ(x))).\]</span></p>
<p>The absence of cycles guarantees that the recursion terminates.</p>
<p>In the general case, servers MUST include the <code>Aggregation.UpPath</code> annotations in the result of <code>$apply</code> but MAY omit them if <code>RecursiveHierarchy/ParentNavigationProperty</code> is single-valued and all start nodes are root nodes.</p>
<p>If <code>RecursiveHierarchy/ParentNavigationProperty</code> is collection-valued but the parent collection never contains more than one parent and the optional parameter <span class="math inline">\(S\)</span> is not specified, then the result is effectively like in the standard case, except for the presence of the <code>Aggregation.UpPath</code> annotations.</p>
<h2 id="63-grouping-with-rolluprecursive"><a name="Groupingwithrolluprecursive" href="#Groupingwithrolluprecursive">6.3 Grouping with <code>rolluprecursive</code></a></h2>
<p>Recall that simple grouping partitions the input set and applies a transformation sequence to each partition. By contrast, grouping with <code>rolluprecursive</code>, informally speaking, transforms the input set into overlapping portions (like “US” and “US East”), one for each node <span class="math inline">\(x\)</span> of a <a href="#RecursiveHierarchy">recursive hierarchy</a>. The transformation <span class="math inline">\(F(x)\)</span>, defined below, outputs the portion whose node identifiers are among the descendants of <span class="math inline">\(x\)</span> (including <span class="math inline">\(x\)</span> itself). A transformation sequence is then applied to each portion, and they are made distinguishable in the output set through injection of information about the node <span class="math inline">\(x\)</span>, which is achieved through the transformation <span class="math inline">\(\Pi_G(σ(x))\)</span> defined in the <a href="#Transformationtraverse"><code>traverse</code></a> section.</p>
<p>As defined <a href="#CommonParametersforHierarchicalTransformations">above</a>, <span class="math inline">\(H\)</span>, <span class="math inline">\(Q\)</span> and <span class="math inline">\(p\)</span> are the first three parameters of <code>rolluprecursive</code>, <span class="math inline">\(S\)</span> is an optional fourth parameter. Let <span class="math inline">\(H&#39;\)</span> be the output set of the transformation sequence <span class="math inline">\(S\)</span> applied to <span class="math inline">\(H\)</span>, or <span class="math inline">\(H&#39;=H\)</span> if <span class="math inline">\(S\)</span> is not specified.</p>
<p>Navigation properties specified in <span class="math inline">\(p\)</span> are expanded by default.</p>
<p>Let <span class="math inline">\(T\)</span> be a transformation sequence, <span class="math inline">\(P_1\)</span> stand in for zero or more property paths and <span class="math inline">\(P_2\)</span> for zero or more <code>rollup</code> or <code>rolluprecursive</code> operators or property paths. The transformation <span class="math inline">\({\tt groupby}((P_1,{\tt rolluprecursive}(H,Q,p,S),P_2),T)\)</span> is computed by the following algorithm, which invokes itself recursively if the number of <code>rolluprecursive</code> operators in the first argument of the <code>groupby</code> transformation, which is called <span class="math inline">\(M\)</span>, is greater than one. Let <span class="math inline">\(N\)</span> be the recursion depth of the algorithm, starting with 1.</p>
<p><em>The <code>rolluprecursive</code> algorithm:</em></p>
<p>A property <span class="math inline">\(χ_N\)</span> appears in the algorithm, but is not present in the output set. It is explained later (see <a href="#rollupnode">example 66</a>). <span class="math inline">\(Z_N\)</span> is a transformation whose output set is its input set with property <span class="math inline">\(χ_N\)</span> removed.</p>
<p>Let <span class="math inline">\(x_1,…,x_n\)</span> be the nodes in <span class="math inline">\(H&#39;\)</span>, possibly with repetitions. If the optional transformation sequence <span class="math inline">\(S\)</span> ends with a <a href="#Transformationtraverse"><code>traverse</code></a> transformation, as in <a href="#weighted">example 118</a>, the sequence <span class="math inline">\(x_1,…,x_n\)</span> MUST have the preorder or postorder established by that traversal, and the transformation <span class="math inline">\({\tt groupby}((P_1,{\tt rolluprecursive}(H,Q,p,S),P_2),T)\)</span> is defined as equivalent to <span class="math display">\[{\tt concat}(R(x_1),…,R(x_n)).\]</span></p>
<p>Otherwise, if <span class="math inline">\(S\)</span> is not specified or does not end with a <code>traverse</code> transformation, the output set of the transformation <span class="math inline">\({\tt groupby}((P_1,{\tt rolluprecursive}(H,Q,p,S),P_2),T)\)</span> is the concatenation of <span class="math inline">\(R(x_1),…,R(x_n)\)</span>. The order of occurrences from the same <span class="math inline">\(R(x_i)\)</span> remains the same, and no order is defined between occurrences from different <span class="math inline">\(R(x_i)\)</span> and <span class="math inline">\(R(x_j)\)</span>.</p>
<p><span class="math inline">\(R(x)\)</span> is a transformation that processes the entire sub-hierarchy rooted at <span class="math inline">\(x\)</span>, which is the output set of <span class="math inline">\(F(x)\)</span>. The output set of <span class="math inline">\(R(x)\)</span> is a collection of aggregated instances for all rollup results.</p>
<p>If at least one of <span class="math inline">\(P_1\)</span> or <span class="math inline">\(P_2\)</span> is non-empty, then <span class="math display">\[R(x)=F(x)/{\tt compute}(x{\tt\ as\ }χ_N)/{\tt groupby}((P_1,P_2),T/Z_N/\Pi_G(σ(x))).\]</span></p>
<p>The property <span class="math inline">\(χ_N=x\)</span> is present during the evaluation of <span class="math inline">\(T\)</span>, but not afterwards. If <span class="math inline">\(P_2\)</span> contains a <code>rolluprecursive</code> operator, the evaluation of the formula involves a recursive invocation (with <span class="math inline">\(N\)</span> increased by 1) of the <code>rolluprecursive</code> algorithm.</p>
<p>Otherwise if <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are empty, then <span class="math display">\[R(x)=F(x)/{\tt compute}(x{\tt\ as\ }χ_N)/T/Z_N/\Pi_G(σ(x)).\]</span></p>
<p><span class="math inline">\(F(x)\)</span> is defined as follows: If <span class="math inline">\(p\)</span> contains only single-valued segments, then <span class="math display">\[\matrix{ F(x)={\tt filter}(\hbox{\tt Aggregation.isdescendant}(\hfill\\ \quad {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\ \quad {\tt Node}=p,\;{\tt Ancestor}=x[q],\;{\tt IncludeSelf}={\tt true})).\hfill }\]</span></p>
<p>Otherwise <span class="math inline">\(p=p_1/…/p_k/r\)</span> with <span class="math inline">\(k≥1\)</span> and <span class="math display">\[\matrix{ F(x)={\tt filter}(\hfill\\ \hskip1pc p_1/{\tt any}(y_1:\hfill\\ \hskip2pc y_1/p_2/{\tt any}(y_2:\hfill\\ \hskip3pc ⋱\hfill\\ \hskip4pc y_{k-1}/p_k/{\tt any}(y_k:\hfill\\ \hskip5pc \hbox{\tt Aggregation.isdescendant}(\hfill\\ \hskip6pc {\tt HierarchyNodes}=H,\;{\tt HierarchyQualifier}=\hbox{\tt{&#39;$Q$&#39;}},\hfill\\ \hskip6pc {\tt Node}=y_k/r,\;{\tt Ancestor}=x[q],\;{\tt IncludeSelf}={\tt true}\hfill\\ \hskip5pc )\hfill\\ \hskip4pc )\hfill\\ \hskip3pc ⋰\hfill\\ \hskip2pc )\hfill\\ \hskip1pc )\hfill\\ )\hfill }\]</span> where <span class="math inline">\(y_1,…,y_k\)</span> denote <code>lambdaVariableExpr</code>s and <span class="math inline">\({}/r\)</span> may be absent. (See <a href="#rollupcoll">example 113</a> for a case with <span class="math inline">\(k=1\)</span>.)</p>
<p>Informatively speaking, the effect of the algorithm can be summarized as follows: If <span class="math inline">\(M≥1\)</span> and <span class="math inline">\(\hat F_N(x)\)</span> denotes the collection of all instances that are related to a node <span class="math inline">\(x\)</span> as determined by <span class="math inline">\(F(x)\)</span> in the recursive hierarchy of the <span class="math inline">\(N\)</span>-th <code>rolluprecursive</code> operator, then <span class="math inline">\(T\)</span> is applied to each of the intersections of <span class="math inline">\(\hat F_1(χ_1),…,\hat F_M(χ_M)\)</span>, as <span class="math inline">\(χ_N\)</span> runs over all nodes of the <span class="math inline">\(N\)</span>-th recursive hierarchy for <span class="math inline">\(1≤N≤M\)</span>. Into the instances of the resulting output sets the <span class="math inline">\(\Pi_G\)</span> transformations inject information about the nodes <span class="math inline">\(χ_1,…,χ_M\)</span>.</p>
<div class="example">
<p>Example <a name="caseone" href="#caseone">65</a>: Total number of sub-organizations for all organizations in the hierarchy defined in <a href="#HierarchyExamples">Hierarchy Examples</a> with <span class="math inline">\(p=q={\tt ID}\)</span> (case 1 of the <a href="#Transformationtraverse">definition</a> of <span class="math inline">\(σ(x)\)</span>). In this case <span class="math inline">\(\Pi_G(σ(x))\)</span> writes back the entire node into the output set of <span class="math inline">\(T\)</span>, aggregates must have an alias to avoid overwriting by a property of the node with the same name.</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    groupby((rolluprecursive(
                 $root/SalesOrganizations,SalesOrgHierarchy,ID)),
             aggregate($count as OrgCnt)/compute(OrgCnt sub 1 as SubOrgCnt))
  &amp;$select=ID,Name,SubOrgCnt
  &amp;$expand=Superordinate($select=ID)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$metadata#SalesOrganizations(ID,Name,SubOrgCnt,Superordinate(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SubOrgCount&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SubOrgCount&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>           <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SubOrgCount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SubOrgCount&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span>         <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SubOrgCount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span>        <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span></span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SubOrgCount&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The value of the property <span class="math inline">\(χ_N\)</span> in the <code>rolluprecursive</code> algorithm is the node <span class="math inline">\(x\)</span> at recursion level <span class="math inline">\(N\)</span>. In a common expression, <span class="math inline">\(χ_N\)</span> cannot be accessed by its name, but can only be read as the return value of the unbound function <span class="math inline">\({\tt rollupnode}({\tt Position}=N)\)</span> defined in the <code>Aggregation</code> vocabulary <a href="#ODataVocAggr">OData-VocAggr</a>, with <span class="math inline">\(1≤N≤M\)</span>, and only during the application of the transformation sequence <span class="math inline">\(T\)</span> in the formula for <span class="math inline">\(R(x)\)</span> above (the function is undefined otherwise). If <span class="math inline">\(N=1\)</span>, the <code>Position</code> parameter can be omitted.</p>
<div class="example">
<p>⚠ Example <a name="rollupnode" href="#rollupnode">66</a>: Total sales amounts per organization, both including and excluding sub-organizations, in the US sub-hierarchy defined in <a href="#HierarchyExamples">Hierarchy Examples</a> with <span class="math inline">\(p=p&#39;/q={\tt SalesOrganization}/{\tt ID}\)</span> and <span class="math inline">\(p&#39;={\tt SalesOrganization}\)</span> (case 2 of the <a href="#Transformationtraverse">definition</a> of <span class="math inline">\(σ(x)\)</span>). The Boolean expression <span class="math inline">\(p&#39;\hbox{\tt\ eq Aggregation.rollupnode}()\)</span> is true for sales in the organization for which the aggregate is computed, but not for sales in sub-organizations.</p>
<pre><code>GET /service/Sales?$apply=groupby(
    (rolluprecursive(
      $root/SalesOrganizations,
      SalesOrgHierarchy,
      SalesOrganization/ID,
      descendants($root/SalesOrganizations,
                  SalesOrgHierarchy,
                  ID, filter(ID eq &#39;US&#39;), keep start))),
    compute(case(SalesOrganization eq Aggregation.rollupnode():Amount)
            as AmountExcl)
    /aggregate(Amount with sum as TotalAmountIncl,
               AmountExcl with sum as TotalAmountExcl))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesOrganization(),</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="st">                               TotalAmountIncl,TotalAmountExcl)&quot;</span><span class="fu">,</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">},</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountIncl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountIncl&quot;</span><span class="fu">:</span>  <span class="dv">7</span><span class="fu">,</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountExcl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span> <span class="fu">,</span><span class="dt">&quot;TotalAmountExcl&quot;</span><span class="fu">:</span>  <span class="dv">7</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">},</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountIncl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountIncl&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountExcl&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">},</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountIncl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountIncl&quot;</span><span class="fu">:</span> <span class="dv">12</span><span class="fu">,</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountExcl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountExcl&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example 67: When requesting a sub-hierarchy consisting of the US East sales organization and its ancestors, the total sales amounts can either include the descendants outside this sub-hierarchy (“actual totals”) or can exclude them (“visual totals”).</p>
<p>Actual totals are computed when <code>rolluprecursive</code> is restricted to the sub-hierarchy by setting the optional parameter <span class="math inline">\(S\)</span> to an <code>ancestors</code> transformation:</p>
<pre><code>GET /service/Sales?$apply=groupby((rolluprecursive(
    $root/SalesOrganizations,SalesOrgHierarchy,SalesOrganization/ID,
    ancestors($root/SalesOrganizations,SalesOrgHierarchy,ID,
              filter(ID eq &#39;US East&#39;),keep start))),
  aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesOrganization(),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">},</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">},</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">19</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">},</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">24</span> <span class="fu">}</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Visual totals are computed when the <code>ancestors</code> transformation is additionally carried out before the <code>rolluprecursive</code>:</p>
<pre><code>GET /service/Sales?$apply=
  ancestors($root/SalesOrganizations,SalesOrgHierarchy,SalesOrganization/ID,
    filter(SalesOrganization/ID eq &#39;US East&#39;),keep start))),
  /groupby((rolluprecursive(
    $root/SalesOrganizations,SalesOrgHierarchy,SalesOrganization/ID,
    ancestors($root/SalesOrganizations,SalesOrgHierarchy,ID,
              filter(ID eq &#39;US East&#39;),keep start))),
  aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesOrganization(),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">},</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">},</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span>   <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">},</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example <a name="pathequals" href="#pathequals">68</a>: Although <span class="math inline">\(p={\tt ID}\)</span> and <span class="math inline">\(q={\tt ID}\)</span>, they are not equal in the sense of case 1, because they are evaluated relative to different entity sets. Hence, this is an example of case 3 of the <a href="#Transformationtraverse">definition</a> of <span class="math inline">\(σ(x)\)</span>, where no <code>Sales/ID</code> matches a <code>SalesOrganizations/ID</code>, that is, all <span class="math inline">\(F(x)\)</span> have empty output sets.</p>
<pre><code>GET /service/Sales?$apply=
    groupby((rolluprecursive(
                 $root/SalesOrganizations,SalesOrgHierarchy,ID))),
             aggregate(Amount with sum as TotalAmount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesOrganization(),TotalAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Corporate Sales&quot;</span> <span class="fu">},</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">},</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>    <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">},</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<hr />
<h1 id="7-examples"><a name="Examples" href="#Examples">7 Examples</a></h1>
<p>The following examples show some common aggregation-related questions that can be answered by combining the transformations defined in <a href="#SystemQueryOptionapply">sections 3</a> and <a href="#HierarchicalTransformations">6</a>.</p>
<h2 id="71-requesting-distinct-values"><a name="RequestingDistinctValues" href="#RequestingDistinctValues">7.1 Requesting Distinct Values</a></h2>
<p>Grouping without specifying a set transformation returns the distinct combination of the grouping properties.</p>
<div class="example">
<p>Example 69:</p>
<pre><code>GET /service/Customers?$apply=groupby((Name))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers(Name)&quot;</span><span class="fu">,</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Luc&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span> <span class="fu">}</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that “Sue” appears only once although the customer base contains two different Sues.</p>
</div>
<p>Aggregation is also possible across related entities.</p>
<div class="example">
<p>Example 70: customers that bought something</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Name))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Name))&quot;</span><span class="fu">,</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Since <code>groupby</code> expands navigation properties in grouping properties by default, this is the same result as if the request would include a <code>$expand=Customer($select=Name)</code>. The <code>groupby</code> removes all other properties.</p>
<p>Note that “Luc” does not appear in the aggregated result as he hasn’t bought anything and therefore there are no sales entities that refer/navigate to Luc.</p>
<p>However, even though both Sues bought products, only one “Sue” appears in the aggregate result. Including properties that guarantee the right level of uniqueness in the grouping can repair that.</p>
</div>
<div class="example">
<p>Example 71:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Name,Customer/ID))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Name,ID))&quot;</span><span class="fu">,</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>This could also have been formulated as</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer))
           &amp;$expand=Customer($select=Name,ID)</code></pre>
</div>
<div class="example">
<p>Example <a name="groupbynav" href="#groupbynav">72</a>: Grouping by navigation property <code>Customer</code></p>
<pre><code>
GET /service/Sales?$apply=groupby((Customer))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer())&quot;</span><span class="fu">,</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 73: the first question in the motivating example in <a href="#ExampleUseCases">section 2.3</a>, which customers bought which products, can now be expressed as</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Name,Customer/ID,Product/Name))</code></pre>
<p>and results in</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Name,ID),Product(Name))&quot;</span><span class="fu">,</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example <a name="subinputtype" href="#subinputtype">74</a>: grouping by properties of subtypes</p>
<pre><code>GET /service/Products?$apply=groupby((SalesModel.FoodProduct/Rating,
                                      SalesModel.NonFoodProduct/RatingClass))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(SalesModel.FoodProduct/Rating,</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="st">                                  SalesModel.NonFoodProduct/RatingClass)&quot;</span><span class="fu">,</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.NonFoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;RatingClass&quot;</span><span class="fu">:</span> <span class="st">&quot;average&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.NonFoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;RatingClass&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example <a name="anystructure" href="#anystructure">75</a>: grouping by a property of a subtype</p>
<pre><code>GET /service/Products?$apply=groupby((SalesModel.FoodProduct/Rating))</code></pre>
<p>results in a third group representing entities with no <code>SalesModel.FoodProduct/Rating</code>, including the <code>SalesModel.NonFoodProduct</code>s:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(@Core.AnyStructure)&quot;</span><span class="fu">,</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;@type&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesModel.FoodProduct&quot;</span><span class="fu">,</span> <span class="dt">&quot;Rating&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="fu">}</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="72-standard-aggregation-methods"><a name="StandardAggregationMethods" href="#StandardAggregationMethods">7.2 Standard Aggregation Methods</a></h2>
<p>The client may specify one of the predefined aggregation methods <a href="#StandardAggregationMethodmin"><code>min</code></a>, <a href="#StandardAggregationMethodmax"><code>max</code></a>, <a href="#StandardAggregationMethodsum"><code>sum</code></a>, <a href="#StandardAggregationMethodaverage"><code>average</code></a>, and <a href="#StandardAggregationMethodcountdistinct"><code>countdistinct</code></a>, or a <a href="#CustomAggregationMethods">custom aggregation method</a>, to aggregate an <a href="#AggregatableExpression">aggregatable expression</a>. Expressions defining an aggregate method specify an <a href="#Keywordas">alias</a>. The aggregated values are returned in a dynamic property whose name is determined by the alias.</p>
<div class="example">
<p>Example <a name="aggr" href="#aggr">76</a>:</p>
<pre><code>GET /service/Products?$apply=groupby((Name),
                              aggregate(Sales/Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,Total)&quot;</span><span class="fu">,</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>   <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span>                          <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that the base set of the request is <code>Products</code>, so there is a result item for product <code>Pencil</code> even though there are no sales items. The input set for the aggregation in the third row is <span class="math inline">\(I\)</span> consisting of the pencil, <span class="math inline">\(p=q/r={\tt Sales}/{\tt Amount}\)</span>, <span class="math inline">\(E=\Gamma(I,q)\)</span> is empty and <span class="math inline">\(A=\Gamma(E,r)\)</span> is also empty. The sum over the empty collection is null.</p>
</div>
<div class="example">
<p>Example <a name="nest" href="#nest">77</a>: Alternatively, the request could ask for the aggregated amount to be nested inside a clone of Sales</p>
<pre><code>GET /service/Products?$apply=addnested(Sales,
    aggregate(Amount with sum as Total) as AggregatedSales)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(AggregatedSales())&quot;</span><span class="fu">,</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Black&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span>                          <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 78: To compute the aggregate as a property without nesting, use the aggregate function in <code>$compute</code> rather than the aggregate transformation in <code>$apply</code>:</p>
<pre><code>GET /service/Products?$compute=Sales/aggregate(Amount with sum) as Total</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(*,Total)&quot;</span><span class="fu">,</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Black&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span><span class="fu">,</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span><span class="fu">,</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>The expression <code>$it/Sales</code> refers to the sales of the current product. Without <code>$it</code>, all sales of all products would be aggregated, because the input collection for the <code>aggregate</code> function consists of all products.</p>
</div>
<div class="example">
<p>Example 79: Alternatively, <code>join</code> could be applied to yield a flat structure:</p>
<pre><code>GET /service/Products?$apply=
    join(Sales as TotalSales,aggregate(Amount with sum as Total))
    /groupby((Name,TotalSales/Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,TotalSales())&quot;</span><span class="fu">,</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Total)/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Applying <code>outerjoin</code> instead would return an additional entity for product with <code>ID</code> “Pencil” and <code>TotalSales</code> having a null value.</p>
</div>
<div class="example">
<p>Example 80:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                            aggregate(Amount with average as AverageAmount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),AverageAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AverageAmount&quot;</span><span class="fu">:</span> <span class="fl">1.6666666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AverageAmount&quot;</span><span class="fu">:</span> <span class="fl">3.8</span> <span class="fu">}</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Here the <code>AverageAmount</code> is of type <code>Edm.Double</code>.</p>
</div>
<div class="example">
<p>Example 81: <code>$count</code> after navigation property</p>
<pre><code>GET /service/Products?$apply=groupby((Name),
                              aggregate(Sales/$count as SalesCount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,SalesCount)&quot;</span><span class="fu">,</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">0</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;SalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>To place the number of instances in a group next to other aggregated values, the aggregate expression <a href="#AggregateExpressioncount"><code>$count</code></a> can be used:</p>
<div class="example">
<p>⚠ Example 82: The effect of the <code>groupby</code> is to create transient entities and avoid in the result structural properties other than <code>Name</code>.</p>
<pre><code>GET /service/Products?$apply=groupby((Name),addnested(Sales,
      aggregate($count as SalesCount,
                Amount with sum as TotalAmount) as AggregatedSales))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,AggregatedSales())&quot;</span><span class="fu">,</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(SalesCount,TotalAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(SalesCount,TotalAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span>  <span class="dv">8</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(SalesCount,TotalAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span></span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(SalesCount,TotalAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span>  <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span>  <span class="dv">4</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The <code>aggregate</code> function can not only be used in <code>$compute</code> but also in <code>$filter</code> and <code>$orderby</code>:</p>
<div class="example">
<p>Example 83: Products with an aggregated sales volume of ten or more</p>
<pre><code>GET /service/Products?$filter=Sales/aggregate(Amount with sum) ge 10</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products&quot;</span><span class="fu">,</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.06</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span> <span class="dt">&quot;TaxRate&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">14</span> <span class="fu">}</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 84: Customers in descending order of their aggregated sales volume</p>
<pre><code>GET /service/Customers?$orderby=Sales/aggregate(Amount with sum) desc</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers&quot;</span><span class="fu">,</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Luc&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;France&quot;</span> <span class="fu">}</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 85: Contribution of each sales to grand total sales amount</p>
<pre><code>GET /service/Sales?$compute=Amount divby $these/aggregate(Amount with sum)
                            as Contribution</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(*,Contribution)&quot;</span><span class="fu">,</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0416666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0833333333333333</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">1666666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">3333333333333333</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">1666666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0833333333333333</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0416666666666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.0833333333333333</span> <span class="fu">}</span></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 86: Product categories with at least one product having an aggregated sales amount greater than 10</p>
<pre><code>GET /service/Categories?$filter=Products/any(
                                p:p/Sales/aggregate(Amount with sum) gt 10)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Categories&quot;</span><span class="fu">,</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;PG1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Food&quot;</span> <span class="fu">}</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The <code>aggregate</code> function can also be applied inside <code>$apply</code>:</p>
<div class="example">
<p>Example 87: Sales volume per customer in relation to total volume</p>
<pre><code>GET /service/Sales?$apply=
    groupby((Customer),aggregate(Amount with sum as CustomerAmount))
    /compute(CustomerAmount divby $these/aggregate(CustomerAmount with sum)
             as Contribution)
  &amp;$expand=Customer/$ref</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(),CustomerAmount,Contribution)&quot;</span><span class="fu">,</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span>    <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;Customers(&#39;C1&#39;)&quot;</span> <span class="fu">},</span></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">2916667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span>    <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;Customers(&#39;C2&#39;)&quot;</span> <span class="fu">},</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span>    <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;Customers(&#39;C3&#39;)&quot;</span> <span class="fu">},</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Contribution@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Contribution&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="er">.</span><span class="dv">2083333</span> <span class="fu">}</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 88: rule 1 for <a href="#Keywordfrom">keyword <code>from</code></a> applied repeatedly</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount with sum
                                    from Time with average
                                    from Customer/Country with max
                                    as MaxDailyAveragePerCountry)</code></pre>
<p>is equivalent to (with nested <code>groupby</code> transformations)</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Customer/Country),
    groupby((Time),aggregate(Amount with sum as D1))
    /aggregate(D1 with average as D2))
  /aggregate(D2 with max as MaxDailyAveragePerCountry)</code></pre>
<p>and is equivalent to (with consecutive <code>groupby</code> transformations)</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Customer/Country,Time),aggregate(Amount with sum as D1))
  /groupby((Customer/Country),aggregate(D1 with average as D2))
  /aggregate(D2 with max as MaxDailyAveragePerCountry)</code></pre>
</div>
<h2 id="73-requesting-expanded-results"><a name="RequestingExpandedResults" href="#RequestingExpandedResults">7.3 Requesting Expanded Results</a></h2>
<div class="example">
<p>Example 89: Assuming an extension of the data model where <code>Customer</code> contains an additional collection-valued complex property <code>Addresses</code> and these contain a single-valued navigation property <code>ResponsibleSalesOrganization</code>, <code>addnested</code> can be used to compute a nested dynamic property:</p>
<pre><code>GET /service/Customers?$apply=
    addnested(Addresses/ResponsibleSalesOrganization,
              compute(Superordinate/Name as SalesRegion)
              as AugmentedSalesOrganization)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers(Addresses(AugmentedSalesOrganization())&quot;</span><span class="fu">,</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Addresses&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;Locality&quot;</span><span class="fu">:</span> <span class="st">&quot;Seattle&quot;</span><span class="fu">,</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;AugmentedSalesOrganization&quot;</span><span class="fu">:</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span> <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesOrganizations/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span> <span class="dt">&quot;SalesRegion&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;Locality&quot;</span><span class="fu">:</span> <span class="st">&quot;DC&quot;</span><span class="fu">,</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;AugmentedSalesOrganization&quot;</span><span class="fu">:</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span> <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#SalesOrganizations/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;SalesRegion&quot;</span><span class="fu">:</span> <span class="st">&quot;Corporate Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span> <span class="er">…</span></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p><code>addnested</code> transformations can be nested.</p>
<div class="example">
<p>Example 90: nested <code>addnested</code> transformations</p>
<pre><code>GET /service/Categories?$apply=
    addnested(Products,
      addnested(Sales,filter(Amount gt 3) as FilteredSales)
    as FilteredProducts)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Categories(FilteredProducts()&quot;</span><span class="fu">,</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;PG1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Food&quot;</span><span class="fu">,</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredProducts@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Products(FilteredSales())&quot;</span><span class="fu">,</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredProducts&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Brown&quot;</span><span class="fu">,</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;PG2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Non-Food&quot;</span><span class="fu">,</span></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredProducts@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Products(FilteredSales())&quot;</span><span class="fu">,</span></span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FilteredProducts&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;White&quot;</span><span class="fu">,</span></span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb170-21"><a href="#cb170-21" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb170-22"><a href="#cb170-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;Color&quot;</span><span class="fu">:</span> <span class="st">&quot;Black&quot;</span><span class="fu">,</span></span>
<span id="cb170-23"><a href="#cb170-23" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales&quot;</span><span class="fu">,</span></span>
<span id="cb170-24"><a href="#cb170-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;FilteredSales&quot;</span><span class="fu">:</span> <span class="ot">[]</span> <span class="fu">}</span></span>
<span id="cb170-25"><a href="#cb170-25" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb170-26"><a href="#cb170-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb170-27"><a href="#cb170-27" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb170-28"><a href="#cb170-28" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Instead of keeping all related entities from navigation properties that <code>addnested</code> expanded by default, an explicit <code>$expand</code> controls which of them to include in the response:</p>
<pre><code>GET /service/Categories?$apply=
    addnested(Products,
      addnested(Sales,filter(Amount gt 3) as FilteredSales)
    as FilteredProducts)
  &amp;$expand=FilteredProducts</code></pre>
<p>results in the response before without the FilteredSales dynamic navigation properties expanded in the result.</p>
</div>
<div class="example">
<p>Example 91: Here only the <code>GroupedSales</code> are expanded, because they are named in <code>$expand</code>, the related <code>Product</code> entity is not:</p>
<pre><code>GET /service/Customers?$apply=addnested(Sales,
    groupby((Product/Name)) as GroupedSales)
  &amp;$expand=GroupedSales</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers(GroupedSales())&quot;</span><span class="fu">,</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(@Core.AnyStructure)&quot;</span><span class="fu">,</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="fu">}</span></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sue&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(@Core.AnyStructure)&quot;</span><span class="fu">,</span></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="fu">}</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Joe&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span><span class="fu">,</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(@Core.AnyStructure)&quot;</span><span class="fu">,</span></span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="fu">}</span></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Luc&quot;</span><span class="fu">,</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;France&quot;</span><span class="fu">,</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(@Core.AnyStructure)&quot;</span><span class="fu">,</span></span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;GroupedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb173-27"><a href="#cb173-27" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 92: use <code>outerjoin</code> to split up collection-valued navigation properties for grouping</p>
<pre><code>GET /service/Customers?$apply=outerjoin(Sales as ProductSales)
                       /groupby((Country,ProductSales/Product/Name))</code></pre>
<p>returns the different combinations of products sold per country:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Customers(Country,ProductSales())&quot;</span><span class="fu">,</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span><span class="fu">,</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span><span class="fu">,</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Product(Name))/$entity&quot;</span><span class="fu">,</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span>  <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;France&quot;</span><span class="fu">,</span> <span class="dt">&quot;ProductSales&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="74-requesting-custom-aggregates"><a name="RequestingCustomAggregates" href="#RequestingCustomAggregates">7.4 Requesting Custom Aggregates</a></h2>
<p>Custom aggregates are defined through the <a href="#CustomAggregates"><code>CustomAggregate</code></a> annotation. They can be associated with an entity set, a collection or an entity container.</p>
<p>A custom aggregate can be used by specifying the name of the custom aggregate in the <a href="#Transformationaggregate"><code>aggregate</code></a> clause.</p>
<div class="example">
<p>Example 93:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                           aggregate(Amount with sum as Actual,Forecast))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Actual,Forecast)&quot;</span><span class="fu">,</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Actual@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Actual&quot;</span><span class="fu">:</span>  <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Forecast@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Forecast&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Actual@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Actual&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Forecast@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Forecast&quot;</span><span class="fu">:</span> <span class="dv">21</span> <span class="fu">}</span></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>When associated with an entity set a custom aggregate MAY have the same name as a property of the underlying entity type with the same type as the type returned by the custom aggregate. This is typically done when the aggregate is used as a default aggregate for that property.</p>
<div class="example">
<p>Example 94: A custom aggregate can be defined with the same name as a property of the same type in order to define a default aggregate for that property.</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),aggregate(Amount))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Amount)&quot;</span><span class="fu">,</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span>  <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">19</span> <span class="fu">}</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 95: illustrates rule 1 for <a href="#Keywordfrom">keyword <code>from</code></a>: maximal sales forecast for a product</p>
<pre><code>GET /service/Sales?$apply=aggregate(Forecast from Product with max
                                    as MaxProductForecast)</code></pre>
<p>is equivalent to</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Product),aggregate(Forecast))
  /aggregate(Forecast with max as MaxProductForecast)</code></pre>
</div>
<div class="example">
<p>Example 96: illustrates rule 2 for <a href="#Keywordfrom">keyword <code>from</code></a>: the forecast is computed in two steps</p>
<pre><code>GET /service/Sales?$apply=aggregate(Forecast from Product as ProductForecast)</code></pre>
<p>is equivalent to the following (except that the property name is <code>Forecast</code> instead of <code>ProductForecast</code>)</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Product),aggregate(Forecast))
  /aggregate(Forecast)</code></pre>
</div>
<div class="example">
<p>Example 97: illustrates rule 1 followed by rule 2 for <a href="#Keywordfrom">keyword <code>from</code></a>: a forecast based on the average daily forecasts per country</p>
<pre><code>GET /service/Sales?$apply=aggregate(Forecast from Time with average
                                    from Customer/Country
                                    as CountryForecast)</code></pre>
<p>is equivalent to the following (except that the property name is <code>Forecast</code> instead of <code>CountryForecast</code>). Note that <code>Forecast</code> appears as a property and as a custom aggregate.</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Customer/Country),
    groupby((Time),aggregate(Forecast))
    /aggregate(Forecast with average as D1))
  /aggregate(Forecast)</code></pre>
</div>
<h2 id="75-aliasing"><a name="Aliasing" href="#Aliasing">7.5 Aliasing</a></h2>
<p>A property can be aggregated in multiple ways, each with a different alias.</p>
<div class="example">
<p>Example 98:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country),
                           aggregate(Amount with sum as Total,
                                     Amount with average as AvgAmt))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total,AvgAmt)&quot;</span><span class="fu">,</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AvgAmt@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="fl">1.6666667</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AvgAmt@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="fl">3.8</span> <span class="fu">}</span></span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>The introduced dynamic property is added to the context where the aggregate expression is applied to:</p>
<div class="example">
<p>Example 99:</p>
<pre><code>GET /service/Products?$apply=groupby((Name),
                              aggregate(Sales/Amount with sum as Total))
    /groupby((Name),
     addnested(Sales,aggregate(Amount with average as AvgAmt)
               as AggregatedSales))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Name,Total,AggregatedSales())&quot;</span><span class="fu">,</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>   <span class="dv">12</span><span class="fu">,</span></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(AvgAmt)&quot;</span><span class="fu">,</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;AvgAmt@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="dv">6</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">8</span><span class="fu">,</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(AvgAmt)&quot;</span><span class="fu">,</span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;AvgAmt@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Pencil&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(AvgAmt)&quot;</span><span class="fu">,</span></span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span><span class="fu">,</span>  <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>    <span class="dv">4</span><span class="fu">,</span></span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(AvgAmt)&quot;</span><span class="fu">,</span></span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;AggregatedSales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;AvgAmt@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">&quot;AvgAmt&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>There is no hard distinction between groupable and aggregatable properties: the same property can be aggregated and used to group the aggregated results.</p>
<div class="example">
<p>Example 100:</p>
<pre><code>GET /service/Sales?$apply=groupby((Amount),aggregate(Amount with sum as Total))</code></pre>
<p>will return all distinct amounts appearing in sales orders and how much money was made with deals of this amount</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Amount,Total)&quot;</span><span class="fu">,</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">6</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">8</span> <span class="fu">}</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="76-combining-transformations-per-group"><a name="CombiningTransformationsperGroup" href="#CombiningTransformationsperGroup">7.6 Combining Transformations per Group</a></h2>
<p>Dynamic property names may be reused in different transformation sequences passed to <code>concat</code>.</p>
<div class="example">
<p>Example <a name="bestselling" href="#bestselling">101</a>: to get the best-selling product per country with sub-totals for every country, the partial results of a transformation sequence and a <code>groupby</code> transformation are concatenated:</p>
<pre><code>GET /service/Sales?$apply=concat(
                     groupby((Customer/Country,Product/Name),
                             aggregate(Amount with sum as Total))
                       /groupby((Customer/Country),topcount(1,Total)),
                     groupby((Customer/Country),
                             aggregate(Amount with sum as Total)))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">19</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 102: transformation sequences are also useful inside <code>groupby</code>: Aggregate the amount by only considering the top two sales amounts per product and country:</p>
<pre><code>GET /service/Sales?$apply=groupby((Customer/Country,Product/Name),
                      topcount(2,Amount)/aggregate(Amount with sum as Total))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span></span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span>         <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">5</span></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example <a name="contradict" href="#contradict">103</a>: concatenation of two different groupings “biggest sale per customer” and “biggest sale per product”, made distinguishable by a dynamic property:</p>
<pre><code>GET /service/Sales?$apply=concat(
    groupby((Customer),topcount(1,Amount))/compute(&#39;Customer&#39; as per),
    groupby((Product),topcount(1,Amount))/compute(&#39;Product&#39; as per))
  &amp;$expand=Customer($select=ID),Product($select=ID)</code></pre>
<p>In the result, <code>Sales</code> entities 4 and 6 occur twice each with contradictory values of the dynamic property <code>per</code>. If a UI consuming the response presents the two groupings in separate columns based on the <code>per</code> property, no contradiction effectively arises.</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(*,per,Customer(ID),Product(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span> <span class="fu">},</span></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span> <span class="fu">},</span></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span> <span class="fu">},</span></span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;6&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span> <span class="fu">},</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;6&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Product&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span> <span class="fu">},</span></span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;4&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Product&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span> <span class="fu">},</span></span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;5&quot;</span><span class="fu">,</span> <span class="dt">&quot;Amount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span> <span class="dt">&quot;per&quot;</span><span class="fu">:</span> <span class="st">&quot;Product&quot;</span> <span class="fu">}</span></span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="77-model-functions-as-set-transformations"><a name="ModelFunctionsasSetTransformations" href="#ModelFunctionsasSetTransformations">7.7 Model Functions as Set Transformations</a></h2>
<div class="example">
<p>Example 104: As a variation of <a href="#bestselling">example 101</a>, a query for returning the best-selling product per country and the total amount of the remaining products can be formulated with the help of a model function.</p>
<p>For this purpose, the model includes a definition of a <code>TopCountAndRemainder</code> function that accepts a count and a numeric property for the top entities:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">edm:Function</span><span class="ot"> Name=</span><span class="st">&quot;TopCountAndRemainder&quot;</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="ot">              IsBound=</span><span class="st">&quot;true&quot;</span>&gt;</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:Parameter</span><span class="ot">  Name=</span><span class="st">&quot;EntityCollection&quot;</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="ot">                    Type=</span><span class="st">&quot;Collection(Edm.EntityType)&quot;</span> /&gt;</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:Parameter</span><span class="ot">  Name=</span><span class="st">&quot;Count&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.Int16&quot;</span> /&gt;</span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:Parameter</span><span class="ot">  Name=</span><span class="st">&quot;Property&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">edm:ReturnType</span><span class="ot"> Type=</span><span class="st">&quot;Collection(Edm.EntityType)&quot;</span> /&gt;</span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">edm:Function</span>&gt;</span></code></pre></div>
<p>The function retains those entities that <code>topcount</code> also would retain, and replaces the remaining entities by a single aggregated entity, where only the numeric property has a value, which is the sum over those remaining entities:</p>
<pre><code>GET /service/Sales?$apply=
  groupby((Customer/Country,Product/Name),
          aggregate(Amount with sum as Total))
  /groupby((Customer/Country),
           Self.TopCountAndRemainder(Count=1,Property=&#39;Total&#39;))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Customer(Country),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">3</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">2</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Coffee&quot;</span> <span class="fu">},</span></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span>  <span class="dv">7</span> <span class="fu">}</span></span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that these two entities get their values for the Country property from the groupby transformation, which ensures that they contain all grouping properties with the correct values.</p>
</div>
<h2 id="78-controlling-aggregation-per-rollup-level"><a name="ControllingAggregationperRollupLevel" href="#ControllingAggregationperRollupLevel">7.8 Controlling Aggregation per Rollup Level</a></h2>
<p>For a leveled hierarchy, consumers may specify a different aggregation method per level for every property passed to <a href="#Groupingwithrollup"><code>rollup</code></a> as a hierarchy level below the root level.</p>
<div class="example">
<p>Example 105: get the average of the overall amount by month per product.</p>
<p>Using a transformation sequence:</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/ID,Product/Name,Time/Month),
                           aggregate(Amount with sum) as Total))
                  /groupby((Product/ID,Product/Name),
                           aggregate(Total with average as MonthlyAverage))</code></pre>
<p>Using <code>from</code>:</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/ID,Product/Name),
                      aggregate(Amount with sum
                                       from Time/Month with average
                                       as MonthlyAverage))</code></pre>
</div>
<div class="example">
<p>Example 106: get the total amount per customer, the average of the total customer amounts per country, and the overall average of these averages</p>
<pre><code>GET /service/Sales?$apply=concat(
                    groupby((rollup(Customer/Country,Customer/ID)),
                           aggregate(Amount with sum
                                     from Customer/ID with average
                                     as CustomerCountryAverage)),
                    aggregate(Amount with sum
                              from Customer/ID      with average
                              from Customer/Country with average
                              as CustomerCountryAverage)))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(CustomerCountryAverage)&quot;</span><span class="fu">,</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">},</span></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage&quot;</span><span class="fu">:</span>   <span class="dv">7</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">},</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage&quot;</span><span class="fu">:</span>  <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;USA&quot;</span> <span class="fu">},</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage&quot;</span><span class="fu">:</span> <span class="fl">9.5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span><span class="fu">,</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">},</span></span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage&quot;</span><span class="fu">:</span> <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="st">&quot;Netherlands&quot;</span> <span class="fu">},</span></span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage&quot;</span><span class="fu">:</span> <span class="dv">5</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;CustomerCountryAverage@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span></span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CustomerCountryAverage&quot;</span><span class="fu">:</span> <span class="fl">7.25</span> <span class="fu">}</span></span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb204-22"><a href="#cb204-22" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that this example extends the result of <code>rollup</code> with <code>concat</code> and <code>aggregate</code> to append the overall average.</p>
</div>
<h2 id="79-aggregation-in-recursive-hierarchies"><a name="AggregationinRecursiveHierarchies" href="#AggregationinRecursiveHierarchies">7.9 Aggregation in Recursive Hierarchies</a></h2>
<p>If aggregation along a recursive hierarchy does not apply to the entire hierarchy, transformations <code>ancestors</code> and <code>descendants</code> may be used to restrict it as needed.</p>
<div class="example">
<p>Example 107: Total sales amounts for sales orgs in ‘US’ in the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a></p>
<pre><code>GET /service/Sales?$apply=
    descendants(
        $root/SalesOrganizations,SalesOrgHierarchy,SalesOrganization/ID,
        filter(SalesOrganization/Name eq &#39;US&#39;),keep start)
    /groupby((rolluprecursive(
        $root/SalesOrganizations,SalesOrgHierarchy,SalesOrganization/ID)),
      aggregate(Amount with sum as TotalAmount))
  &amp;$expand=SalesOrganization($expand=Superordinate/$ref)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(TotalAmount,SalesOrganization())&quot;</span><span class="fu">,</span></span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="dv">12</span><span class="fu">,</span></span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span>  <span class="dv">7</span><span class="fu">,</span></span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span></span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Note that this example returns the actual total sums regardless of whether the <code>descendants</code> transformation comes before or after the <code>groupby</code> with <code>rolluprecursive</code>.</p>
</div>
<p>The order of transformations becomes relevant if <code>groupby</code> with <code>rolluprecursive</code> shall aggregate over a thinned-out hierarchy, like here:</p>
<div class="example">
<p>Example 108: Number of Paper sales per sales org aggregated along the the <code>SalesOrgHierarchy</code> defined in <a href="#HierarchyExamples">Hierarchy Examples</a></p>
<pre><code>GET /service/Sales?$apply=
    filter(Product/Name eq &#39;Paper&#39;)
    /groupby((rolluprecursive((
        $root/SalesOrganizations,SalesOrgHierarchy,SalesOrganization/ID)),
      aggregate($count as PaperSalesCount))
  &amp;$expand=SalesOrganization($expand=Superordinate/$ref)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(PaperSalesCount,SalesOrganization())&quot;</span><span class="fu">,</span></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;PaperSalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;PaperSalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>           <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;PaperSalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;PaperSalesCount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;PaperSalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;PaperSalesCount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span></span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;US&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;PaperSalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;PaperSalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span>         <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span></span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;PaperSalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;PaperSalesCount&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb208-17"><a href="#cb208-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span><span class="fu">,</span></span>
<span id="cb208-18"><a href="#cb208-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;EMEA&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb208-19"><a href="#cb208-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;PaperSalesCount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;PaperSalesCount&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span></span>
<span id="cb208-20"><a href="#cb208-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span>        <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span></span>
<span id="cb208-21"><a href="#cb208-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="fu">}</span></span>
<span id="cb208-22"><a href="#cb208-22" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb208-23"><a href="#cb208-23" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example 109: The input set <code>Sales</code> is filtered along a hierarchy on a related entity (navigation property <code>SalesOrganization</code>) before an aggregation</p>
<pre><code>GET /service/Sales?$apply=
  descendants($root/SalesOrganizations,
    SalesOrgHierarchy,
    SalesOrganization/ID,
    filter(SalesOrganization/Name eq &#39;US&#39;),
    keep start)
  /aggregate(Amount with sum as TotalAmount)</code></pre>
<p>The same aggregate value is computed if the input set is the hierarchical entity <code>SalesOrganizations</code> and an assumed partner navigation property <code>Sales</code> of <code>SalesOrganization</code> appears in the <code>aggregate</code> transformation</p>
<pre><code>GET /service/SalesOrganizations?$apply=
  descendants($root/SalesOrganizations,
    SalesOrgHierarchy,
    ID,
    filter(Name eq &#39;US&#39;),
    keep start)
  /aggregate(Sales/Amount with sum as TotalAmount)</code></pre>
</div>
<div class="example">
<p>⚠ Example 110: total sales amount aggregated along the sales organization sub-hierarchy with root EMEA restricted to 3 levels</p>
<pre><code>GET /service/Sales?$apply=
  groupby((rolluprecursive($root/SalesOrganizations,
                           SalesOrgHierarchy,
                           SalesOrganization/ID)),
          aggregate(Amount with sum as Total))
  /filter(Aggregation.isdescendant(
    HierarchyNodes=$root/SalesOrganizations,
    HierarchyQualifier=&#39;SalesOrgHierarchy&#39;,
    Node=SalesOrganization/ID,
    Ancestor=&#39;EMEA&#39;,
    MaxDistance=2,
    IncludeSelf=true))
  /orderby(SalesOrganization/Name)
  /traverse($root/SalesOrganizations,
            SalesOrgHierarchy,SalesOrganization/ID,preorder)</code></pre>
<p>or, equivalently</p>
<pre><code>GET /service/Sales?$apply=
  groupby((rolluprecursive(
    $root/SalesOrganizations,
    SalesOrgHierarchy,
    SalesOrganization/ID,
    descendants(
      $root/SalesOrganizations,
      SalesOrgHierarchy,
      ID,
      filter(ID eq &#39;EMEA&#39;),
      2, keep start))),
  aggregate(Amount with sum as Total))
  /orderby(SalesOrganization/Name)
  /traverse($root/SalesOrganizations,
            SalesOrgHierarchy,SalesOrganization/ID,preorder)</code></pre>
</div>
<div class="example">
<p>Example 111: Return the result of <a href="#rollupnode">example 66</a> in preorder</p>
<pre><code>GET /service/Sales?$apply=groupby(
    (rolluprecursive(
      $root/SalesOrganizations,
      SalesOrgHierarchy,
      SalesOrganization/ID,
      descendants(
        $root/SalesOrganizations,
        SalesOrgHierarchy,
        ID, filter(ID eq &#39;US&#39;), keep start))),
    compute(case(SalesOrganization eq Aggregation.rollupnode():Amount)
            as AmountExcl)
    /aggregate(Amount with sum as TotalAmountIncl,
               AmountExcl with sum as TotalAmountExcl))
    /traverse($root/SalesOrganizations,
              SalesOrgHierarchy,
              SalesOrganization/ID,
              preorder,
              Name asc)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesOrganization(ID),</span></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="st">                               TotalAmountIncl,TotalAmountExcl)&quot;</span><span class="fu">,</span></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">},</span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountIncl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountIncl&quot;</span><span class="fu">:</span> <span class="dv">19</span><span class="fu">,</span></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountExcl&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">},</span></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountIncl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountIncl&quot;</span><span class="fu">:</span> <span class="dv">12</span><span class="fu">,</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountExcl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountExcl&quot;</span><span class="fu">:</span> <span class="dv">12</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">},</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountIncl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmountIncl&quot;</span><span class="fu">:</span>  <span class="dv">7</span><span class="fu">,</span></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmountExcl@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span> <span class="fu">,</span><span class="dt">&quot;TotalAmountExcl&quot;</span><span class="fu">:</span>  <span class="dv">7</span> <span class="fu">}</span></span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example <a name="traversecoll" href="#traversecoll">112</a>: Preorder traversal of a hierarchy with 1:N relationship with collection-valued segment <span class="math inline">\(p_1={\tt Sales}\)</span> and <span class="math inline">\(r={\tt SalesOrganization}/{\tt ID}\)</span>.</p>
<pre><code>GET /service/Products?$apply=traverse(
      $root/SalesOrganizations,
      SalesOrgHierarchy,
      Sales/SalesOrganization/ID,
      preorder,
      Name asc)
    &amp;$select=ID</code></pre>
<p>The result contains multiple instances of the same <code>Product</code> that differ in their <code>Sales</code> navigation property even though they agree in their <code>ID</code> key property. The node <span class="math inline">\(x\)</span> with <span class="math inline">\(x/{\tt ID}={}\)</span><code>"US"</code> has <span class="math inline">\(σ(x)={}\)</span><code>{"Sales": [{"SalesOrganization": {"ID": "US"}}]}</code>.</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$metadata#Products(ID,Sales(SalesOrganization(ID)))&quot;</span><span class="fu">,</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span></span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-14"><a href="#cb216-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-15"><a href="#cb216-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-16"><a href="#cb216-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-17"><a href="#cb216-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-18"><a href="#cb216-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-19"><a href="#cb216-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P1&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-20"><a href="#cb216-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P2&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb216-21"><a href="#cb216-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;P3&quot;</span><span class="fu">,</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb216-22"><a href="#cb216-22" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb216-23"><a href="#cb216-23" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example <a name="rollupcoll" href="#rollupcoll">113</a>: Aggregation along a hierarchy with 1:N relationship: Sold products per sales organization</p>
<pre><code>GET /service/Products?$apply=
    groupby((rolluprecursive(
               $root/SalesOrganizations,
               SalesOrgHierarchy,
               Sales/SalesOrganization/ID)),
             aggregate(ID with Custom.concat as SoldProducts)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Products(Sales(SalesOrganization(ID)),SoldProducts)&quot;</span><span class="fu">,</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SoldProducts&quot;</span><span class="fu">:</span> <span class="st">&quot;P1,P2,P3&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SoldProducts&quot;</span><span class="fu">:</span> <span class="st">&quot;P1,P3&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SoldProducts&quot;</span><span class="fu">:</span> <span class="st">&quot;P1,P3&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SoldProducts&quot;</span><span class="fu">:</span> <span class="st">&quot;P1,P2,P3&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US East&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SoldProducts&quot;</span><span class="fu">:</span> <span class="st">&quot;P2,P3&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Sales&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb218-15"><a href="#cb218-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SoldProducts&quot;</span><span class="fu">:</span> <span class="st">&quot;P1,P2,P3&quot;</span> <span class="fu">}</span></span>
<span id="cb218-16"><a href="#cb218-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb218-17"><a href="#cb218-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>⚠ Example 114: Assume an extension of the data model where a <code>SalesOrganization</code> is associated with one or more instances of <code>ProductCategory</code>, and <code>ProductCategory</code> also organizes categories in a recursive hierarchy:</p>
<table>
<thead>
<tr class="header">
<th>ProductCategory</th>
<th>parent ProductCategory</th>
<th>associated SalesOrganizations</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Food</td>
<td></td>
<td>US, EMEA</td>
</tr>
<tr class="even">
<td>Cereals</td>
<td>Food</td>
<td>US</td>
</tr>
<tr class="odd">
<td>Organic cereals</td>
<td>Cereals</td>
<td>US West</td>
</tr>
</tbody>
</table>
<p>Aggregation of sales amounts along the sales organization hierarchy could be restricted to those organizations linked with product category “Cereals” or a descendant of it, and the ancestors of those organizations:</p>
<pre><code>GET /service/Sales?$apply=groupby((rolluprecursive(
    $root/SalesOrganizations,SalesOrgHierarchy,
    SalesOrganization/ID,
    ancestors(
      $root/SalesOrganizations,SalesOrgHierarchy,
      ID,
      traverse(
        $root/ProductCategories,ProductCategoryHierarchy,
        ProductCategories/ID,
        preorder,
        filter(Name eq &#39;Cereals&#39;)),
      keep start)
    )),
    aggregate(Amount with sum as TotalAmount))
  &amp;$expand=SalesOrganization($select=ID,$expand=ProductCategories/$ref)</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesOrganization(ID),TotalAmount)&quot;</span><span class="fu">,</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span>   <span class="dt">&quot;ProductCategories&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="dv">24</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span>      <span class="dt">&quot;ProductCategories&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;ProductCategories(&#39;Food&#39;)&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;ProductCategories(&#39;Cereals&#39;)&quot;</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span> <span class="dv">19</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US West&quot;</span><span class="fu">,</span> <span class="dt">&quot;ProductCategories&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;ProductCategories(&#39;Organic cereals&#39;)&quot;</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalAmount@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalAmount&quot;</span><span class="fu">:</span>  <span class="dv">7</span> <span class="fu">}</span></span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><code>traverse</code> acts here as a filter, hence <code>preorder</code> could be changed to <code>postorder</code> without changing the result. <code>filter</code> is the parameter <span class="math inline">\(S\)</span> of <code>traverse</code> and operates on the product category hierarchy being traversed.</p>
<p>Replacing the <code>traverse</code> transformation with a <code>descendants</code> transformation, as in</p>
<pre><code>ancestors(
  $root/SalesOrganizations,SalesOrgHierarchy,
  ID,
  descendants(
    $root/ProductCategories,ProductCategoryHierarchy,
    ProductCategories/ID,
    filter(ProductCategories/any(c:c/Name eq &#39;Cereals&#39;)),
    keep start),
  keep start)</code></pre>
<p>works differently: <code>descendants</code> is the parameter <span class="math inline">\(T\)</span> of <code>ancestors</code> and operates on its input set of sales organizations. This would determine descendants of sales organizations for “Cereals” and their ancestor sales organizations, so US East would appear in the result.</p>
</div>
<h2 id="710-maintaining-recursive-hierarchies"><a name="MaintainingRecursiveHierarchies" href="#MaintainingRecursiveHierarchies">7.10 Maintaining Recursive Hierarchies</a></h2>
<p>Besides changes to the structural properties of the entities in a hierarchical collection, hierarchy maintenance involves changes to the parent-child relationships.</p>
<div class="example">
<p>Example 115: Move a sales organization Switzerland under the parent EMEA Central by binding the parent navigation property to EMEA Central <a href="#ODataJSON">OData-JSON, section 8.5</a>:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="er">PATCH</span> <span class="er">/service/SalesOrganizations(&#39;Switzerland&#39;)</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;EMEA Central&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span></code></pre></div>
<p>results in <code>204 No Content</code>.</p>
<p>Deleting the parent from the sales organization Switzerland (making it a root) can be achieved either with:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="er">PATCH</span> <span class="er">/service/SalesOrganizations(&#39;Switzerland&#39;)</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="kw">null</span> <span class="fu">}</span> <span class="fu">}</span></span></code></pre></div>
<p>or with:</p>
<pre><code>DELETE /service/SalesOrganizations(&#39;Switzerland&#39;)/Superordinate/$ref</code></pre>
</div>
<div class="example">
<p>Example <a name="refconstr" href="#refconstr">116</a>: If the parent navigation property contained a referential constraint for the key of the target <a href="#ODataCSDL">OData-CSDL, section 8.5</a>,</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;SalesOrganization&quot;</span>&gt;</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Name&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;SuperordinateID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Superordinate&quot;</span></span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Type=</span><span class="st">&quot;SalesModel.SalesOrganization&quot;</span>&gt;</span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ReferentialConstraint</span><span class="ot"> Property=</span><span class="st">&quot;SuperordinateID&quot;</span></span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a><span class="ot">                           ReferencedProperty=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">NavigationProperty</span>&gt;</span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span></code></pre></div>
<p>then alternatively the property taking part in the referential constraint <a href="#ODataProtocol">OData-Protocol, section 11.4.9.1</a> could be changed to EMEA Central:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="er">PATCH</span> <span class="er">/service/SalesOrganizations(&#39;Switzerland&#39;)</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;SuperordinateID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA Central&quot;</span> <span class="fu">}</span></span></code></pre></div>
</div>
<p>If the parent-child relationship between sales organizations is maintained in a separate entity set, a node can have multiple parents, with additional information on each parent-child relationship.</p>
<div class="example">
<p>⚠ Example <a name="weight" href="#weight">117</a>: Assume the relation from a node to its parent nodes contains a weight:</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;SalesOrganizationRelation&quot;</span>&gt;</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;Superordinate/ID&quot;</span><span class="ot"> Alias=</span><span class="st">&quot;SuperordinateID&quot;</span> /&gt;</span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Weight&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.Decimal&quot;</span></span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a><span class="ot">                          Nullable=</span><span class="st">&quot;false&quot;</span><span class="ot"> DefaultValue=</span><span class="st">&quot;1&quot;</span> /&gt;</span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Superordinate&quot;</span></span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Type=</span><span class="st">&quot;SalesModel.SalesOrganization&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">EntityType</span><span class="ot"> Name=</span><span class="st">&quot;SalesOrganization&quot;</span>&gt;</span>
<span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Key</span>&gt;</span>
<span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">PropertyRef</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Key</span>&gt;</span>
<span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;ID&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span><span class="ot"> Nullable=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb227-15"><a href="#cb227-15" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Property</span><span class="ot"> Name=</span><span class="st">&quot;Name&quot;</span><span class="ot"> Type=</span><span class="st">&quot;Edm.String&quot;</span> /&gt;</span>
<span id="cb227-16"><a href="#cb227-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">NavigationProperty</span><span class="ot"> Name=</span><span class="st">&quot;Relations&quot;</span></span>
<span id="cb227-17"><a href="#cb227-17" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Type=</span><span class="st">&quot;Collection(SalesModel.SalesOrganizationRelation)&quot;</span></span>
<span id="cb227-18"><a href="#cb227-18" aria-hidden="true" tabindex="-1"></a><span class="ot">                      Nullable=</span><span class="st">&quot;false&quot;</span><span class="ot"> ContainsTarget=</span><span class="st">&quot;true&quot;</span> /&gt;</span>
<span id="cb227-19"><a href="#cb227-19" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.RecursiveHierarchy&quot;</span></span>
<span id="cb227-20"><a href="#cb227-20" aria-hidden="true" tabindex="-1"></a><span class="ot">              Qualifier=</span><span class="st">&quot;MultiParentHierarchy&quot;</span>&gt;</span>
<span id="cb227-21"><a href="#cb227-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Record</span>&gt;</span>
<span id="cb227-22"><a href="#cb227-22" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;NodeProperty&quot;</span></span>
<span id="cb227-23"><a href="#cb227-23" aria-hidden="true" tabindex="-1"></a><span class="ot">                     PropertyPath=</span><span class="st">&quot;ID&quot;</span> /&gt;</span>
<span id="cb227-24"><a href="#cb227-24" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">PropertyValue</span><span class="ot"> Property=</span><span class="st">&quot;ParentNavigationProperty&quot;</span></span>
<span id="cb227-25"><a href="#cb227-25" aria-hidden="true" tabindex="-1"></a><span class="ot">                     NavigationPropertyPath=</span><span class="st">&quot;Relations/Superordinate&quot;</span> /&gt;</span>
<span id="cb227-26"><a href="#cb227-26" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Record</span>&gt;</span>
<span id="cb227-27"><a href="#cb227-27" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">Annotation</span>&gt;</span>
<span id="cb227-28"><a href="#cb227-28" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">EntityType</span>&gt;</span></code></pre></div>
<p>Further assume the following relationships between sales organizations:</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Relations/SuperordinateID</th>
<th style="text-align: right;">Relations/Weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>US</td>
<td>Sales</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>EMEA</td>
<td>Sales</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td>EMEA Central</td>
<td>EMEA</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td>Atlantis</td>
<td>US</td>
<td style="text-align: right;">0.6</td>
</tr>
<tr class="odd">
<td>Atlantis</td>
<td>EMEA</td>
<td style="text-align: right;">0.4</td>
</tr>
<tr class="even">
<td>Phobos</td>
<td>Mars</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
<p>Then Atlantis is a node with two parents. The standard hierarchical transformations disregard the weight property and consider both parents equally valid (but see <a href="#weighted">example 118</a>).</p>
<p>In a traversal with start node Sales only:</p>
<pre><code>GET /service/SalesOrganizations?$apply=
    traverse($root/SalesOrganizations,MultiParentHierarchy,ID,preorder,
             filter(ID eq &#39;Sales&#39;))</code></pre>
<p>Mars and Phobos cannot be reached and hence are orphans. But they can be made descendants of the start node Sales by adding a relationship. Note the collection-valued segment of the <code>ParentNavigationProperty</code> appears at the end of the resource path and the subsequent single-valued segment appears in the payload:</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/service/SalesOrganizations(&#39;Mars&#39;)/Relations</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;Superordinate&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;@id&quot;</span><span class="fu">:</span> <span class="st">&quot;SalesOrganizations(&#39;Sales&#39;)&quot;</span> <span class="fu">}</span> <span class="fu">}</span></span></code></pre></div>
<p>Since this example contains no referential constraint, there is no analogy to <a href="#refconstr">example 116</a>. The alias <code>SuperordinateID</code> cannot be used in the payload, the following request is invalid:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="er">POST</span> <span class="er">/service/SalesOrganizations(&#39;Mars&#39;)/Relations</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="er">Content-Type:</span> <span class="er">application/json</span></span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;SuperordinateID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span> <span class="fu">}</span></span></code></pre></div>
<p>The alias <code>SuperordinateID</code> is used in the request to delete the added relationship again:</p>
<pre><code>DELETE /service/SalesOrganizations(&#39;Mars&#39;)/Relations(&#39;Sales&#39;)</code></pre>
</div>
<div class="example">
<p>⚠ Example <a name="weighted" href="#weighted">118</a>: Continuing <a href="#weight">example 117</a>, assume a <a href="#CustomAggregates">custom aggregate</a> <code>MultiParentWeightedTotal</code> that computes the total sales amount weighted by the <code>SalesOrganizationRelation/Weight</code> properties along the <code>@Aggregation.UpPath#MultiParentHierarchy</code> of a sales organization:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Annotations</span><span class="ot"> Target=</span><span class="st">&quot;SalesData.Sales&quot;</span>&gt;</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">Annotation</span><span class="ot"> Term=</span><span class="st">&quot;Aggregation.CustomAggregate&quot;</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    Qualifier=</span><span class="st">&quot;MultiParentWeightedTotal&quot;</span><span class="ot"> String=</span><span class="st">&quot;Edm.Decimal&quot;</span> /&gt;</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Annotations</span>&gt;</span></code></pre></div>
<p>Then <code>rolluprecursive</code> can be used to aggregate the weighted sales amounts with the request below. The <code>traverse</code> transformation produces an output set <span class="math inline">\(H&#39;\)</span> in which sales organizations with multiple parents occur multiple times. <a href="#SamenessandOrder">For each occurrence</a> <span class="math inline">\(x\)</span> in <span class="math inline">\(H&#39;\)</span>, the <code>rolluprecursive</code> algorithm determines a sales collection <span class="math inline">\(F(x)\)</span> and the custom aggregate <code>MultiParentWeightedTotal</code> evaluates the path <code>SalesOrganization/@Aggregation.UpPath#MultiParentHierarchy</code> relative to that collection:</p>
<pre><code>GET /service/Sales?$apply=groupby(
    (rolluprecursive(
      $root/SalesOrganizations,
      MultiParentHierarchy,
      SalesOrganization/ID,
      traverse(
        $root/SalesOrganizations,
        MultiParentHierarchy,
        SalesOrganization/ID,
        preorder))),
    aggregate(MultiParentWeightedTotal))</code></pre>
<p>Assume that in addition to the sales in the <a href="#ExampleData">example data</a> there are sales of 10 in Atlantis. Then 60% of them would contribute to the US sales organization and 40% to the EMEA sales organization. Without the weights, all duplicate nodes would contribute the same aggregate result, therefore this example only makes sense in connection with a custom aggregate that considers the weights.</p>
<p>Note that <code>rolluprecursive</code> must preserve the preorder established by <code>traverse</code>:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(SalesOrganization(),MultiParentWeightedTotal)&quot;</span><span class="fu">,</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Sales&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Corporate Sales&quot;</span><span class="fu">,</span></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MultiParentWeightedTotal&quot;</span><span class="fu">:</span> <span class="dv">34</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;US&quot;</span><span class="fu">,</span></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MultiParentWeightedTotal&quot;</span><span class="fu">:</span> <span class="dv">25</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;US&quot;</span><span class="ot">,</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MultiParentWeightedTotal&quot;</span><span class="fu">:</span> <span class="dv">6</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;EMEA&quot;</span><span class="fu">,</span></span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MultiParentWeightedTotal&quot;</span><span class="fu">:</span> <span class="dv">9</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;SalesOrganization&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Atlantis&quot;</span><span class="fu">,</span></span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;@Aggregation.UpPath#MultiParentHierarchy&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;EMEA&quot;</span><span class="ot">,</span> <span class="st">&quot;Sales&quot;</span> <span class="ot">]</span> <span class="fu">},</span></span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MultiParentWeightedTotal&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb234-22"><a href="#cb234-22" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<h2 id="711-transformation-sequences"><a name="TransformationSequences" href="#TransformationSequences">7.11 Transformation Sequences</a></h2>
<p>Applying aggregation first covers the most prominent use cases. The slightly more sophisticated question “how much money is earned with small sales” requires filtering the base set before applying the aggregation. To enable this type of question several transformations can be specified in <code>$apply</code> in the order they are to be applied, separated by a forward slash.</p>
<div class="example">
<p>Example 119:</p>
<pre><code>GET /service/Sales?$apply=filter(Amount le 1)
    /aggregate(Amount with sum as Total)</code></pre>
<p>means “filter first, then aggregate”, and results in</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Total)&quot;</span><span class="fu">,</span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">2</span> <span class="fu">}</span></span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<p>Using <code>filter</code> within <code>$apply</code> does not preclude using it as a normal system query option.</p>
<div class="example">
<p>Example 120:</p>
<pre><code>GET /service/Sales?$apply=filter(Amount le 2)/groupby((Product/Name),
                                         aggregate(Amount with sum as Total))
           &amp;$filter=Total ge 4</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Product(Name),Total)&quot;</span><span class="fu">,</span></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Paper&quot;</span> <span class="fu">},</span></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Sugar&quot;</span> <span class="fu">},</span></span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Total@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Decimal&quot;</span><span class="fu">,</span> <span class="dt">&quot;Total&quot;</span><span class="fu">:</span> <span class="dv">4</span> <span class="fu">}</span></span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 121: Revisiting <a href="#from">example 16</a> for using the <code>from</code> keyword with the <code>aggregate</code> function, the request</p>
<pre><code>GET /service/Sales?$apply=aggregate(Amount from Time with average
                                    as DailyAverage)</code></pre>
<p>could be rewritten in a more procedural way using a transformation sequence returning the same result</p>
<pre><code>GET /service/Sales?$apply=groupby((Time),aggregate(Amount with sum as Total))
                  /aggregate(Total with average as DailyAverage)</code></pre>
</div>
<p>For further examples, consider another data model containing entity sets for cities, countries and continents and the obvious associations between them.</p>
<div class="example">
<p>Example 122: getting the population per country with</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                            aggregate(Population with sum as TotalPopulation))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Cities(Continent(Name),Country(Name),</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a><span class="st">                                TotalPopulation)&quot;</span><span class="fu">,</span></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Continent&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Asia&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;China&quot;</span> <span class="fu">},</span></span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalPopulation@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Int32&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalPopulation&quot;</span><span class="fu">:</span> <span class="dv">1412000000</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Continent&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;Asia&quot;</span> <span class="fu">},</span> <span class="dt">&quot;Country&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Name&quot;</span><span class="fu">:</span> <span class="st">&quot;India&quot;</span> <span class="fu">},</span></span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;TotalPopulation@type&quot;</span><span class="fu">:</span> <span class="st">&quot;Int32&quot;</span><span class="fu">,</span> <span class="dt">&quot;TotalPopulation&quot;</span><span class="fu">:</span> <span class="dv">1408000000</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a>    <span class="er">…</span></span>
<span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div class="example">
<p>Example 123: all countries with megacities and their continents</p>
<pre><code>GET /service/Cities?$apply=filter(Population ge 10000000)
                   /groupby((Continent/Name,Country/Name),
                            aggregate(Population with sum as TotalPopulation))</code></pre>
</div>
<div class="example">
<p>Example 124: all countries with tens of millions of city dwellers and the continents only for these countries</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                          aggregate(Population with sum as CountryPopulation))
                   /filter(CountryPopulation ge 10000000)
                   /concat(identity,
                         groupby((Continent/Name),
                           aggregate(CountryPopulation with sum
                                      as TotalPopulation)))</code></pre>
<p>or</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                          aggregate(Population with sum as CountryPopulation))
                   /filter(CountryPopulation ge 10000000)
                   /groupby((rollup(Continent/Name,Country/Name)),
                             aggregate(CountryPopulation with sum
                                       as TotalPopulation))</code></pre>
</div>
<div class="example">
<p>Example 125: all countries with tens of millions of city dwellers and all continents with cities independent of their size</p>
<pre><code>GET /service/Cities?$apply=groupby((Continent/Name,Country/Name),
                          aggregate(Population with sum as CountryPopulation))
                   /concat(filter(CountryPopulation ge 10000000),
                         groupby((Continent/Name),
                                 aggregate(CountryPopulation with sum
                                       as TotalPopulation)))</code></pre>
</div>
<div class="example">
<p>Example 126: assuming the data model includes a sales order entity set with related sets for order items and customers, the base set as well as the related items can be filtered before aggregation</p>
<pre><code>GET /service/SalesOrders?$apply=filter(Status eq &#39;incomplete&#39;)
    /addnested(Items,filter(not Shipped) as FilteredItems)
    /groupby((Customer/Country),
     aggregate(FilteredItems/Amount with sum as ItemAmount))</code></pre>
</div>
<div class="example">
<p>Example 127: assuming that <code>Amount</code> is a custom aggregate in addition to the property, determine the total for countries with an <code>Amount</code> greater than 1000</p>
<pre><code>GET /service/SalesOrders?$apply=
  groupby((Customer/Country),aggregate(Amount))
  /filter(Amount gt 1000)
  /aggregate(Amount)</code></pre>
</div>
<div class="example">
<p>Example <a name="aggrconflict" href="#aggrconflict">128</a>: The output set of the <code>concat</code> transformation contains <code>Sales</code> entities multiple times with conflicting related <code>AugmentedProduct</code> entities that cannot be aggregated by the second transformation.</p>
<pre><code>GET /service/Sales?$apply=
  concat(addnested(Product,compute(0.1 as Discount) as AugmentedProduct),
         addnested(Product,compute(0.2 as Discount) as AugmentedProduct))
  /aggregate(AugmentedProduct/Discount with max as MaxDiscount)</code></pre>
<p>results in an error.</p>
</div>
<div class="example">
<p>Example 129: The <code>nest</code> transformation can be used inside <code>groupby</code> to produce one or more collection-valued properties per group.</p>
<pre><code>GET /service/Sales?$apply=groupby((Product/Category/ID),
                      nest(groupby((Customer/ID)) as Customers))</code></pre>
<p>results in</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;@context&quot;</span><span class="fu">:</span> <span class="st">&quot;$metadata#Sales(Product(Category(ID)),Customers())&quot;</span><span class="fu">,</span></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Category&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;PG1&quot;</span> <span class="fu">}</span> <span class="fu">},</span></span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Customers@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Customer(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Customers&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;Product&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;Category&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;PG2&quot;</span> <span class="fu">}</span> <span class="fu">},</span></span>
<span id="cb251-10"><a href="#cb251-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Customers@context&quot;</span><span class="fu">:</span> <span class="st">&quot;#Sales(Customer(ID))&quot;</span><span class="fu">,</span></span>
<span id="cb251-11"><a href="#cb251-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Customers&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C1&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb251-12"><a href="#cb251-12" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C2&quot;</span> <span class="fu">}</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb251-13"><a href="#cb251-13" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">{</span> <span class="dt">&quot;Customer&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;ID&quot;</span><span class="fu">:</span> <span class="st">&quot;C3&quot;</span> <span class="fu">}</span> <span class="fu">}</span> <span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb251-14"><a href="#cb251-14" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb251-15"><a href="#cb251-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<hr />
<h1 id="8-conformance"><a name="Conformance" href="#Conformance">8 Conformance</a></h1>
<p>Conforming services MUST follow all rules of this specification for the set transformations and aggregation methods they support. They MUST implement all set transformations and aggregation methods they advertise via the annotation <a href="#AggregationCapabilities"><code>ApplySupported</code></a>.</p>
<p>Conforming clients MUST be prepared to consume a model that uses any or all of the constructs defined in this specification, including custom aggregation methods defined by the service, and MUST ignore any constructs not defined in this version of the specification.</p>
<hr />
<h1 id="appendix-a-references"><a name="References" href="#References">Appendix A. References</a></h1>
<p>This appendix contains the normative references that are used in this document.</p>
<p>While any hyperlinks included in this appendix were valid at the time of publication, OASIS cannot guarantee their long-term validity.</p>
<h2 id="a1-normative-references"><a name="NormativeReferences" href="#NormativeReferences">A.1 Normative References</a></h2>
<p>The following documents are referenced in such a way that some or all of their content constitutes requirements of this document.</p>
<h6 id="odata-abnf"><a name="ODataABNF">[OData-ABNF]</a></h6>
<p><em>ABNF components: OData ABNF Construction Rules Version 4.01 and OData ABNF Test Cases.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6 id="odata-agg-abnf"><a name="ODataAggABNF">[OData-Agg-ABNF]</a></h6>
<p><em>OData Aggregation ABNF Construction Rules Version 4.0.</em><br />
See link in “<a href="#AdditionalArtifacts">Additional artifacts</a>” section on cover page.</p>
<h6 id="odata-csdl"><a name="ODataCSDL">[OData-CSDL]</a></h6>
<p><em>OData Common Schema Definition Language (CSDL) JSON Representation Version 4.01.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<p><em>OData Common Schema Definition Language (CSDL) XML Representation Version 4.01.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6 id="odata-json"><a name="ODataJSON">[OData-JSON]</a></h6>
<p><em>OData JSON Format Version 4.01.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6 id="odata-protocol"><a name="ODataProtocol">[OData-Protocol]</a></h6>
<p><em>OData Version 4.01. Part 1: Protocol.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6 id="odata-url"><a name="ODataURL">[OData-URL]</a></h6>
<p><em>OData Version 4.01. Part 2: URL Conventions.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6 id="odata-vocaggr"><a name="ODataVocAggr">[OData-VocAggr]</a></h6>
<p><em>OData Aggregation Vocabulary.</em><br />
See link in “<a href="#AdditionalArtifacts">Additional artifacts</a>” section on cover page.</p>
<h6 id="odata-voccore"><a name="ODataVocCore">[OData-VocCore]</a></h6>
<p><em>OData Core Vocabulary.</em><br />
See link in “<a href="#RelatedWork">Related work</a>” section on cover page.</p>
<h6 id="rfc2119"><a name="rfc2119">[RFC2119]</a></h6>
<p><em>Bradner, S., “Key words for use in RFCs to Indicate Requirement Levels”, BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997</em><br />
<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>.</p>
<h6 id="rfc8174"><a name="rfc8174">[RFC8174]</a></h6>
<p><em>Leiba, B., “Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words”, BCP 14, RFC 8174, DOI 10.17487/RFC8174, May 2017</em><br />
<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>.</p>
<hr />
<h1 id="appendix-b-acknowledgments"><a name="Acknowledgments" href="#Acknowledgments">Appendix B. Acknowledgments</a></h1>
<h2 id="b1-special-thanks"><a name="SpecialThanks" href="#SpecialThanks">B.1 Special Thanks</a></h2>
<p>The contributions of the OASIS OData Technical Committee members, enumerated in <a href="#ODataProtocol">OData-Protocol</a>, are gratefully acknowledged.</p>
<h2 id="b2-participants"><a name="Participants" href="#Participants">B.2 Participants</a></h2>
<p><strong>OData TC Members:</strong></p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">First Name</th>
<th style="text-align: left;">Last Name</th>
<th style="text-align: left;">Company</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">George</td>
<td style="text-align: left;">Ericson</td>
<td style="text-align: left;">Dell</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hubert</td>
<td style="text-align: left;">Heijkers</td>
<td style="text-align: left;">IBM</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ling</td>
<td style="text-align: left;">Jin</td>
<td style="text-align: left;">IBM</td>
</tr>
<tr class="even">
<td style="text-align: left;">Stefan</td>
<td style="text-align: left;">Hagen</td>
<td style="text-align: left;">Individual</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Michael</td>
<td style="text-align: left;">Pizzo</td>
<td style="text-align: left;">Microsoft</td>
</tr>
<tr class="even">
<td style="text-align: left;">Christof</td>
<td style="text-align: left;">Sprenger</td>
<td style="text-align: left;">Microsoft</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ralf</td>
<td style="text-align: left;">Handl</td>
<td style="text-align: left;">SAP SE</td>
</tr>
<tr class="even">
<td style="text-align: left;">Gerald</td>
<td style="text-align: left;">Krause</td>
<td style="text-align: left;">SAP SE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Heiko</td>
<td style="text-align: left;">Theißen</td>
<td style="text-align: left;">SAP SE</td>
</tr>
<tr class="even">
<td style="text-align: left;">Martin</td>
<td style="text-align: left;">Zurmuehl</td>
<td style="text-align: left;">SAP SE</td>
</tr>
</tbody>
</table>
<hr />
<h1 id="appendix-c-revision-history"><a name="RevisionHistory" href="#RevisionHistory">Appendix C. Revision History</a></h1>
<table>
<thead>
<tr class="header">
<th>Revision</th>
<th>Date</th>
<th>Editor</th>
<th>Changes Made</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Working Draft 01</td>
<td>2012-11-12</td>
<td>Ralf Handl</td>
<td>Translated contribution into OASIS format</td>
</tr>
<tr class="even">
<td>Committee Specification Draft 01</td>
<td>2013-07-25</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Martin Zurmuehl</td>
<td>Switched to pipe-and-filter-style query language based on composable set transformations<br> Fleshed out examples and addressed numerous editorial and technical issues processed through the TC<br> Added Conformance section</td>
</tr>
<tr class="odd">
<td>Committee Specification Draft 02</td>
<td>2014-01-09</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Martin Zurmuehl</td>
<td>Dynamic properties used all aggregated values either via aliases or via custom aggregates<br> Refactored annotations</td>
</tr>
<tr class="even">
<td>Committee Specification Draft 03</td>
<td>2015-07-16</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Martin Zurmuehl</td>
<td>Added compute transformation<br> Minor clean-up</td>
</tr>
<tr class="odd">
<td>Committee Specification Draft 04</td>
<td>2023-07-05</td>
<td>Ralf Handl<br> Hubert Heijkers<br> Gerald Krause<br> Michael Pizzo<br> Heiko Theißen</td>
<td>Added section about fundamentals of input and output sets<br> Algorithmic descriptions of transformations<br> Added join and outerjoin transformations, replaced expand by addnested<br> Added transformations orderby, skip, top, nest<br> Added transformations for recursive hierarchies, updated related filter functions<br> Added functions evaluable on a collection, introduced keyword $these<br> Merged section 4 “Representation of Aggregated Instances” into section 3<br> Remove actions and functions (except set transformations) on aggregated entities, adapted section “Actions and Functions on Aggregated Entities”</td>
</tr>
<tr class="even">
<td>Committee Specification 03</td>
<td>2023-09-19</td>
<td>Ralf Handl<br> Gerald Krause<br> Heiko Theißen</td>
<td>Non-material changes from public review feedback</td>
</tr>
</tbody>
</table>
<hr />
<h1 id="appendix-d-notices"><a name="Notices" href="#Notices">Appendix D. Notices</a></h1>
<p>Copyright © OASIS Open 2023. All Rights Reserved.</p>
<p>All capitalized terms in the following text have the meanings assigned to them in the OASIS Intellectual Property Rights Policy (the “OASIS IPR Policy”). The full <a href="https://www.oasis-open.org/policies-guidelines/ipr/">Policy</a> may be found at the OASIS website.</p>
<p>This document and translations of it may be copied and furnished to others, and derivative works that comment on or otherwise explain it or assist in its implementation may be prepared, copied, published, and distributed, in whole or in part, without restriction of any kind, provided that the above copyright notice and this section are included on all such copies and derivative works. However, this document itself may not be modified in any way, including by removing the copyright notice or references to OASIS, except as needed for the purpose of developing any document or deliverable produced by an OASIS Technical Committee (in which case the rules applicable to copyrights, as set forth in the OASIS IPR Policy, must be followed) or as required to translate it into languages other than English.</p>
<p>The limited permissions granted above are perpetual and will not be revoked by OASIS or its successors or assigns.</p>
<p>This document and the information contained herein is provided on an “AS IS” basis and OASIS DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY OWNERSHIP RIGHTS OR ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.</p>
<p>As stated in the OASIS IPR Policy, the following three paragraphs in brackets apply to OASIS Standards Final Deliverable documents (Committee Specification, Candidate OASIS Standard, OASIS Standard, or Approved Errata).</p>
<p>[OASIS requests that any OASIS Party or any other party that believes it has patent claims that would necessarily be infringed by implementations of this OASIS Standards Final Deliverable, to notify OASIS TC Administrator and provide an indication of its willingness to grant patent licenses to such patent claims in a manner consistent with the IPR Mode of the OASIS Technical Committee that produced this deliverable.]</p>
<p>[OASIS invites any party to contact the OASIS TC Administrator if it is aware of a claim of ownership of any patent claims that would necessarily be infringed by implementations of this OASIS Standards Final Deliverable by a patent holder that is not willing to provide a license to such patent claims in a manner consistent with the IPR Mode of the OASIS Technical Committee that produced this OASIS Standards Final Deliverable. OASIS may include such claims on its website, but disclaims any obligation to do so.]</p>
<p>[OASIS takes no position regarding the validity or scope of any intellectual property or other rights that might be claimed to pertain to the implementation or use of the technology described in this OASIS Standards Final Deliverable or the extent to which any license under such rights might or might not be available; neither does it represent that it has made any effort to identify any such rights. Information on OASIS’ procedures with respect to rights in any document or deliverable produced by an OASIS Technical Committee can be found on the OASIS website. Copies of claims of rights made available for publication and any assurances of licenses to be made available, or the result of an attempt made to obtain a general license or permission for the use of such proprietary rights by implementers or users of this OASIS Standards Final Deliverable, can be obtained from the OASIS TC Administrator. OASIS makes no representation that any information or list of intellectual property rights will at any time be complete, or that any claims in such list are, in fact, Essential Claims.]</p>
<p>The name “OASIS” is a trademark of <a href="https://www.oasis-open.org/">OASIS</a>, the owner and developer of this specification, and should be used only to refer to the organization and its official outputs. OASIS welcomes reference to, and implementation and use of, specifications, while reserving the right to enforce its marks against misleading uses. Please see <a href="https://www.oasis-open.org/policies-guidelines/trademark/">https://www.oasis-open.org/policies-guidelines/trademark/</a> for above guidance.</p>
</body>
</html>
